<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audit Practice Manager - Forvis Mazars Botswana</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'IBM Plex Sans', sans-serif; background: #F8F9FA; color: #1A1A1A; }
    .app-container { display: flex; min-height: 100vh; }
    
    /* Sidebar */
    .sidebar { width: 260px; background: linear-gradient(180deg, #1F4E78 0%, #163A5C 100%); color: white; padding: 24px; box-shadow: 4px 0 12px rgba(0,0,0,0.1); position: fixed; height: 100vh; overflow-y: auto; }
    .sidebar-header { margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-header h1 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .sidebar-header p { font-size: 13px; opacity: 0.7; }
    .nav-item { padding: 12px 16px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; }
    .nav-item:hover { background: rgba(255,255,255,0.1); }
    .nav-item.active { background: rgba(255,255,255,0.15); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .user-info { margin-top: auto; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 13px; opacity: 0.8; }
    
    /* Main Content */
    .main-content { margin-left: 260px; flex: 1; padding: 32px; max-width: 1600px; }
    .page-header { margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center; }
    .page-title { font-size: 28px; font-weight: 700; color: #1F4E78; }
    
    /* Buttons */
    .btn { padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; font-family: 'IBM Plex Sans', sans-serif; }
    .btn-primary { background: #1F4E78; color: white; }
    .btn-primary:hover { background: #163A5C; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(31,78,120,0.3); }
    .btn-secondary { background: #E0E0E0; color: #333; }
    
    /* Cards */
    .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px; }
    .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .metric-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid; cursor: pointer; transition: all 0.2s; position: relative; }
    .metric-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }
    .metric-label { font-size: 13px; color: #666; margin-bottom: 8px; font-weight: 500; }
    .metric-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
    .metric-detail { font-size: 12px; color: #999; }
    .alert-badge { position: absolute; top: 12px; right: 12px; background: #DC3545; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; }
    
    /* Tables */
    table { width: 100%; border-collapse: collapse; }
    thead { background: #F8F9FA; }
    th { padding: 12px; text-align: left; font-weight: 600; font-size: 13px; color: #666; border-bottom: 2px solid #E0E0E0; }
    td { padding: 16px 12px; border-bottom: 1px solid #F0F0F0; font-size: 14px; }
    tr:hover { background: #FAFAFA; }
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; display: inline-block; }
    
    /* Modal */
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-content { background: white; border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-header { padding: 24px; border-bottom: 1px solid #E0E0E0; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 24px; font-weight: 700; color: #1F4E78; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 24px; border-top: 1px solid #E0E0E0; display: flex; gap: 12px; justify-content: flex-end; }
    .close-btn { background: none; border: none; font-size: 32px; color: #999; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
    .close-btn:hover { background: #F0F0F0; color: #333; }
    
    /* Forms */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; }
    .form-input { width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 8px; font-size: 14px; font-family: 'IBM Plex Sans', sans-serif; transition: border-color 0.2s; }
    .form-input:focus { outline: none; border-color: #1F4E78; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .section-title { font-size: 16px; font-weight: 600; color: #4472C4; margin: 24px 0 16px 0; padding-bottom: 8px; border-bottom: 2px solid #E0E0E0; }
    
    /* Progress bars */
    .progress-bar { width: 100%; height: 8px; background: #E0E0E0; border-radius: 4px; overflow: hidden; margin-top: 8px; }
    .progress-fill { height: 100%; background: #28A745; transition: width 0.3s; }
    .utilization-bar { display: flex; align-items: center; gap: 12px; padding: 12px; background: #F8F9FA; border-radius: 8px; margin-bottom: 8px; transition: all 0.2s; }
    .utilization-bar:hover { background: #E8E8E8; }
    .utilization-name { flex: 0 0 180px; font-weight: 600; font-size: 14px; }
    .utilization-progress { flex: 1; height: 24px; background: #E0E0E0; border-radius: 12px; overflow: hidden; position: relative; }
    .utilization-fill { height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600; }
    
    /* Empty state */
    .empty-state { text-align: center; padding: 60px 20px; color: #999; }
    .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
    
    /* Enhanced Stage Tabs - Individual Colors */
    .stage-tab-enhanced { 
      padding: 12px 18px; 
      border: 2px solid #E0E0E0;
      font-weight: 600; 
      font-size: 13px; 
      cursor: pointer; 
      border-radius: 8px;
      margin-right: 6px;
      transition: all 0.2s ease;
      background: white;
      color: #666;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .stage-tab-enhanced:hover { 
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    .stage-tab-enhanced.acceptance { border-color: #28A745; color: #28A745; }
    .stage-tab-enhanced.acceptance.active { background: #28A745; color: white; border-color: #28A745; }
    
    .stage-tab-enhanced.planning { border-color: #4472C4; color: #4472C4; }
    .stage-tab-enhanced.planning.active { background: #4472C4; color: white; border-color: #4472C4; }
    
    .stage-tab-enhanced.fieldwork { border-color: #FFC107; color: #F59E0B; }
    .stage-tab-enhanced.fieldwork.active { background: #FFC107; color: #fff; border-color: #FFC107; }
    
    .stage-tab-enhanced.completion { border-color: #ED7D31; color: #ED7D31; }
    .stage-tab-enhanced.completion.active { background: #ED7D31; color: white; border-color: #ED7D31; }
    
    .stage-tab-enhanced.lockdown { border-color: #DC3545; color: #DC3545; }
    .stage-tab-enhanced.lockdown.active { background: #DC3545; color: white; border-color: #DC3545; }
    
    .stage-tab-enhanced .tab-count {
      display: inline-block;
      background: rgba(0,0,0,0.1);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
      margin-left: 4px;
      font-weight: 700;
    }
    .stage-tab-enhanced.active .tab-count {
      background: rgba(255,255,255,0.3);
    }
    
    /* Enhanced Task Table */
    .task-table-enhanced { 
      width: 100%; 
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 20px;
    }
    .task-table-enhanced thead { 
      background: linear-gradient(135deg, #1F4E78 0%, #2d5a8a 100%);
    }
    .task-table-enhanced th { 
      padding: 16px 12px; 
      text-align: left; 
      font-weight: 600; 
      font-size: 13px; 
      color: white;
      border: none;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .task-table-enhanced th:first-child { border-radius: 8px 0 0 0; }
    .task-table-enhanced th:last-child { border-radius: 0 8px 0 0; }
    .task-table-enhanced td { 
      padding: 16px 12px; 
      border-bottom: 1px solid #F0F0F0; 
      font-size: 14px;
      background: white;
    }
    .task-table-enhanced tr:hover td { 
      background: #F8F9FA;
    }
    .task-table-enhanced tr:last-child td:first-child { border-radius: 0 0 0 8px; }
    .task-table-enhanced tr:last-child td:last-child { border-radius: 0 0 8px 0; }
    
    /* Enhanced Status Badges */
    .status-badge-enhanced {
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status-badge-enhanced.completed {
      background: linear-gradient(135deg, #28A745 0%, #20c997 100%);
      color: white;
    }
    .status-badge-enhanced.in-progress {
      background: linear-gradient(135deg, #4472C4 0%, #5a9fd4 100%);
      color: white;
    }
    .status-badge-enhanced.not-started {
      background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
      color: white;
    }
    .status-badge-enhanced::before {
      content: '‚óè';
      font-size: 8px;
    }
    
    /* Action Buttons Enhanced */
    .action-btn-enhanced {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .action-btn-enhanced.edit {
      background: linear-gradient(135deg, #4472C4 0%, #5a9fd4 100%);
      color: white;
    }
    .action-btn-enhanced.delete {
      background: linear-gradient(135deg, #DC3545 0%, #e85362 100%);
      color: white;
    }
    .action-btn-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .action-btn-enhanced:active {
      transform: translateY(0);
    }
    
    /* Hour Adjustment Badge */
    .hour-adjustment {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      background: #FFF3E0;
      color: #856404;
      font-weight: 600;
    }
    
    /* Enhanced Table Buttons */
    .table-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .table-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    .table-btn:active {
      transform: translateY(0);
    }
    .table-btn.manage {
      background: linear-gradient(135deg, #1F4E78 0%, #4472C4 100%);
      color: white;
    }
    .table-btn.view {
      background: linear-gradient(135deg, #28A745 0%, #20c997 100%);
      color: white;
    }
    .table-btn.edit {
      background: linear-gradient(135deg, #FFC107 0%, #FFD54F 100%);
      color: #333;
    }
    
    /* Enhanced View Tabs */
    .view-tab {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      background: #F5F5F5;
      color: #666;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-right: 8px;
      border: 2px solid transparent;
    }
    .view-tab:hover {
      background: #E8E8E8;
      transform: translateY(-1px);
    }
    .view-tab.active {
      background: linear-gradient(135deg, #1F4E78 0%, #4472C4 100%);
      color: white;
      box-shadow: 0 3px 8px rgba(31, 78, 120, 0.3);
      border-color: #1F4E78;
    }
    
    /* Lockdown Warning Enhanced */
    .lockdown-warning-enhanced {
      background: linear-gradient(135deg, #FFF3E0 0%, #FFE8B3 100%);
      border-left: 4px solid #FFC107;
      padding: 16px 20px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
      color: #856404;
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
      display: flex;
      align-items: start;
      gap: 12px;
    }
    .lockdown-warning-enhanced .icon {
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script>
    const { useState, createElement: h } = React;
    const { createRoot } = ReactDOM;

    // Initial Data
    const INITIAL_STAFF = [
      { id: 1, name: 'Jonathan Malefho', position: 'Audit Manager', level: 'Manager', hourlyRate: 800, isActive: true },
      { id: 2, name: 'David Moeti', position: 'Audit Manager', level: 'Manager', hourlyRate: 800, isActive: true },
      { id: 3, name: 'Sarah Smith', position: 'Audit Senior', level: 'Senior', hourlyRate: 500, isActive: true },
      { id: 4, name: 'Mike Johnson', position: 'Audit Senior', level: 'Senior', hourlyRate: 500, isActive: true },
      { id: 5, name: 'Sarah Keabetswe', position: 'Tax Manager', level: 'Tax Manager', hourlyRate: 850, isActive: true },
      { id: 6, name: 'Mpho Kgosana', position: 'Tax Manager', level: 'Tax Manager', hourlyRate: 850, isActive: true }
    ];

    const AUDIT_STAGES = [
      { id: 'acceptance', name: 'Acceptance Stage', order: 1 },
      { id: 'planning', name: 'Planning Stage', order: 2 },
      { id: 'fieldwork', name: 'Fieldwork Stage', order: 3 },
      { id: 'completion', name: 'Completion Stage', order: 4 },
      { id: 'lockdown', name: 'Lockdown Stage', order: 5, maxDays: 60 }
    ];

    const DEFAULT_TASKS = {
      acceptance: [
        { name: 'Client acceptance evaluation', defaultHours: 8 },
        { name: 'Engagement letter', defaultHours: 4 },
        { name: 'Independence assessment', defaultHours: 4 },
        { name: 'Conflict check', defaultHours: 2 }
      ],
      planning: [
        { name: 'Understanding entity', defaultHours: 24 },
        { name: 'Risk assessment', defaultHours: 16 },
        { name: 'Materiality', defaultHours: 8 },
        { name: 'Audit strategy', defaultHours: 16 },
        { name: 'Internal controls', defaultHours: 20 }
      ],
      fieldwork: [
        { name: 'Test of controls', defaultHours: 40 },
        { name: 'Revenue procedures', defaultHours: 32 },
        { name: 'Expense procedures', defaultHours: 28 },
        { name: 'Assets procedures', defaultHours: 36 },
        { name: 'Liabilities procedures', defaultHours: 32 },
        { name: 'Analytical procedures', defaultHours: 16 },
        { name: 'Inventory observation', defaultHours: 16 },
        { name: 'Cash confirmations', defaultHours: 8 }
      ],
      completion: [
        { name: 'Subsequent events', defaultHours: 8 },
        { name: 'Going concern', defaultHours: 12 },
        { name: 'Final analytics', defaultHours: 12 },
        { name: 'Adjustments', defaultHours: 16 },
        { name: 'FS review', defaultHours: 20 },
        { name: 'Report drafting', defaultHours: 12 },
        { name: 'File assembly', defaultHours: 8 }
      ],
      lockdown: [
        { name: 'Final file review', defaultHours: 8 },
        { name: 'Archive preparation', defaultHours: 4 },
        { name: 'Quality control review', defaultHours: 12 },
        { name: 'Post-audit procedures', defaultHours: 4 }
      ]
    };

    const INITIAL_ENGAGEMENTS = [
      {
        id: 1, 
        clientName: "ABC Mining Ltd", 
        yearEnd: "2024-12-31", 
        auditStartDate: "2025-01-15",
        budgetedFee: 500000, 
        actualWIP: 520000, 
        pieStatus: "Yes", 
        taxServices: "Yes",
        taxManager: "Sarah Keabetswe", 
        statutoryReturns: "Yes", 
        stockCount: "Yes",
        manager: "Jonathan Malefho", 
        senior: "Sarah Smith", 
        budgetedHours: 360, 
        actualHours: 320,
        status: "In Progress", 
        riskRating: "High", 
        notes: "",
        teamMembers: [
          { staffId: 1, name: 'Jonathan Malefho', role: 'Manager', budgetHours: 80, actualHours: 70 },
          { staffId: 3, name: 'Sarah Smith', role: 'Senior', budgetHours: 200, actualHours: 180 },
          { staffId: 5, name: 'Sarah Keabetswe', role: 'Tax', budgetHours: 80, actualHours: 70 }
        ],
        billings: [
          { id: 1, date: '2025-02-01', amount: 200000, description: 'Initial billing', status: 'Paid' },
          { id: 2, date: '2025-03-01', amount: 150000, description: 'Progress billing', status: 'Invoiced' }
        ],
        completionDate: "2025-03-15",
        tasks: [
          { 
            id: 1, 
            stage: 'acceptance', 
            name: 'Client acceptance evaluation', 
            budgetHours: 8, 
            actualHours: 8, 
            status: 'Completed', 
            assignments: [{ staffId: 1, hours: 8, startDate: '2026-02-02', endDate: '2026-02-06' }] 
          },
          { 
            id: 2, 
            stage: 'planning', 
            name: 'Risk assessment', 
            budgetHours: 16, 
            actualHours: 20, 
            status: 'Completed', 
            assignments: [
              { staffId: 1, hours: 8, startDate: '2026-02-02', endDate: '2026-02-06' }, 
              { staffId: 3, hours: 8, startDate: '2026-02-02', endDate: '2026-02-06' }
            ],
            approvalRequest: {
              id: 101,
              requestedBy: "Sarah Smith",
              requestDate: "2025-02-15",
              reason: "Additional scope: Client requested detailed analysis of new mining operations that were not in original scope. Required extra procedures and documentation.",
              additionalHours: 4,
              status: "pending",
              approvedBy: null,
              approvalDate: null,
              comments: null
            }
          },
          { 
            id: 3, 
            stage: 'planning', 
            name: 'Understanding entity and environment', 
            budgetHours: 24, 
            actualHours: 28, 
            status: 'In Progress', 
            assignments: [{ staffId: 3, hours: 24, startDate: '2026-02-03', endDate: '2026-02-07' }],
            approvalRequest: {
              id: 102,
              requestedBy: "Sarah Smith",
              requestDate: "2025-02-18",
              reason: "New subsidiary acquired during the year requiring additional understanding and risk assessment procedures.",
              additionalHours: 4,
              status: "approved",
              approvedBy: "Jonathan Malefho",
              approvalDate: "2025-02-19",
              comments: "Approved - acquisition was material and required proper documentation"
            }
          },
          { 
            id: 4, 
            stage: 'fieldwork', 
            name: 'Revenue testing procedures', 
            budgetHours: 32, 
            actualHours: 40, 
            status: 'In Progress', 
            assignments: [{ staffId: 3, hours: 32, startDate: '2026-02-10', endDate: '2026-02-14' }]
          },
          { 
            id: 5, 
            stage: 'fieldwork', 
            name: 'Inventory observation', 
            budgetHours: 16, 
            actualHours: 12, 
            status: 'Completed', 
            assignments: [{ staffId: 3, hours: 16, startDate: '2026-02-17', endDate: '2026-02-21' }],
            approvalRequest: {
              id: 103,
              requestedBy: "Senior Auditor",
              requestDate: "2025-02-10",
              reason: "Requested 8 additional hours but completed efficiently in less time due to improved inventory system.",
              additionalHours: -4,
              status: "rejected",
              approvedBy: "Jonathan Malefho",
              approvalDate: "2025-02-11",
              comments: "No adjustment needed - task completed under budget"
            }
          }
        ]
      },
      {
        id: 2, 
        clientName: "Retail Corp Pty", 
        yearEnd: "2024-06-30", 
        auditStartDate: "2024-07-10",
        budgetedFee: 280000, 
        actualWIP: 265000, 
        pieStatus: "No", 
        taxServices: "Yes",
        taxManager: "Mpho Kgosana", 
        statutoryReturns: "Yes", 
        stockCount: "Yes",
        manager: "David Moeti", 
        senior: "Mike Johnson", 
        budgetedHours: 240, 
        actualHours: 224,
        status: "Completed", 
        riskRating: "Medium", 
        notes: "",
        teamMembers: [
          { staffId: 2, name: 'David Moeti', role: 'Manager', budgetHours: 60, actualHours: 55 },
          { staffId: 4, name: 'Mike Johnson', role: 'Senior', budgetHours: 150, actualHours: 140 },
          { staffId: 6, name: 'Mpho Kgosana', role: 'Tax', budgetHours: 30, actualHours: 29 }
        ],
        billings: [
          { id: 1, date: '2024-09-20', amount: 280000, description: 'Final billing', status: 'Paid' }
        ],
        completionDate: "2024-09-20",
        tasks: [
          { 
            id: 6, 
            stage: 'completion', 
            name: 'Final review and report', 
            budgetHours: 20, 
            actualHours: 24, 
            status: 'Completed', 
            assignments: [{ staffId: 2, hours: 20 }],
            approvalRequest: {
              id: 104,
              requestedBy: "David Moeti",
              requestDate: "2024-09-15",
              reason: "Extended review required due to complex lease accounting under IFRS 16",
              additionalHours: 4,
              status: "approved",
              approvedBy: "Jonathan Malefho",
              approvalDate: "2024-09-16",
              comments: "Approved - IFRS 16 complexity was not anticipated in budget"
            }
          }
        ]
      },
      {
        id: 3, 
        clientName: "Tech Solutions Ltd", 
        yearEnd: "2025-12-31", 
        auditStartDate: "2026-01-20",
        budgetedFee: 350000, 
        actualWIP: 0, 
        pieStatus: "No", 
        taxServices: "No",
        taxManager: "-", 
        statutoryReturns: "Yes", 
        stockCount: "No",
        manager: "Jonathan Malefho", 
        senior: "Mike Johnson", 
        budgetedHours: 280, 
        actualHours: 0,
        status: "Planning", 
        riskRating: "Medium", 
        notes: "New client - software development company",
        teamMembers: [
          { staffId: 1, name: 'Jonathan Malefho', role: 'Manager', budgetHours: 60, actualHours: 0 },
          { staffId: 4, name: 'Mike Johnson', role: 'Senior', budgetHours: 180, actualHours: 0 }
        ],
        billings: [],
        completionDate: "2026-04-30",
        tasks: [
          { 
            id: 7, 
            stage: 'acceptance', 
            name: 'Client acceptance procedures', 
            budgetHours: 8, 
            actualHours: 0, 
            status: 'Not Started', 
            assignments: [{ staffId: 1, hours: 8, startDate: '2026-02-03', endDate: '2026-02-06' }] 
          },
          { 
            id: 8, 
            stage: 'planning', 
            name: 'IT systems understanding', 
            budgetHours: 40, 
            actualHours: 0, 
            status: 'Not Started', 
            assignments: [
              { staffId: 1, hours: 20, startDate: '2026-02-03', endDate: '2026-02-07' }, 
              { staffId: 4, hours: 20, startDate: '2026-02-03', endDate: '2026-02-07' }
            ],
            overtimeApproval: {
              id: 201,
              requestedBy: "Jonathan Malefho",
              requestDate: "2026-01-30",
              reason: "Additional scope: Client requested detailed analysis of new cloud infrastructure implementation that were not in original scope. Required extra procedures and documentation.",
              violations: [{
                staffName: "Jonathan Malefho",
                staffId: 1,
                overtimeDays: [
                  { date: '2026-02-03', existing: 5.2, adding: 4.0, total: 9.2, overtime: 1.2 },
                  { date: '2026-02-04', existing: 5.2, adding: 4.0, total: 9.2, overtime: 1.2 },
                  { date: '2026-02-05', existing: 5.2, adding: 4.0, total: 9.2, overtime: 1.2 },
                  { date: '2026-02-06', existing: 5.2, adding: 4.0, total: 9.2, overtime: 1.2 }
                ]
              }],
              status: "pending",
              approvedBy: null,
              approvalDate: null,
              comments: null
            }
          }
        ]
      }
    ];
    // Helper Functions
    const calculateLockdownDeadline = (completionDate) => {
      if (!completionDate) return null;
      const date = new Date(completionDate);
      date.setDate(date.getDate() + 60);
      return date.toISOString().split('T')[0];
    };
    const calculateDeadline = (yearEnd, months) => {
      if (!yearEnd) return '';
      const date = new Date(yearEnd);
      date.setMonth(date.getMonth() + months);
      return date.toISOString().split('T')[0];
    };

    const isDeadlineApproaching = (deadline) => {
      if (!deadline) return false;
      const diffDays = Math.floor((new Date(deadline) - new Date()) / (1000 * 60 * 60 * 24));
      return diffDays <= 30 && diffDays >= 0;
    };

    const isDeadlineOverdue = (deadline) => {
      return deadline ? new Date(deadline) < new Date() : false;
    };

    const calculateHoursPerformance = (budgeted, actual) => {
      if (!budgeted || budgeted === 0) return { percent: 0, status: 'unknown', color: '#999', label: 'N/A' };
      const ratio = actual / budgeted;
      const percent = (ratio * 100).toFixed(1);
      if (ratio <= 0.9) return { percent, status: 'excellent', color: '#28A745', label: 'Efficient ‚úì' };
      else if (ratio <= 1.1) return { percent, status: 'good', color: '#FFC107', label: 'On Target' };
      else return { percent, status: 'poor', color: '#DC3545', label: 'Inefficient ‚úó' };
    };

    // Main App Component
    function App() {
      const [user, setUser] = useState(null);
      const [currentView, setCurrentView] = useState('dashboard');
      const [engagements, setEngagements] = useState(INITIAL_ENGAGEMENTS);
      const [staff, setStaff] = useState(INITIAL_STAFF);
      const [filterType, setFilterType] = useState(null);
      const [filterData, setFilterData] = useState(null);

      const handleLogin = (userData) => {
        setUser(userData);
      };

      const handleNavigate = (view) => {
        setCurrentView(view);
        setFilterType(null);
        setFilterData(null);
      };

      const handleDrillDown = (type, data) => {
        setFilterType(type);
        setFilterData(data);
        setCurrentView('engagements');
      };

      if (!user) {
        return h(LoginPage, { onLogin: handleLogin });
      }

      return h('div', { className: 'app-container' },
        h(Sidebar, { currentView, onNavigate: handleNavigate, user }),
        h('div', { className: 'main-content' },
          currentView === 'dashboard' && h(Dashboard, { engagements, staff, onDrillDown: handleDrillDown }),
          currentView === 'engagements' && h(EngagementsView, { engagements, staff, filterType, filterData, onUpdate: setEngagements }),
          currentView === 'staff' && h(StaffView, { staff, engagements, onUpdate: setStaff }),
          currentView === 'billing' && h(BillingView, { engagements, onUpdate: setEngagements }),
          currentView === 'resources' && h(ResourceOptimizationView, { staff, engagements, onUpdate: setEngagements })
        )
      );
    }

    // Login Page
    function LoginPage({ onLogin }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        const users = {
          'partner@forvismazars.com': { password: 'partner2025', name: 'Partner', role: 'Partner' },
          'jonathan@forvismazars.com': { password: 'manager2025', name: 'Jonathan Malefho', role: 'Audit Manager' }
        };
        
        if (users[email] && users[email].password === password) {
          onLogin({ email, name: users[email].name, role: users[email].role });
        } else {
          setError('Invalid credentials');
        }
      };

      return h('div', { style: { minHeight: '100vh', background: 'linear-gradient(135deg, #1F4E78 0%, #163A5C 100%)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' } },
        h('div', { style: { background: 'white', borderRadius: '12px', boxShadow: '0 20px 60px rgba(0,0,0,0.3)', padding: '40px', maxWidth: '450px', width: '100%' } },
          h('div', { style: { textAlign: 'center', marginBottom: '30px' } },
            h('h1', { style: { fontSize: '28px', fontWeight: '700', color: '#1F4E78', marginBottom: '8px' } }, 'Forvis Mazars Botswana'),
            h('h2', { style: { fontSize: '18px', color: '#666' } }, 'Audit Practice Manager')
          ),
          h('form', { onSubmit: handleSubmit },
            h('div', { style: { marginBottom: '20px' } },
              h('label', { style: { display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '14px' } }, 'Email'),
              h('input', { type: 'email', value: email, onChange: (e) => setEmail(e.target.value), placeholder: 'your.email@forvismazars.com', required: true, className: 'form-input' })
            ),
            h('div', { style: { marginBottom: '20px' } },
              h('label', { style: { display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '14px' } }, 'Password'),
              h('input', { type: 'password', value: password, onChange: (e) => setPassword(e.target.value), placeholder: 'Enter password', required: true, className: 'form-input' })
            ),
            error && h('div', { style: { color: '#DC3545', marginBottom: '16px', fontSize: '14px' } }, error),
            h('button', { type: 'submit', className: 'btn btn-primary', style: { width: '100%' } }, 'Sign In')
          ),
          h('div', { style: { marginTop: '24px', padding: '16px', background: '#F5F5F5', borderRadius: '8px', fontSize: '13px' } },
            h('div', { style: { fontWeight: '600', marginBottom: '8px' } }, 'Demo Accounts:'),
            h('div', null, 'Partner: partner@forvismazars.com / partner2025'),
            h('div', null, 'Manager: jonathan@forvismazars.com / manager2025')
          )
        )
      );
    }

    // Sidebar Component
    function Sidebar({ currentView, onNavigate, user }) {
      return h('div', { className: 'sidebar' },
        h('div', { className: 'sidebar-header' },
          h('h1', null, 'Forvis Mazars'),
          h('p', null, 'Botswana')
        ),
        h('div', null,
          h('div', { className: `nav-item ${currentView === 'dashboard' ? 'active' : ''}`, onClick: () => onNavigate('dashboard') }, 'üìä Dashboard'),
          h('div', { className: `nav-item ${currentView === 'engagements' ? 'active' : ''}`, onClick: () => onNavigate('engagements') }, 'üìã Engagements'),
          h('div', { className: `nav-item ${currentView === 'staff' ? 'active' : ''}`, onClick: () => onNavigate('staff') }, 'üë• Staff'),
          h('div', { className: `nav-item ${currentView === 'resources' ? 'active' : ''}`, onClick: () => onNavigate('resources') }, 'üìà Resource Optimization'),
          h('div', { className: `nav-item ${currentView === 'billing' ? 'active' : ''}`, onClick: () => onNavigate('billing') }, 'üí∞ Billing')
        ),
        h('div', { className: 'user-info' },
          h('div', { style: { fontWeight: '600', marginBottom: '4px' } }, user.name),
          h('div', null, user.role)
        )
      );
    }

    // Dashboard Component with Clickable Metrics
    function Dashboard({ engagements, staff, onDrillDown }) {
      // Financial metrics
      const totalBudget = engagements.reduce((sum, e) => sum + e.budgetedFee, 0);
      const totalWIP = engagements.reduce((sum, e) => sum + (e.actualWIP || 0), 0);
      const totalBilled = engagements.reduce((sum, e) => {
        return sum + (e.billings || []).reduce((s, b) => s + b.amount, 0);
      }, 0);
      const outstanding = totalBudget - totalBilled;
      const unprofitable = engagements.filter(e => (e.actualWIP || 0) > e.budgetedFee * 1.1);

      // Hours performance
      const efficient = engagements.filter(e => {
        const perf = calculateHoursPerformance(e.budgetedHours, e.actualHours);
        return perf.status === 'excellent';
      });
      const onTarget = engagements.filter(e => {
        const perf = calculateHoursPerformance(e.budgetedHours, e.actualHours);
        return perf.status === 'good';
      });
      const inefficient = engagements.filter(e => {
        const perf = calculateHoursPerformance(e.budgetedHours, e.actualHours);
        return perf.status === 'poor';
      });

      // Resource metrics
      const activeStaff = staff.filter(s => s.isActive);
      const staffWithWorkload = activeStaff.map(s => {
        const totalHours = engagements.reduce((sum, e) => {
          const member = (e.teamMembers || []).find(tm => tm.staffId === s.id);
          return sum + (member ? (member.budgetHours || 0) : 0);
        }, 0);
        return { ...s, totalHours, utilization: (totalHours / 160) * 100 };
      });
      const avgUtilization = staffWithWorkload.reduce((sum, s) => sum + s.utilization, 0) / staffWithWorkload.length || 0;
      const overAllocated = staffWithWorkload.filter(s => s.utilization > 100);
      const underUtilized = staffWithWorkload.filter(s => s.utilization < 70);

      // Deadlines
      const cipaUrgent = engagements.filter(e => {
        if (e.statutoryReturns !== 'Yes') return false;
        const deadline = calculateDeadline(e.yearEnd, 7);
        return isDeadlineApproaching(deadline) || isDeadlineOverdue(deadline);
      });
      const taxUrgent = engagements.filter(e => {
        if (e.taxServices !== 'Yes') return false;
        const deadline = calculateDeadline(e.yearEnd, 3);
        return isDeadlineApproaching(deadline) || isDeadlineOverdue(deadline);
      });

      // Status counts
      const statuses = ['Planning', 'Fieldwork', 'In Progress', 'Review', 'Completed'];
      const statusCounts = statuses.map(status => ({
        status,
        count: engagements.filter(e => e.status === status).length,
        pct: ((engagements.filter(e => e.status === status).length / engagements.length) * 100).toFixed(0)
      }));

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, 'Dashboard')
        ),

        // Financial Performance
        h('h3', { style: { marginBottom: '16px', fontSize: '18px', fontWeight: '600' } }, 'Financial Performance'),
        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'Budgeted Fees'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, `P${(totalBudget / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, 'Total portfolio')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: totalWIP > totalBudget ? '#DC3545' : '#28A745' } },
            h('div', { className: 'metric-label' }, 'Actual WIP'),
            h('div', { className: 'metric-value', style: { color: totalWIP > totalBudget ? '#DC3545' : '#28A745' } }, `P${(totalWIP / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, totalWIP > totalBudget ? 'Over budget!' : 'On track')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#28A745', cursor: 'pointer' },
            onClick: () => onDrillDown('Billing Progress', engagements)
          },
            h('div', { className: 'metric-label' }, 'Total Billed'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, `P${(totalBilled / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, `${((totalBilled / totalBudget) * 100).toFixed(0)}% collected`)
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#FFC107', cursor: 'pointer' },
            onClick: () => onDrillDown('Outstanding Balance', engagements.filter(e => {
              const billed = (e.billings || []).reduce((sum, b) => sum + b.amount, 0);
              return e.budgetedFee - billed > 0;
            }))
          },
            h('div', { className: 'metric-label' }, 'Outstanding'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, `P${(outstanding / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, 'Unbilled fees')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: unprofitable.length > 0 ? '#DC3545' : '#28A745', cursor: 'pointer' },
            onClick: () => onDrillDown('Unprofitable Jobs', unprofitable)
          },
            unprofitable.length > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'Unprofitable Jobs'),
            h('div', { className: 'metric-value', style: { color: unprofitable.length > 0 ? '#DC3545' : '#28A745' } }, unprofitable.length),
            h('div', { className: 'metric-detail' }, '>10% over budget')
          )
        ),

        // Hours Performance
        h('h3', { style: { margin: '32px 0 16px 0', fontSize: '18px', fontWeight: '600' } }, 'Hours Performance'),
        h('div', { className: 'metric-grid' },
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#28A745', cursor: 'pointer' },
            onClick: () => onDrillDown('Efficient Engagements', efficient)
          },
            h('div', { className: 'metric-label' }, 'Efficient'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, efficient.length),
            h('div', { className: 'metric-detail' }, '<90% hours used ‚úì')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#FFC107', cursor: 'pointer' },
            onClick: () => onDrillDown('On-Target Engagements', onTarget)
          },
            h('div', { className: 'metric-label' }, 'On Target'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, onTarget.length),
            h('div', { className: 'metric-detail' }, '90-110% hours')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#DC3545', cursor: 'pointer' },
            onClick: () => onDrillDown('Inefficient Engagements', inefficient)
          },
            inefficient.length > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'Inefficient'),
            h('div', { className: 'metric-value', style: { color: '#DC3545' } }, inefficient.length),
            h('div', { className: 'metric-detail' }, '>110% hours used ‚úó')
          )
        ),

        // Resource Utilization
        h('h3', { style: { margin: '32px 0 16px 0', fontSize: '18px', fontWeight: '600' } }, 'Resource Utilization'),
        h('div', { className: 'metric-grid' },
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#4472C4', cursor: 'pointer' },
            onClick: () => onDrillDown('All Staff', activeStaff)
          },
            h('div', { className: 'metric-label' }, 'Total Staff'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, activeStaff.length),
            h('div', { className: 'metric-detail' }, 'Active team members')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: avgUtilization > 85 ? '#FFC107' : '#28A745' } },
            h('div', { className: 'metric-label' }, 'Avg Utilization'),
            h('div', { className: 'metric-value', style: { color: avgUtilization > 85 ? '#FFC107' : '#28A745' } }, `${avgUtilization.toFixed(0)}%`),
            h('div', { className: 'metric-detail' }, 'Portfolio average')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#DC3545', cursor: 'pointer' },
            onClick: () => onDrillDown('Over-Allocated Staff', overAllocated)
          },
            overAllocated.length > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'Over-Allocated'),
            h('div', { className: 'metric-value', style: { color: '#DC3545' } }, overAllocated.length),
            h('div', { className: 'metric-detail' }, '>100% capacity')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#FFC107', cursor: 'pointer' },
            onClick: () => onDrillDown('Under-Utilized Staff', underUtilized)
          },
            h('div', { className: 'metric-label' }, 'Under-Utilized'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, underUtilized.length),
            h('div', { className: 'metric-detail' }, '<70% capacity')
          )
        ),

        // Deadline Alerts
        h('h3', { style: { margin: '32px 0 16px 0', fontSize: '18px', fontWeight: '600' } }, 'Deadline Alerts'),
        h('div', { className: 'metric-grid' },
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: cipaUrgent.length > 0 ? '#DC3545' : '#28A745', cursor: 'pointer' },
            onClick: () => onDrillDown('CIPA Filings Due', cipaUrgent)
          },
            cipaUrgent.length > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'CIPA Filings'),
            h('div', { className: 'metric-value', style: { color: cipaUrgent.length > 0 ? '#DC3545' : '#28A745' } }, cipaUrgent.length),
            h('div', { className: 'metric-detail' }, 'Due within 30 days')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: taxUrgent.length > 0 ? '#DC3545' : '#28A745', cursor: 'pointer' },
            onClick: () => onDrillDown('Tax Returns Due', taxUrgent)
          },
            taxUrgent.length > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'Tax Returns'),
            h('div', { className: 'metric-value', style: { color: taxUrgent.length > 0 ? '#DC3545' : '#28A745' } }, taxUrgent.length),
            h('div', { className: 'metric-detail' }, 'Due within 30 days')
          )
        ),

        // Status Breakdown
        h('div', { className: 'card' },
          h('h3', { style: { marginBottom: '16px', fontSize: '18px', fontWeight: '600' } }, 'Engagement Status'),
          h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '16px' } },
            statusCounts.map(({ status, count, pct }) =>
              h('div', {
                key: status,
                style: {
                  padding: '20px',
                  background: count > 0 ? '#F8F9FA' : '#FFF',
                  borderRadius: '8px',
                  textAlign: 'center',
                  cursor: count > 0 ? 'pointer' : 'default',
                  border: '2px solid #E0E0E0',
                  transition: 'all 0.2s'
                },
                onClick: count > 0 ? () => onDrillDown(status, engagements.filter(e => e.status === status)) : null,
                onMouseEnter: (e) => { if (count > 0) e.currentTarget.style.transform = 'translateY(-4px)'; },
                onMouseLeave: (e) => { e.currentTarget.style.transform = 'translateY(0)'; }
              },
                h('div', { style: { fontSize: '32px', fontWeight: '700', color: count > 0 ? '#1F4E78' : '#CCC', marginBottom: '4px' } }, count),
                h('div', { style: { fontSize: '14px', color: '#666', marginBottom: '4px' } }, status),
                h('div', { style: { fontSize: '12px', color: '#999' } }, `${pct}%`)
              )
            )
          )
        )
      );
    }


    // SECTION 2: ENGAGEMENTS MODULE
    
    function EngagementsView({ engagements, staff, filterType, filterData, onUpdate }) {
      const [showForm, setShowForm] = useState(false);
      const [editingEngagement, setEditingEngagement] = useState(null);
      const [selectedEngagement, setSelectedEngagement] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [statusFilter, setStatusFilter] = useState('all');

      const displayEngagements = (filterData || engagements).filter(e => {
        const matchesSearch = e.clientName.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesStatus = statusFilter === 'all' || e.status === statusFilter;
        return matchesSearch && matchesStatus;
      });

      const handleDelete = (id) => {
        if (confirm('Are you sure you want to delete this engagement?')) {
          onUpdate(engagements.filter(e => e.id !== id));
        }
      };

      const handleSave = (engagement) => {
        if (editingEngagement) {
          onUpdate(engagements.map(e => e.id === engagement.id ? engagement : e));
        } else {
          onUpdate([...engagements, { ...engagement, id: Date.now() }]);
        }
        setShowForm(false);
        setEditingEngagement(null);
      };

      const filterTitle = filterType || 'All Engagements';

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, filterTitle),
          h('button', { 
            className: 'btn btn-primary',
            onClick: () => {
              setEditingEngagement(null);
              setShowForm(true);
            }
          }, '+ Add Engagement')
        ),

        h('div', { className: 'card', style: { marginBottom: '20px', padding: '16px' } },
          h('div', { style: { display: 'flex', gap: '16px' } },
            h('input', {
              className: 'form-input',
              style: { flex: 1, marginBottom: 0 },
              type: 'text',
              placeholder: 'Search by client name...',
              value: searchTerm,
              onChange: (e) => setSearchTerm(e.target.value)
            }),
            h('select', {
              className: 'form-input',
              style: { minWidth: '200px', marginBottom: 0 },
              value: statusFilter,
              onChange: (e) => setStatusFilter(e.target.value)
            },
              h('option', { value: 'all' }, 'All Statuses'),
              h('option', { value: 'Planning' }, 'Planning'),
              h('option', { value: 'Fieldwork' }, 'Fieldwork'),
              h('option', { value: 'In Progress' }, 'In Progress'),
              h('option', { value: 'Review' }, 'Review'),
              h('option', { value: 'Completed' }, 'Completed')
            )
          )
        ),

        h('div', { className: 'card', style: { overflowX: 'auto' } },
          h('table', { style: { minWidth: '1200px' } },
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', null, 'Year End'),
                h('th', null, 'Senior'),
                h('th', { style: { textAlign: 'right' } }, 'Budget Fee'),
                h('th', { style: { textAlign: 'right' } }, 'Actual WIP'),
                h('th', { style: { textAlign: 'center' } }, 'Hours'),
                h('th', { style: { textAlign: 'center' } }, 'Performance'),
                h('th', { style: { textAlign: 'center' } }, 'Status'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              displayEngagements.length === 0 ?
                h('tr', null,
                  h('td', { colSpan: 9, style: { textAlign: 'center', padding: '40px', color: '#999' } },
                    'No engagements found'
                  )
                ) :
                displayEngagements.map(e => {
                  const perf = calculateHoursPerformance(e.budgetedHours, e.actualHours);

                  return h('tr', { key: e.id },
                    h('td', { style: { fontWeight: '600' } }, e.clientName),
                    h('td', null, e.yearEnd),
                    h('td', null, e.senior),
                    h('td', { style: { textAlign: 'right' } }, `P${(e.budgetedFee / 1000).toFixed(0)}K`),
                    h('td', { style: { textAlign: 'right' } }, `P${((e.actualWIP || 0) / 1000).toFixed(0)}K`),
                    h('td', { style: { textAlign: 'center' } }, 
                      `${e.actualHours || 0}/${e.budgetedHours || 0}`
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('span', {
                        className: 'status-badge',
                        style: { background: perf.color, color: 'white', fontSize: '11px' }
                      }, perf.label)
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('span', {
                        className: 'status-badge',
                        style: { background: e.status === 'Completed' ? '#28A745' : '#4472C4', color: 'white' }
                      }, e.status)
                    ),
                    h('td', null,
                      h('div', { style: { display: 'flex', gap: '8px', justifyContent: 'center' } },
                        h('button', {
                          style: { padding: '6px 12px', background: '#4472C4', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                          onClick: () => setSelectedEngagement(e)
                        }, 'View'),
                        h('button', {
                          style: { padding: '6px 12px', background: '#FFC107', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                          onClick: () => {
                            setEditingEngagement(e);
                            setShowForm(true);
                          }
                        }, 'Edit'),
                        h('button', {
                          style: { padding: '6px 12px', background: '#DC3545', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                          onClick: () => handleDelete(e.id)
                        }, 'Delete')
                      )
                    )
                  );
                })
            )
          )
        ),

        showForm && h(EngagementForm, {
          engagement: editingEngagement,
          staff: staff,
          onSave: handleSave,
          onCancel: () => {
            setShowForm(false);
            setEditingEngagement(null);
          }
        }),

        selectedEngagement && h(EngagementDetailView, {
          engagement: selectedEngagement,
          staff: staff,
          allEngagements: engagements,
          onClose: () => setSelectedEngagement(null)
        })
      );
    }

    function EngagementForm({ engagement, staff, onSave, onCancel }) {
      const [formData, setFormData] = useState(engagement || {
        clientName: '', yearEnd: '', auditStartDate: '', auditCompletionDate: '',
        budgetedFee: '', actualWIP: '', pieStatus: 'No', taxServices: 'No', taxManager: '',
        statutoryReturns: 'No', stockCount: 'No', manager: '', senior: '',
        budgetedHours: '', actualHours: '', status: 'Planning', riskRating: 'Medium',
        notes: '', teamMembers: [], billings: []
      });

      const handleChange = (field, value) => {
        const newData = { ...formData, [field]: value };
        if (field === 'taxServices' && value === 'No') newData.taxManager = '';
        setFormData(newData);
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.clientName || !formData.yearEnd || !formData.senior || !formData.budgetedFee || !formData.manager) {
          alert('Please fill in all required fields');
          return;
        }
        onSave({
          ...formData,
          budgetedFee: parseFloat(formData.budgetedFee) || 0,
          actualWIP: parseFloat(formData.actualWIP) || 0,
          budgetedHours: parseFloat(formData.budgetedHours) || 0,
          actualHours: parseFloat(formData.actualHours) || 0
        });
      };

      const managers = staff.filter(s => s.level === 'Manager' && s.isActive);
      const seniors = staff.filter(s => s.level === 'Senior' && s.isActive);
      const taxManagers = staff.filter(s => s.level === 'Tax Manager' && s.isActive);

      return h('div', { className: 'modal', onClick: onCancel },
        h('div', { className: 'modal-content', onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, engagement ? 'Edit Engagement' : 'Add New Engagement'),
            h('button', { className: 'close-btn', onClick: onCancel }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            h('form', { onSubmit: handleSubmit, id: 'engagementForm' },
              
              h('div', { className: 'section-title' }, 'Client Information'),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Client Name *'),
                  h('input', { className: 'form-input', type: 'text', value: formData.clientName, onChange: (e) => handleChange('clientName', e.target.value), required: true })
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Year End *'),
                  h('input', { className: 'form-input', type: 'date', value: formData.yearEnd, onChange: (e) => handleChange('yearEnd', e.target.value), required: true })
                )
              ),

              h('div', { className: 'section-title' }, 'Financial'),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Budgeted Fee (BWP) *'),
                  h('input', { className: 'form-input', type: 'number', value: formData.budgetedFee, onChange: (e) => handleChange('budgetedFee', e.target.value), min: '0', required: true })
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Actual WIP (BWP)'),
                  h('input', { className: 'form-input', type: 'number', value: formData.actualWIP, onChange: (e) => handleChange('actualWIP', e.target.value), min: '0' })
                )
              ),

              h('div', { className: 'section-title' }, 'Team'),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Manager *'),
                  h('select', { className: 'form-input', value: formData.manager, onChange: (e) => handleChange('manager', e.target.value), required: true },
                    h('option', { value: '' }, '-- Select Manager --'),
                    managers.map(m => h('option', { key: m.id, value: m.name }, m.name))
                  )
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Senior *'),
                  h('select', { className: 'form-input', value: formData.senior, onChange: (e) => handleChange('senior', e.target.value), required: true },
                    h('option', { value: '' }, '-- Select Senior --'),
                    seniors.map(s => h('option', { key: s.id, value: s.name }, s.name))
                  )
                )
              ),

              h('div', { className: 'section-title' }, 'Hours'),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Budgeted Hours'),
                  h('input', { className: 'form-input', type: 'number', value: formData.budgetedHours, onChange: (e) => handleChange('budgetedHours', e.target.value), min: '0' })
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Actual Hours'),
                  h('input', { className: 'form-input', type: 'number', value: formData.actualHours, onChange: (e) => handleChange('actualHours', e.target.value), min: '0' })
                )
              ),

              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Status'),
                  h('select', { className: 'form-input', value: formData.status, onChange: (e) => handleChange('status', e.target.value) },
                    h('option', { value: 'Planning' }, 'Planning'),
                    h('option', { value: 'Fieldwork' }, 'Fieldwork'),
                    h('option', { value: 'In Progress' }, 'In Progress'),
                    h('option', { value: 'Review' }, 'Review'),
                    h('option', { value: 'Completed' }, 'Completed')
                  )
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Stock Count'),
                  h('select', { className: 'form-input', value: formData.stockCount, onChange: (e) => handleChange('stockCount', e.target.value) },
                    h('option', { value: 'No' }, 'No'),
                    h('option', { value: 'Yes' }, 'Yes')
                  )
                )
              )
            )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', type: 'button', onClick: onCancel }, 'Cancel'),
            h('button', { className: 'btn btn-primary', type: 'submit', form: 'engagementForm' }, 
              engagement ? 'Update' : 'Add Engagement'
            )
          )
        )
      );
    }

    function EngagementDetailView({ engagement, staff, allEngagements, onClose }) {
      const perf = calculateHoursPerformance(engagement.budgetedHours, engagement.actualHours);
      const totalBilled = (engagement.billings || []).reduce((sum, b) => sum + b.amount, 0);

      return h('div', { className: 'modal', onClick: onClose },
        h('div', { className: 'modal-content', onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, engagement.clientName),
            h('button', { className: 'close-btn', onClick: onClose }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            h('div', { style: { padding: '20px', background: '#1F4E78', color: 'white', borderRadius: '8px', marginBottom: '24px' } },
              h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px' } },
                h('div', null, h('strong', null, 'Year End: '), engagement.yearEnd),
                h('div', null, h('strong', null, 'Manager: '), engagement.manager),
                h('div', null, h('strong', null, 'Status: '), engagement.status)
              )
            ),
            h('div', { className: 'section-title' }, 'Financial'),
            h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px', marginBottom: '24px' } },
              h('div', null,
                h('div', { style: { fontSize: '12px', color: '#666' } }, 'Budget Fee'),
                h('div', { style: { fontSize: '24px', fontWeight: '700', color: '#4472C4' } }, `P${engagement.budgetedFee.toLocaleString()}`)
              ),
              h('div', null,
                h('div', { style: { fontSize: '12px', color: '#666' } }, 'Actual WIP'),
                h('div', { style: { fontSize: '24px', fontWeight: '700' } }, `P${(engagement.actualWIP || 0).toLocaleString()}`)
              ),
              h('div', null,
                h('div', { style: { fontSize: '12px', color: '#666' } }, 'Total Billed'),
                h('div', { style: { fontSize: '24px', fontWeight: '700', color: '#28A745' } }, `P${totalBilled.toLocaleString()}`)
              )
            ),
            h('div', { className: 'section-title' }, 'Hours Performance'),
            h('div', { style: { textAlign: 'center', padding: '20px', background: '#F8F9FA', borderRadius: '8px' } },
              h('div', { style: { fontSize: '14px', color: '#666', marginBottom: '8px' } }, 
                `${engagement.actualHours || 0}h / ${engagement.budgetedHours || 0}h`
              ),
              h('div', { style: { fontSize: '24px', fontWeight: '700', color: perf.color } }, perf.label)
            )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Close')
          )
        )
      );
    }


    // SECTION 3: STAFF MANAGEMENT MODULE
    
    function StaffView({ staff, engagements, onUpdate }) {
      const [showForm, setShowForm] = useState(false);
      const [editingStaff, setEditingStaff] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [levelFilter, setLevelFilter] = useState('all');

      const filteredStaff = staff.filter(s => {
        const matchesSearch = s.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                             s.position.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesLevel = levelFilter === 'all' || s.level === levelFilter;
        return matchesSearch && matchesLevel && s.isActive;
      });

      const staffWithWorkload = filteredStaff.map(s => {
        const assignments = [];
        engagements.forEach(e => {
          const member = (e.teamMembers || []).find(tm => tm.staffId === s.id);
          if (member) {
            assignments.push({
              clientName: e.clientName,
              role: member.role,
              budgetHours: member.budgetHours || 0,
              actualHours: member.actualHours || 0
            });
          }
        });
        const totalBudgetHours = assignments.reduce((sum, a) => sum + a.budgetHours, 0);
        const totalActualHours = assignments.reduce((sum, a) => sum + a.actualHours, 0);
        const utilization = (totalBudgetHours / 160) * 100;
        
        return { ...s, assignments, totalBudgetHours, totalActualHours, utilization, engagementCount: assignments.length };
      });

      const totalStaff = staff.filter(s => s.isActive).length;
      const avgUtilization = staffWithWorkload.reduce((sum, s) => sum + s.utilization, 0) / staffWithWorkload.length || 0;
      const overAllocated = staffWithWorkload.filter(s => s.utilization > 100).length;
      const underUtilized = staffWithWorkload.filter(s => s.utilization < 70).length;

      const handleDelete = (id) => {
        if (confirm('Are you sure you want to deactivate this staff member?')) {
          onUpdate(staff.map(s => s.id === id ? { ...s, isActive: false } : s));
        }
      };

      const handleSave = (staffMember) => {
        if (editingStaff) {
          onUpdate(staff.map(s => s.id === staffMember.id ? staffMember : s));
        } else {
          onUpdate([...staff, { ...staffMember, id: Date.now(), isActive: true }]);
        }
        setShowForm(false);
        setEditingStaff(null);
      };

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, 'Staff Management'),
          h('button', { 
            className: 'btn btn-primary',
            onClick: () => {
              setEditingStaff(null);
              setShowForm(true);
            }
          }, '+ Add Staff Member')
        ),

        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'Total Active Staff'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, totalStaff),
            h('div', { className: 'metric-detail' }, 'Team members')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: avgUtilization > 85 ? '#FFC107' : '#28A745' } },
            h('div', { className: 'metric-label' }, 'Average Utilization'),
            h('div', { className: 'metric-value', style: { color: avgUtilization > 85 ? '#FFC107' : '#28A745' } }, 
              `${avgUtilization.toFixed(0)}%`
            ),
            h('div', { className: 'metric-detail' }, 'Across all staff')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: overAllocated > 0 ? '#DC3545' : '#28A745' } },
            overAllocated > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'Over-Allocated'),
            h('div', { className: 'metric-value', style: { color: overAllocated > 0 ? '#DC3545' : '#28A745' } }, overAllocated),
            h('div', { className: 'metric-detail' }, '>100% utilization')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#FFC107' } },
            h('div', { className: 'metric-label' }, 'Under-Utilized'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, underUtilized),
            h('div', { className: 'metric-detail' }, '<70% utilization')
          )
        ),

        h('div', { className: 'card', style: { marginBottom: '20px', padding: '16px' } },
          h('div', { style: { display: 'flex', gap: '16px' } },
            h('input', {
              className: 'form-input',
              style: { flex: 1, marginBottom: 0 },
              type: 'text',
              placeholder: 'Search by name or position...',
              value: searchTerm,
              onChange: (e) => setSearchTerm(e.target.value)
            }),
            h('select', {
              className: 'form-input',
              style: { minWidth: '200px', marginBottom: 0 },
              value: levelFilter,
              onChange: (e) => setLevelFilter(e.target.value)
            },
              h('option', { value: 'all' }, 'All Levels'),
              h('option', { value: 'Partner' }, 'Partner'),
              h('option', { value: 'Manager' }, 'Manager'),
              h('option', { value: 'Senior' }, 'Senior'),
              h('option', { value: 'Tax Manager' }, 'Tax Manager')
            )
          )
        ),

        h('div', { className: 'card', style: { overflowX: 'auto' } },
          h('table', null,
            h('thead', null,
              h('tr', null,
                h('th', null, 'Name'),
                h('th', null, 'Position'),
                h('th', null, 'Level'),
                h('th', { style: { textAlign: 'right' } }, 'Hourly Rate'),
                h('th', { style: { textAlign: 'center' } }, 'Engagements'),
                h('th', { style: { textAlign: 'center' } }, 'Hours'),
                h('th', { style: { textAlign: 'center' } }, 'Utilization'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              staffWithWorkload.length === 0 ?
                h('tr', null,
                  h('td', { colSpan: 8, style: { textAlign: 'center', padding: '40px', color: '#999' } },
                    'No staff members found'
                  )
                ) :
                staffWithWorkload.map(s => {
                  const utilizationColor = s.utilization > 100 ? '#DC3545' : 
                                          s.utilization >= 70 ? '#28A745' : '#FFC107';
                  
                  return h('tr', { key: s.id },
                    h('td', { style: { fontWeight: '600' } }, s.name),
                    h('td', null, s.position),
                    h('td', null, s.level),
                    h('td', { style: { textAlign: 'right' } }, `P${s.hourlyRate.toLocaleString()}`),
                    h('td', { style: { textAlign: 'center' } }, s.engagementCount),
                    h('td', { style: { textAlign: 'center' } }, `${s.totalBudgetHours.toFixed(0)}h / 160h`),
                    h('td', { style: { textAlign: 'center' } },
                      h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', justifyContent: 'center' } },
                        h('div', { 
                          style: { 
                            width: '80px', 
                            height: '20px', 
                            background: '#E0E0E0', 
                            borderRadius: '10px',
                            overflow: 'hidden'
                          }
                        },
                          h('div', {
                            style: {
                              width: `${Math.min(s.utilization, 100)}%`,
                              height: '100%',
                              background: utilizationColor,
                              transition: 'width 0.3s'
                            }
                          })
                        ),
                        h('span', { style: { fontWeight: '600', fontSize: '13px', color: utilizationColor } }, 
                          `${s.utilization.toFixed(0)}%`
                        )
                      )
                    ),
                    h('td', null,
                      h('div', { style: { display: 'flex', gap: '8px', justifyContent: 'center' } },
                        h('button', {
                          style: { padding: '6px 12px', background: '#4472C4', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                          onClick: () => {
                            setEditingStaff(s);
                            setShowForm(true);
                          }
                        }, 'Edit'),
                        h('button', {
                          style: { padding: '6px 12px', background: '#DC3545', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                          onClick: () => handleDelete(s.id)
                        }, 'Deactivate')
                      )
                    )
                  );
                })
            )
          )
        ),

        showForm && h(StaffForm, {
          staff: editingStaff,
          onSave: handleSave,
          onCancel: () => {
            setShowForm(false);
            setEditingStaff(null);
          }
        })
      );
    }

    function StaffForm({ staff, onSave, onCancel }) {
      const [formData, setFormData] = useState(staff || {
        name: '', position: '', level: 'Senior', hourlyRate: '', skills: '', availabilityPercent: 100
      });

      const handleChange = (field, value) => {
        setFormData({ ...formData, [field]: value });
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.name || !formData.position || !formData.hourlyRate) {
          alert('Please fill in all required fields');
          return;
        }
        onSave({
          ...formData,
          hourlyRate: parseFloat(formData.hourlyRate) || 0,
          availabilityPercent: parseFloat(formData.availabilityPercent) || 100
        });
      };

      return h('div', { className: 'modal', onClick: onCancel },
        h('div', { className: 'modal-content', style: { maxWidth: '600px' }, onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, staff ? 'Edit Staff Member' : 'Add Staff Member'),
            h('button', { className: 'close-btn', onClick: onCancel }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            h('form', { onSubmit: handleSubmit, id: 'staffForm' },
              h('div', { className: 'section-title' }, 'Basic Information'),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Full Name *'),
                  h('input', { className: 'form-input', type: 'text', value: formData.name, onChange: (e) => handleChange('name', e.target.value), required: true })
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Position *'),
                  h('input', { className: 'form-input', type: 'text', value: formData.position, onChange: (e) => handleChange('position', e.target.value), required: true })
                )
              ),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Level *'),
                  h('select', { className: 'form-input', value: formData.level, onChange: (e) => handleChange('level', e.target.value), required: true },
                    h('option', { value: 'Partner' }, 'Partner'),
                    h('option', { value: 'Manager' }, 'Manager'),
                    h('option', { value: 'Senior' }, 'Senior'),
                    h('option', { value: 'Semi-Senior' }, 'Semi-Senior'),
                    h('option', { value: 'Assistant' }, 'Assistant'),
                    h('option', { value: 'Tax Manager' }, 'Tax Manager')
                  )
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Hourly Rate (BWP) *'),
                  h('input', { className: 'form-input', type: 'number', value: formData.hourlyRate, onChange: (e) => handleChange('hourlyRate', e.target.value), required: true, min: '0' })
                )
              ),
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Skills / Specializations'),
                h('input', { className: 'form-input', type: 'text', value: formData.skills || '', onChange: (e) => handleChange('skills', e.target.value) })
              )
            )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', type: 'button', onClick: onCancel }, 'Cancel'),
            h('button', { className: 'btn btn-primary', type: 'submit', form: 'staffForm' }, 
              staff ? 'Update Staff Member' : 'Add Staff Member'
            )
          )
        )
      );
    }


    // SECTION 4: BILLING MODULE
    
    function BillingView({ engagements, onUpdate }) {
      const [selectedEngagement, setSelectedEngagement] = useState(null);
      const [showBillingForm, setShowBillingForm] = useState(false);
      const [editingBilling, setEditingBilling] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');

      const totalBudget = engagements.reduce((sum, e) => sum + e.budgetedFee, 0);
      const totalBilled = engagements.reduce((sum, e) => 
        sum + (e.billings || []).reduce((s, b) => s + b.amount, 0), 0
      );
      const totalOutstanding = totalBudget - totalBilled;
      const collectionRate = totalBudget > 0 ? ((totalBilled / totalBudget) * 100).toFixed(1) : 0;

      const engagementsWithBilling = engagements.map(e => {
        const billed = (e.billings || []).reduce((sum, b) => sum + b.amount, 0);
        const outstanding = e.budgetedFee - billed;
        const progress = e.budgetedFee > 0 ? ((billed / e.budgetedFee) * 100).toFixed(0) : 0;
        return { ...e, totalBilled: billed, outstanding, billingProgress: progress };
      }).filter(e => e.clientName.toLowerCase().includes(searchTerm.toLowerCase()));

      const handleAddBilling = (billing) => {
        const updated = engagements.map(e => {
          if (e.id === selectedEngagement.id) {
            const billings = e.billings || [];
            if (editingBilling) {
              return { ...e, billings: billings.map(b => b.id === billing.id ? billing : b) };
            } else {
              return { ...e, billings: [...billings, { ...billing, id: Date.now() }] };
            }
          }
          return e;
        });
        onUpdate(updated);
        setShowBillingForm(false);
        setEditingBilling(null);
      };

      const handleDeleteBilling = (billingId) => {
        if (confirm('Delete this billing record?')) {
          const updated = engagements.map(e => {
            if (e.id === selectedEngagement.id) {
              return { ...e, billings: (e.billings || []).filter(b => b.id !== billingId) };
            }
            return e;
          });
          onUpdate(updated);
        }
      };

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, 'Billing Management')
        ),

        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'Total Budget'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, `P${(totalBudget / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, 'All engagements')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#28A745' } },
            h('div', { className: 'metric-label' }, 'Total Billed'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, `P${(totalBilled / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, `${collectionRate}% of budget`)
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#FFC107' } },
            h('div', { className: 'metric-label' }, 'Outstanding'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, `P${(totalOutstanding / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, 'To be billed')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'Collection Rate'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, `${collectionRate}%`),
            h('div', { className: 'metric-detail' }, 'Billed vs Budget')
          )
        ),

        h('div', { className: 'card', style: { marginBottom: '20px', padding: '16px' } },
          h('input', {
            className: 'form-input',
            style: { marginBottom: 0 },
            type: 'text',
            placeholder: 'Search by client name...',
            value: searchTerm,
            onChange: (e) => setSearchTerm(e.target.value)
          })
        ),

        h('div', { className: 'card', style: { overflowX: 'auto' } },
          h('table', null,
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', { style: { textAlign: 'right' } }, 'Budget Fee'),
                h('th', { style: { textAlign: 'right' } }, 'Total Billed'),
                h('th', { style: { textAlign: 'right' } }, 'Outstanding'),
                h('th', { style: { textAlign: 'center' } }, 'Progress'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              engagementsWithBilling.map(e => {
                const progressColor = e.billingProgress >= 100 ? '#28A745' : 
                                     e.billingProgress >= 70 ? '#4472C4' : '#FFC107';
                
                return h('tr', { key: e.id },
                  h('td', { style: { fontWeight: '600' } }, e.clientName),
                  h('td', { style: { textAlign: 'right' } }, `P${e.budgetedFee.toLocaleString()}`),
                  h('td', { style: { textAlign: 'right', color: '#28A745', fontWeight: '600' } }, `P${e.totalBilled.toLocaleString()}`),
                  h('td', { style: { textAlign: 'right', color: e.outstanding > 0 ? '#FFC107' : '#28A745', fontWeight: '600' } }, `P${e.outstanding.toLocaleString()}`),
                  h('td', { style: { textAlign: 'center' } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', justifyContent: 'center' } },
                      h('div', { style: { width: '100px', height: '20px', background: '#E0E0E0', borderRadius: '10px', overflow: 'hidden' } },
                        h('div', { style: { width: `${Math.min(e.billingProgress, 100)}%`, height: '100%', background: progressColor, transition: 'width 0.3s' } })
                      ),
                      h('span', { style: { fontSize: '13px', fontWeight: '600', color: progressColor } }, `${e.billingProgress}%`)
                    )
                  ),
                  h('td', { style: { textAlign: 'center' } },
                    h('button', {
                      className: 'btn btn-primary',
                      style: { padding: '6px 16px', fontSize: '13px' },
                      onClick: () => setSelectedEngagement(e)
                    }, 'Manage')
                  )
                );
              })
            )
          )
        ),

        selectedEngagement && h(BillingDetailModal, {
          engagement: selectedEngagement,
          onClose: () => setSelectedEngagement(null),
          onAddBilling: () => {
            setEditingBilling(null);
            setShowBillingForm(true);
          },
          onEditBilling: (billing) => {
            setEditingBilling(billing);
            setShowBillingForm(true);
          },
          onDeleteBilling: handleDeleteBilling
        }),

        showBillingForm && selectedEngagement && h(BillingForm, {
          engagement: selectedEngagement,
          billing: editingBilling,
          onSave: handleAddBilling,
          onCancel: () => {
            setShowBillingForm(false);
            setEditingBilling(null);
          }
        })
      );
    }

    function BillingDetailModal({ engagement, onClose, onAddBilling, onEditBilling, onDeleteBilling }) {
      const billings = engagement.billings || [];
      const totalBilled = billings.reduce((sum, b) => sum + b.amount, 0);
      const outstanding = engagement.budgetedFee - totalBilled;
      const progress = engagement.budgetedFee > 0 ? ((totalBilled / engagement.budgetedFee) * 100).toFixed(1) : 0;

      return h('div', { className: 'modal', onClick: onClose },
        h('div', { className: 'modal-content', style: { maxWidth: '800px' }, onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, `Billing: ${engagement.clientName}`),
            h('button', { className: 'close-btn', onClick: onClose }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            h('div', { style: { background: '#F8F9FA', padding: '20px', borderRadius: '8px', marginBottom: '24px' } },
              h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px', marginBottom: '16px' } },
                h('div', null,
                  h('div', { style: { fontSize: '12px', color: '#666' } }, 'Budget Fee'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700', color: '#4472C4' } }, `P${engagement.budgetedFee.toLocaleString()}`)
                ),
                h('div', null,
                  h('div', { style: { fontSize: '12px', color: '#666' } }, 'Total Billed'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700', color: '#28A745' } }, `P${totalBilled.toLocaleString()}`)
                ),
                h('div', null,
                  h('div', { style: { fontSize: '12px', color: '#666' } }, 'Outstanding'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700', color: outstanding > 0 ? '#FFC107' : '#28A745' } }, `P${outstanding.toLocaleString()}`)
                )
              ),
              h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '8px' } }, 'Billing Progress'),
              h('div', { className: 'progress-bar' },
                h('div', { className: 'progress-fill', style: { width: `${Math.min(progress, 100)}%`, background: progress >= 100 ? '#28A745' : '#4472C4' } })
              ),
              h('div', { style: { fontSize: '14px', fontWeight: '600', marginTop: '8px', textAlign: 'center' } }, `${progress}% Billed`)
            ),

            h('div', { style: { marginBottom: '16px' } },
              h('button', { className: 'btn btn-primary', onClick: onAddBilling }, '+ Add Billing Record')
            ),

            h('div', { className: 'section-title' }, 'Billing History'),
            billings.length === 0 ?
              h('div', { className: 'empty-state' },
                h('div', { className: 'empty-state-icon' }, 'üí∞'),
                h('p', null, 'No billing records yet')
              ) :
              h('table', null,
                h('thead', null,
                  h('tr', null,
                    h('th', null, 'Date'),
                    h('th', { style: { textAlign: 'right' } }, 'Amount'),
                    h('th', null, 'Description'),
                    h('th', { style: { textAlign: 'center' } }, 'Status'),
                    h('th', { style: { textAlign: 'center' } }, 'Actions')
                  )
                ),
                h('tbody', null,
                  billings.sort((a, b) => new Date(b.date) - new Date(a.date)).map(b => 
                    h('tr', { key: b.id },
                      h('td', null, b.date),
                      h('td', { style: { textAlign: 'right', fontWeight: '600' } }, `P${b.amount.toLocaleString()}`),
                      h('td', null, b.description),
                      h('td', { style: { textAlign: 'center' } },
                        h('span', { className: 'status-badge', style: { background: b.status === 'Paid' ? '#28A745' : '#FFC107', color: 'white' } }, b.status)
                      ),
                      h('td', { style: { textAlign: 'center' } },
                        h('div', { style: { display: 'flex', gap: '8px', justifyContent: 'center' } },
                          h('button', {
                            style: { padding: '4px 10px', background: '#4472C4', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                            onClick: () => onEditBilling(b)
                          }, 'Edit'),
                          h('button', {
                            style: { padding: '4px 10px', background: '#DC3545', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                            onClick: () => onDeleteBilling(b.id)
                          }, 'Delete')
                        )
                      )
                    )
                  )
                )
              )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Close')
          )
        )
      );
    }

    function BillingForm({ engagement, billing, onSave, onCancel }) {
      const [formData, setFormData] = useState(billing || {
        date: new Date().toISOString().split('T')[0],
        amount: '',
        description: '',
        status: 'Draft'
      });

      const handleChange = (field, value) => {
        setFormData({ ...formData, [field]: value });
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.date || !formData.amount || !formData.description) {
          alert('Please fill in all fields');
          return;
        }
        onSave({ ...formData, amount: parseFloat(formData.amount) || 0 });
      };

      return h('div', { className: 'modal', onClick: onCancel },
        h('div', { className: 'modal-content', style: { maxWidth: '600px' }, onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, billing ? 'Edit Billing' : 'Add Billing'),
            h('button', { className: 'close-btn', onClick: onCancel }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            h('form', { onSubmit: handleSubmit, id: 'billingForm' },
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Date *'),
                h('input', { className: 'form-input', type: 'date', value: formData.date, onChange: (e) => handleChange('date', e.target.value), required: true })
              ),
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Amount (BWP) *'),
                h('input', { className: 'form-input', type: 'number', value: formData.amount, onChange: (e) => handleChange('amount', e.target.value), required: true, min: '0' })
              ),
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Description *'),
                h('textarea', { className: 'form-input', style: { minHeight: '80px' }, value: formData.description, onChange: (e) => handleChange('description', e.target.value), required: true })
              ),
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Status *'),
                h('select', { className: 'form-input', value: formData.status, onChange: (e) => handleChange('status', e.target.value), required: true },
                  h('option', { value: 'Draft' }, 'Draft'),
                  h('option', { value: 'Invoiced' }, 'Invoiced'),
                  h('option', { value: 'Paid' }, 'Paid'),
                  h('option', { value: 'Overdue' }, 'Overdue')
                )
              )
            )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', type: 'button', onClick: onCancel }, 'Cancel'),
            h('button', { className: 'btn btn-primary', type: 'submit', form: 'billingForm' }, billing ? 'Update' : 'Add Billing')
          )
        )
      );
    }


    // SECTION 5: RESOURCE PLANNING & OPTIMIZATION MODULE
    

    // SECTION 5: RESOURCE OPTIMIZATION MODULE
    function ResourceOptimizationView({ staff, engagements, onUpdate }) {
      const [selectedEngagement, setSelectedEngagement] = useState(null);
      const [showTaskManager, setShowTaskManager] = useState(false);
      const [currentView, setCurrentView] = useState('tasks');

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, 'Resource Optimization'),
          h('p', { style: { marginTop: '8px', fontSize: '14px', color: '#666' } }, 
            'Task-based planning with calendar views and resource allocation'
          )
        ),

        h('div', { style: { marginBottom: '24px', display: 'flex', gap: '0', flexWrap: 'wrap' } },
          h('button', { 
            className: `view-tab ${currentView === 'tasks' ? 'active' : ''}`,
            onClick: () => setCurrentView('tasks')
          }, 'üìã', h('span', null, 'Task Planning')),
          h('button', { 
            className: `view-tab ${currentView === 'calendar' ? 'active' : ''}`,
            onClick: () => setCurrentView('calendar')
          }, 'üìÖ', h('span', null, 'Calendar View')),
          h('button', { 
            className: `view-tab ${currentView === 'gantt' ? 'active' : ''}`,
            onClick: () => setCurrentView('gantt')
          }, 'üìä', h('span', null, 'Gantt Chart')),
          h('button', { 
            className: `view-tab ${currentView === 'utilization' ? 'active' : ''}`,
            onClick: () => setCurrentView('utilization')
          }, 'üìà', h('span', null, 'Utilization')),
          h('button', { 
            className: `view-tab ${currentView === 'adjustments' ? 'active' : ''}`,
            onClick: () => setCurrentView('adjustments')
          }, '‚úÖ', h('span', null, 'Approvals'))
        ),

        currentView === 'tasks' && h('div', { className: 'card' },
          h('h3', { style: { marginBottom: '16px', fontSize: '18px', fontWeight: '600' } }, 'Task-Based Resource Planning'),
          h('table', null,
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', { style: { textAlign: 'center' } }, 'Tasks'),
                h('th', { style: { textAlign: 'center' } }, 'Budget Hours'),
                h('th', { style: { textAlign: 'center' } }, 'Completion Date'),
                h('th', { style: { textAlign: 'center' } }, 'Status'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              engagements.map(e => {
                const tasks = e.tasks || [];
                const totalBudgetHours = tasks.reduce((sum, t) => sum + (t.budgetHours || 0), 0);
                const lockdownDeadline = calculateLockdownDeadline(e.completionDate);

                return h('tr', { key: e.id },
                  h('td', { style: { fontWeight: '600' } }, e.clientName),
                  h('td', { style: { textAlign: 'center' } }, tasks.length),
                  h('td', { style: { textAlign: 'center' } }, totalBudgetHours + 'h'),
                  h('td', { style: { textAlign: 'center', fontSize: '12px' } }, 
                    e.completionDate || '-',
                    lockdownDeadline && h('div', { style: { fontSize: '11px', color: '#FFC107' } }, 
                      'Lockdown: ' + lockdownDeadline
                    )
                  ),
                  h('td', { style: { textAlign: 'center' } },
                    h('span', {
                      className: 'status-badge',
                      style: { background: e.status === 'Completed' ? '#28A745' : '#4472C4', color: 'white' }
                    }, e.status)
                  ),
                  h('td', { style: { textAlign: 'center' } },
                    h('button', {
                      className: 'table-btn manage',
                      onClick: () => {
                        setSelectedEngagement(e);
                        setShowTaskManager(true);
                      }
                    }, 'üìã Manage Tasks')
                  )
                );
              })
            )
          )
        ),

        currentView === 'calendar' && h(CalendarView, { 
          engagements, 
          staff, 
          onUpdate,
          onOpenTaskManager: (engagement) => {
            setSelectedEngagement(engagement);
            setShowTaskManager(true);
          }
        }),
        
        currentView === 'gantt' && h(GanttChartView, { engagements, staff }),
        
        currentView === 'utilization' && h(UtilizationView, { engagements, staff }),
        
        currentView === 'adjustments' && h(ApprovalsView, { engagements, staff, onUpdate }),

        showTaskManager && selectedEngagement && h(TaskManagerModal, {
          engagement: selectedEngagement,
          staff: staff,
          allEngagements: engagements,
          onClose: () => {
            setShowTaskManager(false);
            setSelectedEngagement(null);
          },
          onUpdate: (updatedEngagement) => {
            const updated = engagements.map(e => 
              e.id === updatedEngagement.id ? updatedEngagement : e
            );
            onUpdate(updated);
            setShowTaskManager(false);
            setSelectedEngagement(null);
          }
        })
      );
    }

    // Phase 2: Calendar View Component - Live Date-Aware Calendar
    function CalendarView({ engagements, staff, onUpdate, onOpenTaskManager }) {
      const [selectedStaff, setSelectedStaff] = useState(null);
      const [viewPeriod, setViewPeriod] = useState('week'); // week, 2weeks, 3weeks, month, 2months, 3months
      const [startDate, setStartDate] = useState(new Date(2026, 0, 31)); // Jan 31, 2026 (Friday)
      const [showAssignModal, setShowAssignModal] = useState(false);
      const [selectedDay, setSelectedDay] = useState(null);
      const [selectedEngagementForAssign, setSelectedEngagementForAssign] = useState(null);
      const [expandedCells, setExpandedCells] = useState({}); // Track which staff-day-client combinations are expanded
      const [expandAllMode, setExpandAllMode] = useState({}); // Track staff members with "expand all" mode
      const [showTaskEditor, setShowTaskEditor] = useState(false);
      const [selectedTaskForEdit, setSelectedTaskForEdit] = useState(null);
      const [selectedEngagementForEdit, setSelectedEngagementForEdit] = useState(null);

      const activeStaff = staff.filter(s => s.isActive);

      // Open task editor
      const openTaskEditor = (engagement, task) => {
        setSelectedEngagementForEdit(engagement);
        setSelectedTaskForEdit(task);
        setShowTaskEditor(true);
      };

      // Toggle client expansion in a specific day cell
      const toggleClientExpansion = (staffId, dayIndex, clientName) => {
        const key = `${staffId}-${dayIndex}-${clientName}`;
        setExpandedCells(prev => ({
          ...prev,
          [key]: !prev[key]
        }));
      };

      // Toggle expand all mode for a staff member
      const toggleExpandAll = (staffId) => {
        setExpandAllMode(prev => ({
          ...prev,
          [staffId]: !prev[staffId]
        }));
      };

      // Date utility functions
      const getNextMonday = (date) => {
        const d = new Date(date);
        const day = d.getDay();
        const diff = day === 0 ? 1 : day === 6 ? 2 : (8 - day);
        d.setDate(d.getDate() + diff);
        return d;
      };

      const getWorkingDays = (start, numDays) => {
        const days = [];
        const currentDate = new Date(start);
        let count = 0;
        
        while (count < numDays) {
          const dayOfWeek = currentDate.getDay();
          if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Skip weekends
            days.push({
              date: new Date(currentDate),
              dayName: currentDate.toLocaleDateString('en-US', { weekday: 'short' }),
              dayNumber: currentDate.getDate(),
              monthName: currentDate.toLocaleDateString('en-US', { month: 'short' }),
              fullDate: currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
            });
            count++;
          }
          currentDate.setDate(currentDate.getDate() + 1);
        }
        return days;
      };

      // Get working days based on view period
      const getPeriodDays = () => {
        // Start from the selected date directly, not next Monday
        const periods = {
          'week': 5,
          '2weeks': 10,
          '3weeks': 15,
          'month': 20,
          '2months': 40,
          '3months': 60
        };
        return getWorkingDays(startDate, periods[viewPeriod] || 5);
      };

      const workingDays = getPeriodDays();
      const totalDays = workingDays.length;

      // Calculate staff allocation per day
      const getStaffSchedule = (staffMember) => {
        const schedule = workingDays.map(day => ({
          ...day,
          allocated: 0,
          budgetedHours: 0,
          pendingHours: 0,
          approvedExtraHours: 0,
          overtimeHours: 0,
          pendingOvertimeHours: 0,
          tasks: [],
          tasksByClient: {}
        }));

        // Distribute task hours based on date ranges
        engagements.forEach(engagement => {
          (engagement.tasks || []).forEach(task => {
            // Calculate total assigned hours for this task
            const totalAssigned = (task.assignments || []).reduce((sum, a) => sum + (a.hours || 0), 0);
            const budget = task.budgetHours || 0;
            const assignmentOverrun = Math.max(0, totalAssigned - budget);
            const hasOverrun = assignmentOverrun > 0;
            const approvalStatus = task.approvalRequest?.status || null;

            (task.assignments || []).forEach(assignment => {
              if (assignment.staffId === staffMember.id) {
                // SKIP REJECTED OVERTIME TASKS - Don't show hours in calendar
                if (task.overtimeApproval && task.overtimeApproval.status === 'rejected') {
                  return; // Skip this task entirely
                }
                
                const totalHours = assignment.hours || 0;
                
                // Calculate what portion of this assignment is overrun
                const proportionOfOverrun = totalAssigned > 0 ? (assignment.hours / totalAssigned) : 0;
                const assignmentOverrunHours = assignmentOverrun * proportionOfOverrun;
                const assignmentBudgetHours = totalHours - assignmentOverrunHours;
                
                // Check if assignment has date range
                if (assignment.startDate && assignment.endDate) {
                  // Calculate working days in assignment's date range
                  const assignmentStart = new Date(assignment.startDate);
                  const assignmentEnd = new Date(assignment.endDate);
                  
                  // Filter schedule days that fall within assignment date range
                  const daysInRange = schedule.filter(day => {
                    const dayDate = day.date;
                    return dayDate >= assignmentStart && dayDate <= assignmentEnd;
                  });
                  
                  if (daysInRange.length > 0) {
                    const hoursPerDay = totalHours / daysInRange.length;
                    const budgetHoursPerDay = assignmentBudgetHours / daysInRange.length;
                    const overrunHoursPerDay = assignmentOverrunHours / daysInRange.length;
                    
                    daysInRange.forEach(day => {
                      const scheduleDay = schedule.find(d => d.date.getTime() === day.date.getTime());
                      if (scheduleDay) {
                        scheduleDay.allocated += hoursPerDay;
                        scheduleDay.budgetedHours += budgetHoursPerDay;
                        
                        if (hasOverrun) {
                          if (approvalStatus === 'approved') {
                            scheduleDay.approvedExtraHours += overrunHoursPerDay;
                          } else if (approvalStatus === 'pending') {
                            scheduleDay.pendingHours += overrunHoursPerDay;
                          } else {
                            // No approval request yet - treat as pending
                            scheduleDay.pendingHours += overrunHoursPerDay;
                          }
                        }
                        
                        const taskInfo = {
                          taskName: task.name,
                          clientName: engagement.clientName,
                          hours: hoursPerDay,
                          budgetHours: task.budgetHours,
                          totalAssigned: totalAssigned,
                          assignmentOverrun: assignmentOverrun,
                          hasOverrun: hasOverrun,
                          approvalStatus: approvalStatus,
                          stage: task.stage,
                          engagementId: engagement.id,
                          taskId: task.id
                        };
                        
                        scheduleDay.tasks.push(taskInfo);
                        
                        // Group by client
                        if (!scheduleDay.tasksByClient[engagement.clientName]) {
                          scheduleDay.tasksByClient[engagement.clientName] = [];
                        }
                        scheduleDay.tasksByClient[engagement.clientName].push(taskInfo);
                      }
                    });
                  }
                } else {
                  // No date range - distribute evenly across all days (backward compatibility)
                  const hoursPerDay = totalHours / totalDays;
                  const budgetHoursPerDay = assignmentBudgetHours / totalDays;
                  const overrunHoursPerDay = assignmentOverrunHours / totalDays;
                  
                  schedule.forEach((day) => {
                    day.allocated += hoursPerDay;
                    day.budgetedHours += budgetHoursPerDay;
                    
                    if (hasOverrun) {
                      if (approvalStatus === 'approved') {
                        day.approvedExtraHours += overrunHoursPerDay;
                      } else if (approvalStatus === 'pending') {
                        day.pendingHours += overrunHoursPerDay;
                      } else {
                        day.pendingHours += overrunHoursPerDay;
                      }
                    }
                    
                    const taskInfo = {
                      taskName: task.name,
                      clientName: engagement.clientName,
                      hours: hoursPerDay,
                      budgetHours: task.budgetHours,
                      totalAssigned: totalAssigned,
                      assignmentOverrun: assignmentOverrun,
                      hasOverrun: hasOverrun,
                      approvalStatus: approvalStatus,
                      stage: task.stage,
                      engagementId: engagement.id,
                      taskId: task.id
                    };
                    
                    day.tasks.push(taskInfo);
                    
                    // Group by client
                    if (!day.tasksByClient[engagement.clientName]) {
                      day.tasksByClient[engagement.clientName] = [];
                    }
                    day.tasksByClient[engagement.clientName].push(taskInfo);
                  });
                }
              }
            });
          });
        });

        // POST-PROCESSING: Apply 8h cap and calculate overtime
        schedule.forEach(day => {
          if (day.allocated > 8) {
            // Check if ANY task on this day has approved overtime
            const hasApprovedOT = day.tasks.some(t => {
              const task = engagements
                .flatMap(e => e.tasks || [])
                .find(et => et.id === t.taskId);
              return task && task.overtimeApproval && task.overtimeApproval.status === 'approved';
            });
            
            if (hasApprovedOT) {
              // Show overtime separately
              day.overtimeHours = day.allocated - 8;
              // day.allocated stays as full amount
            } else {
              // Cap at 8h, hide overtime
              day.pendingOvertimeHours = day.allocated - 8;
              day.allocated = 8; // Cap display
            }
          }
        });

        return schedule.map(day => ({
          ...day,
          idle: 8 - Math.min(day.allocated, 8),
          utilization: (Math.min(day.allocated, 8) / 8) * 100,
          overallocated: day.allocated > 8,
          clientCount: Object.keys(day.tasksByClient).length
        }));
      };

      // Get monthly overview for next 3 months
      const getMonthlyOverview = () => {
        const months = [];
        const currentDate = new Date(startDate);
        
        for (let i = 0; i < 3; i++) {
          const month = new Date(currentDate);
          month.setMonth(currentDate.getMonth() + i);
          
          const workingDaysInMonth = getWorkingDays(
            new Date(month.getFullYear(), month.getMonth(), 1),
            22 // Approximate working days
          ).length;

          months.push({
            name: month.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
            workingDays: workingDaysInMonth,
            totalHours: workingDaysInMonth * 8
          });
        }
        return months;
      };

      const monthlyOverview = getMonthlyOverview();

      // Get all staff with their schedules
      const staffSchedules = activeStaff.map(s => {
        const schedule = getStaffSchedule(s);
        const totalPeriodHours = schedule.reduce((sum, day) => sum + day.allocated, 0);
        const totalAvailableHours = totalDays * 8;
        const periodIdle = totalAvailableHours - totalPeriodHours;
        
        return {
          ...s,
          schedule,
          totalPeriodHours,
          totalAvailableHours,
          periodIdle,
          periodUtilization: (totalPeriodHours / totalAvailableHours) * 100
        };
      });

      const filteredStaff = selectedStaff 
        ? staffSchedules.filter(s => s.id === selectedStaff) 
        : staffSchedules;

      const getStageColor = (stageId) => {
        const colors = {
          acceptance: '#28A745',
          planning: '#4472C4',
          fieldwork: '#FFC107',
          completion: '#ED7D31',
          lockdown: '#DC3545'
        };
        return colors[stageId] || '#999';
      };

      // Navigation functions
      const goToNextPeriod = () => {
        const newDate = new Date(startDate);
        const daysToAdd = viewPeriod === 'week' ? 7 : viewPeriod === '2weeks' ? 14 : viewPeriod === '3weeks' ? 21 : 30;
        newDate.setDate(newDate.getDate() + daysToAdd);
        setStartDate(newDate);
      };

      const goToPreviousPeriod = () => {
        const newDate = new Date(startDate);
        const daysToSubtract = viewPeriod === 'week' ? 7 : viewPeriod === '2weeks' ? 14 : viewPeriod === '3weeks' ? 21 : 30;
        newDate.setDate(newDate.getDate() - daysToSubtract);
        setStartDate(newDate);
      };

      const goToToday = () => {
        setStartDate(new Date(2026, 0, 31)); // Current date
      };

      return h('div', null,
        // Period Selector and Navigation
        h('div', { className: 'card', style: { marginBottom: '20px' } },
          h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '16px' } },
            // Period buttons
            h('div', { style: { display: 'flex', gap: '8px', flexWrap: 'wrap' } },
              ['week', '2weeks', '3weeks', 'month', '2months', '3months'].map(period => {
                const labels = {
                  week: '1 Week',
                  '2weeks': '2 Weeks',
                  '3weeks': '3 Weeks',
                  month: '1 Month',
                  '2months': '2 Months',
                  '3months': '3 Months'
                };
                return h('button', {
                  key: period,
                  className: 'btn ' + (viewPeriod === period ? 'btn-primary' : 'btn-secondary'),
                  style: { padding: '8px 16px', fontSize: '13px' },
                  onClick: () => setViewPeriod(period)
                }, labels[period]);
              })
            ),

            // Date navigation
            h('div', { style: { display: 'flex', gap: '8px', alignItems: 'center' } },
              h('button', {
                className: 'btn btn-secondary',
                style: { padding: '8px 12px' },
                onClick: goToPreviousPeriod
              }, '‚óÄ'),
              h('button', {
                className: 'btn btn-secondary',
                style: { padding: '8px 16px' },
                onClick: goToToday
              }, 'Today'),
              h('button', {
                className: 'btn btn-secondary',
                style: { padding: '8px 12px' },
                onClick: goToNextPeriod
              }, '‚ñ∂'),
              h('div', { style: { fontSize: '14px', fontWeight: '600', marginLeft: '12px' } },
                workingDays.length > 0 ? workingDays[0].fullDate + ' - ' + workingDays[workingDays.length - 1].fullDate : ''
              )
            )
          )
        ),

        // Monthly Overview (for longer periods)
        (viewPeriod === '2months' || viewPeriod === '3months') && h('div', { className: 'card', style: { marginBottom: '20px' } },
          h('h3', { style: { marginBottom: '16px', fontSize: '16px', fontWeight: '600' } }, 'üìÖ Monthly Overview'),
          h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px' } },
            monthlyOverview.map((month, idx) => 
              h('div', {
                key: idx,
                style: {
                  background: 'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)',
                  padding: '16px',
                  borderRadius: '8px',
                  border: '2px solid #4472C4'
                }
              },
                h('div', { style: { fontSize: '14px', fontWeight: '700', color: '#1F4E78', marginBottom: '8px' } }, month.name),
                h('div', { style: { fontSize: '12px', color: '#666' } }, `${month.workingDays} working days`),
                h('div', { style: { fontSize: '20px', fontWeight: '700', color: '#4472C4', marginTop: '8px' } }, 
                  `${month.totalHours}h available`
                )
              )
            )
          )
        ),

        // Staff Filter
        h('div', { className: 'card', style: { marginBottom: '20px' } },
          h('div', { style: { display: 'flex', alignItems: 'center', gap: '16px', flexWrap: 'wrap' } },
            h('label', { style: { fontWeight: '600', fontSize: '14px' } }, 'Filter by Staff:'),
            h('select', {
              className: 'form-input',
              style: { width: '300px' },
              value: selectedStaff || '',
              onChange: (e) => setSelectedStaff(e.target.value ? parseInt(e.target.value) : null)
            },
              h('option', { value: '' }, `üîç All Staff (${activeStaff.length})`),
              activeStaff.map(s => h('option', { key: s.id, value: s.id }, s.name))
            ),
            selectedStaff && h('button', {
              className: 'btn btn-secondary',
              style: { padding: '8px 16px' },
              onClick: () => setSelectedStaff(null)
            }, 'Clear Filter')
          )
        ),

        // Staff Calendars
        filteredStaff.map(staffMember => {
          const hasIdleTime = staffMember.periodIdle > 0;
          const isOverallocated = staffMember.totalPeriodHours > staffMember.totalAvailableHours;

          return h('div', { 
            key: staffMember.id,
            className: 'card',
            style: { 
              marginBottom: '24px', 
              border: hasIdleTime ? '3px solid #DC3545' : isOverallocated ? '3px solid #FFC107' : '2px solid #E0E0E0' 
            }
          },
            // Staff Header
            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px' } },
              h('div', null,
                h('h3', { style: { fontSize: '18px', fontWeight: '700', marginBottom: '4px' } }, staffMember.name),
                h('div', { style: { fontSize: '13px', color: '#666' } }, 
                  staffMember.position + ' ‚Ä¢ ' + staffMember.level
                )
              ),
              h('div', { style: { display: 'flex', alignItems: 'center', gap: '12px' } },
                h('button', {
                  className: 'btn btn-secondary',
                  style: { padding: '6px 12px', fontSize: '12px' },
                  onClick: () => toggleExpandAll(staffMember.id)
                }, expandAllMode[staffMember.id] ? 'üìã Group by Client' : 'üìÇ Expand All'),
                h('div', { style: { textAlign: 'right' } },
                  h('div', { style: { fontSize: '24px', fontWeight: '700', color: isOverallocated ? '#FFC107' : hasIdleTime ? '#DC3545' : '#28A745' } }, 
                    staffMember.totalPeriodHours.toFixed(0) + 'h / ' + staffMember.totalAvailableHours + 'h'
                  ),
                  h('div', { style: { fontSize: '12px', color: '#666', marginTop: '4px' } }, 
                    hasIdleTime 
                      ? `‚ö†Ô∏è ${staffMember.periodIdle.toFixed(0)}h idle (${staffMember.periodUtilization.toFixed(0)}% utilized)` 
                      : isOverallocated 
                      ? `‚ö†Ô∏è ${(staffMember.totalPeriodHours - staffMember.totalAvailableHours).toFixed(0)}h overallocated`
                      : `‚úì ${staffMember.periodUtilization.toFixed(0)}% utilized`
                  )
                )
              )
            ),

            // Calendar Grid
            h('div', { style: { overflowX: 'auto' } },
              h('table', { style: { width: '100%', borderCollapse: 'separate', borderSpacing: '4px', fontSize: viewPeriod.includes('month') ? '11px' : '12px' } },
                h('thead', null,
                  h('tr', null,
                    staffMember.schedule.map((day, idx) =>
                      h('th', { 
                        key: idx,
                        style: { 
                          padding: viewPeriod.includes('month') ? '6px 4px' : '10px 8px',
                          background: '#1F4E78',
                          color: 'white',
                          fontWeight: '600',
                          fontSize: viewPeriod.includes('month') ? '10px' : '11px',
                          borderRadius: '6px 6px 0 0',
                          textAlign: 'center',
                          minWidth: viewPeriod.includes('month') ? '60px' : '120px'
                        }
                      }, 
                        h('div', null, day.dayName),
                        h('div', { style: { fontSize: '10px', opacity: 0.8, marginTop: '2px' } }, 
                          day.monthName + ' ' + day.dayNumber
                        )
                      )
                    )
                  )
                ),
                h('tbody', null,
                  h('tr', null,
                    staffMember.schedule.map((dayData, idx) => {
                      const hasIdle = dayData.idle > 0;
                      const isOver = dayData.overallocated;
                      
                      return h('td', {
                        key: idx,
                        style: {
                          padding: viewPeriod.includes('month') ? '6px 4px' : '12px 8px',
                          background: hasIdle ? '#FFEBEE' : isOver ? '#FFF3E0' : '#E8F5E9',
                          border: hasIdle ? '2px solid #DC3545' : isOver ? '2px solid #FFC107' : '2px solid #E0E0E0',
                          borderRadius: '0 0 6px 6px',
                          verticalAlign: 'top',
                          cursor: hasIdle ? 'pointer' : 'default'
                        },
                        onClick: hasIdle ? () => {
                          setSelectedDay({ staff: staffMember, day: dayData.fullDate, dayData });
                          setShowAssignModal(true);
                        } : undefined
                      },
                        // Hours summary - SEPARATED BY TYPE
                        h('div', { style: { marginBottom: '8px', textAlign: 'center' } },
                          // Total allocated hours
                          h('div', { style: { fontWeight: '700', fontSize: viewPeriod.includes('month') ? '11px' : '16px', marginBottom: '4px' } },
                            h('span', { style: { color: hasIdle ? '#DC3545' : isOver ? '#FFC107' : '#28A745' } },
                              dayData.allocated.toFixed(1) + 'h / 8h'
                            ),
                            // Show overtime badge if approved
                            dayData.overtimeHours > 0 && h('span', {
                              style: {
                                marginLeft: '6px',
                                fontSize: '12px',
                                color: '#1976D2',
                                fontWeight: '600'
                              }
                            }, '+' + dayData.overtimeHours.toFixed(1) + 'h OT‚úì')
                          ),
                          
                          // Hour breakdown (only for week view if there are different types)
                          !viewPeriod.includes('month') && (dayData.pendingHours > 0 || dayData.approvedExtraHours > 0 || dayData.overtimeHours > 0) && h('div', {
                            style: {
                              fontSize: '9px',
                              display: 'flex',
                              gap: '4px',
                              justifyContent: 'center',
                              flexWrap: 'wrap'
                            }
                          },
                            dayData.budgetedHours > 0 && h('div', {
                              style: {
                                background: '#E8F5E9',
                                color: '#2E7D32',
                                padding: '2px 6px',
                                borderRadius: '4px',
                                fontWeight: '600'
                              }
                            }, dayData.budgetedHours.toFixed(1) + 'h'),
                            
                            dayData.pendingHours > 0 && h('div', {
                              style: {
                                background: '#FFF3E0',
                                color: '#F57C00',
                                padding: '2px 6px',
                                borderRadius: '4px',
                                fontWeight: '600'
                              }
                            }, dayData.pendingHours.toFixed(1) + 'h ‚è≥'),
                            
                            dayData.approvedExtraHours > 0 && h('div', {
                              style: {
                                background: '#E3F2FD',
                                color: '#1976D2',
                                padding: '2px 6px',
                                borderRadius: '4px',
                                fontWeight: '600'
                              }
                            }, dayData.approvedExtraHours.toFixed(1) + 'h ‚úì'),
                            
                            dayData.overtimeHours > 0 && h('div', {
                              style: {
                                background: '#E8EAF6',
                                color: '#3F51B5',
                                padding: '2px 6px',
                                borderRadius: '4px',
                                fontWeight: '600',
                                border: '1px solid #3F51B5'
                              }
                            }, '+' + dayData.overtimeHours.toFixed(1) + 'h OT‚úì')
                          ),
                          
                          // Show pending overtime note
                          !viewPeriod.includes('month') && dayData.pendingOvertimeHours > 0 && h('div', {
                            style: {
                              fontSize: '9px',
                              color: '#F57C00',
                              marginTop: '4px',
                              fontStyle: 'italic'
                            }
                          }, dayData.pendingOvertimeHours.toFixed(1) + 'h OT pending approval')
                        ),

                        // Idle warning (only for week/2week view)
                        !viewPeriod.includes('month') && hasIdle && h('div', {
                          style: {
                            background: '#DC3545',
                            color: 'white',
                            padding: '4px 6px',
                            borderRadius: '4px',
                            fontSize: '10px',
                            fontWeight: '600',
                            marginBottom: '6px',
                            textAlign: 'center'
                          }
                        }, `${dayData.idle.toFixed(1)}h IDLE`),

                        // Task rendering - Grouped by Client or Expanded All
                        viewPeriod.includes('month') ? 
                          // Condensed view for month
                          dayData.tasks.length > 0 && h('div', { style: { fontSize: '9px', color: '#666', textAlign: 'center' } },
                            dayData.clientCount + ' client' + (dayData.clientCount > 1 ? 's' : '') + ', ' + 
                            dayData.tasks.length + ' task' + (dayData.tasks.length > 1 ? 's' : '')
                          )
                        :
                          // Detailed view for week - WITH CLIENT GROUPING
                          expandAllMode[staffMember.id] ?
                            // EXPAND ALL MODE - Show all tasks individually
                            h('div', { style: { fontSize: '10px' } },
                              dayData.tasks.map((task, tidx) => {
                                // Find the actual engagement and task objects for editing
                                const engagement = engagements.find(e => e.id === task.engagementId);
                                const fullTask = engagement?.tasks?.find(t => t.id === task.taskId);
                                
                                return h('div', {
                                  key: tidx,
                                  style: {
                                    background: task.hasOverrun ? '#FFEBEE' : 'white',
                                    padding: '4px 6px',
                                    borderRadius: '4px',
                                    marginBottom: '4px',
                                    borderLeft: `3px solid ${getStageColor(task.stage)}`,
                                    border: task.hasOverrun ? '1px solid #DC3545' : '1px solid #F0F0F0',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s'
                                  },
                                  onClick: (e) => {
                                    e.stopPropagation();
                                    if (engagement && fullTask) {
                                      openTaskEditor(engagement, fullTask);
                                    }
                                  },
                                  onMouseEnter: (e) => {
                                    e.currentTarget.style.background = task.hasOverrun ? '#FFD6D6' : '#F0F7FF';
                                    e.currentTarget.style.transform = 'scale(1.02)';
                                  },
                                  onMouseLeave: (e) => {
                                    e.currentTarget.style.background = task.hasOverrun ? '#FFEBEE' : 'white';
                                    e.currentTarget.style.transform = 'scale(1)';
                                  }
                                },
                                  h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'start', gap: '4px' } },
                                    h('div', { style: { flex: 1 } },
                                      h('div', { style: { fontWeight: '600', fontSize: '10px', color: '#333' } }, task.clientName),
                                      h('div', { style: { fontSize: '9px', color: '#666', marginTop: '2px' } }, 
                                        task.taskName.substring(0, 20) + (task.taskName.length > 20 ? '...' : '')
                                      )
                                    ),
                                    h('div', { style: { textAlign: 'right' } },
                                      h('div', { style: { fontSize: '10px', fontWeight: '600', color: task.hasOverrun ? '#DC3545' : '#666' } }, 
                                        task.hours.toFixed(1) + 'h'
                                      ),
                                      task.hasOverrun && h('div', { style: { fontSize: '8px', color: '#DC3545' } }, '‚ö†Ô∏è'),
                                      h('div', { style: { fontSize: '9px', color: '#999' } }, '‚úèÔ∏è')
                                    )
                                  )
                                );
                              })
                            )
                          :
                            // GROUPED MODE - Group by client
                            h('div', { style: { fontSize: '10px' } },
                              Object.entries(dayData.tasksByClient).map(([clientName, clientTasks]) => {
                                const totalClientHours = clientTasks.reduce((sum, t) => sum + t.hours, 0);
                                const hasOverrunTasks = clientTasks.some(t => t.hasOverrun);
                                const cellKey = `${staffMember.id}-${idx}-${clientName}`;
                                const isExpanded = expandedCells[cellKey];

                                return h('div', {
                                  key: clientName,
                                  style: {
                                    marginBottom: '4px'
                                  }
                                },
                                  // Client header (collapsible)
                                  h('div', {
                                    style: {
                                      background: hasOverrunTasks ? 'linear-gradient(135deg, #FFEBEE 0%, #FFE8E8 100%)' : 'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)',
                                      padding: '6px 8px',
                                      borderRadius: '4px',
                                      cursor: 'pointer',
                                      border: hasOverrunTasks ? '1px solid #DC3545' : '1px solid #4472C4',
                                      display: 'flex',
                                      justifyContent: 'space-between',
                                      alignItems: 'center',
                                      transition: 'all 0.2s'
                                    },
                                    onClick: (e) => {
                                      e.stopPropagation();
                                      toggleClientExpansion(staffMember.id, idx, clientName);
                                    }
                                  },
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: '4px', flex: 1 } },
                                      h('span', { style: { fontSize: '10px' } }, isExpanded ? '‚ñº' : '‚ñ∂'),
                                      h('div', null,
                                        h('div', { style: { fontWeight: '700', fontSize: '10px', color: hasOverrunTasks ? '#DC3545' : '#1976D2' } }, 
                                          clientName
                                        ),
                                        h('div', { style: { fontSize: '8px', color: '#666', marginTop: '2px' } }, 
                                          clientTasks.length + ' task' + (clientTasks.length > 1 ? 's' : '')
                                        )
                                      )
                                    ),
                                    h('div', { style: { fontSize: '10px', fontWeight: '700', color: hasOverrunTasks ? '#DC3545' : '#1976D2' } },
                                      totalClientHours.toFixed(1) + 'h',
                                      hasOverrunTasks && h('span', { style: { marginLeft: '4px' } }, '‚ö†Ô∏è')
                                    )
                                  ),

                                  // Expanded tasks
                                  isExpanded && h('div', { 
                                    style: { 
                                      marginTop: '4px',
                                      paddingLeft: '12px',
                                      borderLeft: '2px solid #E0E0E0'
                                    } 
                                  },
                                    clientTasks.map((task, tidx) => {
                                      // Find the actual engagement and task objects for editing
                                      const engagement = engagements.find(e => e.id === task.engagementId);
                                      const fullTask = engagement?.tasks?.find(t => t.id === task.taskId);
                                      
                                      return h('div', {
                                        key: tidx,
                                        style: {
                                          background: task.hasOverrun ? '#FFEBEE' : 'white',
                                          padding: '4px 6px',
                                          borderRadius: '3px',
                                          marginBottom: '3px',
                                          borderLeft: `2px solid ${getStageColor(task.stage)}`,
                                          border: task.hasOverrun ? '1px solid #DC3545' : '1px solid #F0F0F0',
                                          cursor: 'pointer',
                                          transition: 'all 0.2s'
                                        },
                                        onClick: (e) => {
                                          e.stopPropagation();
                                          if (engagement && fullTask) {
                                            openTaskEditor(engagement, fullTask);
                                          }
                                        },
                                        onMouseEnter: (e) => {
                                          e.currentTarget.style.background = task.hasOverrun ? '#FFD6D6' : '#F0F7FF';
                                          e.currentTarget.style.transform = 'scale(1.02)';
                                        },
                                        onMouseLeave: (e) => {
                                          e.currentTarget.style.background = task.hasOverrun ? '#FFEBEE' : 'white';
                                          e.currentTarget.style.transform = 'scale(1)';
                                        }
                                      },
                                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                                          h('div', { style: { fontSize: '9px', color: '#666', flex: 1 } }, 
                                            task.taskName.substring(0, 15) + (task.taskName.length > 15 ? '...' : '')
                                          ),
                                          h('div', { style: { display: 'flex', alignItems: 'center', gap: '4px' } },
                                            h('span', { style: { fontSize: '9px', fontWeight: '600', color: task.hasOverrun ? '#DC3545' : '#666' } }, 
                                              task.hours.toFixed(1) + 'h'
                                            ),
                                            task.hasOverrun && h('span', { style: { fontSize: '8px', color: '#DC3545' } }, '‚ö†Ô∏è'),
                                            h('span', { style: { fontSize: '9px', color: '#999', marginLeft: '2px' } }, '‚úèÔ∏è')
                                          )
                                        )
                                      );
                                    })
                                  )
                                );
                              })
                            ),

                        // Click prompt for idle
                        hasIdle && !viewPeriod.includes('month') && h('div', {
                          style: {
                            marginTop: '6px',
                            padding: '4px',
                            background: 'white',
                            borderRadius: '3px',
                            textAlign: 'center',
                            fontSize: '9px',
                            color: '#DC3545',
                            fontWeight: '600',
                            border: '1px dashed #DC3545'
                          }
                        }, 'üñ±Ô∏è Click')
                      );
                    })
                  )
                )
              )
            )
          );
        }),

        // No staff message
        filteredStaff.length === 0 && h('div', { className: 'card' },
          h('div', { className: 'empty-state' },
            h('div', { className: 'empty-state-icon' }, 'üë•'),
            h('p', null, 'No staff members found')
          )
        ),

        // Assign Work Modal
        showAssignModal && selectedDay && h('div', { className: 'modal', onClick: () => setShowAssignModal(false) },
          h('div', { 
            className: 'modal-content', 
            style: { maxWidth: '600px' },
            onClick: (e) => e.stopPropagation() 
          },
            h('div', { className: 'modal-header' },
              h('h2', { className: 'modal-title' }, 'Assign Work to Staff'),
              h('button', { className: 'close-btn', onClick: () => setShowAssignModal(false) }, '√ó')
            ),
            h('div', { className: 'modal-body' },
              h('div', { style: { background: '#E3F2FD', padding: '16px', borderRadius: '8px', marginBottom: '20px', border: '2px solid #4472C4' } },
                h('div', { style: { fontSize: '15px', fontWeight: '600', marginBottom: '8px', color: '#1F4E78' } },
                  `üìÖ ${selectedDay.staff.name} - ${selectedDay.day}`
                ),
                h('div', { style: { fontSize: '13px', color: '#666' } },
                  '‚ö†Ô∏è Available idle time: ' + selectedDay.dayData.idle.toFixed(1) + ' hours'
                )
              ),
              
              h('div', { style: { marginBottom: '20px' } },
                h('label', { className: 'form-label' }, 'Select Engagement to Assign Tasks:'),
                h('select', {
                  className: 'form-input',
                  value: selectedEngagementForAssign || '',
                  onChange: (e) => setSelectedEngagementForAssign(parseInt(e.target.value))
                },
                  h('option', { value: '' }, '-- Select an engagement --'),
                  engagements.map(e => 
                    h('option', { key: e.id, value: e.id }, 
                      `${e.clientName} (${(e.tasks || []).length} tasks, ${e.status})`
                    )
                  )
                )
              ),

              selectedEngagementForAssign && h('div', { 
                style: { background: '#F8F9FA', padding: '12px', borderRadius: '6px', marginBottom: '16px', fontSize: '13px' } 
              },
                h('strong', null, 'Next step: '),
                'The Task Manager will open where you can assign tasks to ' + selectedDay.staff.name
              ),

              h('button', {
                className: 'btn btn-primary',
                style: { width: '100%' },
                disabled: !selectedEngagementForAssign,
                onClick: () => {
                  if (selectedEngagementForAssign && onOpenTaskManager) {
                    const engagement = engagements.find(e => e.id === selectedEngagementForAssign);
                    setShowAssignModal(false);
                    setSelectedEngagementForAssign(null);
                    onOpenTaskManager(engagement);
                  }
                }
              }, 'üìã Open Task Manager' + (selectedEngagementForAssign ? '' : ' (Select engagement first)'))
            )
          )
        ),

        // Task Editor Modal
        showTaskEditor && selectedEngagementForEdit && selectedTaskForEdit && h(TaskManagerModal, {
          engagement: selectedEngagementForEdit,
          staff: staff,
          allEngagements: engagements,
          onClose: () => {
            setShowTaskEditor(false);
            setSelectedEngagementForEdit(null);
            setSelectedTaskForEdit(null);
          },
          onUpdate: (updatedEngagement) => {
            const updatedEngagements = engagements.map(e => 
              e.id === updatedEngagement.id ? updatedEngagement : e
            );
            onUpdate(updatedEngagements);
            setShowTaskEditor(false);
            setSelectedEngagementForEdit(null);
            setSelectedTaskForEdit(null);
          }
        })
      );
    }

    // Phase 3: Gantt Chart View Component
    function GanttChartView({ engagements, staff }) {
      const [selectedEngagement, setSelectedEngagement] = useState(null);
      const [timeScale, setTimeScale] = useState('week'); // week, month, quarter
      
      // Get all tasks with dates for timeline
      const allTasks = engagements.flatMap(e => 
        (e.tasks || []).map(t => ({
          ...t,
          clientName: e.clientName,
          engagementId: e.id,
          startDate: e.auditStartDate || '2026-02-03',
          endDate: e.completionDate || '2026-03-15'
        }))
      );

      // Group tasks by engagement
      const engagementsWithTasks = engagements.map(e => ({
        ...e,
        tasks: allTasks.filter(t => t.engagementId === e.id)
      })).filter(e => e.tasks.length > 0);

      // Calculate timeline based on all dates
      const allDates = allTasks.flatMap(t => [new Date(t.startDate), new Date(t.endDate)]);
      const minDate = allDates.length > 0 ? new Date(Math.min(...allDates)) : new Date();
      const maxDate = allDates.length > 0 ? new Date(Math.max(...allDates)) : new Date();
      
      // Generate timeline markers
      const getTimelineMarkers = () => {
        const markers = [];
        const current = new Date(minDate);
        current.setDate(1); // Start of month
        
        while (current <= maxDate) {
          markers.push({
            date: new Date(current),
            label: current.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
          });
          current.setMonth(current.getMonth() + 1);
        }
        return markers;
      };

      const timelineMarkers = getTimelineMarkers();
      const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) || 30;

      // Calculate position and width for task bar
      const getTaskBarStyle = (task) => {
        const taskStart = new Date(task.startDate);
        const taskEnd = new Date(task.endDate);
        const startOffset = Math.ceil((taskStart - minDate) / (1000 * 60 * 60 * 24));
        const duration = Math.ceil((taskEnd - taskStart) / (1000 * 60 * 60 * 24)) || 1;
        
        const leftPercent = (startOffset / totalDays) * 100;
        const widthPercent = (duration / totalDays) * 100;

        return {
          left: `${leftPercent}%`,
          width: `${Math.max(widthPercent, 2)}%`
        };
      };

      const getStageColor = (stageId) => {
        const colors = {
          acceptance: '#28A745',
          planning: '#4472C4',
          fieldwork: '#FFC107',
          completion: '#ED7D31',
          lockdown: '#DC3545'
        };
        return colors[stageId] || '#999';
      };

      const getProgressColor = (status) => {
        if (status === 'Completed') return '#28A745';
        if (status === 'In Progress') return '#4472C4';
        return '#999';
      };

      return h('div', null,
        // Header with controls
        h('div', { className: 'card', style: { marginBottom: '20px' } },
          h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '16px' } },
            h('div', null,
              h('h3', { style: { fontSize: '20px', fontWeight: '700', marginBottom: '4px' } }, 'üìä Gantt Chart Timeline'),
              h('p', { style: { fontSize: '13px', color: '#666' } }, 
                `Showing ${engagementsWithTasks.length} engagements with ${allTasks.length} tasks`
              )
            ),
            h('div', { style: { display: 'flex', gap: '8px' } },
              ['week', 'month', 'quarter'].map(scale => 
                h('button', {
                  key: scale,
                  className: 'btn ' + (timeScale === scale ? 'btn-primary' : 'btn-secondary'),
                  style: { padding: '8px 16px', fontSize: '13px', textTransform: 'capitalize' },
                  onClick: () => setTimeScale(scale)
                }, scale)
              )
            )
          )
        ),

        // Instructions
        h('div', { 
          style: { 
            background: 'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)',
            border: '2px solid #4472C4',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px'
          }
        },
          h('div', { style: { fontSize: '16px', fontWeight: '700', color: '#1F4E78', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' } },
            h('span', { style: { fontSize: '24px' } }, 'üí°'),
            'How to Use the Gantt Chart'
          ),
          h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '16px' } },
            h('div', null,
              h('div', { style: { fontSize: '14px', fontWeight: '600', color: '#1F4E78', marginBottom: '6px' } }, 'üìÖ Timeline Bars'),
              h('div', { style: { fontSize: '13px', color: '#666' } }, 
                'Horizontal bars show the duration of each engagement and task. Longer bars = longer duration.'
              )
            ),
            h('div', null,
              h('div', { style: { fontSize: '14px', fontWeight: '600', color: '#1F4E78', marginBottom: '6px' } }, 'üé® Color Coding'),
              h('div', { style: { fontSize: '13px', color: '#666' } }, 
                'Tasks are colored by audit stage: Green (Acceptance), Blue (Planning), Yellow (Fieldwork), Orange (Completion), Red (Lockdown).'
              )
            ),
            h('div', null,
              h('div', { style: { fontSize: '14px', fontWeight: '600', color: '#1F4E78', marginBottom: '6px' } }, '‚ñ∂ Click to Expand'),
              h('div', { style: { fontSize: '13px', color: '#666' } }, 
                'Click on any engagement row (‚ñ∂) to expand and see all individual tasks underneath with their timelines.'
              )
            ),
            h('div', null,
              h('div', { style: { fontSize: '14px', fontWeight: '600', color: '#1F4E78', marginBottom: '6px' } }, 'üìä Timeline View'),
              h('div', { style: { fontSize: '13px', color: '#666' } }, 
                'The chart shows from earliest start date to latest end date across all your engagements.'
              )
            )
          )
        ),

        // Legend
        h('div', { className: 'card', style: { marginBottom: '20px' } },
          h('div', { style: { display: 'flex', gap: '24px', flexWrap: 'wrap', alignItems: 'center' } },
            h('div', { style: { fontSize: '14px', fontWeight: '600' } }, 'Stages:'),
            AUDIT_STAGES.map(stage => 
              h('div', { key: stage.id, style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                h('div', { style: { width: '20px', height: '20px', borderRadius: '4px', background: getStageColor(stage.id) } }),
                h('span', { style: { fontSize: '13px' } }, stage.name)
              )
            )
          )
        ),

        // Gantt Chart
        h('div', { className: 'card' },
          h('div', { style: { overflowX: 'auto' } },
            h('div', { style: { minWidth: '800px' } },
              // Timeline header
              h('div', { style: { display: 'flex', borderBottom: '2px solid #1F4E78', marginBottom: '16px', paddingBottom: '8px' } },
                h('div', { style: { width: '250px', flexShrink: 0, fontWeight: '700', fontSize: '14px', color: '#1F4E78' } }, 
                  'Engagement / Task'
                ),
                h('div', { style: { flex: 1, display: 'flex', justifyContent: 'space-between', paddingLeft: '8px' } },
                  timelineMarkers.map((marker, idx) =>
                    h('div', { key: idx, style: { fontSize: '12px', fontWeight: '600', color: '#666' } }, 
                      marker.label
                    )
                  )
                )
              ),

              // Engagements and tasks
              engagementsWithTasks.length === 0 ?
                h('div', { className: 'empty-state' },
                  h('div', { className: 'empty-state-icon' }, 'üìä'),
                  h('p', null, 'No tasks to display in Gantt chart')
                ) :
                engagementsWithTasks.map(engagement => {
                  const isExpanded = selectedEngagement === engagement.id;
                  
                  return h('div', { 
                    key: engagement.id,
                    style: { marginBottom: '24px' }
                  },
                    // Engagement row
                    h('div', { 
                      style: { 
                        display: 'flex', 
                        alignItems: 'center',
                        padding: '12px 0',
                        cursor: 'pointer',
                        borderRadius: '8px',
                        background: isExpanded ? '#F8F9FA' : 'transparent'
                      },
                      onClick: () => setSelectedEngagement(isExpanded ? null : engagement.id)
                    },
                      h('div', { style: { width: '250px', flexShrink: 0 } },
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                          h('span', { style: { fontSize: '16px' } }, isExpanded ? '‚ñº' : '‚ñ∂'),
                          h('div', null,
                            h('div', { style: { fontWeight: '700', fontSize: '14px' } }, engagement.clientName),
                            h('div', { style: { fontSize: '11px', color: '#666' } }, 
                              `${engagement.tasks.length} tasks`
                            )
                          )
                        )
                      ),
                      h('div', { style: { flex: 1, position: 'relative', height: '30px', paddingLeft: '8px' } },
                        // Engagement timeline bar
                        h('div', {
                          style: {
                            position: 'absolute',
                            ...getTaskBarStyle({ startDate: engagement.auditStartDate, endDate: engagement.completionDate }),
                            height: '24px',
                            background: getProgressColor(engagement.status),
                            borderRadius: '4px',
                            border: '2px solid white',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '11px',
                            fontWeight: '600',
                            boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                          }
                        }, engagement.status)
                      )
                    ),

                    // Tasks (when expanded)
                    isExpanded && engagement.tasks.map(task => 
                      h('div', { 
                        key: task.id,
                        style: { 
                          display: 'flex', 
                          alignItems: 'center',
                          padding: '8px 0 8px 40px',
                          borderLeft: '2px solid #E0E0E0',
                          marginLeft: '20px'
                        }
                      },
                        h('div', { style: { width: '210px', flexShrink: 0 } },
                          h('div', { style: { fontSize: '13px', fontWeight: '600' } }, task.name),
                          h('div', { style: { fontSize: '11px', color: '#666' } }, 
                            `${task.budgetHours}h budgeted`
                          )
                        ),
                        h('div', { style: { flex: 1, position: 'relative', height: '24px', paddingLeft: '8px' } },
                          // Task bar
                          h('div', {
                            style: {
                              position: 'absolute',
                              ...getTaskBarStyle(task),
                              height: '18px',
                              background: getStageColor(task.stage),
                              borderRadius: '3px',
                              border: '1px solid white',
                              display: 'flex',
                              alignItems: 'center',
                              paddingLeft: '6px',
                              color: 'white',
                              fontSize: '10px',
                              fontWeight: '600',
                              boxShadow: '0 1px 3px rgba(0,0,0,0.15)'
                            }
                          }, 
                            h('span', { style: { whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' } },
                              AUDIT_STAGES.find(s => s.id === task.stage)?.name
                            )
                          )
                        )
                      )
                    )
                  );
                })
            )
          )
        )
      );
    }

    // Phase 2: Utilization View Component - Focus on Idle Time
    function UtilizationView({ engagements, staff }) {
      const activeStaff = staff.filter(s => s.isActive);
      
      const staffWithWorkload = activeStaff.map(s => {
        const taskAssignments = [];
        let totalBudgetHours = 0;
        
        engagements.forEach(e => {
          (e.tasks || []).forEach(task => {
            (task.assignments || []).forEach(assignment => {
              if (assignment.staffId === s.id) {
                taskAssignments.push({
                  engagementId: e.id,
                  clientName: e.clientName,
                  taskName: task.name,
                  stage: task.stage,
                  hours: assignment.hours || 0,
                  taskStatus: task.status
                });
                totalBudgetHours += assignment.hours || 0;
              }
            });
          });
        });

        const availableHours = 160;
        const utilization = (totalBudgetHours / availableHours) * 100;
        const idleHours = availableHours - totalBudgetHours;
        const hasIdleTime = idleHours > 0;

        return {
          ...s,
          taskAssignments,
          totalBudgetHours,
          availableHours,
          utilization,
          idleHours,
          hasIdleTime,
          engagementCount: new Set(taskAssignments.map(t => t.engagementId)).size
        };
      });

      const totalCapacity = activeStaff.length * 160;
      const totalAllocated = staffWithWorkload.reduce((sum, s) => sum + s.totalBudgetHours, 0);
      const totalIdle = staffWithWorkload.reduce((sum, s) => sum + s.idleHours, 0);
      const staffWithIdle = staffWithWorkload.filter(s => s.hasIdleTime).length;

      return h('div', null,
        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'Total Capacity'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, `${totalCapacity}h`),
            h('div', { className: 'metric-detail' }, `${activeStaff.length} active staff`)
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#28A745' } },
            h('div', { className: 'metric-label' }, 'Total Allocated'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, 
              `${totalAllocated.toFixed(0)}h`
            ),
            h('div', { className: 'metric-detail' }, 'Billable hours assigned')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#DC3545' } },
            h('div', { className: 'metric-label' }, 'üö® Total Idle Time'),
            h('div', { className: 'metric-value', style: { color: '#DC3545' } }, 
              `${totalIdle.toFixed(0)}h`
            ),
            h('div', { className: 'metric-detail' }, `${staffWithIdle} staff with idle time`)
          )
        ),

        // Idle Time Alert
        staffWithIdle > 0 && h('div', {
          style: {
            background: 'linear-gradient(135deg, #FFEBEE 0%, #FFE8B3 100%)',
            border: '2px solid #DC3545',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '24px',
            display: 'flex',
            alignItems: 'start',
            gap: '16px'
          }
        },
          h('div', { style: { fontSize: '48px' } }, '‚ö†Ô∏è'),
          h('div', null,
            h('div', { style: { fontSize: '18px', fontWeight: '700', color: '#DC3545', marginBottom: '8px' } },
              `Alert: ${staffWithIdle} staff member${staffWithIdle > 1 ? 's' : ''} have idle time`
            ),
            h('div', { style: { fontSize: '14px', color: '#666' } },
              'Underutilized staff should be assigned to engagements to maximize billable hours. See the Calendar View to identify available time slots.'
            )
          )
        ),

        h('div', { className: 'card' },
          h('h3', { style: { marginBottom: '20px', fontSize: '18px', fontWeight: '600' } }, 
            'Staff Utilization & Idle Time Overview'
          ),
          h('div', { style: { maxHeight: '600px', overflow: 'auto' } },
            staffWithWorkload
              .sort((a, b) => b.idleHours - a.idleHours) // Sort by idle time (most idle first)
              .map(s => {
                const hasIdle = s.hasIdleTime;
                const isOver = s.utilization > 100;
                const barColor = isOver ? '#FFC107' : hasIdle ? '#DC3545' : '#28A745';
                
                return h('div', {
                  key: s.id,
                  style: {
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '16px',
                    background: hasIdle ? '#FFEBEE' : '#F8F9FA',
                    border: hasIdle ? '2px solid #DC3545' : '1px solid #E0E0E0',
                    borderRadius: '8px',
                    marginBottom: '12px',
                    transition: 'all 0.2s'
                  }
                },
                  // Red flag for idle time
                  hasIdle && h('div', { style: { fontSize: '32px', flexShrink: 0 } }, 'üö®'),
                  
                  h('div', { style: { minWidth: '180px', flexShrink: 0 } },
                    h('div', { style: { fontWeight: '700', fontSize: '14px' } }, s.name),
                    h('div', { style: { fontSize: '12px', color: '#666' } }, s.position)
                  ),
                  
                  h('div', { style: { flex: 1 } },
                    h('div', { style: { height: '32px', background: '#E0E0E0', borderRadius: '16px', overflow: 'hidden', position: 'relative' } },
                      h('div', {
                        style: {
                          height: '100%',
                          width: `${Math.min(s.utilization, 100)}%`,
                          background: barColor,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: 'white',
                          fontSize: '13px',
                          fontWeight: '700',
                          transition: 'width 0.3s'
                        }
                      }, s.utilization > 15 && `${s.utilization.toFixed(0)}%`)
                    )
                  ),
                  
                  h('div', { style: { minWidth: '200px', textAlign: 'right' } },
                    h('div', { style: { fontSize: '16px', fontWeight: '700' } },
                      h('span', { style: { color: hasIdle ? '#DC3545' : '#28A745' } }, 
                        `${s.totalBudgetHours.toFixed(0)}h`
                      ),
                      h('span', { style: { color: '#999', fontSize: '13px' } }, ' / 160h')
                    ),
                    hasIdle && h('div', {
                      style: {
                        fontSize: '13px',
                        fontWeight: '700',
                        color: '#DC3545',
                        marginTop: '4px'
                      }
                    }, `‚ö†Ô∏è ${s.idleHours.toFixed(0)}h IDLE`)
                  ),
                  
                  h('div', { style: { minWidth: '150px', fontSize: '12px', color: '#666', textAlign: 'right' } },
                    h('div', null, `${s.taskAssignments.length} tasks assigned`),
                    h('div', null, `${s.engagementCount} engagements`)
                  )
                );
              })
          )
        )
      );
    }

    // Phase 3: Approvals & Workflow View Component
    function ApprovalsView({ engagements, staff, onUpdate }) {
      const [showApprovalModal, setShowApprovalModal] = useState(false);
      const [selectedRequest, setSelectedRequest] = useState(null);
      const [approvalComment, setApprovalComment] = useState('');
      const [showRequestModal, setShowRequestModal] = useState(false);
      const [requestReason, setRequestReason] = useState('');
      const [selectedTaskForRequest, setSelectedTaskForRequest] = useState(null);

      // Calculate tasks with allocated hours variance AND overtime approvals
      const tasksWithApprovals = engagements.flatMap(e =>
        (e.tasks || []).map(t => {
          // Calculate total allocated hours from assignments
          const totalAllocated = (t.assignments || []).reduce((sum, a) => sum + (a.hours || 0), 0);
          const budget = t.budgetHours || 0;
          const variance = totalAllocated - budget;
          
          return {
            ...t,
            engagementId: e.id,
            clientName: e.clientName,
            allocatedHours: totalAllocated,
            variance: variance,
            approvalRequest: t.approvalRequest || null,
            overtimeApproval: t.overtimeApproval || null
          };
        })
      );

      // Budget overrun requests
      const pendingBudgetRequests = tasksWithApprovals.filter(t => 
        t.approvalRequest && t.approvalRequest.status === 'pending'
      );
      
      // Overtime capacity requests
      const pendingOvertimeRequests = tasksWithApprovals.filter(t =>
        t.overtimeApproval && t.overtimeApproval.status === 'pending'
      );
      
      // Combined pending
      const pendingRequests = [...pendingBudgetRequests, ...pendingOvertimeRequests];
      
      const approvedRequests = tasksWithApprovals.filter(t => 
        (t.approvalRequest && t.approvalRequest.status === 'approved') ||
        (t.overtimeApproval && t.overtimeApproval.status === 'approved')
      );
      
      const rejectedRequests = tasksWithApprovals.filter(t => 
        (t.approvalRequest && t.approvalRequest.status === 'rejected') ||
        (t.overtimeApproval && t.overtimeApproval.status === 'rejected')
      );

      const tasksNeedingApproval = tasksWithApprovals.filter(t => 
        t.variance > 0 && !t.approvalRequest
      );

      const handleApprove = () => {
        if (!selectedRequest) {
          console.error('handleApprove: No selectedRequest');
          return;
        }
        
        console.log('handleApprove called with:', selectedRequest);
        
        const isOvertimeApproval = selectedRequest.overtimeApproval && 
                                    selectedRequest.overtimeApproval.status === 'pending';
        
        console.log('Is overtime approval?', isOvertimeApproval);
        
        try {
          // Update task with approval
          const updatedEngagements = engagements.map(e => {
            console.log('Processing engagement:', e.id, e.clientName);
            return {
              ...e,
              tasks: (e.tasks || []).map(t => {
                if (t.id === selectedRequest.id && e.id === selectedRequest.engagementId) {
                  console.log('Found matching task:', t.id, t.name);
                  const updates = { ...t };
                  
                  if (isOvertimeApproval) {
                    console.log('Updating overtimeApproval');
                    // Safely update or create overtimeApproval
                    updates.overtimeApproval = {
                      ...(t.overtimeApproval || {}),
                      status: 'approved',
                      approvedBy: 'Jonathan Malefho',
                      approvalDate: new Date().toISOString().split('T')[0],
                      comments: approvalComment || 'Approved'
                    };
                    console.log('Updated overtimeApproval:', updates.overtimeApproval);
                  } else {
                    console.log('Updating approvalRequest');
                    // Safely update or create approvalRequest
                    updates.approvalRequest = {
                      ...(t.approvalRequest || {}),
                      status: 'approved',
                      approvedBy: 'Jonathan Malefho',
                      approvalDate: new Date().toISOString().split('T')[0],
                      comments: approvalComment || 'Approved'
                    };
                    console.log('Updated approvalRequest:', updates.approvalRequest);
                  }
                  
                  return updates;
                }
                return t;
              })
            };
          });
          
          console.log('About to call onUpdate with:', updatedEngagements);
          onUpdate(updatedEngagements);
          console.log('onUpdate completed successfully');
          
          setShowApprovalModal(false);
          setApprovalComment('');
          setSelectedRequest(null);
        } catch (error) {
          console.error('Error in handleApprove:', error);
          alert('Error approving request: ' + error.message);
        }
      };

      const handleReject = () => {
        if (!selectedRequest || !approvalComment) {
          alert('Please provide a reason for rejection');
          return;
        }
        
        const isOvertimeApproval = selectedRequest.overtimeApproval && 
                                    selectedRequest.overtimeApproval.status === 'pending';
        
        // Update task with rejection
        const updatedEngagements = engagements.map(e => ({
          ...e,
          tasks: (e.tasks || []).map(t => {
            if (t.id === selectedRequest.id && e.id === selectedRequest.engagementId) {
              const updates = { ...t };
              
              if (isOvertimeApproval) {
                // Safely update or create overtimeApproval
                updates.overtimeApproval = {
                  ...(t.overtimeApproval || {}),
                  status: 'rejected',
                  approvedBy: 'Jonathan Malefho',
                  approvalDate: new Date().toISOString().split('T')[0],
                  comments: approvalComment
                };
              } else {
                // Safely update or create approvalRequest
                updates.approvalRequest = {
                  ...(t.approvalRequest || {}),
                  status: 'rejected',
                  approvedBy: 'Jonathan Malefho',
                  approvalDate: new Date().toISOString().split('T')[0],
                  comments: approvalComment
                };
              }
              
              return updates;
            }
            return t;
          })
        }));
        
        onUpdate(updatedEngagements);
        setShowApprovalModal(false);
        setApprovalComment('');
        setSelectedRequest(null);
      };

      const handleSubmitRequest = () => {
        if (!selectedTaskForRequest || !requestReason) {
          alert('Please provide a reason for the request');
          return;
        }
        
        // Create approval request
        const updatedEngagements = engagements.map(e => ({
          ...e,
          tasks: (e.tasks || []).map(t => {
            if (t.id === selectedTaskForRequest.id && e.id === selectedTaskForRequest.engagementId) {
              return {
                ...t,
                approvalRequest: {
                  id: Date.now(),
                  requestedBy: 'Staff Member',
                  requestDate: new Date().toISOString().split('T')[0],
                  reason: requestReason,
                  additionalHours: t.variance,
                  status: 'pending',
                  approvedBy: null,
                  approvalDate: null,
                  comments: null
                }
              };
            }
            return t;
          })
        }));
        
        onUpdate(updatedEngagements);
        setShowRequestModal(false);
        setRequestReason('');
        setSelectedTaskForRequest(null);
      };

      return h('div', null,
        // Metrics
        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#FFC107' } },
            h('div', { className: 'metric-label' }, '‚è≥ Pending Approvals'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, pendingRequests.length),
            h('div', { className: 'metric-detail' }, 'Awaiting review')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#28A745' } },
            h('div', { className: 'metric-label' }, '‚úÖ Approved'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, approvedRequests.length),
            h('div', { className: 'metric-detail' }, 'Budget adjustments approved')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#DC3545' } },
            h('div', { className: 'metric-label' }, '‚ùå Rejected'),
            h('div', { className: 'metric-value', style: { color: '#DC3545' } }, rejectedRequests.length),
            h('div', { className: 'metric-detail' }, 'Requests declined')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'üìù Need Approval'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, tasksNeedingApproval.length),
            h('div', { className: 'metric-detail' }, 'Tasks over budget')
          )
        ),

        // Pending Requests - Priority Section
        pendingRequests.length > 0 && h('div', { 
          className: 'card', 
          style: { 
            marginBottom: '24px',
            border: '3px solid #FFC107',
            background: 'linear-gradient(135deg, #FFF3E0 0%, #FFFFFF 100%)'
          }
        },
          h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' } },
            h('h3', { style: { fontSize: '18px', fontWeight: '700', color: '#F59E0B' } }, 
              '‚è≥ Pending Approval Requests (' + pendingRequests.length + ')'
            ),
            h('div', { style: { background: '#FFC107', color: 'white', padding: '6px 12px', borderRadius: '12px', fontSize: '12px', fontWeight: '600' } },
              '‚ö° ACTION REQUIRED'
            )
          ),

          h('table', { className: 'task-table-enhanced' },
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', null, 'Task'),
                h('th', { style: { textAlign: 'center' } }, 'Budget'),
                h('th', { style: { textAlign: 'center' } }, 'Allocated'),
                h('th', { style: { textAlign: 'center' } }, 'Variance'),
                h('th', null, 'Reason'),
                h('th', { style: { textAlign: 'center' } }, 'Requested'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              pendingRequests.map((task, idx) => {
                const isOvertimeRequest = task.overtimeApproval && task.overtimeApproval.status === 'pending';
                const request = isOvertimeRequest ? task.overtimeApproval : task.approvalRequest;
                
                return h('tr', { key: idx, style: { background: isOvertimeRequest ? '#FFF3E6' : '#FFF9E6' } },
                  h('td', { style: { fontWeight: '600' } }, task.clientName),
                  h('td', null, 
                    h('div', null,
                      task.name,
                      isOvertimeRequest && h('div', { 
                        style: { 
                          fontSize: '10px', 
                          color: '#FF6B6B', 
                          fontWeight: '700',
                          marginTop: '4px',
                          display: 'inline-block',
                          background: '#FFE5E5',
                          padding: '2px 6px',
                          borderRadius: '4px'
                        } 
                      }, '‚è±Ô∏è OVERTIME APPROVAL')
                    )
                  ),
                  h('td', { style: { textAlign: 'center' } }, task.budgetHours + 'h'),
                  h('td', { style: { textAlign: 'center' } }, task.allocatedHours.toFixed(1) + 'h'),
                  h('td', { style: { textAlign: 'center' } },
                    isOvertimeRequest ?
                      h('span', { style: { color: '#FF6B6B', fontWeight: '700' } }, 
                        'Capacity Exceeded'
                      ) :
                      h('span', { style: { color: '#DC3545', fontWeight: '700' } }, 
                        '+' + task.variance.toFixed(1) + 'h'
                      )
                  ),
                  h('td', { style: { fontSize: '12px', maxWidth: '200px' } }, 
                    request ? request.reason : 'N/A'
                  ),
                  h('td', { style: { textAlign: 'center', fontSize: '11px', color: '#666' } },
                    request ? request.requestDate : 'N/A'
                  ),
                  h('td', { style: { textAlign: 'center' } },
                    h('div', { style: { display: 'flex', gap: '6px', justifyContent: 'center' } },
                      h('button', {
                        className: 'action-btn-enhanced edit',
                        style: { fontSize: '11px', padding: '6px 12px', background: 'linear-gradient(135deg, #28A745 0%, #20c997 100%)', color: 'white' },
                        onClick: () => {
                          setSelectedRequest(task);
                          setShowApprovalModal(true);
                        }
                      }, '‚úì Review')
                    )
                  )
                );
              })
            )
          )
        ),

        // Tasks Needing Approval Request
        tasksNeedingApproval.length > 0 && h('div', { className: 'card', style: { marginBottom: '24px' } },
          h('h3', { style: { fontSize: '18px', fontWeight: '600', marginBottom: '16px' } }, 
            'üìù Tasks Over Budget (Request Approval)'
          ),
          
          h('table', { className: 'task-table-enhanced' },
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', null, 'Task'),
                h('th', { style: { textAlign: 'center' } }, 'Budget'),
                h('th', { style: { textAlign: 'center' } }, 'Allocated'),
                h('th', { style: { textAlign: 'center' } }, 'Variance'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              tasksNeedingApproval.map((task, idx) => 
                h('tr', { key: idx },
                  h('td', { style: { fontWeight: '600' } }, task.clientName),
                  h('td', null, task.name),
                  h('td', { style: { textAlign: 'center' } }, task.budgetHours + 'h'),
                  h('td', { style: { textAlign: 'center' } }, task.allocatedHours.toFixed(1) + 'h'),
                  h('td', { style: { textAlign: 'center' } },
                    h('span', { style: { color: '#DC3545', fontWeight: '700' } }, '+' + task.variance.toFixed(1) + 'h')
                  ),
                  h('td', { style: { textAlign: 'center' } },
                    h('button', {
                      className: 'action-btn-enhanced edit',
                      style: { fontSize: '11px', padding: '6px 12px' },
                      onClick: () => {
                        setSelectedTaskForRequest(task);
                        setShowRequestModal(true);
                      }
                    }, 'üì§ Request Approval')
                  )
                )
              )
            )
          )
        ),

        // Approved Requests History
        approvedRequests.length > 0 && h('div', { className: 'card', style: { marginBottom: '24px' } },
          h('h3', { style: { fontSize: '18px', fontWeight: '600', marginBottom: '16px', color: '#28A745' } }, 
            '‚úÖ Approved Requests (' + approvedRequests.length + ')'
          ),
          
          h('table', { className: 'task-table-enhanced' },
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', null, 'Task'),
                h('th', { style: { textAlign: 'center' } }, 'Variance'),
                h('th', null, 'Approved By'),
                h('th', { style: { textAlign: 'center' } }, 'Date'),
                h('th', null, 'Comments')
              )
            ),
            h('tbody', null,
              approvedRequests.map((task, idx) => {
                // Determine which approval type this is
                const isOvertimeApproval = task.overtimeApproval && task.overtimeApproval.status === 'approved';
                const approval = isOvertimeApproval ? task.overtimeApproval : task.approvalRequest;
                
                return h('tr', { key: idx, style: { background: '#E8F5E9' } },
                  h('td', { style: { fontWeight: '600' } }, task.clientName),
                  h('td', null, 
                    task.name,
                    isOvertimeApproval && h('div', { 
                      style: { 
                        fontSize: '10px', 
                        color: '#FF6B6B', 
                        fontWeight: '700',
                        marginTop: '4px',
                        background: '#FFE5E5',
                        padding: '2px 6px',
                        borderRadius: '3px',
                        display: 'inline-block'
                      } 
                    }, '‚è±Ô∏è OVERTIME')
                  ),
                  h('td', { style: { textAlign: 'center', color: '#28A745', fontWeight: '700' } }, 
                    isOvertimeApproval ? 'Capacity Exceeded' : '+' + task.variance + 'h'
                  ),
                  h('td', null, approval ? approval.approvedBy : '-'),
                  h('td', { style: { textAlign: 'center', fontSize: '11px' } }, 
                    approval ? approval.approvalDate : '-'
                  ),
                  h('td', { style: { fontSize: '12px', color: '#666' } }, 
                    approval ? (approval.comments || '-') : '-'
                  )
                );
              })
            )
          )
        ),

        // Rejected Requests History
        rejectedRequests.length > 0 && h('div', { className: 'card', style: { marginBottom: '24px' } },
          h('h3', { style: { fontSize: '18px', fontWeight: '600', marginBottom: '16px', color: '#DC3545' } }, 
            '‚ùå Rejected Requests (' + rejectedRequests.length + ')'
          ),
          
          h('table', { className: 'task-table-enhanced' },
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', null, 'Task'),
                h('th', { style: { textAlign: 'center' } }, 'Variance'),
                h('th', null, 'Rejected By'),
                h('th', { style: { textAlign: 'center' } }, 'Date'),
                h('th', null, 'Comments')
              )
            ),
            h('tbody', null,
              rejectedRequests.map((task, idx) => {
                // Determine which approval type this is
                const isOvertimeApproval = task.overtimeApproval && task.overtimeApproval.status === 'rejected';
                const approval = isOvertimeApproval ? task.overtimeApproval : task.approvalRequest;
                
                return h('tr', { key: idx, style: { background: '#FFEBEE' } },
                  h('td', { style: { fontWeight: '600' } }, task.clientName),
                  h('td', null, 
                    h('span', { style: { textDecoration: 'line-through', color: '#999' } }, task.name),
                    isOvertimeApproval && h('div', { 
                      style: { 
                        fontSize: '10px', 
                        color: '#FF6B6B', 
                        fontWeight: '700',
                        marginTop: '4px',
                        background: '#FFE5E5',
                        padding: '2px 6px',
                        borderRadius: '3px',
                        display: 'inline-block'
                      } 
                    }, '‚è±Ô∏è OVERTIME')
                  ),
                  h('td', { style: { textAlign: 'center', color: '#DC3545', fontWeight: '700', textDecoration: 'line-through' } }, 
                    isOvertimeApproval ? 'Capacity Exceeded' : '+' + task.variance + 'h'
                  ),
                  h('td', null, approval ? approval.approvedBy : '-'),
                  h('td', { style: { textAlign: 'center', fontSize: '11px' } }, 
                    approval ? approval.approvalDate : '-'
                  ),
                  h('td', { style: { fontSize: '12px', color: '#666' } }, 
                    approval ? (approval.comments || '-') : '-'
                  )
                );
              })
            )
          )
        ),

        // Approval Modal
        showApprovalModal && selectedRequest && h('div', { className: 'modal', onClick: () => setShowApprovalModal(false) },
          h('div', { 
            className: 'modal-content', 
            style: { maxWidth: '600px' },
            onClick: (e) => e.stopPropagation() 
          },
            h('div', { className: 'modal-header' },
              h('h2', { className: 'modal-title' }, 'Review Approval Request'),
              h('button', { className: 'close-btn', onClick: () => setShowApprovalModal(false) }, '√ó')
            ),
            h('div', { className: 'modal-body' },
              h('div', { style: { background: '#F8F9FA', padding: '16px', borderRadius: '8px', marginBottom: '20px' } },
                h('div', { style: { fontSize: '16px', fontWeight: '700', marginBottom: '12px' } }, 
                  selectedRequest.clientName + ' - ' + selectedRequest.name
                ),
                // Check if this is an overtime approval
                (selectedRequest.overtimeApproval && selectedRequest.overtimeApproval.status === 'pending') ? 
                  // OVERTIME APPROVAL VIEW
                  h('div', null,
                    h('div', { 
                      style: { 
                        fontSize: '14px', 
                        fontWeight: '700', 
                        color: '#FF6B6B',
                        marginBottom: '12px',
                        background: '#FFE5E5',
                        padding: '8px',
                        borderRadius: '4px'
                      } 
                    }, '‚è±Ô∏è OVERTIME APPROVAL REQUEST'),
                    h('div', { style: { fontSize: '13px', color: '#666', marginBottom: '12px' } },
                      'This task assignment will cause staff to exceed 8 hours per day capacity.'
                    ),
                    selectedRequest.overtimeApproval.violations && Array.isArray(selectedRequest.overtimeApproval.violations) && selectedRequest.overtimeApproval.violations.length > 0 && 
                      h('div', { style: { marginBottom: '12px' } },
                        selectedRequest.overtimeApproval.violations.map((v, idx) => 
                          h('div', { key: idx, style: { marginBottom: '8px' } },
                            h('div', { style: { fontSize: '13px', fontWeight: '600', marginBottom: '4px' } }, (v.staffName || 'Unknown Staff') + ':'),
                            v.overtimeDays && Array.isArray(v.overtimeDays) && v.overtimeDays.slice(0, 3).map((day, dayIdx) =>
                              h('div', { key: dayIdx, style: { fontSize: '12px', color: '#666', marginLeft: '12px' } },
                                (day.date || '') + ': ' + 
                                (day.existing || 0).toFixed(1) + 'h existing + ' + 
                                (day.adding || 0).toFixed(1) + 'h new = ' + 
                                (day.total || 0).toFixed(1) + 'h (' + 
                                (day.overtime || 0).toFixed(1) + 'h over)'
                              )
                            ),
                            v.overtimeDays && Array.isArray(v.overtimeDays) && v.overtimeDays.length > 3 &&
                              h('div', { style: { fontSize: '12px', color: '#999', marginLeft: '12px', fontStyle: 'italic' } },
                                '... and ' + (v.overtimeDays.length - 3) + ' more days'
                              )
                          )
                        )
                      ),
                    h('div', { style: { borderTop: '1px solid #E0E0E0', paddingTop: '12px' } },
                      h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Reason:'),
                      h('div', { style: { fontSize: '14px' } }, selectedRequest.overtimeApproval.reason || 'No reason provided')
                    )
                  )
                : 
                  // BUDGET APPROVAL VIEW  
                  h('div', null,
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px', marginBottom: '12px' } },
                      h('div', null,
                        h('div', { style: { fontSize: '11px', color: '#666' } }, 'Budget Hours'),
                        h('div', { style: { fontSize: '18px', fontWeight: '700' } }, selectedRequest.budgetHours + 'h')
                      ),
                      h('div', null,
                        h('div', { style: { fontSize: '11px', color: '#666' } }, 'Allocated Hours'),
                        h('div', { style: { fontSize: '18px', fontWeight: '700' } }, selectedRequest.allocatedHours.toFixed(1) + 'h')
                      ),
                      h('div', null,
                        h('div', { style: { fontSize: '11px', color: '#666' } }, 'Variance'),
                        h('div', { style: { fontSize: '18px', fontWeight: '700', color: '#DC3545' } }, 
                          '+' + selectedRequest.variance.toFixed(1) + 'h'
                        )
                      )
                    ),
                    h('div', { style: { borderTop: '1px solid #E0E0E0', paddingTop: '12px' } },
                      h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Reason:'),
                      h('div', { style: { fontSize: '14px' } }, 
                        selectedRequest.approvalRequest ? selectedRequest.approvalRequest.reason : 'No reason provided'
                      )
                    )
                  )
              ),

              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Manager Comments'),
                h('textarea', {
                  className: 'form-input',
                  rows: 3,
                  placeholder: 'Add comments about this approval/rejection...',
                  value: approvalComment,
                  onChange: (e) => setApprovalComment(e.target.value)
                })
              )
            ),
            h('div', { className: 'modal-footer' },
              h('button', { 
                className: 'btn btn-secondary', 
                onClick: () => setShowApprovalModal(false) 
              }, 'Cancel'),
              h('button', { 
                className: 'action-btn-enhanced delete',
                onClick: handleReject
              }, '‚ùå Reject'),
              h('button', { 
                className: 'action-btn-enhanced edit',
                style: { background: 'linear-gradient(135deg, #28A745 0%, #20c997 100%)', color: 'white' },
                onClick: handleApprove
              }, '‚úÖ Approve')
            )
          )
        ),

        // Request Modal
        showRequestModal && selectedTaskForRequest && h('div', { className: 'modal', onClick: () => setShowRequestModal(false) },
          h('div', { 
            className: 'modal-content', 
            style: { maxWidth: '600px' },
            onClick: (e) => e.stopPropagation() 
          },
            h('div', { className: 'modal-header' },
              h('h2', { className: 'modal-title' }, 'Request Hour Adjustment Approval'),
              h('button', { className: 'close-btn', onClick: () => setShowRequestModal(false) }, '√ó')
            ),
            h('div', { className: 'modal-body' },
              h('div', { style: { background: '#F8F9FA', padding: '16px', borderRadius: '8px', marginBottom: '20px' } },
                h('div', { style: { fontSize: '16px', fontWeight: '700', marginBottom: '8px' } }, 
                  selectedTaskForRequest.clientName + ' - ' + selectedTaskForRequest.name
                ),
                h('div', { style: { fontSize: '14px', color: '#666' } },
                  `Requesting approval for additional ${selectedTaskForRequest.variance} hours`
                )
              ),

              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Reason for Additional Hours *'),
                h('textarea', {
                  className: 'form-input',
                  rows: 4,
                  placeholder: 'Explain why additional hours are needed (e.g., scope change, unexpected issues, client requests)...',
                  value: requestReason,
                  onChange: (e) => setRequestReason(e.target.value),
                  required: true
                })
              )
            ),
            h('div', { className: 'modal-footer' },
              h('button', { 
                className: 'btn btn-secondary', 
                onClick: () => setShowRequestModal(false) 
              }, 'Cancel'),
              h('button', { 
                className: 'btn btn-primary',
                onClick: handleSubmitRequest,
                disabled: !requestReason
              }, 'üì§ Submit Request')
            )
          )
        )
      );
    }

    function TaskManagerModal({ engagement, staff, onClose, onUpdate }) {
      const [showAdjustmentForm, setShowAdjustmentForm] = useState(false);
      const [selectedTask, setSelectedTask] = useState(null);

      // Get all tasks with hour variances
      const tasksWithVariance = engagements.flatMap(e =>
        (e.tasks || [])
          .map(t => ({
            ...t,
            engagementId: e.id,
            clientName: e.clientName,
            variance: (t.actualHours || 0) - (t.budgetHours || 0)
          }))
          .filter(t => t.variance !== 0)
      );

      const totalOverruns = tasksWithVariance.filter(t => t.variance > 0).length;
      const totalUnderruns = tasksWithVariance.filter(t => t.variance < 0).length;
      const totalVarianceHours = tasksWithVariance.reduce((sum, t) => sum + Math.abs(t.variance), 0);

      return h('div', null,
        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#DC3545' } },
            h('div', { className: 'metric-label' }, 'Budget Overruns'),
            h('div', { className: 'metric-value', style: { color: '#DC3545' } }, totalOverruns),
            h('div', { className: 'metric-detail' }, 'Tasks over budget')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#28A745' } },
            h('div', { className: 'metric-label' }, 'Budget Underruns'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, totalUnderruns),
            h('div', { className: 'metric-detail' }, 'Tasks under budget')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#FFC107' } },
            h('div', { className: 'metric-label' }, 'Total Variance'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, `${totalVarianceHours}h`),
            h('div', { className: 'metric-detail' }, 'Hours difference')
          )
        ),

        h('div', { className: 'card' },
          h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' } },
            h('h3', { style: { fontSize: '18px', fontWeight: '600' } }, 
              'Hour Adjustments & Approval'
            ),
            h('div', { style: { padding: '8px 16px', background: '#E3F2FD', borderRadius: '8px', fontSize: '13px', color: '#1976D2' } },
              'üí° Phase 2: Approval workflow coming soon'
            )
          ),

          tasksWithVariance.length === 0 ?
            h('div', { className: 'empty-state' },
              h('div', { className: 'empty-state-icon' }, '‚úÖ'),
              h('p', null, 'All tasks are on budget!')
            ) :
            h('table', { className: 'task-table-enhanced' },
              h('thead', null,
                h('tr', null,
                  h('th', null, 'Client'),
                  h('th', null, 'Task'),
                  h('th', { style: { textAlign: 'center' } }, 'Budget'),
                  h('th', { style: { textAlign: 'center' } }, 'Actual'),
                  h('th', { style: { textAlign: 'center' } }, 'Variance'),
                  h('th', { style: { textAlign: 'center' } }, 'Status'),
                  h('th', { style: { textAlign: 'center' } }, 'Actions')
                )
              ),
              h('tbody', null,
                tasksWithVariance.map((task, idx) => {
                  const varianceClass = task.variance > 0 ? 'overrun' : 'underrun';
                  
                  return h('tr', { key: idx },
                    h('td', { style: { fontWeight: '600' } }, task.clientName),
                    h('td', null, task.name),
                    h('td', { style: { textAlign: 'center' } }, `${task.budgetHours}h`),
                    h('td', { style: { textAlign: 'center' } }, `${task.actualHours}h`),
                    h('td', { style: { textAlign: 'center' } },
                      h('span', {
                        style: {
                          color: task.variance > 0 ? '#DC3545' : '#28A745',
                          fontWeight: '700',
                          fontSize: '14px'
                        }
                      }, `${task.variance > 0 ? '+' : ''}${task.variance}h`)
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('span', {
                        className: 'hour-adjustment'
                      }, task.variance > 0 ? '‚ö†Ô∏è Over Budget' : '‚úì Under Budget')
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('button', {
                        className: 'action-btn-enhanced edit',
                        style: { fontSize: '11px', padding: '6px 12px' }
                      }, 'Request Approval')
                    )
                  );
                })
              )
            )
        )
      );
    }

    function TaskManagerModal({ engagement, staff, allEngagements, onClose, onUpdate }) {
      const [tasks, setTasks] = useState(engagement.tasks || []);
      const [currentStage, setCurrentStage] = useState('acceptance');
      const [showTaskForm, setShowTaskForm] = useState(false);
      const [editingTask, setEditingTask] = useState(null);

      const handleSaveTask = (task) => {
        let updatedTasks;
        if (editingTask) {
          updatedTasks = tasks.map(t => t.id === task.id ? task : t);
        } else {
          updatedTasks = [...tasks, { ...task, id: Date.now() }];
        }
        setTasks(updatedTasks);
        setShowTaskForm(false);
        setEditingTask(null);
      };

      const handleDeleteTask = (taskId) => {
        if (confirm('Delete this task?')) {
          setTasks(tasks.filter(t => t.id !== taskId));
        }
      };

      const handleLoadDefaultTasks = () => {
        if (confirm('Load default audit tasks?')) {
          const newTasks = [];
          let taskId = Date.now();
          
          Object.entries(DEFAULT_TASKS).forEach(([stage, stageTasks]) => {
            stageTasks.forEach(task => {
              newTasks.push({
                id: taskId++,
                stage: stage,
                name: task.name,
                budgetHours: task.defaultHours,
                actualHours: 0,
                status: 'Not Started',
                assignments: []
              });
            });
          });
          
          setTasks([...tasks, ...newTasks]);
        }
      };

      const currentStageTasks = tasks.filter(t => t.stage === currentStage);
      const totalBudgetHours = tasks.reduce((sum, t) => sum + (t.budgetHours || 0), 0);
      const lockdownDeadline = calculateLockdownDeadline(engagement.completionDate);

      return h('div', { className: 'modal', onClick: onClose },
        h('div', { className: 'modal-content', onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, 'Task Manager: ' + engagement.clientName),
            h('button', { className: 'close-btn', onClick: onClose }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            
            h('div', { style: { background: '#1F4E78', color: 'white', padding: '16px', borderRadius: '8px', marginBottom: '20px' } },
              h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '16px', textAlign: 'center' } },
                h('div', null,
                  h('div', { style: { fontSize: '12px', opacity: 0.8 } }, 'Total Tasks'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700' } }, tasks.length)
                ),
                h('div', null,
                  h('div', { style: { fontSize: '12px', opacity: 0.8 } }, 'Budget Hours'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700' } }, totalBudgetHours + 'h')
                ),
                h('div', null,
                  h('div', { style: { fontSize: '12px', opacity: 0.8 } }, 'Completed'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700' } }, 
                    tasks.filter(t => t.status === 'Completed').length
                  )
                ),
                h('div', null,
                  h('div', { style: { fontSize: '12px', opacity: 0.8 } }, 'In Progress'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700' } }, 
                    tasks.filter(t => t.status === 'In Progress').length
                  )
                )
              )
            ),

            h('div', { style: { marginBottom: '20px', display: 'flex', gap: '12px' } },
              h('button', {
                className: 'btn btn-primary',
                onClick: () => {
                  setEditingTask(null);
                  setShowTaskForm(true);
                }
              }, '+ Add Task'),
              h('button', {
                className: 'btn btn-secondary',
                onClick: handleLoadDefaultTasks
              }, 'Load Default Tasks')
            ),

            h('div', { style: { display: 'flex', gap: '6px', marginBottom: '20px', overflowX: 'auto' } },
              AUDIT_STAGES.map(stage => {
                const count = tasks.filter(t => t.stage === stage.id).length;
                return h('button', { 
                  key: stage.id,
                  className: 'stage-tab-enhanced ' + stage.id + (currentStage === stage.id ? ' active' : ''),
                  onClick: () => setCurrentStage(stage.id)
                }, 
                  stage.name,
                  h('span', { className: 'tab-count' }, count),
                  stage.id === 'lockdown' && h('span', { style: { marginLeft: '4px' } }, '‚è∞')
                );
              })
            ),

            currentStage === 'lockdown' && engagement.completionDate && h('div', { className: 'lockdown-warning-enhanced' },
              h('div', { className: 'icon' }, '‚ö†Ô∏è'),
              h('div', null,
                h('strong', null, 'Lockdown Stage: '),
                'Maximum 60 days from completion date (' + engagement.completionDate + '). ',
                h('strong', null, 'Deadline: ' + lockdownDeadline)
              )
            ),

            h('div', { style: { marginTop: '20px' } },
              currentStageTasks.length === 0 ?
                h('div', { className: 'empty-state' },
                  h('div', { className: 'empty-state-icon' }, 'üìù'),
                  h('p', null, 'No tasks in ' + AUDIT_STAGES.find(s => s.id === currentStage)?.name)
                ) :
                h('table', { className: 'task-table-enhanced' },
                  h('thead', null,
                    h('tr', null,
                      h('th', null, 'Task Name'),
                      h('th', { style: { textAlign: 'center' } }, 'Budget Hours'),
                      h('th', { style: { textAlign: 'center' } }, 'Assigned To'),
                      h('th', { style: { textAlign: 'center' } }, 'Status'),
                      h('th', { style: { textAlign: 'center' } }, 'Actions')
                    )
                  ),
                  h('tbody', null,
                    currentStageTasks.map(task => {
                      const assignedStaff = (task.assignments || []).map(a => {
                        const s = staff.find(st => st.id === a.staffId);
                        return s ? s.name : 'Unknown';
                      }).join(', ');
                      
                      const statusClass = task.status === 'Completed' ? 'completed' :
                                        task.status === 'In Progress' ? 'in-progress' : 'not-started';

                      return h('tr', { key: task.id },
                        h('td', { style: { fontWeight: '600' } }, task.name),
                        h('td', { style: { textAlign: 'center' } }, task.budgetHours + 'h'),
                        h('td', { style: { textAlign: 'center', fontSize: '12px' } }, assignedStaff || '-'),
                        h('td', { style: { textAlign: 'center' } },
                          h('span', {
                            className: 'status-badge-enhanced ' + statusClass
                          }, task.status)
                        ),
                        h('td', { style: { textAlign: 'center' } },
                          h('div', { style: { display: 'flex', gap: '6px', justifyContent: 'center' } },
                            h('button', {
                              className: 'action-btn-enhanced edit',
                              onClick: () => {
                                setEditingTask(task);
                                setShowTaskForm(true);
                              }
                            }, 'Edit'),
                            h('button', {
                              className: 'action-btn-enhanced delete',
                              onClick: () => handleDeleteTask(task.id)
                            }, 'Delete')
                          )
                        )
                      );
                    })
                  )
                )
            )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Cancel'),
            h('button', { 
              className: 'btn btn-primary', 
              onClick: () => onUpdate({ ...engagement, tasks })
            }, 'Save All Tasks')
          )
        ),

        showTaskForm && h(TaskForm, {
          task: editingTask,
          stage: currentStage,
          staff: staff,
          currentEngagement: engagement,
          allEngagements: allEngagements,
          onSave: handleSaveTask,
          onCancel: () => {
            setShowTaskForm(false);
            setEditingTask(null);
          }
        })
      );
    }

    function TaskForm({ task, stage, staff, currentEngagement, allEngagements, onSave, onCancel }) {
      const [formData, setFormData] = useState(task || {
        name: '',
        stage: stage,
        budgetHours: '',
        actualHours: 0,
        status: 'Not Started',
        assignments: []
      });
      const [searchTerm, setSearchTerm] = useState('');
      const [showApprovalWarning, setShowApprovalWarning] = useState(false);
      const [approvalReason, setApprovalReason] = useState('');
      const [hasCapacityViolation, setHasCapacityViolation] = useState(false);

      // Helper: Calculate existing capacity for a staff member
      const calculateExistingCapacity = (staffId, startDate, endDate) => {
        if (!startDate || !endDate || !allEngagements) {
          console.log('  ‚Üí calculateExistingCapacity: Missing params', {startDate, endDate, hasAllEngagements: !!allEngagements});
          return {};
        }
        
        console.log('  ‚Üí calculateExistingCapacity START');
        console.log('  ‚Üí staffId:', staffId);
        console.log('  ‚Üí allEngagements count:', allEngagements.length);
        
        try {
          const start = new Date(startDate);
          const end = new Date(endDate);
          const capacityByDate = {};
          
          // Initialize capacity for date range
          let current = new Date(start);
          while (current <= end) {
            const day = current.getDay();
            if (day !== 0 && day !== 6) {
              capacityByDate[current.toISOString().split('T')[0]] = 0;
            }
            current.setDate(current.getDate() + 1);
          }
          
          console.log('  ‚Üí Initialized dates:', Object.keys(capacityByDate));
          
          // Calculate existing allocations
          let tasksChecked = 0;
          let assignmentsChecked = 0;
          let matchingAssignments = 0;
          
          allEngagements.forEach(eng => {
            if (!eng || !eng.tasks) return;
            
            (eng.tasks || []).forEach(t => {
              tasksChecked++;
              
              // Skip current task being edited
              if (task && t.id === task.id) {
                console.log('  ‚Üí Skipping current task:', t.name);
                return;
              }
              
              (t.assignments || []).forEach(assignment => {
                assignmentsChecked++;
                
                // Convert both to string for comparison (handles number vs string mismatch)
                if (String(assignment.staffId) === String(staffId)) {
                  // Use assignment dates if available, otherwise use engagement dates
                  const assignmentStart = assignment.startDate || eng.auditStartDate;
                  const assignmentEnd = assignment.endDate || eng.auditCompletionDate;
                  
                  console.log('  ‚Üí Found assignment for staffId', staffId, ':', {
                    task: t.name,
                    hours: assignment.hours,
                    assignmentStartDate: assignment.startDate,
                    assignmentEndDate: assignment.endDate,
                    engagementStartDate: eng.auditStartDate,
                    engagementEndDate: eng.auditCompletionDate,
                    effectiveStart: assignmentStart,
                    effectiveEnd: assignmentEnd
                  });
                  
                  if (assignmentStart && assignmentEnd && assignment.hours) {
                    matchingAssignments++;
                    console.log('  ‚Üí MATCH! Task:', t.name, 'Hours:', assignment.hours, 'Dates:', assignmentStart, 'to', assignmentEnd);
                    
                    const taskStart = new Date(assignmentStart);
                    const taskEnd = new Date(assignmentEnd);
                    
                    // Calculate working days
                    let workingDays = 0;
                    let curr = new Date(taskStart);
                    while (curr <= taskEnd) {
                      if (curr.getDay() !== 0 && curr.getDay() !== 6) workingDays++;
                      curr.setDate(curr.getDate() + 1);
                    }
                    
                    if (workingDays > 0) {
                      const hoursPerDay = assignment.hours / workingDays;
                      console.log('  ‚Üí Adding', hoursPerDay, 'h/day');
                      
                      // Add to overlapping days
                      curr = new Date(taskStart);
                      while (curr <= taskEnd) {
                        if (curr.getDay() !== 0 && curr.getDay() !== 6) {
                          const dateKey = curr.toISOString().split('T')[0];
                          if (capacityByDate.hasOwnProperty(dateKey)) {
                            capacityByDate[dateKey] += hoursPerDay;
                          }
                        }
                        curr.setDate(curr.getDate() + 1);
                      }
                    }
                  } else {
                    console.log('  ‚Üí ‚ùå REJECTED: Missing', 
                      !assignmentStart ? 'start date' : '',
                      !assignmentEnd ? 'end date' : '',
                      !assignment.hours ? 'hours' : ''
                    );
                  }
                } else if (assignment.staffId && assignment.hours) {
                  // Log why it didn't match
                  console.log('  ‚Üí Not matching: assignment.staffId=', assignment.staffId, '(', typeof assignment.staffId, ') vs staffId=', staffId, '(', typeof staffId, ')');
                }
              });
            });
          });
          
          console.log('  ‚Üí Stats: Checked', tasksChecked, 'tasks,', assignmentsChecked, 'assignments, Found', matchingAssignments, 'matches');
          console.log('  ‚Üí Final capacity:', capacityByDate);
          
          return capacityByDate;
        } catch (error) {
          console.error('  ‚Üí Capacity calculation error:', error);
          return {};
        }
      };

      const handleChange = (field, value) => {
        setFormData({ ...formData, [field]: value });
      };

      const handleAssignmentChange = (staffId, field, value) => {
        const assignments = [...(formData.assignments || [])];
        const existingIndex = assignments.findIndex(a => a.staffId === staffId);
        
        if (field === 'hours') {
          const hours = parseFloat(value);
          if (hours > 0) {
            if (existingIndex >= 0) {
              assignments[existingIndex] = { 
                ...assignments[existingIndex],
                hours 
              };
            } else {
              assignments.push({ 
                staffId, 
                hours,
                startDate: '',
                endDate: ''
              });
            }
          } else {
            if (existingIndex >= 0) {
              assignments.splice(existingIndex, 1);
            }
          }
        } else {
          // Updating startDate or endDate
          if (existingIndex >= 0) {
            assignments[existingIndex] = {
              ...assignments[existingIndex],
              [field]: value
            };
          }
        }
        
        // Update form data
        const updatedFormData = { ...formData, assignments };
        setFormData(updatedFormData);
        
        // Check if total assigned hours exceed budget OR if there are capacity violations
        const totalAssigned = assignments.reduce((sum, a) => sum + (a.hours || 0), 0);
        const budget = parseFloat(updatedFormData.budgetHours) || 0;
        
        // FULL capacity check against existing allocations
        let hasCapacityIssue = false;
        
        // Check each assignment for capacity violations
        assignments.forEach(a => {
          if (a.hours > 0 && a.staffId && a.startDate && a.endDate) {
            // Get existing capacity for this staff member
            const existingCapacity = calculateExistingCapacity(
              a.staffId,
              a.startDate,
              a.endDate
            );
            
            // Calculate hours per day for this assignment
            const start = new Date(a.startDate);
            const end = new Date(a.endDate);
            let workingDays = 0;
            let curr = new Date(start);
            while (curr <= end) {
              if (curr.getDay() !== 0 && curr.getDay() !== 6) workingDays++;
              curr.setDate(curr.getDate() + 1);
            }
            
            if (workingDays > 0) {
              const hoursPerDay = a.hours / workingDays;
              
              // Check if adding this would exceed 8h on any day
              curr = new Date(start);
              while (curr <= end) {
                if (curr.getDay() !== 0 && curr.getDay() !== 6) {
                  const dateKey = curr.toISOString().split('T')[0];
                  const existing = existingCapacity[dateKey] || 0;
                  const newTotal = existing + hoursPerDay;
                  
                  if (newTotal > 8) {
                    hasCapacityIssue = true;
                    break;
                  }
                }
                curr.setDate(curr.getDate() + 1);
              }
            }
          }
        });
        
        if (totalAssigned > budget || hasCapacityIssue) {
          setShowApprovalWarning(true);
          setHasCapacityViolation(hasCapacityIssue);
        } else {
          setShowApprovalWarning(false);
          setHasCapacityViolation(false);
          setApprovalReason('');
        }
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.name || !formData.budgetHours) {
          alert('Please fill in task name and budget hours');
          return;
        }

        const budget = parseFloat(formData.budgetHours) || 0;
        const totalAssigned = (formData.assignments || []).reduce((sum, a) => sum + (a.hours || 0), 0);
        const assignmentOverrun = totalAssigned - budget;

        // REQUIRE date ranges for all assignments
        const assignmentsWithoutDates = formData.assignments.filter(a => 
          a.hours > 0 && (!a.startDate || !a.endDate)
        );
        
        if (assignmentsWithoutDates.length > 0) {
          const staffNames = assignmentsWithoutDates.map(a => {
            const s = staff.find(st => st.id === a.staffId);
            return s?.name || 'Unknown';
          }).join(', ');
          
          alert(`Date ranges required!\n\nPlease specify Start Date and End Date for:\n${staffNames}\n\nDate ranges are required for capacity checking.`);
          return;
        }

        // NEW: Check for daily capacity violations
        const overtimeViolations = [];
        
        console.log('=== CAPACITY CHECK START ===');
        console.log('Task:', formData.name);
        console.log('Assignments:', formData.assignments);
        
        formData.assignments.forEach(assignment => {
          if (assignment.startDate && assignment.endDate && assignment.hours > 0) {
            const staffMember = staff.find(s => s.id === assignment.staffId);
            console.log('\nChecking assignment for:', staffMember?.name);
            console.log('Hours:', assignment.hours, 'Dates:', assignment.startDate, 'to', assignment.endDate);
            
            // Get existing capacity
            const existingCapacity = calculateExistingCapacity(
              assignment.staffId,
              assignment.startDate,
              assignment.endDate
            );
            
            console.log('Existing capacity by date:', existingCapacity);
            
            // Calculate working days for this assignment
            const start = new Date(assignment.startDate);
            const end = new Date(assignment.endDate);
            let workingDays = 0;
            const current = new Date(start);
            while (current <= end) {
              const day = current.getDay();
              if (day !== 0 && day !== 6) workingDays++;
              current.setDate(current.getDate() + 1);
            }
            
            if (workingDays > 0) {
              const hoursPerDay = assignment.hours / workingDays;
              
              // Check each day for capacity violations
              let maxOvertime = 0;
              let overtimeDays = [];
              
              const curr = new Date(start);
              while (curr <= end) {
                const day = curr.getDay();
                if (day !== 0 && day !== 6) {
                  const dateKey = curr.toISOString().split('T')[0];
                  const existing = existingCapacity[dateKey] || 0;
                  const newTotal = existing + hoursPerDay;
                  
                  if (newTotal > 8) {
                    const overtimeForDay = newTotal - 8;
                    maxOvertime = Math.max(maxOvertime, overtimeForDay);
                    overtimeDays.push({
                      date: dateKey,
                      existing: existing,
                      adding: hoursPerDay,
                      total: newTotal,
                      overtime: overtimeForDay
                    });
                  }
                }
                curr.setDate(curr.getDate() + 1);
              }
              
              if (overtimeDays.length > 0) {
                console.log('VIOLATION DETECTED!');
                console.log('Overtime days:', overtimeDays);
                
                overtimeViolations.push({
                  staffName: staffMember?.name || 'Unknown',
                  staffId: assignment.staffId,
                  hoursPerDay: hoursPerDay,
                  overtimeHours: maxOvertime,
                  overtimeDays: overtimeDays,
                  startDate: assignment.startDate,
                  endDate: assignment.endDate
                });
              } else {
                console.log('No violations - within capacity');
              }
            }
          }
        });
        
        console.log('\nTotal violations found:', overtimeViolations.length);
        console.log('Violations:', overtimeViolations);
        console.log('=== CAPACITY CHECK END ===\n');

        // If overtime detected, require approval
        if (overtimeViolations.length > 0 && !approvalReason.trim()) {
          const violationsList = overtimeViolations.map(v => {
            const dayDetails = v.overtimeDays.slice(0, 3).map(d => 
              `  ${d.date}: ${d.existing.toFixed(1)}h existing + ${d.adding.toFixed(1)}h new = ${d.total.toFixed(1)}h (${d.overtime.toFixed(1)}h over)`
            ).join('\n');
            
            const moreText = v.overtimeDays.length > 3 ? `\n  ... and ${v.overtimeDays.length - 3} more days` : '';
            
            return `${v.staffName}:\n${dayDetails}${moreText}`;
          }).join('\n\n');
          
          alert(`‚ö†Ô∏è DAILY CAPACITY EXCEEDED!\n\nAdding this task will exceed 8h/day capacity:\n\n${violationsList}\n\n‚ùå TASK NOT SAVED\n\nPlease scroll down and enter a reason in the "Approval Reason" field, then click Save again.`);
          
          // Scroll to approval reason field
          const reasonField = document.querySelector('textarea[placeholder*="reason"]');
          if (reasonField) {
            reasonField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            reasonField.focus();
            reasonField.style.border = '3px solid #FF6B6B';
            reasonField.style.background = '#FFE5E5';
            setTimeout(() => {
              reasonField.style.border = '';
              reasonField.style.background = '';
            }, 3000);
          }
          
          return;
        }

        // Check if approval is needed for assignment overrun
        if (assignmentOverrun > 0 && !approvalReason.trim()) {
          alert(`‚ö†Ô∏è BUDGET EXCEEDED!\n\nTotal assigned hours (${totalAssigned}h) exceed budget (${budget}h) by ${assignmentOverrun}h.\n\n‚ùå TASK NOT SAVED\n\nPlease scroll down and enter a reason in the "Approval Reason" field, then click Save again.`);
          
          // Scroll to approval reason field
          const reasonField = document.querySelector('textarea[placeholder*="reason"]');
          if (reasonField) {
            reasonField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            reasonField.focus();
            reasonField.style.border = '3px solid #FF6B6B';
            reasonField.style.background = '#FFE5E5';
            setTimeout(() => {
              reasonField.style.border = '';
              reasonField.style.background = '';
            }, 3000);
          }
          
          return;
        }

        // Create task with approval requests
        const taskData = {
          ...formData,
          budgetHours: budget,
          actualHours: parseFloat(formData.actualHours) || 0
        };

        // Auto-create approval request for assignment overrun
        if (assignmentOverrun > 0) {
          taskData.approvalRequest = {
            id: Date.now(),
            requestedBy: "Current User",
            requestDate: new Date().toISOString().split('T')[0],
            reason: approvalReason,
            additionalHours: assignmentOverrun,
            status: 'pending',
            approvedBy: null,
            approvalDate: null,
            comments: null
          };
        }

        // Auto-create overtime approval request
        if (overtimeViolations.length > 0) {
          taskData.overtimeApproval = {
            id: Date.now() + 1,
            requestedBy: "Current User",
            requestDate: new Date().toISOString().split('T')[0],
            reason: approvalReason,
            violations: overtimeViolations,
            status: 'pending',
            approvedBy: null,
            approvalDate: null,
            comments: null
          };
        }

        onSave(taskData);
      };

      const filteredStaff = staff.filter(s => {
        if (!s.isActive) return false;
        const searchLower = searchTerm.toLowerCase();
        return s.name.toLowerCase().includes(searchLower) || 
               s.position.toLowerCase().includes(searchLower) ||
               s.level.toLowerCase().includes(searchLower);
      });

      const totalAssignedHours = (formData.assignments || []).reduce((sum, a) => sum + (a.hours || 0), 0);
      const budget = parseFloat(formData.budgetHours) || 0;
      const assignmentOverrun = totalAssignedHours - budget;
      const hasOverrun = assignmentOverrun > 0;

      return h('div', { className: 'modal', onClick: onCancel },
        h('div', { className: 'modal-content', style: { maxWidth: '800px' }, onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, task ? 'Edit Task' : 'Add New Task'),
            h('button', { className: 'close-btn', onClick: onCancel }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            h('form', { onSubmit: handleSubmit, id: 'taskForm' },
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Task Name *'),
                h('input', { 
                  className: 'form-input', 
                  type: 'text', 
                  value: formData.name, 
                  onChange: (e) => handleChange('name', e.target.value),
                  required: true,
                  placeholder: 'e.g., Risk assessment procedures'
                })
              ),
              
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Stage *'),
                  h('select', { 
                    className: 'form-input', 
                    value: formData.stage, 
                    onChange: (e) => handleChange('stage', e.target.value),
                    required: true
                  },
                    AUDIT_STAGES.map(s => 
                      h('option', { key: s.id, value: s.id }, 
                        s.name + (s.id === 'lockdown' ? ' (Max 60 days)' : '')
                      )
                    )
                  )
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Status'),
                  h('select', { 
                    className: 'form-input', 
                    value: formData.status, 
                    onChange: (e) => handleChange('status', e.target.value)
                  },
                    h('option', { value: 'Not Started' }, 'Not Started'),
                    h('option', { value: 'In Progress' }, 'In Progress'),
                    h('option', { value: 'Completed' }, 'Completed')
                  )
                )
              ),

              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Budget Hours *'),
                  h('input', { 
                    className: 'form-input', 
                    type: 'number', 
                    value: formData.budgetHours, 
                    onChange: (e) => handleChange('budgetHours', e.target.value),
                    required: true,
                    min: '0',
                    step: '0.5'
                  })
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Actual Hours'),
                  h('input', { 
                    className: 'form-input', 
                    type: 'number', 
                    value: formData.actualHours, 
                    onChange: (e) => handleChange('actualHours', e.target.value),
                    min: '0',
                    step: '0.5'
                  }),
                  h('div', { style: { fontSize: '11px', color: '#666', marginTop: '4px', fontStyle: 'italic' } },
                    'For final reporting only - not used for approvals'
                  )
                )
              ),

              h('div', { className: 'section-title' }, 
                'Team Assignments',
                h('span', { style: { fontSize: '13px', fontWeight: 'normal', marginLeft: '12px' } },
                  h('span', { style: { color: '#666' } }, 'Total Assigned: '),
                  h('span', { style: { fontWeight: '700', color: hasOverrun ? '#DC3545' : totalAssignedHours > 0 ? '#28A745' : '#666' } },
                    totalAssignedHours.toFixed(1) + 'h'
                  ),
                  budget > 0 && h('span', { style: { color: '#999', marginLeft: '4px' } }, 
                    ' / ' + budget + 'h budget'
                  ),
                  hasOverrun && h('span', { style: { color: '#DC3545', marginLeft: '8px', fontWeight: '700' } },
                    '‚ö†Ô∏è +' + assignmentOverrun.toFixed(1) + 'h over!'
                  )
                )
              ),

              // Approval Warning and Reason - FOR BOTH BUDGET AND CAPACITY VIOLATIONS
              (hasOverrun || hasCapacityViolation) && h('div', {
                style: {
                  background: hasCapacityViolation ? 'linear-gradient(135deg, #E3F2FD 0%, #FFF3E0 100%)' : 'linear-gradient(135deg, #FFF3E0 0%, #FFEBEE 100%)',
                  border: hasCapacityViolation ? '2px solid #2196F3' : '2px solid #FFC107',
                  borderRadius: '8px',
                  padding: '16px',
                  marginBottom: '20px'
                }
              },
                h('div', { style: { display: 'flex', alignItems: 'start', gap: '12px', marginBottom: '12px' } },
                  h('div', { style: { fontSize: '32px' } }, hasCapacityViolation ? '‚è∞' : '‚ö†Ô∏è'),
                  h('div', null,
                    h('div', { style: { fontSize: '16px', fontWeight: '700', color: hasCapacityViolation ? '#1976D2' : '#DC3545', marginBottom: '6px' } },
                      hasCapacityViolation ? 'Daily Capacity Will Be Exceeded' : 'Assignment Overrun Detected'
                    ),
                    !hasCapacityViolation && h('div', { style: { fontSize: '13px', color: '#666', marginBottom: '4px' } },
                      `Budget: ${budget}h | Total Assigned: ${totalAssignedHours.toFixed(1)}h | Overrun: ${assignmentOverrun.toFixed(1)}h`
                    ),
                    h('div', { style: { fontSize: '13px', color: '#666', marginBottom: '8px' } },
                      hasCapacityViolation 
                        ? 'One or more staff members will exceed 8 hours per day with this assignment. Overtime approval will be required.'
                        : `You have assigned ${assignmentOverrun.toFixed(1)} hours more than the budget. An approval request will be automatically created for the additional hours.`
                    ),
                    h('div', { style: { fontSize: '12px', color: '#856404', background: '#FFF9E6', padding: '8px', borderRadius: '4px', border: '1px solid #FFE58F' } },
                      hasCapacityViolation
                        ? 'üí° Tip: Explain why overtime is needed (e.g., "Urgent client deadline", "Critical phase of audit", "Staff shortage").'
                        : 'üí° Tip: Explain why the task requires more hours than originally budgeted (e.g., "Scope expanded", "Unexpected complexity", "Client request").'
                    )
                  )
                ),
                h('div', { className: 'form-group', style: { marginBottom: 0 } },
                  h('label', { className: 'form-label' }, 
                    hasCapacityViolation 
                      ? 'Overtime Approval Reason *'
                      : 'Approval Reason for Additional ' + assignmentOverrun.toFixed(1) + 'h *',
                    h('span', { style: { color: '#DC3545', marginLeft: '4px' } }, '(Required)')
                  ),
                  h('textarea', {
                    className: 'form-input',
                    rows: 3,
                    placeholder: hasCapacityViolation
                      ? 'Explain why overtime is necessary (e.g., "Client moved deadline forward by 2 weeks", "Complex technical issues requiring additional senior time", "Year-end reporting deadline cannot be moved")...'
                      : 'Explain why additional assignment hours are needed beyond the budget (e.g., "Client expanded scope to include 3 additional subsidiaries", "Complex technical issues discovered during planning", "Regulatory requirement changes")...',
                    value: approvalReason,
                    onChange: (e) => setApprovalReason(e.target.value),
                    required: hasOverrun || hasCapacityViolation,
                    style: { borderColor: (hasOverrun || hasCapacityViolation) && !approvalReason ? '#DC3545' : undefined }
                  })
                )
              ),
              
              h('input', {
                type: 'text',
                className: 'form-input',
                style: { marginBottom: '12px' },
                placeholder: 'üîç Search staff by name, position, or level...',
                value: searchTerm,
                onChange: (e) => setSearchTerm(e.target.value)
              }),

              h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '12px' } },
                'Showing ' + filteredStaff.length + ' of ' + staff.filter(s => s.isActive).length + ' staff'
              ),

              h('div', { style: { maxHeight: '300px', overflow: 'auto', border: '1px solid #E0E0E0', borderRadius: '8px', padding: '8px' } },
                filteredStaff.length === 0 ?
                  h('div', { style: { textAlign: 'center', padding: '20px', color: '#999' } },
                    searchTerm ? 'No staff found matching "' + searchTerm + '"' : 'No active staff available'
                  ) :
                  filteredStaff.map(s => {
                    const assignment = (formData.assignments || []).find(a => a.staffId === s.id);
                    const hours = assignment ? assignment.hours : '';
                    const startDate = assignment ? assignment.startDate : '';
                    const endDate = assignment ? assignment.endDate : '';
                    
                    return h('div', { 
                      key: s.id, 
                      style: { 
                        padding: '12px', 
                        borderBottom: '1px solid #F0F0F0',
                        background: hours ? '#F0F7FF' : 'transparent',
                        borderRadius: hours ? '6px' : '0',
                        marginBottom: hours ? '8px' : '0'
                      }
                    },
                      h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: hours ? '8px' : '0' } },
                        h('div', { style: { flex: 1 } },
                          h('div', { style: { fontWeight: '600', fontSize: '14px' } }, s.name),
                          h('div', { style: { fontSize: '12px', color: '#666' } }, s.position + ' ‚Ä¢ ' + s.level)
                        ),
                        h('input', {
                          type: 'number',
                          placeholder: 'Hours',
                          value: hours,
                          onChange: (e) => handleAssignmentChange(s.id, 'hours', e.target.value),
                          style: { 
                            width: '90px', 
                            padding: '8px', 
                            border: '2px solid #4472C4', 
                            borderRadius: '6px',
                            fontSize: '14px',
                            fontWeight: hours ? '600' : 'normal'
                          },
                          min: '0',
                          step: '0.5'
                        })
                      ),
                      hours > 0 && h('div', { 
                        style: { 
                          display: 'grid', 
                          gridTemplateColumns: '1fr 1fr', 
                          gap: '8px',
                          paddingTop: '8px',
                          borderTop: '1px solid #E0E0E0'
                        } 
                      },
                        h('div', null,
                          h('label', { style: { fontSize: '11px', color: '#666', fontWeight: '600', display: 'block', marginBottom: '4px' } }, 
                            'üìÖ Start Date'
                          ),
                          h('input', {
                            type: 'date',
                            value: startDate,
                            onChange: (e) => handleAssignmentChange(s.id, 'startDate', e.target.value),
                            style: {
                              width: '100%',
                              padding: '6px',
                              border: '1px solid #E0E0E0',
                              borderRadius: '4px',
                              fontSize: '12px'
                            }
                          })
                        ),
                        h('div', null,
                          h('label', { style: { fontSize: '11px', color: '#666', fontWeight: '600', display: 'block', marginBottom: '4px' } }, 
                            'üìÖ End Date'
                          ),
                          h('input', {
                            type: 'date',
                            value: endDate,
                            onChange: (e) => handleAssignmentChange(s.id, 'endDate', e.target.value),
                            style: {
                              width: '100%',
                              padding: '6px',
                              border: '1px solid #E0E0E0',
                              borderRadius: '4px',
                              fontSize: '12px'
                            }
                          })
                        )
                      ),
                      hours > 0 && startDate && endDate && h('div', {
                        style: {
                          marginTop: '6px',
                          padding: '6px 8px',
                          background: '#E3F2FD',
                          borderRadius: '4px',
                          fontSize: '11px',
                          color: '#1976D2',
                          fontWeight: '600'
                        }
                      }, 'üìä ' + hours + 'h distributed from ' + new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + 
                         ' to ' + new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }))
                    );
                  })
              )
            )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', type: 'button', onClick: onCancel }, 'Cancel'),
            h('button', { className: 'btn btn-primary', type: 'submit', form: 'taskForm' }, 
              task ? 'Update Task' : 'Add Task'
            )
          )
        )
      );
    }

    // Initialize App
    const root = createRoot(document.getElementById('root'));
    root.render(h(App));
  </script>
</body>
</html>
