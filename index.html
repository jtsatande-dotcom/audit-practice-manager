<!-- Supabase JavaScript Client -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>

/* (kept your full CSS unchanged for brevity in this message) */

/* Paste the entire CSS block from your original file here unchanged */

* { margin: 0; padding: 0; box-sizing: border-box; }

body {

font-family: 'Segoe UI', 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;

background: #F5F7FA;

color: #2C3E50;

}

/* ... (rest of your large CSS block) ... */

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>

<body>

<div id="root"></div>

<!-- React (UMD) -->

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>

<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<script>

// ---------- SAFETY / INIT WRAPPER ----------

// Defer entire app init until DOM is ready and external scripts have had a chance to load.

document.addEventListener('DOMContentLoaded', () => {

// Supabase credentials (keep secure in env for production; anon key here kept as in original)

const SUPABASE_URL = 'https://bkguwgviimksfwtpygnx.supabase.co';

const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrZ3V3Z3ZpaW1rc2Z3dHB5Z254Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNzQ3ODQsImV4cCI6MjA4NjY1MDc4NH0.ctTILmxLO5yd5YdoosmNGeZK2TZoPpASFq9Bw1T4xXc';

// Create supabase client if library loaded, otherwise create a small stub to avoid runtime errors

let supabaseClient = null;

if (window.supabase && typeof window.supabase.createClient === 'function') {

try {

supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

console.log('âœ… Supabase client initialized');

} catch (err) {

console.warn('âš ï¸ Supabase createClient failed:', err);

}

}

if (!supabaseClient) {

console.warn('âš ï¸ Supabase library not available. Creating safe stub to avoid crashes (auth will not work).');

// minimal stub so code that calls supabase.* doesn't throw

window.supabase = {

auth: {

signInWithPassword: async () => ({ data: null, error: { message: 'Supabase not loaded' } }),

signOut: async () => ({})

},

from: () => ({ select: async () => ({ data: null, error: { message: 'Supabase not loaded' } }) }),

// leave createClient function for compatibility if something calls it

createClient: () => window.supabase

};

supabaseClient = window.supabase;

} else {

// ensure global supabase refers to the client for existing code references

window.supabase = supabaseClient;

}

// Expose for debug if needed

window._APP_SUPABASE_CLIENT = supabaseClient;

// ---------- REACT APP ----------

const { useState, useEffect, createElement: h } = React;

const { createRoot } = ReactDOM;

// ======================================================

// Paste the rest of your JavaScript React app here.

// I will include the corrected/cleaned JS from your original file,

// but with one important fix: removed the duplicate TaskManagerModal

// definition (kept the later complete one) and left references intact.

// ======================================================

// For brevity in this message, I'll include the full corrected JS in-place:

// (Start of application JS - copied and adapted from your provided file)

// Initial Data

const INITIAL_STAFF = [

{ id: 1, name: 'Jonathan Malefho', position: 'Audit Manager', level: 'Manager', hourlyRate: 800, isActive: true },

{ id: 2, name: 'David Moeti', position: 'Audit Manager', level: 'Manager', hourlyRate: 800, isActive: true },

{ id: 3, name: 'Sarah Smith', position: 'Audit Senior', level: 'Senior', hourlyRate: 500, isActive: true },

{ id: 4, name: 'Mike Johnson', position: 'Audit Senior', level: 'Senior', hourlyRate: 500, isActive: true },

{ id: 5, name: 'Sarah Keabetswe', position: 'Tax Manager', level: 'Tax Manager', hourlyRate: 850, isActive: true },

{ id: 6, name: 'Mpho Kgosana', position: 'Tax Manager', level: 'Tax Manager', hourlyRate: 850, isActive: true }

];

const AUDIT_STAGES = [

{ id: 'acceptance', name: 'Acceptance Stage', order: 1 },

{ id: 'planning', name: 'Planning Stage', order: 2 },

{ id: 'fieldwork', name: 'Fieldwork Stage', order: 3 },

{ id: 'completion', name: 'Completion Stage', order: 4 },

{ id: 'lockdown', name: 'Lockdown Stage', order: 5, maxDays: 60 }

];

const DEFAULT_TASKS = {

acceptance: [

{ name: 'Client acceptance evaluation', defaultHours: 8 },

{ name: 'Engagement letter', defaultHours: 4 },

{ name: 'Independence assessment', defaultHours: 4 },

{ name: 'Conflict check', defaultHours: 2 }

],

planning: [

{ name: 'Understanding entity', defaultHours: 24 },

{ name: 'Risk assessment', defaultHours: 16 },

{ name: 'Materiality', defaultHours: 8 },

{ name: 'Audit strategy', defaultHours: 16 },

{ name: 'Internal controls', defaultHours: 20 }

],

fieldwork: [

{ name: 'Test of controls', defaultHours: 40 },

{ name: 'Revenue procedures', defaultHours: 32 },

{ name: 'Expense procedures', defaultHours: 28 },

{ name: 'Assets procedures', defaultHours: 36 },

{ name: 'Liabilities procedures', defaultHours: 32 },

{ name: 'Analytical procedures', defaultHours: 16 },

{ name: 'Inventory observation', defaultHours: 16 },

{ name: 'Cash confirmations', defaultHours: 8 }

],

completion: [

{ name: 'Subsequent events', defaultHours: 8 },

{ name: 'Going concern', defaultHours: 12 },

{ name: 'Final analytics', defaultHours: 12 },

{ name: 'Adjustments', defaultHours: 16 },

{ name: 'FS review', defaultHours: 20 },

{ name: 'Report drafting', defaultHours: 12 },

{ name: 'File assembly', defaultHours: 8 }

],

lockdown: [

{ name: 'Final file review', defaultHours: 8 },

{ name: 'Archive preparation', defaultHours: 4 },

{ name: 'Quality control review', defaultHours: 12 },

{ name: 'Post-audit procedures', defaultHours: 4 }

]

};

const INITIAL_ENGAGEMENTS = [

{

id: 1,

clientName: "ABC Mining Ltd",

yearEnd: "2024-12-31",

auditStartDate: "2025-01-15",

budgetedFee: 500000,

actualWIP: 0,

pieStatus: "Yes",

taxServices: "Yes",

taxManager: "Sarah Keabetswe",

statutoryReturns: "Yes",

stockCount: "Yes",

manager: "Jonathan Malefho",

senior: "Sarah Smith",

budgetedHours: 0,

actualHours: 0,

status: "Planning",

riskRating: "High",

notes: "",

teamMembers: [],

billings: [],

completionDate: "2025-03-15",

tasks: []

},

{

id: 2,

clientName: "Retail Corp Pty",

yearEnd: "2024-06-30",

auditStartDate: "2024-07-10",

budgetedFee: 280000,

actualWIP: 0,

pieStatus: "No",

taxServices: "Yes",

taxManager: "Mpho Kgosana",

statutoryReturns: "Yes",

stockCount: "Yes",

manager: "David Moeti",

senior: "Mike Johnson",

budgetedHours: 0,

actualHours: 0,

status: "Planning",

riskRating: "Medium",

notes: "",

teamMembers: [],

billings: [],

completionDate: "2024-09-20",

tasks: []

},

{

id: 3,

clientName: "Tech Solutions Ltd",

yearEnd: "2024-12-31",

auditStartDate: "2026-01-10",

budgetedFee: 420000,

actualWIP: 0,

pieStatus: "Yes",

taxServices: "No",

taxManager: "",

statutoryReturns: "Yes",

stockCount: "No",

manager: "Jonathan Malefho",

senior: "John Doe",

budgetedHours: 0,

actualHours: 0,

status: "Planning",

riskRating: "Medium",

notes: "",

teamMembers: [],

billings: [],

completionDate: "2026-04-30",

tasks: []

}

];

// Helper Functions

const calculateLockdownDeadline = (completionDate) => {

if (!completionDate) return null;

const date = new Date(completionDate);

date.setDate(date.getDate() + 60);

return date.toISOString().split('T')[0];

};

const calculateDeadline = (yearEnd, months) => {

if (!yearEnd) return '';

const date = new Date(yearEnd);

date.setMonth(date.getMonth() + months);

return date.toISOString().split('T')[0];

};

const isDeadlineApproaching = (deadline) => {

if (!deadline) return false;

const diffDays = Math.floor((new Date(deadline) - new Date()) / (1000 * 60 * 60 * 24));

return diffDays <= 30 && diffDays >= 0;

};

const isDeadlineOverdue = (deadline) => {

return deadline ? new Date(deadline) < new Date() : false;

};

const calculateHoursPerformance = (budgeted, actual) => {

if (!budgeted || budgeted === 0) return { percent: 0, status: 'unknown', color: '#999', label: 'N/A' };

const ratio = actual / budgeted;

const percent = (ratio * 100).toFixed(1);

if (ratio <= 0.9) return { percent, status: 'excellent', color: '#28A745', label: 'Efficient âœ“' };

else if (ratio <= 1.1) return { percent, status: 'good', color: '#FFC107', label: 'On Target' };

else return { percent, status: 'poor', color: '#DC3545', label: 'Inefficient âœ—' };

};

// Main App Component

function App() {

const [user, setUser] = useState(null);

const [currentView, setCurrentView] = useState('dashboard');

// CRITICAL FIX: Load from localStorage on mount, save on changes

const [engagements, setEngagements] = useState(() => {

try {

const saved = localStorage.getItem('auditEngagements');

return saved ? JSON.parse(saved) : INITIAL_ENGAGEMENTS;

} catch (err) {

return INITIAL_ENGAGEMENTS;

}

});

// Save to localStorage whenever engagements change

useEffect(() => {

try {

localStorage.setItem('auditEngagements', JSON.stringify(engagements));

} catch (err) {

console.warn('Failed to save engagements to localStorage', err);

}

}, [engagements]);

const [staff, setStaff] = useState(INITIAL_STAFF);

const [filterType, setFilterType] = useState(null);

const [filterData, setFilterData] = useState(null);

const handleLogin = (userData) => {

setUser(userData);

};

const handleNavigate = (view) => {

setCurrentView(view);

setFilterType(null);

setFilterData(null);

};

const handleDrillDown = (type, data) => {

setFilterType(type);

setFilterData(data);

setCurrentView('engagements');

};

if (!user) {

return h(LoginPage, { onLogin: handleLogin });

}

// Show module dashboard if on 'dashboard' view

if (currentView === 'dashboard') {

return h('div', null,

// Top Navigation

h('div', { className: 'top-nav' },

h('div', { className: 'top-nav-content' },

h('div', { className: 'nav-brand' },

h('div', null,

h('div', { className: 'nav-logo' }, 'ðŸ”· Audit Practice Manager'),

h('div', { className: 'nav-logo-subtitle' }, 'Forvis Mazars Botswana')

)

),

h('div', { className: 'nav-user' },

h('div', { style: { textAlign: 'right' } },

h('div', { className: 'user-name' }, user.name),

h('div', { className: 'user-role' }, user.role)

),

h('div', { className: 'user-avatar' }, user.name.charAt(0)),

h('button', {

className: 'logout-btn',

onClick: async () => {

try {

await window.supabase.auth.signOut();

} catch (err) {

console.warn('supabase signOut failed or stubbed', err);

}

setUser(null);

}

}, 'Logout')

)

)

),

// Main Content

h('div', { className: 'app-container' },

h('div', { className: 'main-content' },

// Welcome Banner

h('div', { className: 'welcome-banner' },

h('h1', { className: 'welcome-title' }, 'Welcome to Audit Practice Manager, ' + user.name.split(' ')[0]),

h('p', { className: 'welcome-subtitle' },

'Streamline your audit workflow, manage budgets, track progress, and optimize resources - all in one place.'

)

),

// Modules Grid

h('div', null,

h('h2', { style: { fontSize: '24px', fontWeight: '700', marginBottom: '24px', color: '#2C3E50' } },

'Audit Workspace'

),

h('div', { className: 'modules-grid' },

// Engagements Module

h('div', {

className: 'module-card',

onClick: () => setCurrentView('engagements')

},

h('div', { className: 'module-card-image' }, 'ðŸ“‹'),

h('div', { className: 'module-card-content' },

h('h3', { className: 'module-card-title' }, 'Engagements'),

h('p', { className: 'module-card-description' },

'Manage all audit engagements, track progress, and monitor key dates. View detailed information and status for each client engagement.'

),

h('span', { className: 'module-card-action' },

'Open module â†’'

)

)

),

// Budget Builder Module

h('div', {

className: 'module-card',

onClick: () => setCurrentView('budget')

},

h('div', { className: 'module-card-image' }, 'ðŸ’°'),

h('div', { className: 'module-card-content' },

h('h3', { className: 'module-card-title' }, 'Budget Builder'),

h('p', { className: 'module-card-description' },

'Create detailed engagement budgets by audit stage and task. Allocate staff resources and track budget vs actual performance.'

),

h('span', { className: 'module-card-action' },

'Open module â†’'

)

)

