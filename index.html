<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audit Practice Manager - Forvis Mazars Botswana</title>
  
  <!-- Supabase JavaScript Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif; 
      background: #F5F7FA; 
      color: #2C3E50;
    }
    
    /* Top Navigation Bar - Forvis Mazars Style */
    .top-nav {
      background: linear-gradient(135deg, #0052A3 0%, #003D7A 100%);
      color: white;
      padding: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      height: 70px;
    }
    
    .top-nav-content {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 32px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .nav-brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .nav-logo {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    .nav-logo-subtitle {
      font-size: 13px;
      opacity: 0.9;
      font-weight: 400;
    }
    
    .nav-user {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .user-avatar:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }
    
    .user-name {
      font-size: 14px;
      font-weight: 500;
    }
    
    .user-role {
      font-size: 12px;
      opacity: 0.8;
    }
    
    .logout-btn {
      padding: 8px 20px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      color: white;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.25);
      border-color: rgba(255,255,255,0.5);
    }
    
    /* Main Content Area */
    .app-container { 
      padding-top: 70px;
    }
    
    .main-content { 
      max-width: 1600px; 
      margin: 0 auto;
      padding: 40px 32px;
    }
    
    /* Welcome Section */
    .welcome-banner {
      background: linear-gradient(135deg, #0052A3 0%, #00408A 100%);
      border-radius: 16px;
      padding: 48px;
      margin-bottom: 40px;
      color: white;
      box-shadow: 0 4px 20px rgba(0,82,163,0.2);
      position: relative;
      overflow: hidden;
    }
    
    .welcome-banner::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
    }
    
    .welcome-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
    }
    
    .welcome-subtitle {
      font-size: 16px;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }
    
    /* Module Cards Grid */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }
    
    .module-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      border: 1px solid #E8EBF0;
    }
    
    .module-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 28px rgba(0,0,0,0.12);
      border-color: #0052A3;
    }
    
    .module-card-image {
      width: 100%;
      height: 160px;
      background: linear-gradient(135deg, #0052A3 0%, #00408A 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      position: relative;
      overflow: hidden;
    }
    
    .module-card-image::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    }
    
    .module-card-content {
      padding: 24px;
    }
    
    .module-card-title {
      font-size: 20px;
      font-weight: 700;
      color: #2C3E50;
      margin-bottom: 12px;
    }
    
    .module-card-description {
      font-size: 14px;
      color: #64748B;
      line-height: 1.6;
      margin-bottom: 20px;
    }
    
    .module-card-action {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #0052A3;
      font-weight: 600;
      font-size: 14px;
      text-decoration: none;
      transition: gap 0.2s;
    }
    
    .module-card:hover .module-card-action {
      gap: 12px;
    }
    
    .page-header { 
      margin-bottom: 32px; 
    }
    
    .page-title { 
      font-size: 28px; 
      font-weight: 700; 
      color: #2C3E50;
      margin-bottom: 8px;
    }
    
    .page-subtitle {
      font-size: 14px;
      color: #64748B;
    }
    
    /* Buttons */
    .btn { 
      padding: 12px 24px; 
      border-radius: 8px; 
      border: none; 
      font-weight: 600; 
      font-size: 14px; 
      cursor: pointer; 
      transition: all 0.2s; 
      font-family: 'Segoe UI', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary { 
      background: #0052A3; 
      color: white; 
    }
    
    .btn-primary:hover { 
      background: #003D7A; 
      transform: translateY(-2px); 
      box-shadow: 0 4px 12px rgba(0,82,163,0.3); 
    }
    
    .btn-secondary { 
      background: #E8EBF0; 
      color: #2C3E50; 
    }
    
    .btn-secondary:hover {
      background: #D1D5DB;
    }
    
    /* Cards */
    .card { 
      background: white; 
      border-radius: 12px; 
      padding: 24px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
      margin-bottom: 24px;
      border: 1px solid #E8EBF0;
    }
    
    .metric-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
      gap: 20px; 
      margin-bottom: 32px; 
    }
    
    .metric-card { 
      background: white; 
      border-radius: 12px; 
      padding: 24px; 
      box-shadow: 0 2px 12px rgba(0,0,0,0.06); 
      border-left: 4px solid; 
      cursor: pointer; 
      transition: all 0.3s;
      border: 1px solid #E8EBF0;
    }
    
    .metric-card:hover { 
      transform: translateY(-4px); 
      box-shadow: 0 8px 24px rgba(0,0,0,0.12); 
    }
    
    .metric-label { 
      font-size: 13px; 
      color: #64748B; 
      margin-bottom: 8px; 
      font-weight: 500; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .metric-value { 
      font-size: 32px; 
      font-weight: 700; 
      margin-bottom: 4px; 
    }
    
    .metric-detail { 
      font-size: 12px; 
      color: #94A3B8; 
    }
    
    .alert-badge { 
      position: absolute; 
      top: 12px; 
      right: 12px; 
      background: #DC3545; 
      color: white; 
      width: 24px; 
      height: 24px; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 12px; 
      font-weight: 700; 
    }
    
    /* Tables */
    table { 
      width: 100%; 
      border-collapse: collapse; 
    }
    
    thead { 
      background: #F8FAFC; 
    }
    
    th { 
      padding: 14px 16px; 
      text-align: left; 
      font-weight: 600; 
      font-size: 12px; 
      color: #64748B; 
      border-bottom: 2px solid #E8EBF0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    td { 
      padding: 16px; 
      border-bottom: 1px solid #F1F5F9; 
      font-size: 14px; 
    }
    
    tr:hover { 
      background: #F8FAFC; 
    }
    
    .status-badge { 
      padding: 6px 12px; 
      border-radius: 12px; 
      font-size: 12px; 
      font-weight: 600; 
      display: inline-block; 
    }
    
    /* Modal */
    .modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.5); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 1000; 
      padding: 20px;
      backdrop-filter: blur(4px);
    }
    
    .modal-content { 
      background: white; 
      border-radius: 16px; 
      max-width: 900px; 
      width: 100%; 
      max-height: 90vh; 
      overflow-y: auto; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
    }
    
    .modal-header { 
      padding: 28px 32px; 
      border-bottom: 1px solid #E8EBF0; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      background: #F8FAFC;
    }
    
    .modal-title { 
      font-size: 24px; 
      font-weight: 700; 
      color: #2C3E50; 
    }
    
    .modal-body { 
      padding: 32px; 
    }
    
    .modal-footer { 
      padding: 24px 32px; 
      border-top: 1px solid #E8EBF0; 
      display: flex; 
      gap: 12px; 
      justify-content: flex-end;
      background: #F8FAFC;
    }
    
    .close-btn { 
      background: none; 
      border: none; 
      font-size: 28px; 
      color: #94A3B8; 
      cursor: pointer; 
      width: 40px; 
      height: 40px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      border-radius: 8px; 
      transition: all 0.2s; 
    }
    
    .close-btn:hover { 
      background: #E8EBF0; 
      color: #2C3E50; 
    }
    
    /* Forms */
    .form-group { 
      margin-bottom: 20px; 
    }
    
    .form-label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600; 
      font-size: 14px; 
      color: #2C3E50; 
    }
    
    .form-input { 
      width: 100%; 
      padding: 12px 16px; 
      border: 2px solid #E8EBF0; 
      border-radius: 8px; 
      font-size: 14px; 
      font-family: 'Segoe UI', sans-serif; 
      transition: all 0.2s;
      background: white;
    }
    
    .form-input:focus { 
      outline: none; 
      border-color: #0052A3;
      box-shadow: 0 0 0 3px rgba(0,82,163,0.1);
    }
    
    .form-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 16px; 
    }
    
    .section-title { 
      font-size: 18px; 
      font-weight: 700; 
      color: #0052A3; 
      margin: 32px 0 20px 0; 
      padding-bottom: 12px; 
      border-bottom: 2px solid #E8EBF0; 
    }
    
    /* Progress bars */
    .progress-bar { 
      width: 100%; 
      height: 8px; 
      background: #E8EBF0; 
      border-radius: 4px; 
      overflow: hidden; 
      margin-top: 8px; 
    }
    
    .progress-fill { 
      height: 100%; 
      background: linear-gradient(90deg, #0052A3 0%, #00408A 100%); 
      transition: width 0.3s; 
    }
    
    /* Empty state */
    .empty-state { 
      text-align: center; 
      padding: 60px 20px; 
      color: #94A3B8; 
    }
    
    .empty-state-icon { 
      font-size: 64px; 
      margin-bottom: 16px; 
      opacity: 0.3; 
    }
    
    /* Sidebar (kept for backward compatibility but hidden) */
    .sidebar { display: none; }
    .app-container { display: block; }
    
    /* Utility classes */
    .text-primary { color: #0052A3; }
    .bg-primary { background: #0052A3; }
    .text-secondary { color: #64748B; }
    .bg-secondary { background: #F8FAFC; }
    
    /* Enhanced Stage Tabs - Individual Colors */
    .stage-tab-enhanced { 
      padding: 12px 18px; 
      border: 2px solid #E0E0E0;
      font-weight: 600; 
      font-size: 13px; 
      cursor: pointer; 
      border-radius: 8px;
      margin-right: 6px;
      transition: all 0.2s ease;
      background: white;
      color: #666;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .stage-tab-enhanced:hover { 
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    .stage-tab-enhanced.acceptance { border-color: #28A745; color: #28A745; }
    .stage-tab-enhanced.acceptance.active { background: #28A745; color: white; border-color: #28A745; }
    
    .stage-tab-enhanced.planning { border-color: #4472C4; color: #4472C4; }
    .stage-tab-enhanced.planning.active { background: #4472C4; color: white; border-color: #4472C4; }
    
    .stage-tab-enhanced.fieldwork { border-color: #FFC107; color: #F59E0B; }
    .stage-tab-enhanced.fieldwork.active { background: #FFC107; color: #fff; border-color: #FFC107; }
    
    .stage-tab-enhanced.completion { border-color: #ED7D31; color: #ED7D31; }
    .stage-tab-enhanced.completion.active { background: #ED7D31; color: white; border-color: #ED7D31; }
    
    .stage-tab-enhanced.lockdown { border-color: #DC3545; color: #DC3545; }
    .stage-tab-enhanced.lockdown.active { background: #DC3545; color: white; border-color: #DC3545; }
    
    .stage-tab-enhanced .tab-count {
      display: inline-block;
      background: rgba(0,0,0,0.1);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
      margin-left: 4px;
      font-weight: 700;
    }
    .stage-tab-enhanced.active .tab-count {
      background: rgba(255,255,255,0.3);
    }
    
    /* Enhanced Task Table */
    .task-table-enhanced { 
      width: 100%; 
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 20px;
    }
    .task-table-enhanced thead { 
      background: linear-gradient(135deg, #1F4E78 0%, #2d5a8a 100%);
    }
    .task-table-enhanced th { 
      padding: 16px 12px; 
      text-align: left; 
      font-weight: 600; 
      font-size: 13px; 
      color: white;
      border: none;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .task-table-enhanced th:first-child { border-radius: 8px 0 0 0; }
    .task-table-enhanced th:last-child { border-radius: 0 8px 0 0; }
    .task-table-enhanced td { 
      padding: 16px 12px; 
      border-bottom: 1px solid #F0F0F0; 
      font-size: 14px;
      background: white;
    }
    .task-table-enhanced tr:hover td { 
      background: #F8F9FA;
    }
    .task-table-enhanced tr:last-child td:first-child { border-radius: 0 0 0 8px; }
    .task-table-enhanced tr:last-child td:last-child { border-radius: 0 0 8px 0; }
    
    /* Enhanced Status Badges */
    .status-badge-enhanced {
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status-badge-enhanced.completed {
      background: linear-gradient(135deg, #28A745 0%, #20c997 100%);
      color: white;
    }
    .status-badge-enhanced.in-progress {
      background: linear-gradient(135deg, #4472C4 0%, #5a9fd4 100%);
      color: white;
    }
    .status-badge-enhanced.not-started {
      background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
      color: white;
    }
    .status-badge-enhanced::before {
      content: '‚óè';
      font-size: 8px;
    }
    
    /* Action Buttons Enhanced */
    .action-btn-enhanced {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .action-btn-enhanced.edit {
      background: linear-gradient(135deg, #4472C4 0%, #5a9fd4 100%);
      color: white;
    }
    .action-btn-enhanced.delete {
      background: linear-gradient(135deg, #DC3545 0%, #e85362 100%);
      color: white;
    }
    .action-btn-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .action-btn-enhanced:active {
      transform: translateY(0);
    }
    
    /* Hour Adjustment Badge */
    .hour-adjustment {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      background: #FFF3E0;
      color: #856404;
      font-weight: 600;
    }
    
    /* Enhanced Table Buttons */
    .table-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .table-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    .table-btn:active {
      transform: translateY(0);
    }
    .table-btn.manage {
      background: linear-gradient(135deg, #1F4E78 0%, #4472C4 100%);
      color: white;
    }
    .table-btn.view {
      background: linear-gradient(135deg, #28A745 0%, #20c997 100%);
      color: white;
    }
    .table-btn.edit {
      background: linear-gradient(135deg, #FFC107 0%, #FFD54F 100%);
      color: #333;
    }
    
    /* Enhanced View Tabs */
    .view-tab {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      background: #F5F5F5;
      color: #666;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-right: 8px;
      border: 2px solid transparent;
    }
    .view-tab:hover {
      background: #E8E8E8;
      transform: translateY(-1px);
    }
    .view-tab.active {
      background: linear-gradient(135deg, #1F4E78 0%, #4472C4 100%);
      color: white;
      box-shadow: 0 3px 8px rgba(31, 78, 120, 0.3);
      border-color: #1F4E78;
    }
    
    /* Lockdown Warning Enhanced */
    .lockdown-warning-enhanced {
      background: linear-gradient(135deg, #FFF3E0 0%, #FFE8B3 100%);
      border-left: 4px solid #FFC107;
      padding: 16px 20px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
      color: #856404;
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
      display: flex;
      align-items: start;
      gap: 12px;
    }
    .lockdown-warning-enhanced .icon {
      font-size: 24px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
<script>
    // ============================================
    // SUPABASE CONFIGURATION
    // ============================================
    
    const SUPABASE_URL = 'https://bkguwgviimksfwtpygnx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrZ3V3Z3ZpaW1rc2Z3dHB5Z254Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNzQ3ODQsImV4cCI6MjA4NjY1MDc4NH0.ctTILmxLO5yd5YdoosmNGeZK2TZoPpASFq9Bw1T4xXc';
    
    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    console.log('‚úÖ Supabase client initialized');
    console.log('üîó Connected to:', SUPABASE_URL);
    
    // ============================================
    // REACT SETUP
    // ============================================
    const { useState, useEffect, createElement: h } = React;
    const { createRoot } = ReactDOM;

    // Initial Data
    const INITIAL_STAFF = [
      { id: 1, name: 'Jonathan Malefho', position: 'Audit Manager', level: 'Manager', hourlyRate: 800, isActive: true },
      { id: 2, name: 'David Moeti', position: 'Audit Manager', level: 'Manager', hourlyRate: 800, isActive: true },
      { id: 3, name: 'Sarah Smith', position: 'Audit Senior', level: 'Senior', hourlyRate: 500, isActive: true },
      { id: 4, name: 'Mike Johnson', position: 'Audit Senior', level: 'Senior', hourlyRate: 500, isActive: true },
      { id: 5, name: 'Sarah Keabetswe', position: 'Tax Manager', level: 'Tax Manager', hourlyRate: 850, isActive: true },
      { id: 6, name: 'Mpho Kgosana', position: 'Tax Manager', level: 'Tax Manager', hourlyRate: 850, isActive: true }
    ];

    const AUDIT_STAGES = [
      { id: 'acceptance', name: 'Acceptance Stage', order: 1 },
      { id: 'planning', name: 'Planning Stage', order: 2 },
      { id: 'fieldwork', name: 'Fieldwork Stage', order: 3 },
      { id: 'completion', name: 'Completion Stage', order: 4 },
      { id: 'lockdown', name: 'Lockdown Stage', order: 5, maxDays: 60 }
    ];

    const DEFAULT_TASKS = {
      acceptance: [
        { name: 'Client acceptance evaluation', defaultHours: 8 },
        { name: 'Engagement letter', defaultHours: 4 },
        { name: 'Independence assessment', defaultHours: 4 },
        { name: 'Conflict check', defaultHours: 2 }
      ],
      planning: [
        { name: 'Understanding entity', defaultHours: 24 },
        { name: 'Risk assessment', defaultHours: 16 },
        { name: 'Materiality', defaultHours: 8 },
        { name: 'Audit strategy', defaultHours: 16 },
        { name: 'Internal controls', defaultHours: 20 }
      ],
      fieldwork: [
        { name: 'Test of controls', defaultHours: 40 },
        { name: 'Revenue procedures', defaultHours: 32 },
        { name: 'Expense procedures', defaultHours: 28 },
        { name: 'Assets procedures', defaultHours: 36 },
        { name: 'Liabilities procedures', defaultHours: 32 },
        { name: 'Analytical procedures', defaultHours: 16 },
        { name: 'Inventory observation', defaultHours: 16 },
        { name: 'Cash confirmations', defaultHours: 8 }
      ],
      completion: [
        { name: 'Subsequent events', defaultHours: 8 },
        { name: 'Going concern', defaultHours: 12 },
        { name: 'Final analytics', defaultHours: 12 },
        { name: 'Adjustments', defaultHours: 16 },
        { name: 'FS review', defaultHours: 20 },
        { name: 'Report drafting', defaultHours: 12 },
        { name: 'File assembly', defaultHours: 8 }
      ],
      lockdown: [
        { name: 'Final file review', defaultHours: 8 },
        { name: 'Archive preparation', defaultHours: 4 },
        { name: 'Quality control review', defaultHours: 12 },
        { name: 'Post-audit procedures', defaultHours: 4 }
      ]
    };

    const INITIAL_ENGAGEMENTS = [
      {
        id: 1, 
        clientName: "ABC Mining Ltd", 
        yearEnd: "2024-12-31", 
        auditStartDate: "2025-01-15",
        budgetedFee: 500000, 
        actualWIP: 0, 
        pieStatus: "Yes", 
        taxServices: "Yes",
        taxManager: "Sarah Keabetswe", 
        statutoryReturns: "Yes", 
        stockCount: "Yes",
        manager: "Jonathan Malefho", 
        senior: "Sarah Smith", 
        budgetedHours: 0, 
        actualHours: 0,
        status: "Planning", 
        riskRating: "High", 
        notes: "",
        teamMembers: [],
        billings: [],
        completionDate: "2025-03-15",
        tasks: []
      },
      {
        id: 2, 
        clientName: "Retail Corp Pty", 
        yearEnd: "2024-06-30", 
        auditStartDate: "2024-07-10",
        budgetedFee: 280000, 
        actualWIP: 0, 
        pieStatus: "No", 
        taxServices: "Yes",
        taxManager: "Mpho Kgosana", 
        statutoryReturns: "Yes", 
        stockCount: "Yes",
        manager: "David Moeti", 
        senior: "Mike Johnson", 
        budgetedHours: 0, 
        actualHours: 0,
        status: "Planning", 
        riskRating: "Medium", 
        notes: "",
        teamMembers: [],
        billings: [],
        completionDate: "2024-09-20",
        tasks: []
      },
      {
        id: 3, 
        clientName: "Tech Solutions Ltd", 
        yearEnd: "2024-12-31", 
        auditStartDate: "2026-01-10",
        budgetedFee: 420000, 
        actualWIP: 0, 
        pieStatus: "Yes", 
        taxServices: "No",
        taxManager: "", 
        statutoryReturns: "Yes", 
        stockCount: "No",
        manager: "Jonathan Malefho", 
        senior: "John Doe", 
        budgetedHours: 0, 
        actualHours: 0,
        status: "Planning", 
        riskRating: "Medium", 
        notes: "",
        teamMembers: [],
        billings: [],
        completionDate: "2026-04-30",
        tasks: []
      }
    ];

    // Helper Functions
    const calculateLockdownDeadline = (completionDate) => {
      if (!completionDate) return null;
      const date = new Date(completionDate);
      date.setDate(date.getDate() + 60);
      return date.toISOString().split('T')[0];
    };
    const calculateDeadline = (yearEnd, months) => {
      if (!yearEnd) return '';
      const date = new Date(yearEnd);
      date.setMonth(date.getMonth() + months);
      return date.toISOString().split('T')[0];
    };

    const isDeadlineApproaching = (deadline) => {
      if (!deadline) return false;
      const diffDays = Math.floor((new Date(deadline) - new Date()) / (1000 * 60 * 60 * 24));
      return diffDays <= 30 && diffDays >= 0;
    };

    const isDeadlineOverdue = (deadline) => {
      return deadline ? new Date(deadline) < new Date() : false;
    };

    const calculateHoursPerformance = (budgeted, actual) => {
      if (!budgeted || budgeted === 0) return { percent: 0, status: 'unknown', color: '#999', label: 'N/A' };
      const ratio = actual / budgeted;
      const percent = (ratio * 100).toFixed(1);
      if (ratio <= 0.9) return { percent, status: 'excellent', color: '#28A745', label: 'Efficient ‚úì' };
      else if (ratio <= 1.1) return { percent, status: 'good', color: '#FFC107', label: 'On Target' };
      else return { percent, status: 'poor', color: '#DC3545', label: 'Inefficient ‚úó' };
    };

    // Main App Component
    function App() {
      const [user, setUser] = useState(null);
      const [currentView, setCurrentView] = useState('dashboard');
      // CRITICAL FIX: Load from localStorage on mount, save on changes
      const [engagements, setEngagements] = useState(() => {
        const saved = localStorage.getItem('auditEngagements');
        return saved ? JSON.parse(saved) : INITIAL_ENGAGEMENTS;
      });
      
      // Save to localStorage whenever engagements change
      useEffect(() => {
        localStorage.setItem('auditEngagements', JSON.stringify(engagements));
      }, [engagements]);
      const [staff, setStaff] = useState(INITIAL_STAFF);
      const [filterType, setFilterType] = useState(null);
      const [filterData, setFilterData] = useState(null);

      const handleLogin = (userData) => {
        setUser(userData);
      };

      const handleNavigate = (view) => {
        setCurrentView(view);
        setFilterType(null);
        setFilterData(null);
      };

      const handleDrillDown = (type, data) => {
        setFilterType(type);
        setFilterData(data);
        setCurrentView('engagements');
      };

      if (!user) {
        return h(LoginPage, { onLogin: handleLogin });
      }

      // Show module dashboard if on 'dashboard' view
      if (currentView === 'dashboard') {
        return h('div', null,
          // Top Navigation
          h('div', { className: 'top-nav' },
            h('div', { className: 'top-nav-content' },
              h('div', { className: 'nav-brand' },
                h('div', null,
                  h('div', { className: 'nav-logo' }, 'üî∑ Audit Practice Manager'),
                  h('div', { className: 'nav-logo-subtitle' }, 'Forvis Mazars Botswana')
                )
              ),
              h('div', { className: 'nav-user' },
                h('div', { style: { textAlign: 'right' } },
                  h('div', { className: 'user-name' }, user.name),
                  h('div', { className: 'user-role' }, user.role)
                ),
                h('div', { className: 'user-avatar' }, user.name.charAt(0)),
                h('button', { 
                  className: 'logout-btn',
                  onClick: async () => {
                    await supabase.auth.signOut();
                    setUser(null);
                  }
                }, 'Logout')
              )
            )
          ),
          
          // Main Content
          h('div', { className: 'app-container' },
            h('div', { className: 'main-content' },
              // Welcome Banner
              h('div', { className: 'welcome-banner' },
                h('h1', { className: 'welcome-title' }, 'Welcome to Audit Practice Manager, ' + user.name.split(' ')[0]),
                h('p', { className: 'welcome-subtitle' }, 
                  'Streamline your audit workflow, manage budgets, track progress, and optimize resources - all in one place.'
                )
              ),
              
              // Modules Grid
              h('div', null,
                h('h2', { style: { fontSize: '24px', fontWeight: '700', marginBottom: '24px', color: '#2C3E50' } }, 
                  'Audit Workspace'
                ),
                h('div', { className: 'modules-grid' },
                  // Engagements Module
                  h('div', { 
                    className: 'module-card',
                    onClick: () => setCurrentView('engagements')
                  },
                    h('div', { className: 'module-card-image' }, 'üìã'),
                    h('div', { className: 'module-card-content' },
                      h('h3', { className: 'module-card-title' }, 'Engagements'),
                      h('p', { className: 'module-card-description' }, 
                        'Manage all audit engagements, track progress, and monitor key dates. View detailed information and status for each client engagement.'
                      ),
                      h('span', { className: 'module-card-action' }, 
                        'Open module ‚Üí'
                      )
                    )
                  ),
                  
                  // Budget Builder Module
                  h('div', { 
                    className: 'module-card',
                    onClick: () => setCurrentView('budget')
                  },
                    h('div', { className: 'module-card-image' }, 'üí∞'),
                    h('div', { className: 'module-card-content' },
                      h('h3', { className: 'module-card-title' }, 'Budget Builder'),
                      h('p', { className: 'module-card-description' }, 
                        'Create detailed engagement budgets by audit stage and task. Allocate staff resources and track budget vs actual performance.'
                      ),
                      h('span', { className: 'module-card-action' }, 
                        'Open module ‚Üí'
                      )
                    )
                  ),
                  
                  // Budget Approvals Module
                  h('div', { 
                    className: 'module-card',
                    onClick: () => setCurrentView('budgetApprovals')
                  },
                    h('div', { className: 'module-card-image' }, '‚úì'),
                    h('div', { className: 'module-card-content' },
                      h('h3', { className: 'module-card-title' }, 'Budget Approvals'),
                      h('p', { className: 'module-card-description' }, 
                        'Review and approve engagement budgets. Process unlock requests and manage budget modifications with full audit trail.'
                      ),
                      h('span', { className: 'module-card-action' }, 
                        'Open module ‚Üí'
                      )
                    )
                  ),
                  
                  // Analytics Module
                  h('div', { 
                    className: 'module-card',
                    onClick: () => setCurrentView('analytics')
                  },
                    h('div', { className: 'module-card-image' }, 'üìä'),
                    h('div', { className: 'module-card-content' },
                      h('h3', { className: 'module-card-title' }, 'Analytics'),
                      h('p', { className: 'module-card-description' }, 
                        'Analyze budget vs actual WIP by engagement, stage, task, and individual. Import actual hours and track performance metrics.'
                      ),
                      h('span', { className: 'module-card-action' }, 
                        'Open module ‚Üí'
                      )
                    )
                  ),
                  
                  // Resource Optimization Module
                  h('div', { 
                    className: 'module-card',
                    onClick: () => setCurrentView('resources')
                  },
                    h('div', { className: 'module-card-image' }, 'üìà'),
                    h('div', { className: 'module-card-content' },
                      h('h3', { className: 'module-card-title' }, 'Resource Optimization'),
                      h('p', { className: 'module-card-description' }, 
                        'Optimize staff allocation, visualize capacity planning, and balance workload across team members for maximum efficiency.'
                      ),
                      h('span', { className: 'module-card-action' }, 
                        'Open module ‚Üí'
                      )
                    )
                  ),
                  
                  // Staff Management Module
                  h('div', { 
                    className: 'module-card',
                    onClick: () => setCurrentView('staff')
                  },
                    h('div', { className: 'module-card-image' }, 'üë•'),
                    h('div', { className: 'module-card-content' },
                      h('h3', { className: 'module-card-title' }, 'Staff Management'),
                      h('p', { className: 'module-card-description' }, 
                        'Manage team members, track hourly rates, monitor assignments, and view individual workload across all engagements.'
                      ),
                      h('span', { className: 'module-card-action' }, 
                        'Open module ‚Üí'
                      )
                    )
                  ),
                  
                  // Billing Module
                  h('div', { 
                    className: 'module-card',
                    onClick: () => setCurrentView('billing')
                  },
                    h('div', { className: 'module-card-image' }, 'üí≥'),
                    h('div', { className: 'module-card-content' },
                      h('h3', { className: 'module-card-title' }, 'Billing'),
                      h('p', { className: 'module-card-description' }, 
                        'Track billings, manage invoices, monitor payment status, and generate billing reports for all client engagements.'
                      ),
                      h('span', { className: 'module-card-action' }, 
                        'Open module ‚Üí'
                      )
                    )
                  )
                )
              )
            )
          )
        );
      }

      // Module views with top nav
      return h('div', null,
        // Top Navigation
        h('div', { className: 'top-nav' },
          h('div', { className: 'top-nav-content' },
            h('div', { className: 'nav-brand', onClick: () => setCurrentView('dashboard'), style: { cursor: 'pointer' } },
              h('div', null,
                h('div', { className: 'nav-logo' }, 'üî∑ Audit Practice Manager'),
                h('div', { className: 'nav-logo-subtitle' }, 'Forvis Mazars Botswana')
              )
            ),
            h('div', { className: 'nav-user' },
              h('div', { style: { textAlign: 'right' } },
                h('div', { className: 'user-name' }, user.name),
                h('div', { className: 'user-role' }, user.role)
              ),
              h('div', { className: 'user-avatar' }, user.name.charAt(0)),
              h('button', { 
                className: 'logout-btn',
                onClick: async () => {
                  await supabase.auth.signOut();
                  setUser(null);
                }
              }, 'Logout')
            )
          )
        ),
        
        // Main Content
        h('div', { className: 'app-container' },
          h('div', { className: 'main-content' },
            currentView === 'engagements' && h(EngagementsView, { engagements, staff, filterType, filterData, onUpdate: setEngagements }),
            currentView === 'analytics' && h(AnalyticsView, { engagements, staff, onUpdate: setEngagements }),
            currentView === 'staff' && h(StaffView, { staff, engagements, onUpdate: setStaff }),
            currentView === 'billing' && h(BillingView, { engagements, onUpdate: setEngagements }),
            currentView === 'resources' && h(ResourceOptimizationView, { staff, engagements, onUpdate: setEngagements }),
            currentView === 'budget' && h(FinalBudgetSystem, { engagements, staff, onUpdate: setEngagements, user }),
            currentView === 'budgetApprovals' && h(BudgetApprovalsView, { engagements, onUpdate: setEngagements, user }),
          )
        )
      );
    }

    // Login Page - SUPABASE AUTHENTICATION
    function LoginPage({ onLogin }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        
        try {
          console.log('üîê Attempting login for:', email);
          
          // Sign in with Supabase
          const { data, error: signInError } = await supabase.auth.signInWithPassword({
            email: email.trim(),
            password: password
          });
          
          if (signInError) {
            console.error('‚ùå Login error:', signInError);
            setError(signInError.message || 'Invalid email or password');
            setLoading(false);
            return;
          }
          
          if (data.user) {
            console.log('‚úÖ User authenticated:', data.user.email);
            
            // Get user profile from database
            const { data: profile, error: profileError } = await supabase
              .from('user_profiles')
              .select('*')
              .eq('id', data.user.id)
              .single();
            
            if (profileError) {
              console.error('‚ùå Profile error:', profileError);
              setError('User profile not found. Please contact your administrator.');
              setLoading(false);
              return;
            }
            
            console.log('‚úÖ User profile loaded:', profile.full_name);
            
            // Login successful - pass user data to app
            onLogin({
              id: profile.id,
              email: profile.email,
              name: profile.full_name,
              role: profile.role,
              fullAccess: profile.full_access,
              hourlyRate: profile.hourly_rate,
              managerId: profile.manager_id,
              managerName: profile.manager_name
            });
          }
        } catch (err) {
          console.error('‚ùå Unexpected error:', err);
          setError('Login failed. Please try again.');
        }
        
        setLoading(false);
      };

      return h('div', { style: { minHeight: '100vh', background: 'linear-gradient(135deg, #1F4E78 0%, #163A5C 100%)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' } },
        h('div', { style: { background: 'white', borderRadius: '16px', boxShadow: '0 20px 60px rgba(0,0,0,0.3)', padding: '48px', maxWidth: '440px', width: '100%' } },
          h('div', { style: { textAlign: 'center', marginBottom: '32px' } },
            h('h1', { style: { fontSize: '24px', fontWeight: '700', color: '#1F4E78', marginBottom: '8px' } }, 'Forvis Mazars Botswana'),
            h('h2', { style: { fontSize: '16px', color: '#666', fontWeight: '500' } }, 'Audit Practice Manager')
          ),
          h('form', { onSubmit: handleSubmit },
            h('div', { style: { marginBottom: '20px' } },
              h('label', { style: { display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '14px', color: '#333' } }, 'Email'),
              h('input', { 
                type: 'email', 
                value: email, 
                onChange: (e) => setEmail(e.target.value), 
                placeholder: 'your.email@forvismazars.com', 
                required: true, 
                autoComplete: 'username',
                style: { 
                  width: '100%', 
                  padding: '14px 16px', 
                  border: '2px solid #E0E0E0', 
                  borderRadius: '8px', 
                  fontSize: '15px', 
                  fontFamily: 'inherit',
                  transition: 'border-color 0.2s'
                }
              })
            ),
            h('div', { style: { marginBottom: '24px' } },
              h('label', { style: { display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '14px', color: '#333' } }, 'Password'),
              h('input', { 
                type: 'password', 
                value: password, 
                onChange: (e) => setPassword(e.target.value), 
                placeholder: 'Enter your password', 
                required: true,
                autoComplete: 'current-password',
                style: { 
                  width: '100%', 
                  padding: '14px 16px', 
                  border: '2px solid #E0E0E0', 
                  borderRadius: '8px', 
                  fontSize: '15px', 
                  fontFamily: 'inherit',
                  transition: 'border-color 0.2s'
                }
              })
            ),
            error && h('div', { 
              style: { 
                background: '#FFEBEE', 
                color: '#C62828', 
                padding: '12px 16px', 
                borderRadius: '8px', 
                fontSize: '14px', 
                marginBottom: '16px',
                textAlign: 'center',
                border: '1px solid #FFCDD2'
              } 
            }, error),
            h('button', { 
              type: 'submit', 
              disabled: loading,
              style: { 
                width: '100%', 
                padding: '16px', 
                background: loading ? '#999' : '#0052A3', 
                color: 'white', 
                border: 'none', 
                borderRadius: '8px', 
                fontSize: '16px', 
                fontWeight: '600', 
                cursor: loading ? 'not-allowed' : 'pointer',
                fontFamily: 'inherit',
                transition: 'all 0.2s'
              }
            }, loading ? 'üîÑ Signing in...' : 'üîê Sign In')
          ),
          h('div', { style: { marginTop: '24px', padding: '16px', background: '#F5F5F5', borderRadius: '8px', fontSize: '13px', color: '#666' } },
            h('div', { style: { fontWeight: '600', marginBottom: '8px', color: '#333' } }, 'üîí Secure Access'),
            h('div', null, 'Contact your system administrator for login credentials.')
          ),
          h('div', { style: { marginTop: '20px', textAlign: 'center', fontSize: '12px', color: '#999' } },
            '¬© 2026 Forvis Mazars Botswana'
          )
        )
      );
    }

    // Sidebar Component
    function Sidebar({ currentView, onNavigate, user, engagements }) {
      const handleLogout = () => {
        if (confirm('Are you sure you want to logout?')) {
          localStorage.removeItem('audit_manager_session');
          window.location.reload();
        }
      };
      
      // Count pending unlock requests (for Managers and Partners)
      const canApprove = user.role === 'Audit Manager' || 
                        user.role === 'Senior Manager' || 
                        user.role === 'Manager' || 
                        user.role === 'Partner';
      const unlockRequestCount = engagements && canApprove ? 
        engagements
          .filter(e => e.budgetData && e.budgetData.unlockRequests && e.budgetData.unlockRequests.length > 0)
          .flatMap(e => e.budgetData.unlockRequests.filter(req => req.status === 'Pending'))
          .length : 0;
      
      return h('div', { className: 'sidebar' },
        h('div', { className: 'sidebar-header' },
          h('h1', null, 'Forvis Mazars'),
          h('p', null, 'Botswana')
        ),
        h('div', null,
          h('div', { className: `nav-item ${currentView === 'dashboard' ? 'active' : ''}`, onClick: () => onNavigate('dashboard') }, 'üìä Dashboard'),
          h('div', { className: `nav-item ${currentView === 'engagements' ? 'active' : ''}`, onClick: () => onNavigate('engagements') }, 'üìã Engagements'),
          h('div', { className: `nav-item ${currentView === 'budget' ? 'active' : ''}`, onClick: () => onNavigate('budget') }, 'üìä Budget Builder'),
          h('div', { className: `nav-item ${currentView === 'budgetApprovals' ? 'active' : ''}`, onClick: () => onNavigate('budgetApprovals') }, 
            '‚úì Budget Approvals',
            unlockRequestCount > 0 && h('span', {
              style: {
                marginLeft: '8px',
                padding: '2px 8px',
                background: '#FF9800',
                color: 'white',
                borderRadius: '12px',
                fontSize: '11px',
                fontWeight: '600'
              }
            }, unlockRequestCount)
          ),
          h('div', { className: `nav-item ${currentView === 'resources' ? 'active' : ''}`, onClick: () => onNavigate('resources') }, 'üìà Resource Optimization'),
          h('div', { className: `nav-item ${currentView === 'analytics' ? 'active' : ''}`, onClick: () => onNavigate('analytics') }, 'üìä Analytics'),
          h('div', { className: `nav-item ${currentView === 'staff' ? 'active' : ''}`, onClick: () => onNavigate('staff') }, 'üë• Staff'),
          h('div', { className: `nav-item ${currentView === 'billing' ? 'active' : ''}`, onClick: () => onNavigate('billing') }, 'üí∞ Billing')
        ),
        h('div', { className: 'user-info' },
          h('div', { style: { fontWeight: '600', marginBottom: '4px' } }, user.name),
          h('div', { style: { marginBottom: '12px', fontSize: '12px' } }, user.role),
          h('button', {
            onClick: handleLogout,
            style: {
              width: '100%',
              padding: '8px 12px',
              background: 'rgba(255,255,255,0.1)',
              border: '1px solid rgba(255,255,255,0.2)',
              borderRadius: '6px',
              color: 'white',
              fontSize: '13px',
              fontWeight: '500',
              cursor: 'pointer',
              transition: 'all 0.2s',
              fontFamily: 'inherit'
            },
            onMouseOver: (e) => e.target.style.background = 'rgba(255,255,255,0.15)',
            onMouseOut: (e) => e.target.style.background = 'rgba(255,255,255,0.1)'
          }, 'üö™ Logout')
        )
      );
    }

    // Dashboard Component with Clickable Metrics
    function Dashboard({ engagements, staff, onDrillDown }) {
      // Financial metrics
      const totalBudget = engagements.reduce((sum, e) => sum + e.budgetedFee, 0);
      const totalWIP = engagements.reduce((sum, e) => sum + (e.actualWIP || 0), 0);
      const totalBilled = engagements.reduce((sum, e) => {
        return sum + (e.billings || []).reduce((s, b) => s + b.amount, 0);
      }, 0);
      const outstanding = totalBudget - totalBilled;
      const unprofitable = engagements.filter(e => (e.actualWIP || 0) > e.budgetedFee * 1.1);

      // Hours performance
      const efficient = engagements.filter(e => {
        const perf = calculateHoursPerformance(e.budgetedHours, e.actualHours);
        return perf.status === 'excellent';
      });
      const onTarget = engagements.filter(e => {
        const perf = calculateHoursPerformance(e.budgetedHours, e.actualHours);
        return perf.status === 'good';
      });
      const inefficient = engagements.filter(e => {
        const perf = calculateHoursPerformance(e.budgetedHours, e.actualHours);
        return perf.status === 'poor';
      });

      // Resource metrics
      const activeStaff = staff.filter(s => s.isActive);
      const staffWithWorkload = activeStaff.map(s => {
        const totalHours = engagements.reduce((sum, e) => {
          const member = (e.teamMembers || []).find(tm => tm.staffId === s.id);
          return sum + (member ? (member.budgetHours || 0) : 0);
        }, 0);
        return { ...s, totalHours, utilization: (totalHours / 160) * 100 };
      });
      const avgUtilization = staffWithWorkload.reduce((sum, s) => sum + s.utilization, 0) / staffWithWorkload.length || 0;
      const overAllocated = staffWithWorkload.filter(s => s.utilization > 100);
      const underUtilized = staffWithWorkload.filter(s => s.utilization < 70);

      // Deadlines
      const cipaUrgent = engagements.filter(e => {
        if (e.statutoryReturns !== 'Yes') return false;
        const deadline = calculateDeadline(e.yearEnd, 7);
        return isDeadlineApproaching(deadline) || isDeadlineOverdue(deadline);
      });
      const taxUrgent = engagements.filter(e => {
        if (e.taxServices !== 'Yes') return false;
        const deadline = calculateDeadline(e.yearEnd, 3);
        return isDeadlineApproaching(deadline) || isDeadlineOverdue(deadline);
      });

      // Status counts
      const statuses = ['Planning', 'Fieldwork', 'In Progress', 'Review', 'Completed'];
      const statusCounts = statuses.map(status => ({
        status,
        count: engagements.filter(e => e.status === status).length,
        pct: ((engagements.filter(e => e.status === status).length / engagements.length) * 100).toFixed(0)
      }));

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, 'Dashboard')
        ),

        // Financial Performance
        h('h3', { style: { marginBottom: '16px', fontSize: '18px', fontWeight: '600' } }, 'Financial Performance'),
        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'Budgeted Fees'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, `P${(totalBudget / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, 'Total portfolio')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: totalWIP > totalBudget ? '#DC3545' : '#28A745' } },
            h('div', { className: 'metric-label' }, 'Actual WIP'),
            h('div', { className: 'metric-value', style: { color: totalWIP > totalBudget ? '#DC3545' : '#28A745' } }, `P${(totalWIP / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, totalWIP > totalBudget ? 'Over budget!' : 'On track')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#28A745', cursor: 'pointer' },
            onClick: () => onDrillDown('Billing Progress', engagements)
          },
            h('div', { className: 'metric-label' }, 'Total Billed'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, `P${(totalBilled / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, `${((totalBilled / totalBudget) * 100).toFixed(0)}% collected`)
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#FFC107', cursor: 'pointer' },
            onClick: () => onDrillDown('Outstanding Balance', engagements.filter(e => {
              const billed = (e.billings || []).reduce((sum, b) => sum + b.amount, 0);
              return e.budgetedFee - billed > 0;
            }))
          },
            h('div', { className: 'metric-label' }, 'Outstanding'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, `P${(outstanding / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, 'Unbilled fees')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: unprofitable.length > 0 ? '#DC3545' : '#28A745', cursor: 'pointer' },
            onClick: () => onDrillDown('Unprofitable Jobs', unprofitable)
          },
            unprofitable.length > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'Unprofitable Jobs'),
            h('div', { className: 'metric-value', style: { color: unprofitable.length > 0 ? '#DC3545' : '#28A745' } }, unprofitable.length),
            h('div', { className: 'metric-detail' }, '>10% over budget')
          )
        ),

        // Hours Performance
        h('h3', { style: { margin: '32px 0 16px 0', fontSize: '18px', fontWeight: '600' } }, 'Hours Performance'),
        h('div', { className: 'metric-grid' },
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#28A745', cursor: 'pointer' },
            onClick: () => onDrillDown('Efficient Engagements', efficient)
          },
            h('div', { className: 'metric-label' }, 'Efficient'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, efficient.length),
            h('div', { className: 'metric-detail' }, '<90% hours used ‚úì')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#FFC107', cursor: 'pointer' },
            onClick: () => onDrillDown('On-Target Engagements', onTarget)
          },
            h('div', { className: 'metric-label' }, 'On Target'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, onTarget.length),
            h('div', { className: 'metric-detail' }, '90-110% hours')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#DC3545', cursor: 'pointer' },
            onClick: () => onDrillDown('Inefficient Engagements', inefficient)
          },
            inefficient.length > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'Inefficient'),
            h('div', { className: 'metric-value', style: { color: '#DC3545' } }, inefficient.length),
            h('div', { className: 'metric-detail' }, '>110% hours used ‚úó')
          )
        ),

        // Resource Utilization
        h('h3', { style: { margin: '32px 0 16px 0', fontSize: '18px', fontWeight: '600' } }, 'Resource Utilization'),
        h('div', { className: 'metric-grid' },
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#4472C4', cursor: 'pointer' },
            onClick: () => onDrillDown('All Staff', activeStaff)
          },
            h('div', { className: 'metric-label' }, 'Total Staff'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, activeStaff.length),
            h('div', { className: 'metric-detail' }, 'Active team members')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: avgUtilization > 85 ? '#FFC107' : '#28A745' } },
            h('div', { className: 'metric-label' }, 'Avg Utilization'),
            h('div', { className: 'metric-value', style: { color: avgUtilization > 85 ? '#FFC107' : '#28A745' } }, `${avgUtilization.toFixed(0)}%`),
            h('div', { className: 'metric-detail' }, 'Portfolio average')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#DC3545', cursor: 'pointer' },
            onClick: () => onDrillDown('Over-Allocated Staff', overAllocated)
          },
            overAllocated.length > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'Over-Allocated'),
            h('div', { className: 'metric-value', style: { color: '#DC3545' } }, overAllocated.length),
            h('div', { className: 'metric-detail' }, '>100% capacity')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: '#FFC107', cursor: 'pointer' },
            onClick: () => onDrillDown('Under-Utilized Staff', underUtilized)
          },
            h('div', { className: 'metric-label' }, 'Under-Utilized'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, underUtilized.length),
            h('div', { className: 'metric-detail' }, '<70% capacity')
          )
        ),

        // Deadline Alerts
        h('h3', { style: { margin: '32px 0 16px 0', fontSize: '18px', fontWeight: '600' } }, 'Deadline Alerts'),
        h('div', { className: 'metric-grid' },
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: cipaUrgent.length > 0 ? '#DC3545' : '#28A745', cursor: 'pointer' },
            onClick: () => onDrillDown('CIPA Filings Due', cipaUrgent)
          },
            cipaUrgent.length > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'CIPA Filings'),
            h('div', { className: 'metric-value', style: { color: cipaUrgent.length > 0 ? '#DC3545' : '#28A745' } }, cipaUrgent.length),
            h('div', { className: 'metric-detail' }, 'Due within 30 days')
          ),
          h('div', {
            className: 'metric-card',
            style: { borderLeftColor: taxUrgent.length > 0 ? '#DC3545' : '#28A745', cursor: 'pointer' },
            onClick: () => onDrillDown('Tax Returns Due', taxUrgent)
          },
            taxUrgent.length > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'Tax Returns'),
            h('div', { className: 'metric-value', style: { color: taxUrgent.length > 0 ? '#DC3545' : '#28A745' } }, taxUrgent.length),
            h('div', { className: 'metric-detail' }, 'Due within 30 days')
          )
        ),

        // Status Breakdown
        h('div', { className: 'card' },
          h('h3', { style: { marginBottom: '16px', fontSize: '18px', fontWeight: '600' } }, 'Engagement Status'),
          h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '16px' } },
            statusCounts.map(({ status, count, pct }) =>
              h('div', {
                key: status,
                style: {
                  padding: '20px',
                  background: count > 0 ? '#F8F9FA' : '#FFF',
                  borderRadius: '8px',
                  textAlign: 'center',
                  cursor: count > 0 ? 'pointer' : 'default',
                  border: '2px solid #E0E0E0',
                  transition: 'all 0.2s'
                },
                onClick: count > 0 ? () => onDrillDown(status, engagements.filter(e => e.status === status)) : null,
                onMouseEnter: (e) => { if (count > 0) e.currentTarget.style.transform = 'translateY(-4px)'; },
                onMouseLeave: (e) => { e.currentTarget.style.transform = 'translateY(0)'; }
              },
                h('div', { style: { fontSize: '32px', fontWeight: '700', color: count > 0 ? '#1F4E78' : '#CCC', marginBottom: '4px' } }, count),
                h('div', { style: { fontSize: '14px', color: '#666', marginBottom: '4px' } }, status),
                h('div', { style: { fontSize: '12px', color: '#999' } }, `${pct}%`)
              )
            )
          )
        )
      );
    }


    // SECTION 2: ENGAGEMENTS MODULE
    
    function EngagementsView({ engagements, staff, filterType, filterData, onUpdate }) {
      const [showForm, setShowForm] = useState(false);
      const [editingEngagement, setEditingEngagement] = useState(null);
      const [selectedEngagement, setSelectedEngagement] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [statusFilter, setStatusFilter] = useState('all');
      
      // NEW FILTERS
      const [managerFilter, setManagerFilter] = useState('all');
      const [seniorFilter, setSeniorFilter] = useState('all');
      const [pieFilter, setPieFilter] = useState('all');
      const [yearEndFilter, setYearEndFilter] = useState('all');
      const [auditStartFilter, setAuditStartFilter] = useState('all');
      const [deadlineFilter, setDeadlineFilter] = useState('all');
      const [expandedDeadlines, setExpandedDeadlines] = useState({});
      const [showWIPImportModal, setShowWIPImportModal] = useState(false);
      const [wipFile, setWIPFile] = useState(null);
      const [wipImportResults, setWIPImportResults] = useState(null);

      // Get unique managers and seniors
      const uniqueManagers = [...new Set(engagements.map(e => e.manager).filter(m => m))];
      const uniqueSeniors = [...new Set(engagements.map(e => e.senior).filter(s => s))];
      const uniqueYearEnds = [...new Set(engagements.map(e => e.yearEnd).filter(y => y))].sort();
      
      // Helper function to check upcoming deadlines
      const hasUpcomingDeadline = (engagement, type, days) => {
        const today = new Date();
        const futureDate = new Date(today);
        futureDate.setDate(today.getDate() + days);
        
        let deadlineDate = null;
        
        switch(type) {
          case 'tax':
            deadlineDate = engagement.taxDeadline ? new Date(engagement.taxDeadline) : null;
            break;
          case 'cipa':
            deadlineDate = engagement.cipaDeadline ? new Date(engagement.cipaDeadline) : null;
            break;
          case 'nbfira':
            deadlineDate = engagement.nbfiraDeadline ? new Date(engagement.nbfiraDeadline) : null;
            break;
          case 'stock':
            deadlineDate = engagement.stockCountDate ? new Date(engagement.stockCountDate) : null;
            break;
        }
        
        return deadlineDate && deadlineDate >= today && deadlineDate <= futureDate;
      };

      const displayEngagements = (filterData || engagements).filter(e => {
        const matchesSearch = e.clientName.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesStatus = statusFilter === 'all' || e.status === statusFilter;
        const matchesManager = managerFilter === 'all' || e.manager === managerFilter;
        const matchesSenior = seniorFilter === 'all' || e.senior === seniorFilter;
        const matchesPie = pieFilter === 'all' || e.pieStatus === pieFilter;
        const matchesYearEnd = yearEndFilter === 'all' || e.yearEnd === yearEndFilter;
        
        // Audit Start Date filter logic
        let matchesAuditStart = true;
        if (auditStartFilter === 'thisMonth') {
          const now = new Date();
          const startDate = e.auditStartDate ? new Date(e.auditStartDate) : null;
          if (startDate) {
            matchesAuditStart = startDate.getMonth() === now.getMonth() && 
                               startDate.getFullYear() === now.getFullYear();
          } else {
            matchesAuditStart = false;
          }
        } else if (auditStartFilter === 'nextMonth') {
          const now = new Date();
          const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
          const startDate = e.auditStartDate ? new Date(e.auditStartDate) : null;
          if (startDate) {
            matchesAuditStart = startDate.getMonth() === nextMonth.getMonth() && 
                               startDate.getFullYear() === nextMonth.getFullYear();
          } else {
            matchesAuditStart = false;
          }
        } else if (auditStartFilter === 'lastMonth') {
          const now = new Date();
          const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          const startDate = e.auditStartDate ? new Date(e.auditStartDate) : null;
          if (startDate) {
            matchesAuditStart = startDate.getMonth() === lastMonth.getMonth() && 
                               startDate.getFullYear() === lastMonth.getFullYear();
          } else {
            matchesAuditStart = false;
          }
        } else if (auditStartFilter === 'twoMonthsAgo') {
          const now = new Date();
          const twoMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 2, 1);
          const startDate = e.auditStartDate ? new Date(e.auditStartDate) : null;
          if (startDate) {
            matchesAuditStart = startDate.getMonth() === twoMonthsAgo.getMonth() && 
                               startDate.getFullYear() === twoMonthsAgo.getFullYear();
          } else {
            matchesAuditStart = false;
          }
        } else if (auditStartFilter === 'moreThanTwoMonths') {
          const now = new Date();
          const twoMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 2, 1);
          const startDate = e.auditStartDate ? new Date(e.auditStartDate) : null;
          if (startDate) {
            matchesAuditStart = startDate < twoMonthsAgo;
          } else {
            matchesAuditStart = false;
          }
        } else if (auditStartFilter === 'thisQuarter') {
          const now = new Date();
          const currentQuarter = Math.floor(now.getMonth() / 3);
          const startDate = e.auditStartDate ? new Date(e.auditStartDate) : null;
          if (startDate) {
            const startQuarter = Math.floor(startDate.getMonth() / 3);
            matchesAuditStart = startQuarter === currentQuarter && 
                               startDate.getFullYear() === now.getFullYear();
          } else {
            matchesAuditStart = false;
          }
        }
        
        // Deadline filter logic
        let matchesDeadline = true;
        if (deadlineFilter === 'urgent') {
          // Next 7 days
          matchesDeadline = hasUpcomingDeadline(e, 'tax', 7) || 
                           hasUpcomingDeadline(e, 'cipa', 7) ||
                           hasUpcomingDeadline(e, 'nbfira', 7) ||
                           hasUpcomingDeadline(e, 'stock', 7);
        } else if (deadlineFilter === 'upcoming') {
          // Next 30 days
          matchesDeadline = hasUpcomingDeadline(e, 'tax', 30) || 
                           hasUpcomingDeadline(e, 'cipa', 30) ||
                           hasUpcomingDeadline(e, 'nbfira', 30) ||
                           hasUpcomingDeadline(e, 'stock', 30);
        } else if (deadlineFilter === 'tax') {
          matchesDeadline = hasUpcomingDeadline(e, 'tax', 90);
        } else if (deadlineFilter === 'cipa') {
          matchesDeadline = hasUpcomingDeadline(e, 'cipa', 90);
        } else if (deadlineFilter === 'nbfira') {
          matchesDeadline = hasUpcomingDeadline(e, 'nbfira', 90);
        } else if (deadlineFilter === 'stock') {
          matchesDeadline = hasUpcomingDeadline(e, 'stock', 90);
        }
        
        return matchesSearch && matchesStatus && matchesManager && matchesSenior && matchesPie && matchesYearEnd && matchesAuditStart && matchesDeadline;
      });

      const handleDelete = (id) => {
        if (confirm('Are you sure you want to delete this engagement?')) {
          onUpdate(engagements.filter(e => e.id !== id));
        }
      };

      const handleSave = (engagement) => {
        if (editingEngagement) {
          onUpdate(engagements.map(e => e.id === engagement.id ? engagement : e));
        } else {
          onUpdate([...engagements, { ...engagement, id: Date.now() }]);
        }
        setShowForm(false);
        setEditingEngagement(null);
      };

      const filterTitle = filterType || 'All Engagements';

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, filterTitle),
          h('div', { style: { display: 'flex', gap: '12px' } },
            h('button', { 
              className: 'btn btn-secondary',
              style: { display: 'flex', alignItems: 'center', gap: '8px' },
              onClick: () => setShowWIPImportModal(true)
            }, 
              h('span', null, 'üì•'),
              h('span', null, 'Import WIP Data')
            ),
            h('button', { 
              className: 'btn btn-primary',
              onClick: () => {
                setEditingEngagement(null);
                setShowForm(true);
              }
            }, '+ Add Engagement')
          )
        ),

        h('div', { className: 'card', style: { marginBottom: '20px', padding: '16px' } },
          h('div', { style: { marginBottom: '12px', fontWeight: '600', color: '#1F4E78' } }, 'Filter Engagements'),
          h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '12px' } },
            h('input', {
              className: 'form-input',
              style: { marginBottom: 0 },
              type: 'text',
              placeholder: 'üîç Search client...',
              value: searchTerm,
              onChange: (e) => setSearchTerm(e.target.value)
            }),
            h('select', {
              className: 'form-input',
              style: { marginBottom: 0 },
              value: statusFilter,
              onChange: (e) => setStatusFilter(e.target.value)
            },
              h('option', { value: 'all' }, 'All Statuses'),
              h('option', { value: 'Planning' }, 'Planning'),
              h('option', { value: 'Fieldwork' }, 'Fieldwork'),
              h('option', { value: 'In Progress' }, 'In Progress'),
              h('option', { value: 'Review' }, 'Review'),
              h('option', { value: 'Completed' }, 'Completed')
            ),
            h('select', {
              className: 'form-input',
              style: { marginBottom: 0 },
              value: managerFilter,
              onChange: (e) => setManagerFilter(e.target.value)
            },
              h('option', { value: 'all' }, 'All Managers'),
              uniqueManagers.map(m => h('option', { key: m, value: m }, m))
            ),
            h('select', {
              className: 'form-input',
              style: { marginBottom: 0 },
              value: seniorFilter,
              onChange: (e) => setSeniorFilter(e.target.value)
            },
              h('option', { value: 'all' }, 'All Seniors'),
              uniqueSeniors.map(s => h('option', { key: s, value: s }, s))
            ),
            h('select', {
              className: 'form-input',
              style: { marginBottom: 0 },
              value: pieFilter,
              onChange: (e) => setPieFilter(e.target.value)
            },
              h('option', { value: 'all' }, 'All Types'),
              h('option', { value: 'Yes' }, 'PIE Entities'),
              h('option', { value: 'No' }, 'Non-PIE')
            ),
            h('select', {
              className: 'form-input',
              style: { marginBottom: 0 },
              value: yearEndFilter,
              onChange: (e) => setYearEndFilter(e.target.value)
            },
              h('option', { value: 'all' }, 'All Year Ends'),
              uniqueYearEnds.map(y => h('option', { key: y, value: y }, y))
            ),
            h('select', {
              className: 'form-input',
              style: { marginBottom: 0 },
              value: auditStartFilter,
              onChange: (e) => setAuditStartFilter(e.target.value)
            },
              h('option', { value: 'all' }, 'All Start Dates'),
              h('option', { value: 'thisMonth' }, 'üìÖ Starting This Month'),
              h('option', { value: 'nextMonth' }, 'üìÖ Starting Next Month'),
              h('option', { value: 'thisQuarter' }, 'üìÖ Starting This Quarter'),
              h('option', { value: 'lastMonth' }, '‚èÆÔ∏è Started Last Month'),
              h('option', { value: 'twoMonthsAgo' }, '‚èÆÔ∏è Started 2 Months Ago'),
              h('option', { value: 'moreThanTwoMonths' }, '‚ö†Ô∏è Started >2 Months Ago')
            ),
            h('select', {
              className: 'form-input',
              style: { 
                marginBottom: 0,
                background: deadlineFilter !== 'all' ? '#FFF3E0' : '',
                borderColor: deadlineFilter !== 'all' ? '#FF9800' : '',
                fontWeight: deadlineFilter !== 'all' ? '600' : ''
              },
              value: deadlineFilter,
              onChange: (e) => setDeadlineFilter(e.target.value)
            },
              h('option', { value: 'all' }, 'üìÖ All Deadlines'),
              h('option', { value: 'urgent' }, 'üî¥ Urgent (7 days)'),
              h('option', { value: 'upcoming' }, 'üü° Upcoming (30 days)'),
              h('option', { value: 'tax' }, 'üèõÔ∏è Tax Deadlines'),
              h('option', { value: 'cipa' }, 'üìã CIPA Deadlines'),
              h('option', { value: 'nbfira' }, 'üè¶ NBFIRA Deadlines'),
              h('option', { value: 'stock' }, 'üì¶ Stock Count Dates')
            ),
            h('button', {
              className: 'btn btn-secondary',
              style: { padding: '8px 16px', fontSize: '13px' },
              onClick: () => {
                setSearchTerm('');
                setStatusFilter('all');
                setManagerFilter('all');
                setSeniorFilter('all');
                setPieFilter('all');
                setYearEndFilter('all');
                setAuditStartFilter('all');
                setDeadlineFilter('all');
              }
            }, 'üîÑ Clear Filters')
          ),
          displayEngagements.length !== engagements.length && h('div', {
            style: {
              marginTop: '12px',
              padding: '8px 12px',
              background: '#E3F2FD',
              borderRadius: '6px',
              fontSize: '13px',
              color: '#1976D2'
            }
          }, `Showing ${displayEngagements.length} of ${engagements.length} engagements`)
        ),

        h('div', { className: 'card', style: { overflowX: 'auto' } },
          h('table', { style: { minWidth: '1200px' } },
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', null, 'Year End'),
                h('th', null, 'Audit Start Date'),
                h('th', { style: { textAlign: 'right' } }, 'Budget Fee'),
                h('th', { style: { textAlign: 'right' } }, 'Actual WIP'),
                h('th', { style: { textAlign: 'center' } }, 'Hours'),
                h('th', { style: { textAlign: 'center' } }, 'Entity Type'),
                h('th', { style: { minWidth: '200px' } }, 'Upcoming Deadlines'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              displayEngagements.length === 0 ?
                h('tr', null,
                  h('td', { colSpan: 9, style: { textAlign: 'center', padding: '40px', color: '#999' } },
                    'No engagements found'
                  )
                ) :
                displayEngagements.map(e => {
                  const perf = calculateHoursPerformance(e.budgetedHours, e.actualHours);
                  
                  // Calculate upcoming deadlines
                  const today = new Date();
                  const getDeadlineInfo = (date, type, icon) => {
                    if (!date) return null;
                    const deadline = new Date(date);
                    const daysUntil = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil < 0) return null; // Past deadline
                    
                    let color = '#28A745'; // Green
                    let urgency = '';
                    if (daysUntil <= 7) {
                      color = '#DC3545'; // Red
                      urgency = 'üî¥';
                    } else if (daysUntil <= 30) {
                      color = '#FF9800'; // Orange
                      urgency = 'üü°';
                    }
                    
                    // Format actual date
                    const dateStr = deadline.toLocaleDateString('en-GB', { 
                      day: '2-digit', 
                      month: 'short', 
                      year: 'numeric' 
                    });
                    
                    return { type, icon, daysUntil, color, urgency, dateStr };
                  };
                  
                  // Get all deadlines
                  let allDeadlines = [
                    getDeadlineInfo(e.taxDeadline, 'Tax', 'üèõÔ∏è'),
                    getDeadlineInfo(e.cipaDeadline, 'CIPA', 'üìã'),
                    getDeadlineInfo(e.nbfiraDeadline, 'NBFIRA', 'üè¶'),
                    getDeadlineInfo(e.stockCountDate, 'Stock', 'üì¶')
                  ].filter(Boolean).sort((a, b) => a.daysUntil - b.daysUntil);
                  
                  // FILTER DEADLINES BASED ON ACTIVE FILTER
                  let deadlines = allDeadlines;
                  if (deadlineFilter === 'urgent') {
                    // Show only urgent deadlines (‚â§7 days)
                    deadlines = allDeadlines.filter(dl => dl.daysUntil <= 7);
                  } else if (deadlineFilter === 'upcoming') {
                    // Show only upcoming deadlines (‚â§30 days)
                    deadlines = allDeadlines.filter(dl => dl.daysUntil <= 30);
                  } else if (deadlineFilter === 'tax') {
                    // Show only Tax deadlines
                    deadlines = allDeadlines.filter(dl => dl.type === 'Tax');
                  } else if (deadlineFilter === 'cipa') {
                    // Show only CIPA deadlines
                    deadlines = allDeadlines.filter(dl => dl.type === 'CIPA');
                  } else if (deadlineFilter === 'nbfira') {
                    // Show only NBFIRA deadlines
                    deadlines = allDeadlines.filter(dl => dl.type === 'NBFIRA');
                  } else if (deadlineFilter === 'stock') {
                    // Show only Stock deadlines
                    deadlines = allDeadlines.filter(dl => dl.type === 'Stock');
                  }
                  // else deadlineFilter === 'all' ‚Üí show all deadlines

                  return h('tr', { key: e.id },
                    h('td', { style: { fontWeight: '600' } }, e.clientName),
                    h('td', null, e.yearEnd),
                    h('td', null, e.auditStartDate || '‚Äî'),
                    h('td', { style: { textAlign: 'right' } }, `P${(e.budgetedFee / 1000).toFixed(0)}K`),
                    h('td', { style: { textAlign: 'right' } }, `P${((e.actualWIP || 0) / 1000).toFixed(0)}K`),
                    h('td', { style: { textAlign: 'center' } }, 
                      `${e.actualHours || 0}/${e.budgetedHours || 0}`
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('span', {
                        className: 'status-badge',
                        style: { 
                          background: e.pieStatus === 'Yes' ? '#1F4E78' : '#757575',
                          color: 'white',
                          fontSize: '11px',
                          padding: '4px 10px'
                        }
                      }, e.pieStatus === 'Yes' ? 'üèõÔ∏è PIE' : 'üè¢ Non-PIE')
                    ),
                    // DEADLINES CELL - EXPANDED VIEW
                    h('td', { style: { padding: '12px' } },
                      deadlines.length === 0 ? 
                        h('div', { style: { display: 'flex', flexDirection: 'column', gap: '4px' } },
                          h('span', { style: { color: '#999', fontSize: '12px' } }, 
                            deadlineFilter !== 'all' ? 'No matching deadlines' : 'No upcoming deadlines'
                          ),
                          // Show if filtered and engagement has other deadlines
                          deadlineFilter !== 'all' && allDeadlines.length > 0 && h('span', {
                            style: {
                              fontSize: '10px',
                              color: '#666',
                              fontStyle: 'italic'
                            }
                          }, `(${allDeadlines.length} other deadline${allDeadlines.length > 1 ? 's' : ''} hidden)`)
                        ) :
                        h('div', { style: { display: 'flex', flexDirection: 'column', gap: '6px' } },
                          // Filter indicator
                          deadlineFilter !== 'all' && allDeadlines.length > deadlines.length && h('div', {
                            style: {
                              fontSize: '10px',
                              color: '#FF9800',
                              fontWeight: '600',
                              padding: '4px 8px',
                              background: '#FFF3E0',
                              borderRadius: '4px',
                              marginBottom: '2px'
                            }
                          }, `üîç Filtered view (${deadlines.length} of ${allDeadlines.length} deadlines)`),
                          
                          // Show first 2 deadlines or all if expanded
                          deadlines.slice(0, expandedDeadlines[e.id] ? deadlines.length : 2).map((dl, idx) => 
                            h('div', {
                              key: idx,
                              style: {
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '2px',
                                fontSize: '12px',
                                padding: '6px 10px',
                                background: dl.color + '15',
                                borderRadius: '6px',
                                border: '1px solid ' + dl.color,
                                minWidth: '180px'
                              }
                            },
                              h('div', {
                                style: {
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'space-between',
                                  gap: '8px'
                                }
                              },
                                h('div', { 
                                  style: { 
                                    display: 'flex', 
                                    alignItems: 'center', 
                                    gap: '6px',
                                    flex: 1
                                  } 
                                },
                                  h('span', { style: { fontSize: '14px' } }, dl.urgency || ''),
                                  h('span', { style: { fontSize: '14px' } }, dl.icon),
                                  h('span', { 
                                    style: { 
                                      fontWeight: '500',
                                      color: '#333'
                                    } 
                                  }, dl.type)
                                ),
                                h('span', { 
                                  style: { 
                                    fontWeight: '700',
                                    color: dl.color,
                                    fontSize: '13px',
                                    background: 'white',
                                    padding: '2px 8px',
                                    borderRadius: '4px'
                                  } 
                                }, dl.daysUntil + ' days')
                              ),
                              // Actual date in faint color
                              h('div', {
                                style: {
                                  fontSize: '10px',
                                  color: '#999',
                                  fontStyle: 'italic',
                                  marginTop: '2px',
                                  paddingLeft: '32px'
                                }
                              }, dl.dateStr)
                            )
                          ),
                          // Expand/Collapse button if more than 2 deadlines
                          deadlines.length > 2 && h('button', {
                            onClick: () => setExpandedDeadlines({
                              ...expandedDeadlines,
                              [e.id]: !expandedDeadlines[e.id]
                            }),
                            style: {
                              padding: '4px 8px',
                              fontSize: '11px',
                              background: '#E3F2FD',
                              border: '1px solid #1976D2',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              color: '#1976D2',
                              fontWeight: '600'
                            }
                          }, expandedDeadlines[e.id] ? 
                            `‚ñ≤ Show Less` : 
                            `‚ñº Show ${deadlines.length - 2} More`)
                        )
                    ),
                    h('td', null,
                      h('div', { style: { display: 'flex', gap: '8px', justifyContent: 'center' } },
                        h('button', {
                          style: { padding: '6px 12px', background: '#4472C4', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                          onClick: () => setSelectedEngagement(e)
                        }, 'View'),
                        h('button', {
                          style: { padding: '6px 12px', background: '#FFC107', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                          onClick: () => {
                            setEditingEngagement(e);
                            setShowForm(true);
                          }
                        }, 'Edit'),
                        h('button', {
                          style: { padding: '6px 12px', background: '#DC3545', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                          onClick: () => handleDelete(e.id)
                        }, 'Delete')
                      )
                    )
                  );
                })
            )
          )
        ),

        showForm && h(EngagementForm, {
          engagement: editingEngagement,
          staff: staff,
          onSave: handleSave,
          onCancel: () => {
            setShowForm(false);
            setEditingEngagement(null);
          }
        }),

        selectedEngagement && h(EngagementDetailView, {
          engagement: selectedEngagement,
          staff: staff,
          allEngagements: engagements,
          onClose: () => setSelectedEngagement(null)
        }),
        
        // WIP IMPORT MODAL
        showWIPImportModal && h('div', {
          className: 'modal',
          style: { display: 'flex' },
          onClick: () => {
            setShowWIPImportModal(false);
            setWIPFile(null);
            setWIPImportResults(null);
          }
        },
          h('div', {
            className: 'modal-content',
            style: { maxWidth: '700px', maxHeight: '80vh', overflow: 'auto' },
            onClick: (e) => e.stopPropagation()
          },
            h('div', { className: 'modal-header' },
              h('h2', { className: 'modal-title' }, 'üì• Import WIP Data'),
              h('button', {
                className: 'close-btn',
                onClick: () => {
                  setShowWIPImportModal(false);
                  setWIPFile(null);
                  setWIPImportResults(null);
                }
              }, '√ó')
            ),
            h('div', { className: 'modal-body' },
              // Instructions
              h('div', {
                style: {
                  padding: '16px',
                  background: '#E3F2FD',
                  borderRadius: '8px',
                  marginBottom: '20px',
                  border: '1px solid #1976D2'
                }
              },
                h('h4', { style: { fontSize: '14px', fontWeight: '600', marginBottom: '8px', color: '#1976D2' } },
                  'üìã Expected File Format'
                ),
                h('p', { style: { fontSize: '13px', color: '#555', marginBottom: '8px' } },
                  'Excel or CSV file with the following columns:'
                ),
                h('ul', { style: { fontSize: '12px', color: '#666', paddingLeft: '20px', margin: '8px 0' } },
                  h('li', null, h('strong', null, 'Client Name'), ' - Must match existing engagement'),
                  h('li', null, h('strong', null, 'Actual Hours'), ' - Number (e.g., 45)'),
                  h('li', null, h('strong', null, 'Actual WIP'), ' - BWP amount (e.g., 25000)')
                ),
                h('p', { style: { fontSize: '11px', color: '#999', marginTop: '8px', fontStyle: 'italic' } },
                  'Note: System will match clients by name and update their WIP data'
                )
              ),
              
              // File Upload
              !wipImportResults && h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Select WIP File'),
                h('input', {
                  type: 'file',
                  accept: '.csv,.xlsx,.xls',
                  className: 'form-input',
                  onChange: (e) => {
                    const file = e.target.files[0];
                    if (file) {
                      setWIPFile(file);
                    }
                  }
                })
              ),
              
              wipFile && !wipImportResults && h('div', {
                style: {
                  padding: '12px',
                  background: '#E8F5E9',
                  borderRadius: '6px',
                  fontSize: '13px',
                  color: '#2E7D32',
                  marginTop: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }
              },
                h('span', null, '‚úì'),
                h('span', null, 'File ready: ' + wipFile.name)
              ),
              
              // Results Display
              wipImportResults && h('div', {
                style: {
                  marginTop: '20px'
                }
              },
                h('h4', { style: { fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#1F4E78' } },
                  'üìä Import Results'
                ),
                
                // Success count
                wipImportResults.success > 0 && h('div', {
                  style: {
                    padding: '12px',
                    background: '#E8F5E9',
                    borderRadius: '6px',
                    marginBottom: '12px',
                    border: '1px solid #4CAF50'
                  }
                },
                  h('div', { style: { fontSize: '13px', fontWeight: '600', color: '#2E7D32' } },
                    '‚úì Successfully updated: ' + wipImportResults.success + ' engagement(s)'
                  )
                ),
                
                // Error count
                wipImportResults.errors.length > 0 && h('div', {
                  style: {
                    padding: '12px',
                    background: '#FFEBEE',
                    borderRadius: '6px',
                    marginBottom: '12px',
                    border: '1px solid #F44336'
                  }
                },
                  h('div', { style: { fontSize: '13px', fontWeight: '600', color: '#C62828', marginBottom: '8px' } },
                    '‚úó Errors: ' + wipImportResults.errors.length
                  ),
                  h('ul', { style: { fontSize: '12px', color: '#C62828', paddingLeft: '20px', margin: 0 } },
                    wipImportResults.errors.slice(0, 5).map((err, idx) =>
                      h('li', { key: idx }, err)
                    ),
                    wipImportResults.errors.length > 5 && h('li', { style: { fontStyle: 'italic' } },
                      '...and ' + (wipImportResults.errors.length - 5) + ' more'
                    )
                  )
                )
              )
            ),
            h('div', { className: 'modal-footer' },
              h('button', {
                className: 'btn btn-secondary',
                onClick: () => {
                  setShowWIPImportModal(false);
                  setWIPFile(null);
                  setWIPImportResults(null);
                }
              }, wipImportResults ? 'Close' : 'Cancel'),
              !wipImportResults && h('button', {
                className: 'btn btn-primary',
                disabled: !wipFile,
                onClick: () => {
                  // PROCESS WIP IMPORT
                  const reader = new FileReader();
                  reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                      alert('File appears to be empty or invalid');
                      return;
                    }
                    
                    // Parse CSV
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    const clientIdx = headers.findIndex(h => h.includes('client'));
                    const hoursIdx = headers.findIndex(h => h.includes('hour'));
                    const wipIdx = headers.findIndex(h => h.includes('wip') || h.includes('amount') || h.includes('value'));
                    
                    if (clientIdx === -1 || hoursIdx === -1 || wipIdx === -1) {
                      alert('Invalid file format. Required columns: Client Name, Actual Hours, Actual WIP');
                      return;
                    }
                    
                    let success = 0;
                    let errors = [];
                    const updatedEngagements = [...engagements];
                    
                    for (let i = 1; i < lines.length; i++) {
                      const values = lines[i].split(',').map(v => v.trim());
                      const clientName = values[clientIdx];
                      const actualHours = parseFloat(values[hoursIdx]);
                      const actualWIP = parseFloat(values[wipIdx]);
                      
                      if (!clientName) continue;
                      
                      const engIndex = updatedEngagements.findIndex(e => 
                        e.clientName.toLowerCase() === clientName.toLowerCase()
                      );
                      
                      if (engIndex === -1) {
                        errors.push(`Row ${i + 1}: Client "${clientName}" not found`);
                        continue;
                      }
                      
                      if (isNaN(actualHours) || isNaN(actualWIP)) {
                        errors.push(`Row ${i + 1}: Invalid hours or WIP value for "${clientName}"`);
                        continue;
                      }
                      
                      updatedEngagements[engIndex] = {
                        ...updatedEngagements[engIndex],
                        actualHours: actualHours,
                        actualWIP: actualWIP,
                        lastWIPImport: new Date().toISOString()
                      };
                      success++;
                    }
                    
                    if (success > 0) {
                      onUpdate(updatedEngagements);
                    }
                    
                    setWIPImportResults({ success, errors });
                  };
                  reader.readAsText(wipFile);
                }
              }, 'üì• Import WIP Data')
            )
          )
        )
      );
    }

    function EngagementForm({ engagement, staff, onSave, onCancel }) {
      const [formData, setFormData] = useState(engagement || {
        clientName: '', yearEnd: '', auditStartDate: '', auditCompletionDate: '',
        budgetedFee: '', actualWIP: '', pieStatus: 'No', taxServices: 'No', taxManager: '',
        statutoryReturns: 'No', stockCount: 'No', manager: '', senior: '',
        budgetedHours: '', actualHours: '', status: 'Planning', riskRating: 'Medium',
        notes: '', teamMembers: [], billings: [],
        // NEW: Important deadlines
        taxDeadline: '', taxDeadlineDesc: '',
        cipaDeadline: '', cipaDeadlineDesc: '',
        nbfiraDeadline: '', nbfiraDeadlineDesc: '',
        stockCountDate: '', stockCountNotes: ''
      });

      // AUTO-CALCULATE budgeted hours from budget
      const budgetedHours = React.useMemo(() => {
        if (!engagement || !engagement.budgetData || !engagement.budgetData.tasks) return 0;
        
        // Sum all hours from budget tasks
        return Object.values(engagement.budgetData.tasks)
          .flat()
          .reduce((sum, task) => sum + (task.hours || 0), 0);
      }, [engagement]);

      const handleChange = (field, value) => {
        const newData = { ...formData, [field]: value };
        if (field === 'taxServices' && value === 'No') newData.taxManager = '';
        setFormData(newData);
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.clientName || !formData.yearEnd || !formData.senior || !formData.budgetedFee || !formData.manager) {
          alert('Please fill in all required fields');
          return;
        }
        if (!formData.auditStartDate || !formData.auditCompletionDate) {
          alert('Please specify both Audit Start Date and Expected Completion Date');
          return;
        }
        if (new Date(formData.auditCompletionDate) <= new Date(formData.auditStartDate)) {
          alert('Completion Date must be after Start Date');
          return;
        }
        onSave({
          ...formData,
          budgetedFee: parseFloat(formData.budgetedFee) || 0,
          actualWIP: parseFloat(formData.actualWIP) || 0,
          budgetedHours: budgetedHours || parseFloat(formData.budgetedHours) || 0,  // Use calculated or manual
          budgetedHours: parseFloat(formData.budgetedHours) || 0,
          actualHours: parseFloat(formData.actualHours) || 0
        });
      };

      const managers = staff.filter(s => s.level === 'Manager' && s.isActive);
      const seniors = staff.filter(s => s.level === 'Senior' && s.isActive);
      const taxManagers = staff.filter(s => s.level === 'Tax Manager' && s.isActive);

      return h('div', { className: 'modal', onClick: onCancel },
        h('div', { className: 'modal-content', onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, engagement ? 'Edit Engagement' : 'Add New Engagement'),
            h('button', { className: 'close-btn', onClick: onCancel }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            h('form', { onSubmit: handleSubmit, id: 'engagementForm' },
              
              h('div', { className: 'section-title' }, 'Client Information'),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Client Name *'),
                  h('input', { className: 'form-input', type: 'text', value: formData.clientName, onChange: (e) => handleChange('clientName', e.target.value), required: true })
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Year End *'),
                  h('input', { className: 'form-input', type: 'date', value: formData.yearEnd, onChange: (e) => handleChange('yearEnd', e.target.value), required: true })
                )
              ),
              
              h('div', { className: 'section-title' }, 'üìÖ Audit Timeline'),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Audit Start Date *'),
                  h('input', { 
                    className: 'form-input', 
                    type: 'date', 
                    value: formData.auditStartDate, 
                    onChange: (e) => handleChange('auditStartDate', e.target.value),
                    required: true
                  }),
                  h('div', { 
                    style: { 
                      fontSize: '11px', 
                      color: '#666', 
                      marginTop: '4px' 
                    } 
                  }, 'Tasks can only be allocated from this date onwards')
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Expected Completion Date *'),
                  h('input', { 
                    className: 'form-input', 
                    type: 'date', 
                    value: formData.auditCompletionDate, 
                    onChange: (e) => handleChange('auditCompletionDate', e.target.value),
                    min: formData.auditStartDate || '',
                    required: true
                  }),
                  h('div', { 
                    style: { 
                      fontSize: '11px', 
                      color: '#666', 
                      marginTop: '4px' 
                    } 
                  }, 'Tasks cannot be allocated after this date')
                )
              ),
              
              // Lockdown period info
              formData.auditCompletionDate && h('div', {
                style: {
                  padding: '12px',
                  background: '#FFF3E0',
                  borderRadius: '6px',
                  fontSize: '12px',
                  color: '#F57C00',
                  marginBottom: '16px',
                  border: '1px solid #FF9800'
                }
              },
                h('div', { style: { fontWeight: '600', marginBottom: '4px' } }, 'üîí Lockdown Period (60 days after completion)'),
                h('div', null, 
                  (() => {
                    const completion = new Date(formData.auditCompletionDate);
                    const lockdownEnd = new Date(completion);
                    lockdownEnd.setDate(completion.getDate() + 60);
                    return `${completion.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })} to ${lockdownEnd.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}`;
                  })(),
                  ' - file archiving and final procedures only'
                )
              ),

              h('div', { className: 'section-title' }, 'Financial'),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Budgeted Fee (BWP) *'),
                  h('input', { className: 'form-input', type: 'number', value: formData.budgetedFee, onChange: (e) => handleChange('budgetedFee', e.target.value), min: '0', required: true })
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Actual WIP (BWP)'),
                  h('input', { className: 'form-input', type: 'number', value: formData.actualWIP, onChange: (e) => handleChange('actualWIP', e.target.value), min: '0' })
                )
              ),

              h('div', { className: 'section-title' }, 'Team'),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Manager *'),
                  h('select', { className: 'form-input', value: formData.manager, onChange: (e) => handleChange('manager', e.target.value), required: true },
                    h('option', { value: '' }, '-- Select Manager --'),
                    managers.map(m => h('option', { key: m.id, value: m.name }, m.name))
                  )
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Senior *'),
                  h('select', { className: 'form-input', value: formData.senior, onChange: (e) => handleChange('senior', e.target.value), required: true },
                    h('option', { value: '' }, '-- Select Senior --'),
                    seniors.map(s => h('option', { key: s.id, value: s.name }, s.name))
                  )
                )
              ),

              h('div', { className: 'section-title' }, 'Hours'),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Budgeted Hours'),
                  h('input', { 
                    className: 'form-input', 
                    type: 'number', 
                    value: budgetedHours || formData.budgetedHours || 0,
                    readOnly: true,
                    disabled: true,
                    style: {
                      background: '#F5F5F5',
                      cursor: 'not-allowed',
                      color: '#666'
                    }
                  }),
                  h('div', {
                    style: {
                      fontSize: '11px',
                      color: budgetedHours > 0 ? '#2E7D32' : '#999',
                      marginTop: '4px'
                    }
                  }, budgetedHours > 0 ? 'üìä Auto-calculated from Budget Builder' : '‚ö†Ô∏è Create budget first')
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Actual Hours'),
                  h('input', { className: 'form-input', type: 'number', value: formData.actualHours, onChange: (e) => handleChange('actualHours', e.target.value), min: '0' })
                )
              ),

              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Entity Type'),
                  h('div', { style: { display: 'flex', gap: '12px' } },
                    h('button', {
                      type: 'button',
                      className: formData.pieStatus === 'Yes' ? 'btn btn-primary' : 'btn btn-secondary',
                      onClick: () => handleChange('pieStatus', 'Yes'),
                      style: { 
                        flex: 1,
                        padding: '12px',
                        fontSize: '14px',
                        fontWeight: '600',
                        background: formData.pieStatus === 'Yes' ? '#1F4E78' : '#E0E0E0',
                        color: formData.pieStatus === 'Yes' ? 'white' : '#666',
                        border: formData.pieStatus === 'Yes' ? '2px solid #1F4E78' : '2px solid #E0E0E0'
                      }
                    }, 'üèõÔ∏è PIE Entity'),
                    h('button', {
                      type: 'button',
                      className: formData.pieStatus === 'No' ? 'btn btn-primary' : 'btn btn-secondary',
                      onClick: () => handleChange('pieStatus', 'No'),
                      style: { 
                        flex: 1,
                        padding: '12px',
                        fontSize: '14px',
                        fontWeight: '600',
                        background: formData.pieStatus === 'No' ? '#1F4E78' : '#E0E0E0',
                        color: formData.pieStatus === 'No' ? 'white' : '#666',
                        border: formData.pieStatus === 'No' ? '2px solid #1F4E78' : '2px solid #E0E0E0'
                      }
                    }, 'üè¢ Non-PIE')
                  )
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Stock Count'),
                  h('select', { className: 'form-input', value: formData.stockCount, onChange: (e) => handleChange('stockCount', e.target.value) },
                    h('option', { value: 'No' }, 'No'),
                    h('option', { value: 'Yes' }, 'Yes')
                  ),
                  formData.stockCount === 'Yes' && h('div', { style: { marginTop: '12px' } },
                    h('label', { className: 'form-label', style: { fontSize: '13px' } }, 'Stock Count Date'),
                    h('input', {
                      className: 'form-input',
                      type: 'date',
                      value: formData.stockCountDate || '',
                      onChange: (e) => handleChange('stockCountDate', e.target.value),
                      style: { marginBottom: '8px' }
                    }),
                    h('input', {
                      className: 'form-input',
                      type: 'text',
                      placeholder: 'Notes (optional)',
                      value: formData.stockCountNotes || '',
                      onChange: (e) => handleChange('stockCountNotes', e.target.value)
                    })
                  )
                )
              ),
              
              // IMPORTANT DEADLINES SECTION
              h('div', { style: { marginTop: '32px', paddingTop: '24px', borderTop: '2px solid #E0E0E0' } },
                h('h3', {
                  style: {
                    fontSize: '16px',
                    fontWeight: '600',
                    marginBottom: '16px',
                    color: '#1F4E78'
                  }
                }, 'üìÖ Important Deadlines'),
                
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'üèõÔ∏è Tax Deadline'),
                  h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '12px' } },
                    h('input', {
                      type: 'date',
                      className: 'form-input',
                      value: formData.taxDeadline || '',
                      onChange: (e) => handleChange('taxDeadline', e.target.value)
                    }),
                    h('input', {
                      type: 'text',
                      className: 'form-input',
                      placeholder: 'Description (e.g., VAT Return)',
                      value: formData.taxDeadlineDesc || '',
                      onChange: (e) => handleChange('taxDeadlineDesc', e.target.value)
                    })
                  )
                ),
                
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'üìã CIPA Filing'),
                  h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '12px' } },
                    h('input', {
                      type: 'date',
                      className: 'form-input',
                      value: formData.cipaDeadline || '',
                      onChange: (e) => handleChange('cipaDeadline', e.target.value)
                    }),
                    h('input', {
                      type: 'text',
                      className: 'form-input',
                      placeholder: 'Description (e.g., Annual Returns)',
                      value: formData.cipaDeadlineDesc || '',
                      onChange: (e) => handleChange('cipaDeadlineDesc', e.target.value)
                    })
                  )
                ),
                
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'üè¶ NBFIRA Submission'),
                  h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '12px' } },
                    h('input', {
                      type: 'date',
                      className: 'form-input',
                      value: formData.nbfiraDeadline || '',
                      onChange: (e) => handleChange('nbfiraDeadline', e.target.value)
                    }),
                    h('input', {
                      type: 'text',
                      className: 'form-input',
                      placeholder: 'Description',
                      value: formData.nbfiraDeadlineDesc || '',
                      onChange: (e) => handleChange('nbfiraDeadlineDesc', e.target.value)
                    })
                  )
                )
              )
            )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', type: 'button', onClick: onCancel }, 'Cancel'),
            h('button', { className: 'btn btn-primary', type: 'submit', form: 'engagementForm' }, 
              engagement ? 'Update' : 'Add Engagement'
            )
          )
        )
      );
    }

    function EngagementDetailView({ engagement, staff, allEngagements, onClose }) {
      const perf = calculateHoursPerformance(engagement.budgetedHours, engagement.actualHours);
      const totalBilled = (engagement.billings || []).reduce((sum, b) => sum + b.amount, 0);
      
      // Calculate budgeted hours from budget
      const budgetedHours = React.useMemo(() => {
        if (!engagement || !engagement.budgetData || !engagement.budgetData.tasks) return engagement.budgetedHours || 0;
        return Object.values(engagement.budgetData.tasks)
          .flat()
          .reduce((sum, task) => sum + (task.hours || 0), 0);
      }, [engagement]);

      return h('div', { className: 'modal', onClick: onClose, style: { display: 'flex' } },
        h('div', { 
          className: 'modal-content', 
          onClick: (e) => e.stopPropagation(),
          style: { maxWidth: '800px', maxHeight: '90vh', overflow: 'auto' }
        },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, 'üìã ' + engagement.clientName),
            h('button', { className: 'close-btn', onClick: onClose }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            // Header Summary
            h('div', { 
              style: { 
                padding: '20px', 
                background: 'linear-gradient(135deg, #1F4E78 0%, #163A5C 100%)', 
                color: 'white', 
                borderRadius: '8px', 
                marginBottom: '24px' 
              } 
            },
              h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px', marginBottom: '12px' } },
                h('div', null, h('strong', null, 'Year End: '), engagement.yearEnd),
                h('div', null, h('strong', null, 'Manager: '), engagement.manager),
                h('div', null, h('strong', null, 'Senior: '), engagement.senior)
              ),
              h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px' } },
                h('div', null, h('strong', null, 'Entity Type: '), 
                  h('span', { 
                    style: { 
                      background: engagement.pieStatus === 'Yes' ? '#FFD700' : '#90CAF9',
                      color: '#000',
                      padding: '2px 8px',
                      borderRadius: '4px',
                      fontSize: '12px',
                      fontWeight: '600'
                    }
                  }, engagement.pieStatus === 'Yes' ? 'üèõÔ∏è PIE' : 'üè¢ Non-PIE')
                ),
                h('div', null, h('strong', null, 'Risk Rating: '), engagement.riskRating),
                h('div', null, h('strong', null, 'Stock Count: '), engagement.stockCount)
              )
            ),
            
            // Dates Section
            h('div', { className: 'section-title' }, 'üìÖ Key Dates'),
            h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '24px' } },
              h('div', { style: { padding: '12px', background: '#F8F9FA', borderRadius: '6px' } },
                h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Audit Start Date'),
                h('div', { style: { fontSize: '14px', fontWeight: '600' } }, engagement.auditStartDate || '‚Äî')
              ),
              h('div', { style: { padding: '12px', background: '#F8F9FA', borderRadius: '6px' } },
                h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Completion Date'),
                h('div', { style: { fontSize: '14px', fontWeight: '600' } }, engagement.auditCompletionDate || '‚Äî')
              )
            ),
            
            // Financial Summary
            h('div', { className: 'section-title' }, 'üí∞ Financial Summary'),
            h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px', marginBottom: '24px' } },
              h('div', { style: { padding: '16px', background: '#E3F2FD', borderRadius: '8px', border: '2px solid #1976D2' } },
                h('div', { style: { fontSize: '12px', color: '#1976D2', marginBottom: '4px' } }, 'Budgeted Fee'),
                h('div', { style: { fontSize: '24px', fontWeight: '700', color: '#1976D2' } }, 
                  `P${(engagement.budgetedFee / 1000).toFixed(0)}K`
                )
              ),
              h('div', { style: { padding: '16px', background: '#FFF3E0', borderRadius: '8px', border: '2px solid #FF9800' } },
                h('div', { style: { fontSize: '12px', color: '#F57C00', marginBottom: '4px' } }, 'Actual WIP'),
                h('div', { style: { fontSize: '24px', fontWeight: '700', color: '#F57C00' } }, 
                  `P${((engagement.actualWIP || 0) / 1000).toFixed(0)}K`
                )
              ),
              h('div', { style: { padding: '16px', background: '#E8F5E9', borderRadius: '8px', border: '2px solid #4CAF50' } },
                h('div', { style: { fontSize: '12px', color: '#2E7D32', marginBottom: '4px' } }, 'Total Billed'),
                h('div', { style: { fontSize: '24px', fontWeight: '700', color: '#2E7D32' } }, 
                  `P${(totalBilled / 1000).toFixed(0)}K`
                )
              )
            ),
            
            // Hours Summary
            h('div', { className: 'section-title' }, '‚è±Ô∏è Hours Summary'),
            h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '24px' } },
              h('div', { style: { padding: '16px', background: '#F8F9FA', borderRadius: '8px' } },
                h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Budgeted Hours'),
                h('div', { style: { fontSize: '20px', fontWeight: '700' } }, budgetedHours + 'h'),
                budgetedHours > 0 && h('div', { style: { fontSize: '10px', color: '#2E7D32', marginTop: '4px' } }, 
                  '‚úì From Budget Builder'
                )
              ),
              h('div', { style: { padding: '16px', background: '#F8F9FA', borderRadius: '8px' } },
                h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Actual Hours'),
                h('div', { style: { fontSize: '20px', fontWeight: '700' } }, (engagement.actualHours || 0) + 'h')
              )
            ),
            
            // Important Deadlines
            (engagement.taxDeadline || engagement.cipaDeadline || engagement.nbfiraDeadline || engagement.stockCountDate) &&
            h('div', null,
              h('div', { className: 'section-title' }, 'üìÖ Important Deadlines'),
              h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '24px' } },
                engagement.taxDeadline && h('div', { 
                  style: { 
                    padding: '12px', 
                    background: '#FFF3E0', 
                    borderRadius: '6px',
                    border: '1px solid #FF9800'
                  } 
                },
                  h('div', { style: { fontSize: '12px', color: '#F57C00', marginBottom: '4px' } }, 'üèõÔ∏è Tax Deadline'),
                  h('div', { style: { fontSize: '14px', fontWeight: '600' } }, engagement.taxDeadline),
                  engagement.taxDeadlineDesc && h('div', { style: { fontSize: '11px', color: '#666', marginTop: '4px' } }, 
                    engagement.taxDeadlineDesc
                  )
                ),
                engagement.cipaDeadline && h('div', { 
                  style: { 
                    padding: '12px', 
                    background: '#E3F2FD', 
                    borderRadius: '6px',
                    border: '1px solid #1976D2'
                  } 
                },
                  h('div', { style: { fontSize: '12px', color: '#1976D2', marginBottom: '4px' } }, 'üìã CIPA Deadline'),
                  h('div', { style: { fontSize: '14px', fontWeight: '600' } }, engagement.cipaDeadline),
                  engagement.cipaDeadlineDesc && h('div', { style: { fontSize: '11px', color: '#666', marginTop: '4px' } }, 
                    engagement.cipaDeadlineDesc
                  )
                ),
                engagement.nbfiraDeadline && h('div', { 
                  style: { 
                    padding: '12px', 
                    background: '#F3E5F5', 
                    borderRadius: '6px',
                    border: '1px solid #9C27B0'
                  } 
                },
                  h('div', { style: { fontSize: '12px', color: '#7B1FA2', marginBottom: '4px' } }, 'üè¶ NBFIRA Deadline'),
                  h('div', { style: { fontSize: '14px', fontWeight: '600' } }, engagement.nbfiraDeadline),
                  engagement.nbfiraDeadlineDesc && h('div', { style: { fontSize: '11px', color: '#666', marginTop: '4px' } }, 
                    engagement.nbfiraDeadlineDesc
                  )
                ),
                engagement.stockCountDate && h('div', { 
                  style: { 
                    padding: '12px', 
                    background: '#E8F5E9', 
                    borderRadius: '6px',
                    border: '1px solid #4CAF50'
                  } 
                },
                  h('div', { style: { fontSize: '12px', color: '#2E7D32', marginBottom: '4px' } }, 'üì¶ Stock Count'),
                  h('div', { style: { fontSize: '14px', fontWeight: '600' } }, engagement.stockCountDate),
                  engagement.stockCountNotes && h('div', { style: { fontSize: '11px', color: '#666', marginTop: '4px' } }, 
                    engagement.stockCountNotes
                  )
                )
              )
            ),
            
            // Notes
            engagement.notes && h('div', null,
              h('div', { className: 'section-title' }, 'üìù Notes'),
              h('div', { 
                style: { 
                  padding: '12px', 
                  background: '#FFF9C4', 
                  borderRadius: '6px',
                  fontSize: '13px',
                  marginBottom: '24px'
                } 
              }, engagement.notes)
            )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Close')
          )
        )
      );
    }


    // SECTION 3: STAFF MANAGEMENT MODULE
    
    function StaffView({ staff, engagements, onUpdate }) {
      const [showForm, setShowForm] = useState(false);
      const [editingStaff, setEditingStaff] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [levelFilter, setLevelFilter] = useState('all');

      const filteredStaff = staff.filter(s => {
        const matchesSearch = s.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                             s.position.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesLevel = levelFilter === 'all' || s.level === levelFilter;
        return matchesSearch && matchesLevel && s.isActive;
      });

      const staffWithWorkload = filteredStaff.map(s => {
        const assignments = [];
        engagements.forEach(e => {
          const member = (e.teamMembers || []).find(tm => tm.staffId === s.id);
          if (member) {
            assignments.push({
              clientName: e.clientName,
              role: member.role,
              budgetHours: member.budgetHours || 0,
              actualHours: member.actualHours || 0
            });
          }
        });
        const totalBudgetHours = assignments.reduce((sum, a) => sum + a.budgetHours, 0);
        const totalActualHours = assignments.reduce((sum, a) => sum + a.actualHours, 0);
        const utilization = (totalBudgetHours / 160) * 100;
        
        return { ...s, assignments, totalBudgetHours, totalActualHours, utilization, engagementCount: assignments.length };
      });

      const totalStaff = staff.filter(s => s.isActive).length;
      const avgUtilization = staffWithWorkload.reduce((sum, s) => sum + s.utilization, 0) / staffWithWorkload.length || 0;
      const overAllocated = staffWithWorkload.filter(s => s.utilization > 100).length;
      const underUtilized = staffWithWorkload.filter(s => s.utilization < 70).length;

      const handleDelete = (id) => {
        if (confirm('Are you sure you want to deactivate this staff member?')) {
          onUpdate(staff.map(s => s.id === id ? { ...s, isActive: false } : s));
        }
      };

      const handleSave = (staffMember) => {
        if (editingStaff) {
          onUpdate(staff.map(s => s.id === staffMember.id ? staffMember : s));
        } else {
          onUpdate([...staff, { ...staffMember, id: Date.now(), isActive: true }]);
        }
        setShowForm(false);
        setEditingStaff(null);
      };

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, 'Staff Management'),
          h('button', { 
            className: 'btn btn-primary',
            onClick: () => {
              setEditingStaff(null);
              setShowForm(true);
            }
          }, '+ Add Staff Member')
        ),

        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'Total Active Staff'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, totalStaff),
            h('div', { className: 'metric-detail' }, 'Team members')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: avgUtilization > 85 ? '#FFC107' : '#28A745' } },
            h('div', { className: 'metric-label' }, 'Average Utilization'),
            h('div', { className: 'metric-value', style: { color: avgUtilization > 85 ? '#FFC107' : '#28A745' } }, 
              `${avgUtilization.toFixed(0)}%`
            ),
            h('div', { className: 'metric-detail' }, 'Across all staff')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: overAllocated > 0 ? '#DC3545' : '#28A745' } },
            overAllocated > 0 && h('div', { className: 'alert-badge' }, '!'),
            h('div', { className: 'metric-label' }, 'Over-Allocated'),
            h('div', { className: 'metric-value', style: { color: overAllocated > 0 ? '#DC3545' : '#28A745' } }, overAllocated),
            h('div', { className: 'metric-detail' }, '>100% utilization')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#FFC107' } },
            h('div', { className: 'metric-label' }, 'Under-Utilized'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, underUtilized),
            h('div', { className: 'metric-detail' }, '<70% utilization')
          )
        ),

        h('div', { className: 'card', style: { marginBottom: '20px', padding: '16px' } },
          h('div', { style: { display: 'flex', gap: '16px' } },
            h('input', {
              className: 'form-input',
              style: { flex: 1, marginBottom: 0 },
              type: 'text',
              placeholder: 'Search by name or position...',
              value: searchTerm,
              onChange: (e) => setSearchTerm(e.target.value)
            }),
            h('select', {
              className: 'form-input',
              style: { minWidth: '200px', marginBottom: 0 },
              value: levelFilter,
              onChange: (e) => setLevelFilter(e.target.value)
            },
              h('option', { value: 'all' }, 'All Levels'),
              h('option', { value: 'Partner' }, 'Partner'),
              h('option', { value: 'Manager' }, 'Manager'),
              h('option', { value: 'Senior' }, 'Senior'),
              h('option', { value: 'Tax Manager' }, 'Tax Manager')
            )
          )
        ),

        h('div', { className: 'card', style: { overflowX: 'auto' } },
          h('table', null,
            h('thead', null,
              h('tr', null,
                h('th', null, 'Name'),
                h('th', null, 'Position'),
                h('th', null, 'Level'),
                h('th', { style: { textAlign: 'right' } }, 'Hourly Rate'),
                h('th', { style: { textAlign: 'center' } }, 'Engagements'),
                h('th', { style: { textAlign: 'center' } }, 'Hours'),
                h('th', { style: { textAlign: 'center' } }, 'Utilization'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              staffWithWorkload.length === 0 ?
                h('tr', null,
                  h('td', { colSpan: 8, style: { textAlign: 'center', padding: '40px', color: '#999' } },
                    'No staff members found'
                  )
                ) :
                staffWithWorkload.map(s => {
                  const utilizationColor = s.utilization > 100 ? '#DC3545' : 
                                          s.utilization >= 70 ? '#28A745' : '#FFC107';
                  
                  return h('tr', { key: s.id },
                    h('td', { style: { fontWeight: '600' } }, s.name),
                    h('td', null, s.position),
                    h('td', null, s.level),
                    h('td', { style: { textAlign: 'right' } }, `P${s.hourlyRate.toLocaleString()}`),
                    h('td', { style: { textAlign: 'center' } }, s.engagementCount),
                    h('td', { style: { textAlign: 'center' } }, `${s.totalBudgetHours.toFixed(0)}h / 160h`),
                    h('td', { style: { textAlign: 'center' } },
                      h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', justifyContent: 'center' } },
                        h('div', { 
                          style: { 
                            width: '80px', 
                            height: '20px', 
                            background: '#E0E0E0', 
                            borderRadius: '10px',
                            overflow: 'hidden'
                          }
                        },
                          h('div', {
                            style: {
                              width: `${Math.min(s.utilization, 100)}%`,
                              height: '100%',
                              background: utilizationColor,
                              transition: 'width 0.3s'
                            }
                          })
                        ),
                        h('span', { style: { fontWeight: '600', fontSize: '13px', color: utilizationColor } }, 
                          `${s.utilization.toFixed(0)}%`
                        )
                      )
                    ),
                    h('td', null,
                      h('div', { style: { display: 'flex', gap: '8px', justifyContent: 'center' } },
                        h('button', {
                          style: { padding: '6px 12px', background: '#4472C4', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                          onClick: () => {
                            setEditingStaff(s);
                            setShowForm(true);
                          }
                        }, 'Edit'),
                        h('button', {
                          style: { padding: '6px 12px', background: '#DC3545', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                          onClick: () => handleDelete(s.id)
                        }, 'Deactivate')
                      )
                    )
                  );
                })
            )
          )
        ),

        showForm && h(StaffForm, {
          staff: editingStaff,
          onSave: handleSave,
          onCancel: () => {
            setShowForm(false);
            setEditingStaff(null);
          }
        })
      );
    }

    function StaffForm({ staff, onSave, onCancel }) {
      const [formData, setFormData] = useState(staff || {
        name: '', position: '', level: 'Senior', hourlyRate: '', skills: '', availabilityPercent: 100
      });

      const handleChange = (field, value) => {
        setFormData({ ...formData, [field]: value });
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.name || !formData.position || !formData.hourlyRate) {
          alert('Please fill in all required fields');
          return;
        }
        onSave({
          ...formData,
          hourlyRate: parseFloat(formData.hourlyRate) || 0,
          availabilityPercent: parseFloat(formData.availabilityPercent) || 100
        });
      };

      return h('div', { className: 'modal', onClick: onCancel },
        h('div', { className: 'modal-content', style: { maxWidth: '600px' }, onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, staff ? 'Edit Staff Member' : 'Add Staff Member'),
            h('button', { className: 'close-btn', onClick: onCancel }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            h('form', { onSubmit: handleSubmit, id: 'staffForm' },
              h('div', { className: 'section-title' }, 'Basic Information'),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Full Name *'),
                  h('input', { className: 'form-input', type: 'text', value: formData.name, onChange: (e) => handleChange('name', e.target.value), required: true })
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Position *'),
                  h('input', { className: 'form-input', type: 'text', value: formData.position, onChange: (e) => handleChange('position', e.target.value), required: true })
                )
              ),
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Level *'),
                  h('select', { className: 'form-input', value: formData.level, onChange: (e) => handleChange('level', e.target.value), required: true },
                    h('option', { value: 'Partner' }, 'Partner'),
                    h('option', { value: 'Manager' }, 'Manager'),
                    h('option', { value: 'Senior' }, 'Senior'),
                    h('option', { value: 'Semi-Senior' }, 'Semi-Senior'),
                    h('option', { value: 'Assistant' }, 'Assistant'),
                    h('option', { value: 'Tax Manager' }, 'Tax Manager')
                  )
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Hourly Rate (BWP) *'),
                  h('input', { className: 'form-input', type: 'number', value: formData.hourlyRate, onChange: (e) => handleChange('hourlyRate', e.target.value), required: true, min: '0' })
                )
              ),
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Skills / Specializations'),
                h('input', { className: 'form-input', type: 'text', value: formData.skills || '', onChange: (e) => handleChange('skills', e.target.value) })
              )
            )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', type: 'button', onClick: onCancel }, 'Cancel'),
            h('button', { className: 'btn btn-primary', type: 'submit', form: 'staffForm' }, 
              staff ? 'Update Staff Member' : 'Add Staff Member'
            )
          )
        )
      );
    }


    // SECTION 4: BILLING MODULE
    
    // BUDGET APPROVALS VIEW
    function BudgetApprovalsView({ engagements, onUpdate, user }) {
      const [showPreviewModal, setShowPreviewModal] = useState(false);
      const [previewEngagement, setPreviewEngagement] = useState(null);
      
      // ROLE-BASED FILTERING
      let pendingBudgets = engagements.filter(e => 
        e.budgetData && (e.budgetData.status === 'Pending Approval' || e.budgetApprovalStatus === 'Pending')
      );
      
      let approvedBudgets = engagements.filter(e => 
        e.budgetData && (e.budgetData.status === 'Approved' || e.budgetApprovalStatus === 'Approved')
      );
      
      // Filter based on user role
      if (user.role === 'Manager') {
        // Managers see only budgets for engagements assigned to them
        pendingBudgets = pendingBudgets.filter(e => e.manager === user.name);
        approvedBudgets = approvedBudgets.filter(e => e.manager === user.name);
      } else if (user.role === 'Senior' || user.role === 'Assistant') {
        // Seniors and below cannot approve, show empty
        pendingBudgets = [];
        approvedBudgets = approvedBudgets.filter(e => e.senior === user.name || e.manager === user.name);
      }
      // Partners see ALL budgets (no filter)

      const handlePreviewBudget = (engagement) => {
        setPreviewEngagement(engagement);
        setShowPreviewModal(true);
      };

      const handleApproveBudget = (engagement) => {
        // Check permissions - Allow Audit Manager, Senior Manager, and Partner
        const canApprove = user.role === 'Audit Manager' || 
                          user.role === 'Senior Manager' || 
                          user.role === 'Manager' || 
                          user.role === 'Partner';
        
        if (!canApprove) {
          alert('‚ö†Ô∏è PERMISSION DENIED\n\nOnly Managers and Partners can approve budgets.\n\nPlease contact your Manager or Partner for approval.');
          return;
        }
        
        if (!confirm(`Approve budget for ${engagement.clientName}?\n\nThis will lock the budget and enable task allocation.`)) {
          return;
        }

        const tasksArray = [];
        let taskId = Date.now();
        
        // Create tasks from budget if not already created
        if (engagement.budgetData && engagement.budgetData.stages) {
          engagement.budgetData.stages.forEach(stage => {
            const stageTasks = engagement.budgetData.tasks[stage.code] || [];
            stageTasks.forEach(task => {
              // Check if task already exists
              const existingTask = (engagement.tasks || []).find(t => t.code === task.code);
              if (!existingTask) {
                tasksArray.push({
                  id: taskId++,
                  name: task.name,
                  code: task.code,
                  stage: stage.code.toLowerCase() === 'a' ? 'acceptance' :
                         stage.code.toLowerCase() === 'b' ? 'planning' :
                         stage.code.toLowerCase() === 'c' ? 'fieldwork' :
                         stage.code.toLowerCase() === 'd' ? 'completion' : 'lockdown',
                  budgetHours: task.hours,
                  actualHours: 0,
                  status: 'Not Started',
                  assignments: [],
                  budgetSource: 'Budget Builder',
                  budgetLocked: true
                });
              }
            });
          });
        }

        const updated = engagements.map(e => {
          if (e.id === engagement.id) {
            return {
              ...e,
              budgetData: {
                ...e.budgetData,
                status: 'Approved',
                approvedBy: user.name,
                approvedDate: new Date().toISOString(),
                approvalComments: 'Approved'
              },
              budgetApprovalStatus: 'Approved',
              tasks: [...(e.tasks || []), ...tasksArray]
            };
          }
          return e;
        });
        
        onUpdate(updated);
        alert(`‚úÖ Budget approved for ${engagement.clientName}\n\nTasks are now ready for allocation in Resource Optimization.`);
      };

      const handleRejectBudget = (engagement, reason) => {
        const updated = engagements.map(e => {
          if (e.id === engagement.id) {
            return {
              ...e,
              budgetData: {
                ...e.budgetData,
                status: 'Rejected',
                approvedBy: user.name,
                approvedDate: new Date().toISOString(),
                approvalComments: reason
              },
              budgetApprovalStatus: 'Rejected'
            };
          }
          return e;
        });
        
        onUpdate(updated);
      };

      // Get all unlock requests
      const unlockRequests = engagements
        .filter(e => e.budgetData && e.budgetData.unlockRequests && e.budgetData.unlockRequests.length > 0)
        .flatMap(e => 
          e.budgetData.unlockRequests
            .filter(req => req.status === 'Pending')
            .map(req => ({ ...req, engagement: e }))
        );
      
      const handleUnlockApprove = (engagement, requestId) => {
        const session = JSON.parse(localStorage.getItem('audit_manager_session') || '{}');
        const canApprove = session.user && (
          session.user.role === 'Audit Manager' || 
          session.user.role === 'Senior Manager' || 
          session.user.role === 'Manager' || 
          session.user.role === 'Partner'
        );
        
        if (!canApprove) {
          alert('Only Managers and Partners can approve unlock requests');
          return;
        }
        
        if (!confirm('Approve unlock request for ' + engagement.clientName + '?\n\nThis will unlock the budget for editing.')) {
          return;
        }
        
        // Update unlock request status
        const updated = engagements.map(e => {
          if (e.id === engagement.id) {
            const request = e.budgetData.unlockRequests.find(r => r.id === requestId);
            if (request) {
              request.status = 'Approved';
              request.approvedBy = session.user.name;
              request.approvedAt = new Date().toISOString();
            }
            
            // Unlock the budget
            e.budgetData.status = 'Pending Approval';
            e.budgetData.unlockHistory = e.budgetData.unlockHistory || [];
            e.budgetData.unlockHistory.push({
              unlockedBy: session.user.name,
              unlockedAt: new Date().toISOString(),
              reason: request.reason,
              previousStatus: 'Approved',
              type: 'Request Approved',
              requestedBy: request.requestedBy
            });
          }
          return e;
        });
        
        onUpdate(updated);
        alert('‚úÖ Unlock request approved!\n\nBudget is now unlocked for editing.\nStatus changed to: Pending Approval');
      };
      
      const handleUnlockReject = (engagement, requestId) => {
        const session = JSON.parse(localStorage.getItem('audit_manager_session') || '{}');
        const canApprove = session.user && (
          session.user.role === 'Audit Manager' || 
          session.user.role === 'Senior Manager' || 
          session.user.role === 'Manager' || 
          session.user.role === 'Partner'
        );
        
        if (!canApprove) {
          alert('Only Managers and Partners can reject unlock requests');
          return;
        }
        
        const rejectionReason = prompt('Please provide reason for rejecting this unlock request:');
        if (!rejectionReason || rejectionReason.trim() === '') {
          alert('Rejection reason is required');
          return;
        }
        
        // Update unlock request status
        const updated = engagements.map(e => {
          if (e.id === engagement.id) {
            const request = e.budgetData.unlockRequests.find(r => r.id === requestId);
            if (request) {
              request.status = 'Rejected';
              request.approvedBy = session.user.name;
              request.approvedAt = new Date().toISOString();
              request.rejectionReason = rejectionReason;
            }
          }
          return e;
        });
        
        onUpdate(updated);
        alert('‚ùå Unlock request rejected.\n\nRequester will be notified.');
      };

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, '‚úì Budget Approvals'),
          h('p', { style: { marginTop: '8px', fontSize: '14px', color: '#666' } }, 
            'Review and approve budgets from your team (Manager/Partner only)'
          )
        ),

        // Unlock Requests (Partner only)
        unlockRequests.length > 0 && h('div', { className: 'card', style: { marginBottom: '24px', border: '2px solid #FF9800' } },
          h('div', { style: { marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
            h('h3', { style: { fontSize: '18px', fontWeight: '700', color: '#F57C00', margin: 0 } }, 
              'üîì Unlock Requests (' + unlockRequests.length + ')'
            ),
            h('div', {
              style: {
                padding: '6px 12px',
                background: '#FF9800',
                color: 'white',
                borderRadius: '12px',
                fontSize: '12px',
                fontWeight: '600'
              }
            }, 'Partner action required')
          ),
          
          h('table', null,
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', null, 'Requested By'),
                h('th', null, 'Requested Date'),
                h('th', null, 'Reason'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              unlockRequests.map(req => {
                return h('tr', { key: req.id, style: { background: '#FFF3E0' } },
                  h('td', { style: { fontWeight: '600' } }, req.engagement.clientName),
                  h('td', null, 
                    h('div', null, req.requestedBy),
                    h('div', { style: { fontSize: '11px', color: '#666' } }, req.requestedByRole)
                  ),
                  h('td', null, new Date(req.requestedAt).toLocaleString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })),
                  h('td', { style: { maxWidth: '300px' } }, 
                    h('div', { 
                      style: { 
                        fontSize: '13px',
                        fontStyle: 'italic',
                        color: '#555',
                        background: '#FFF',
                        padding: '8px',
                        borderRadius: '4px',
                        border: '1px solid #E0E0E0'
                      } 
                    }, '"' + req.reason + '"')
                  ),
                  h('td', { style: { textAlign: 'center' } },
                    h('div', { style: { display: 'flex', gap: '8px', justifyContent: 'center', flexWrap: 'wrap' } },
                      h('button', {
                        className: 'btn btn-secondary',
                        style: { padding: '6px 16px', fontSize: '13px' },
                        onClick: () => handlePreviewBudget(req.engagement)
                      }, 'üëÅÔ∏è Preview'),
                      h('button', {
                        className: 'btn btn-primary',
                        style: { padding: '6px 16px', fontSize: '13px', background: '#28A745' },
                        onClick: () => handleUnlockApprove(req.engagement, req.id)
                      }, '‚úì Approve'),
                      h('button', {
                        className: 'btn btn-secondary',
                        style: { padding: '6px 16px', fontSize: '13px', background: '#DC3545', color: 'white' },
                        onClick: () => handleUnlockReject(req.engagement, req.id)
                      }, '‚úó Reject')
                    )
                  )
                );
              })
            )
          )
        ),

        // Pending Approvals
        h('div', { className: 'card', style: { marginBottom: '24px' } },
          h('div', { style: { marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
            h('h3', { style: { fontSize: '18px', fontWeight: '700', color: '#1F4E78', margin: 0 } }, 
              '‚è≥ Pending Approval (' + pendingBudgets.length + ')'
            ),
            pendingBudgets.length > 0 && h('div', {
              style: {
                padding: '6px 12px',
                background: '#FFF3E0',
                color: '#E65100',
                borderRadius: '12px',
                fontSize: '12px',
                fontWeight: '600'
              }
            }, pendingBudgets.length + ' awaiting review')
          ),
          
          pendingBudgets.length === 0 ? 
            h('div', { className: 'empty-state' },
              h('div', { className: 'empty-state-icon' }, '‚úì'),
              h('p', null, 'No budgets pending approval'),
              h('p', { style: { fontSize: '13px', color: '#999' } }, 'All budgets have been reviewed')
            ) :
            h('table', null,
              h('thead', null,
                h('tr', null,
                  h('th', null, 'Client'),
                  h('th', { style: { textAlign: 'center' } }, 'Year End'),
                  h('th', { style: { textAlign: 'center' } }, 'Total Tasks'),
                  h('th', { style: { textAlign: 'center' } }, 'Total Hours'),
                  h('th', null, 'Created By'),
                  h('th', null, 'Created Date'),
                  h('th', { style: { textAlign: 'center' } }, 'Actions')
                )
              ),
              h('tbody', null,
                pendingBudgets.map(eng => {
                  const totalTasks = Object.values(eng.budgetData.tasks || {}).flat().length;
                  const totalHours = Object.values(eng.budgetData.tasks || {}).flat().reduce((s, t) => s + t.hours, 0);
                  
                  return h('tr', { key: eng.id, style: { background: '#FFFEF0' } },
                    h('td', { style: { fontWeight: '600' } }, eng.clientName),
                    h('td', { style: { textAlign: 'center' } }, eng.yearEnd),
                    h('td', { style: { textAlign: 'center', fontWeight: '600' } }, totalTasks),
                    h('td', { style: { textAlign: 'center', fontWeight: '600' } }, totalHours + 'h'),
                    h('td', null, eng.budgetData.createdBy || '-'),
                    h('td', null, eng.budgetData.createdDate ? new Date(eng.budgetData.createdDate).toLocaleDateString() : '-'),
                    h('td', { style: { textAlign: 'center' } },
                      h('div', { style: { display: 'flex', gap: '8px', justifyContent: 'center', flexWrap: 'wrap' } },
                        h('button', {
                          className: 'btn btn-secondary',
                          style: { padding: '6px 16px', fontSize: '13px' },
                          onClick: () => handlePreviewBudget(eng)
                        }, 'üëÅÔ∏è Preview'),
                        h('button', {
                          className: 'btn btn-primary',
                          style: { padding: '6px 16px', fontSize: '13px', background: '#4CAF50' },
                          onClick: () => handleApproveBudget(eng)
                        }, '‚úì Approve'),
                        h('button', {
                          className: 'btn btn-secondary',
                          style: { padding: '6px 16px', fontSize: '13px', color: '#F44336' },
                          onClick: () => {
                            const reason = prompt('Reason for rejection:');
                            if (reason) {
                              handleRejectBudget(eng, reason);
                            }
                          }
                        }, '‚úï Reject')
                      )
                    )
                  );
                })
              )
            )
        ),

        // Approved Budgets (History)
        h('div', { className: 'card' },
          h('h3', { style: { fontSize: '18px', fontWeight: '700', color: '#2E7D32', marginBottom: '20px' } }, 
            '‚úÖ Approved Budgets (' + approvedBudgets.length + ')'
          ),
          
          approvedBudgets.length === 0 ?
            h('div', { className: 'empty-state' },
              h('div', { className: 'empty-state-icon' }, 'üìã'),
              h('p', null, 'No approved budgets yet')
            ) :
            h('table', null,
              h('thead', null,
                h('tr', null,
                  h('th', null, 'Client'),
                  h('th', { style: { textAlign: 'center' } }, 'Tasks'),
                  h('th', { style: { textAlign: 'center' } }, 'Hours'),
                  h('th', null, 'Approved By'),
                  h('th', null, 'Approved Date'),
                  h('th', null, 'Status')
                )
              ),
              h('tbody', null,
                approvedBudgets.map(eng => {
                  const totalTasks = Object.values(eng.budgetData.tasks || {}).flat().length;
                  const totalHours = Object.values(eng.budgetData.tasks || {}).flat().reduce((s, t) => s + t.hours, 0);
                  
                  return h('tr', { key: eng.id },
                    h('td', { style: { fontWeight: '600' } }, eng.clientName),
                    h('td', { style: { textAlign: 'center' } }, totalTasks),
                    h('td', { style: { textAlign: 'center' } }, totalHours + 'h'),
                    h('td', null, eng.budgetData.approvedBy || '-'),
                    h('td', null, eng.budgetData.approvedDate ? new Date(eng.budgetData.approvedDate).toLocaleDateString() : '-'),
                    h('td', null,
                      h('span', {
                        style: {
                          padding: '4px 10px',
                          borderRadius: '12px',
                          fontSize: '11px',
                          fontWeight: '600',
                          background: '#E8F5E9',
                          color: '#2E7D32'
                        }
                      }, '‚úì Approved')
                    )
                  );
                })
              )
            )
        ),

        // Preview Budget Modal
        showPreviewModal && previewEngagement && h('div', {
          className: 'modal',
          style: { display: 'flex' },
          onClick: (e) => {
            if (e.target.className === 'modal') {
              setShowPreviewModal(false);
              setPreviewEngagement(null);
            }
          }
        },
          h('div', { className: 'modal-content', style: { maxWidth: '900px' }, onClick: (e) => e.stopPropagation() },
            h('div', { className: 'modal-header' },
              h('h2', { className: 'modal-title' }, 'üëÅÔ∏è Budget Preview: ' + previewEngagement.clientName),
              h('button', { className: 'close-btn', onClick: () => {
                setShowPreviewModal(false);
                setPreviewEngagement(null);
              } }, '√ó')
            ),
            h('div', { className: 'modal-body' },
              h('div', { style: { marginBottom: '24px', padding: '16px', background: '#F5F5F5', borderRadius: '8px' } },
                h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' } },
                  h('div', null,
                    h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Client'),
                    h('div', { style: { fontSize: '16px', fontWeight: '600' } }, previewEngagement.clientName)
                  ),
                  h('div', null,
                    h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Year End'),
                    h('div', { style: { fontSize: '16px', fontWeight: '600' } }, previewEngagement.yearEnd)
                  ),
                  h('div', null,
                    h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Budgeted Fee'),
                    h('div', { style: { fontSize: '16px', fontWeight: '600' } }, 'P' + (previewEngagement.budgetedFee || 0).toLocaleString())
                  ),
                  h('div', null,
                    h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Created By'),
                    h('div', { style: { fontSize: '16px', fontWeight: '600' } }, previewEngagement.budgetData.createdBy || '-')
                  )
                )
              ),
              
              // Budget by Stage
              previewEngagement.budgetData.stages && previewEngagement.budgetData.stages.map(stage => {
                const stageTasks = previewEngagement.budgetData.tasks[stage.code] || [];
                const stageHours = stageTasks.reduce((sum, t) => sum + t.hours, 0);
                
                return h('div', { key: stage.code, style: { marginBottom: '20px' } },
                  h('div', { 
                    style: { 
                      padding: '12px 16px', 
                      background: stage.color + '20', 
                      borderLeft: '4px solid ' + stage.color,
                      marginBottom: '12px',
                      borderRadius: '4px',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center'
                    } 
                  },
                    h('div', { style: { fontWeight: '700', fontSize: '15px' } }, stage.name),
                    h('div', { style: { fontWeight: '700', color: stage.color } }, 
                      stageTasks.length + ' tasks | ' + stageHours + 'h'
                    )
                  ),
                  stageTasks.length > 0 && h('table', { style: { width: '100%', fontSize: '13px' } },
                    h('thead', null,
                      h('tr', null,
                        h('th', { style: { textAlign: 'left', padding: '8px' } }, 'Code'),
                        h('th', { style: { textAlign: 'left', padding: '8px' } }, 'Task'),
                        h('th', { style: { textAlign: 'center', padding: '8px' } }, 'Hours')
                      )
                    ),
                    h('tbody', null,
                      stageTasks.map((task, idx) => 
                        h('tr', { key: idx, style: { borderBottom: '1px solid #EEE' } },
                          h('td', { style: { padding: '8px', fontWeight: '600' } }, task.code),
                          h('td', { style: { padding: '8px' } }, task.name),
                          h('td', { style: { padding: '8px', textAlign: 'center', fontWeight: '600' } }, task.hours + 'h')
                        )
                      )
                    )
                  )
                );
              }),

              // Summary
              h('div', { style: { marginTop: '24px', padding: '16px', background: '#E3F2FD', borderRadius: '8px' } },
                h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' } },
                  h('div', null,
                    h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Total Tasks'),
                    h('div', { style: { fontSize: '24px', fontWeight: '700', color: '#1976D2' } }, 
                      Object.values(previewEngagement.budgetData.tasks || {}).flat().length
                    )
                  ),
                  h('div', null,
                    h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Total Hours'),
                    h('div', { style: { fontSize: '24px', fontWeight: '700', color: '#1976D2' } }, 
                      Object.values(previewEngagement.budgetData.tasks || {}).flat().reduce((s, t) => s + t.hours, 0) + 'h'
                    )
                  )
                )
              )
            ),
            h('div', { className: 'modal-footer' },
              h('button', { 
                className: 'btn btn-secondary', 
                onClick: () => {
                  setShowPreviewModal(false);
                  setPreviewEngagement(null);
                }
              }, 'Close'),
              h('button', {
                className: 'btn btn-primary',
                style: { background: '#4CAF50' },
                onClick: () => {
                  setShowPreviewModal(false);
                  setPreviewEngagement(null);
                  handleApproveBudget(previewEngagement);
                }
              }, '‚úì Approve Budget')
            )
          )
        )
      );
    }

    // ANALYTICS MODULE
    function AnalyticsView({ engagements, staff, onUpdate }) {
      const [selectedEngagement, setSelectedEngagement] = useState(null);
      const [showImportModal, setShowImportModal] = useState(false);
      const [viewMode, setViewMode] = useState('engagement'); // engagement, stage, task, individual
      const [detailTab, setDetailTab] = useState('stage'); // Tab state for detail modal
      const [wipData, setWipData] = useState({}); // Stores actual WIP data
      
      // Import WIP Data
      const handleWIPImport = () => {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.csv,.xlsx,.xls';
        
        fileInput.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const text = event.target.result;
              const lines = text.split('\n').filter(line => line.trim());
              
              if (lines.length < 2) {
                alert('File appears to be empty');
                return;
              }
              
              const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
              
              // Expected columns: Engagement, Stage, Task, Staff Member, Hours, Amount (BWP)
              const engagementIdx = headers.findIndex(h => h.includes('engagement') || h.includes('client'));
              const stageIdx = headers.findIndex(h => h.includes('stage') || h.includes('phase'));
              const taskIdx = headers.findIndex(h => h.includes('task'));
              const staffIdx = headers.findIndex(h => h.includes('staff') || h.includes('member') || h.includes('name'));
              const hoursIdx = headers.findIndex(h => h.includes('hours'));
              const amountIdx = headers.findIndex(h => h.includes('amount') || h.includes('wip') || h.includes('value'));
              
              if (engagementIdx === -1 || hoursIdx === -1) {
                alert('Required columns missing. Need at least: Engagement, Hours');
                return;
              }
              
              const newWipData = {};
              let recordsImported = 0;
              
              for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length < headers.length) continue;
                
                const engagementName = values[engagementIdx];
                const stage = stageIdx !== -1 ? values[stageIdx] : 'Not Specified';
                const task = taskIdx !== -1 ? values[taskIdx] : 'Not Specified';
                const staffMember = staffIdx !== -1 ? values[staffIdx] : 'Not Specified';
                const hours = parseFloat(values[hoursIdx]) || 0;
                const amount = amountIdx !== -1 ? parseFloat(values[amountIdx]) || 0 : 0;
                
                if (!newWipData[engagementName]) {
                  newWipData[engagementName] = {
                    totalHours: 0,
                    totalAmount: 0,
                    stages: {},
                    tasks: {},
                    staff: {}
                  };
                }
                
                newWipData[engagementName].totalHours += hours;
                newWipData[engagementName].totalAmount += amount;
                
                // By stage
                if (!newWipData[engagementName].stages[stage]) {
                  newWipData[engagementName].stages[stage] = { hours: 0, amount: 0, tasks: {} };
                }
                newWipData[engagementName].stages[stage].hours += hours;
                newWipData[engagementName].stages[stage].amount += amount;
                
                // By task
                const taskKey = `${stage}:${task}`;
                if (!newWipData[engagementName].tasks[taskKey]) {
                  newWipData[engagementName].tasks[taskKey] = { hours: 0, amount: 0, staff: {} };
                }
                newWipData[engagementName].tasks[taskKey].hours += hours;
                newWipData[engagementName].tasks[taskKey].amount += amount;
                
                // By staff
                if (!newWipData[engagementName].staff[staffMember]) {
                  newWipData[engagementName].staff[staffMember] = { hours: 0, amount: 0, tasks: {} };
                }
                newWipData[engagementName].staff[staffMember].hours += hours;
                newWipData[engagementName].staff[staffMember].amount += amount;
                
                // Staff by task
                if (!newWipData[engagementName].staff[staffMember].tasks[taskKey]) {
                  newWipData[engagementName].staff[staffMember].tasks[taskKey] = { hours: 0, amount: 0 };
                }
                newWipData[engagementName].staff[staffMember].tasks[taskKey].hours += hours;
                newWipData[engagementName].staff[staffMember].tasks[taskKey].amount += amount;
                
                recordsImported++;
              }
              
              setWipData(newWipData);
              setShowImportModal(false);
              alert(`‚úÖ WIP Data Imported Successfully!\n\n${recordsImported} records imported\n${Object.keys(newWipData).length} engagements`);
            } catch (error) {
              alert('Import failed: ' + error.message);
            }
          };
          
          reader.readAsText(file);
        };
        
        fileInput.click();
      };
      
      // Download Import Template
      const downloadTemplate = () => {
        const template = 
          'Engagement,Stage,Task,Staff Member,Hours,Amount (BWP)\n' +
          'ABC Mining Ltd,Planning,Risk Assessment,John Doe,8,4800\n' +
          'ABC Mining Ltd,Planning,Planning Memo,Jane Smith,12,7200\n' +
          'ABC Mining Ltd,Fieldwork,Revenue Testing,John Doe,24,14400\n' +
          'Tech Solutions Ltd,Planning,Understanding Entity,Mike Johnson,10,6000\n' +
          'Tech Solutions Ltd,Fieldwork,Expense Testing,Sarah Smith,16,9600';
        
        const blob = new Blob([template], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'WIP_Import_Template.csv';
        a.click();
        URL.revokeObjectURL(url);
      };
      
      // Calculate engagement-level analytics
      const getEngagementAnalytics = () => {
        return engagements.map(eng => {
          const budgetedHours = eng.budgetData ? 
            Object.values(eng.budgetData.tasks || {}).flat().reduce((sum, t) => sum + (t.hours || 0), 0) : 0;
          const budgetedFee = eng.budgetedFee || 0;
          
          const wipInfo = wipData[eng.clientName] || { totalHours: 0, totalAmount: 0 };
          const actualHours = wipInfo.totalHours;
          const actualAmount = wipInfo.totalAmount;
          
          const hoursVariance = actualHours - budgetedHours;
          const hoursVariancePercent = budgetedHours > 0 ? (hoursVariance / budgetedHours * 100) : 0;
          
          const amountVariance = actualAmount - budgetedFee;
          const amountVariancePercent = budgetedFee > 0 ? (amountVariance / budgetedFee * 100) : 0;
          
          return {
            engagement: eng,
            budgetedHours,
            budgetedFee,
            actualHours,
            actualAmount,
            hoursVariance,
            hoursVariancePercent,
            amountVariance,
            amountVariancePercent,
            status: hoursVariancePercent > 10 ? 'Over Budget' : hoursVariancePercent < -10 ? 'Under Budget' : 'On Track'
          };
        }).filter(a => a.budgetedHours > 0);
      };
      
      // Calculate stage-level analytics
      const getStageAnalytics = (engagement) => {
        if (!engagement.budgetData) return [];
        
        const stages = ['A', 'B', 'C', 'D', 'E'];
        const stageNames = {
          'A': 'Acceptance',
          'B': 'Planning', 
          'C': 'Fieldwork',
          'D': 'Completion',
          'E': 'Lockdown'
        };
        
        const wipInfo = wipData[engagement.clientName] || { stages: {} };
        
        return stages.map(stageCode => {
          const stageTasks = engagement.budgetData.tasks[stageCode] || [];
          const budgetedHours = stageTasks.reduce((sum, t) => sum + (t.hours || 0), 0);
          
          const stageName = stageNames[stageCode];
          const actualData = wipInfo.stages[stageName] || wipInfo.stages[stageName.toLowerCase()] || 
                           wipInfo.stages[stageCode] || { hours: 0, amount: 0 };
          const actualHours = actualData.hours;
          const actualAmount = actualData.amount;
          
          const variance = actualHours - budgetedHours;
          const variancePercent = budgetedHours > 0 ? (variance / budgetedHours * 100) : 0;
          
          return {
            stage: stageCode,
            stageName: stageName,
            budgetedHours,
            actualHours,
            actualAmount,
            variance,
            variancePercent,
            status: variancePercent > 10 ? 'Over' : variancePercent < -10 ? 'Under' : 'On Track'
          };
        }).filter(s => s.budgetedHours > 0);
      };
      
      // Calculate task-level analytics
      const getTaskAnalytics = (engagement) => {
        if (!engagement.budgetData) return [];
        
        const stageNames = {
          'A': 'Acceptance',
          'B': 'Planning', 
          'C': 'Fieldwork',
          'D': 'Completion',
          'E': 'Lockdown'
        };
        
        const wipInfo = wipData[engagement.clientName] || { tasks: {} };
        const allTasks = [];
        
        // Iterate through all stages and tasks
        Object.keys(engagement.budgetData.tasks || {}).forEach(stageCode => {
          const stageTasks = engagement.budgetData.tasks[stageCode] || [];
          const stageName = stageNames[stageCode];
          
          stageTasks.forEach(task => {
            // Try multiple key formats to match WIP data
            const taskKey1 = `${stageName}:${task.name}`;
            const taskKey2 = `${stageName.toLowerCase()}:${task.name.toLowerCase()}`;
            const taskKey3 = `${stageCode}:${task.name}`;
            const taskKey4 = task.name;
            
            const actualData = wipInfo.tasks[taskKey1] || 
                             wipInfo.tasks[taskKey2] || 
                             wipInfo.tasks[taskKey3] ||
                             wipInfo.tasks[taskKey4] ||
                             { hours: 0, amount: 0 };
            
            const variance = actualData.hours - task.hours;
            const variancePercent = task.hours > 0 ? (variance / task.hours * 100) : 0;
            
            allTasks.push({
              stage: stageCode,
              stageName: stageName,
              taskCode: task.code,
              taskName: task.name,
              budgetedHours: task.hours,
              actualHours: actualData.hours,
              actualAmount: actualData.amount,
              variance: variance,
              variancePercent: variancePercent,
              status: variancePercent > 10 ? 'Over' : variancePercent < -10 ? 'Under' : 'On Track'
            });
          });
        });
        
        return allTasks;
      };
      
      // Calculate individual staff analytics for engagement
      const getIndividualAnalytics = (engagement) => {
        const wipInfo = wipData[engagement.clientName] || { staff: {} };
        
        return Object.keys(wipInfo.staff).map(staffName => {
          const staffData = wipInfo.staff[staffName];
          
          // Calculate budgeted hours for this staff member (from task assignments)
          let budgetedHours = 0;
          if (engagement.tasks) {
            engagement.tasks.forEach(task => {
              if (task.assignments) {
                task.assignments.forEach(assignment => {
                  const assignedStaff = staff.find(s => s.id === assignment.staffId);
                  if (assignedStaff && assignedStaff.name === staffName) {
                    budgetedHours += assignment.hours || 0;
                  }
                });
              }
            });
          }
          
          const variance = staffData.hours - budgetedHours;
          const variancePercent = budgetedHours > 0 ? (variance / budgetedHours * 100) : 0;
          
          return {
            staffName: staffName,
            budgetedHours: budgetedHours,
            actualHours: staffData.hours,
            actualAmount: staffData.amount,
            variance: variance,
            variancePercent: variancePercent,
            tasks: staffData.tasks,
            status: variancePercent > 10 ? 'Over' : variancePercent < -10 ? 'Under' : 'On Track'
          };
        }).sort((a, b) => b.actualHours - a.actualHours);
      };
      
      const engagementAnalytics = getEngagementAnalytics();
      const hasWipData = Object.keys(wipData).length > 0;

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, 'üìä Budget vs Actual Analytics'),
          h('p', { style: { marginTop: '8px', fontSize: '14px', color: '#666' } },
            'Analyze budgeted hours vs actual WIP by engagement, stage, task, and individual'
          ),
          h('div', { style: { display: 'flex', gap: '12px', marginTop: '16px' } },
            h('button', {
              className: 'btn btn-primary',
              onClick: handleWIPImport
            }, 'üì• Import WIP Data'),
            h('button', {
              className: 'btn btn-secondary',
              onClick: downloadTemplate
            }, 'üìÑ Download Template')
          )
        ),
        
        !hasWipData && h('div', { className: 'card' },
          h('div', { className: 'empty-state' },
            h('div', { className: 'empty-state-icon' }, 'üìä'),
            h('p', null, 'No WIP data imported yet'),
            h('p', { style: { fontSize: '13px', color: '#999', marginTop: '8px' } },
              'Import actual WIP data to see budget vs actual analysis'
            ),
            h('div', { style: { marginTop: '16px', display: 'flex', gap: '12px', justifyContent: 'center' } },
              h('button', {
                className: 'btn btn-primary',
                onClick: handleWIPImport
              }, 'üì• Import WIP Data'),
              h('button', {
                className: 'btn btn-secondary',
                onClick: downloadTemplate
              }, 'üìÑ Download Template')
            )
          )
        ),
        
        hasWipData && h('div', null,
          // Summary Cards
          h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px' } },
            h('div', { className: 'card', style: { padding: '20px', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white' } },
              h('div', { style: { fontSize: '13px', opacity: 0.9, marginBottom: '8px' } }, 'Engagements Analyzed'),
              h('div', { style: { fontSize: '32px', fontWeight: '700' } }, engagementAnalytics.length),
              h('div', { style: { fontSize: '11px', opacity: 0.8, marginTop: '4px' } }, 'with budget & WIP data')
            ),
            h('div', { className: 'card', style: { padding: '20px', background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', color: 'white' } },
              h('div', { style: { fontSize: '13px', opacity: 0.9, marginBottom: '8px' } }, 'Total Budgeted Hours'),
              h('div', { style: { fontSize: '32px', fontWeight: '700' } }, 
                engagementAnalytics.reduce((sum, a) => sum + a.budgetedHours, 0).toFixed(0) + 'h'
              )
            ),
            h('div', { className: 'card', style: { padding: '20px', background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', color: 'white' } },
              h('div', { style: { fontSize: '13px', opacity: 0.9, marginBottom: '8px' } }, 'Total Actual Hours'),
              h('div', { style: { fontSize: '32px', fontWeight: '700' } }, 
                engagementAnalytics.reduce((sum, a) => sum + a.actualHours, 0).toFixed(0) + 'h'
              )
            ),
            h('div', { className: 'card', style: { padding: '20px', background: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', color: 'white' } },
              h('div', { style: { fontSize: '13px', opacity: 0.9, marginBottom: '8px' } }, 'Total Variance'),
              h('div', { style: { fontSize: '32px', fontWeight: '700' } }, 
                (() => {
                  const totalVar = engagementAnalytics.reduce((sum, a) => sum + a.hoursVariance, 0);
                  return (totalVar >= 0 ? '+' : '') + totalVar.toFixed(0) + 'h';
                })()
              ),
              h('div', { style: { fontSize: '11px', opacity: 0.8, marginTop: '4px' } },
                (() => {
                  const totalBudget = engagementAnalytics.reduce((sum, a) => sum + a.budgetedHours, 0);
                  const totalVar = engagementAnalytics.reduce((sum, a) => sum + a.hoursVariance, 0);
                  const percent = totalBudget > 0 ? (totalVar / totalBudget * 100) : 0;
                  return (percent >= 0 ? '+' : '') + percent.toFixed(1) + '%';
                })()
              )
            )
          ),
          
          // Engagement-Level Analysis
          h('div', { className: 'card', style: { marginBottom: '24px' } },
            h('h3', { style: { fontSize: '18px', fontWeight: '700', marginBottom: '16px' } }, 
              'üìã Engagement-Level Analysis'
            ),
            h('table', null,
              h('thead', null,
                h('tr', null,
                  h('th', null, 'Engagement'),
                  h('th', { style: { textAlign: 'center' } }, 'Budgeted Hours'),
                  h('th', { style: { textAlign: 'center' } }, 'Actual Hours'),
                  h('th', { style: { textAlign: 'center' } }, 'Variance'),
                  h('th', { style: { textAlign: 'right' } }, 'Budgeted Fee'),
                  h('th', { style: { textAlign: 'right' } }, 'Actual WIP'),
                  h('th', { style: { textAlign: 'right' } }, 'Amount Variance'),
                  h('th', { style: { textAlign: 'center' } }, 'Status'),
                  h('th', { style: { textAlign: 'center' } }, 'Actions')
                )
              ),
              h('tbody', null,
                engagementAnalytics.map(analytics => {
                  const varianceColor = analytics.hoursVariancePercent > 10 ? '#DC3545' : 
                                       analytics.hoursVariancePercent < -10 ? '#28A745' : '#FF9800';
                  
                  return h('tr', { key: analytics.engagement.id },
                    h('td', { style: { fontWeight: '600' } }, analytics.engagement.clientName),
                    h('td', { style: { textAlign: 'center', fontWeight: '600' } }, 
                      analytics.budgetedHours.toFixed(1) + 'h'
                    ),
                    h('td', { style: { textAlign: 'center', fontWeight: '600', color: '#1976D2' } }, 
                      analytics.actualHours.toFixed(1) + 'h'
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('div', null,
                        h('div', { style: { fontWeight: '600', color: varianceColor } },
                          (analytics.hoursVariance >= 0 ? '+' : '') + analytics.hoursVariance.toFixed(1) + 'h'
                        ),
                        h('div', { style: { fontSize: '11px', color: varianceColor } },
                          (analytics.hoursVariancePercent >= 0 ? '+' : '') + analytics.hoursVariancePercent.toFixed(1) + '%'
                        )
                      )
                    ),
                    h('td', { style: { textAlign: 'right' } }, 
                      'P' + (analytics.budgetedFee / 1000).toFixed(0) + 'K'
                    ),
                    h('td', { style: { textAlign: 'right', fontWeight: '600', color: '#1976D2' } }, 
                      'P' + (analytics.actualAmount / 1000).toFixed(0) + 'K'
                    ),
                    h('td', { style: { textAlign: 'right', fontWeight: '600', color: varianceColor } }, 
                      (analytics.amountVariance >= 0 ? '+' : '') + 
                      'P' + (analytics.amountVariance / 1000).toFixed(0) + 'K'
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('span', {
                        className: 'status-badge',
                        style: {
                          background: varianceColor,
                          color: 'white',
                          fontSize: '11px'
                        }
                      }, analytics.status)
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('button', {
                        className: 'btn btn-secondary',
                        style: { padding: '4px 12px', fontSize: '12px' },
                        onClick: () => setSelectedEngagement(analytics.engagement)
                      }, 'üìä Details')
                    )
                  );
                })
              )
            )
          ),
          
          // Detailed Analysis Modal
          selectedEngagement && h('div', { className: 'modal', onClick: () => setSelectedEngagement(null) },
            h('div', { 
              className: 'modal-content', 
              onClick: (e) => e.stopPropagation(),
              style: { maxWidth: '1400px', maxHeight: '90vh', overflow: 'auto' }
            },
              h('div', { className: 'modal-header' },
                h('h2', { className: 'modal-title' }, 
                  'üìä Detailed Analysis: ' + selectedEngagement.clientName
                ),
                h('button', { className: 'close-btn', onClick: () => setSelectedEngagement(null) }, '√ó')
              ),
              
              // Tab Navigation
              h('div', { style: { 
                display: 'flex', 
                borderBottom: '2px solid #E0E0E0',
                padding: '0 24px',
                gap: '8px'
              } },
                h('button', {
                  onClick: () => setDetailTab('stage'),
                  style: {
                    padding: '12px 24px',
                    border: 'none',
                    background: detailTab === 'stage' ? '#1F4E78' : 'transparent',
                    color: detailTab === 'stage' ? 'white' : '#666',
                    fontWeight: '600',
                    cursor: 'pointer',
                    borderRadius: '8px 8px 0 0',
                    marginBottom: '-2px'
                  }
                }, 'üî∑ By Stage'),
                h('button', {
                  onClick: () => setDetailTab('task'),
                  style: {
                    padding: '12px 24px',
                    border: 'none',
                    background: detailTab === 'task' ? '#1F4E78' : 'transparent',
                    color: detailTab === 'task' ? 'white' : '#666',
                    fontWeight: '600',
                    cursor: 'pointer',
                    borderRadius: '8px 8px 0 0',
                    marginBottom: '-2px'
                  }
                }, 'üìù By Task'),
                h('button', {
                  onClick: () => setDetailTab('individual'),
                  style: {
                    padding: '12px 24px',
                    border: 'none',
                    background: detailTab === 'individual' ? '#1F4E78' : 'transparent',
                    color: detailTab === 'individual' ? 'white' : '#666',
                    fontWeight: '600',
                    cursor: 'pointer',
                    borderRadius: '8px 8px 0 0',
                    marginBottom: '-2px'
                  }
                }, 'üë§ By Individual')
              ),
                
                h('div', { className: 'modal-body' },
                  // Stage-Level Analysis Tab
                  detailTab === 'stage' && h('div', null,
                    h('h3', { style: { fontSize: '16px', fontWeight: '700', marginBottom: '12px', color: '#1F4E78' } },
                      'üî∑ Stage-Level Analysis'
                    ),
                    h('table', { style: { marginBottom: '24px' } },
                      h('thead', null,
                        h('tr', null,
                          h('th', null, 'Stage'),
                          h('th', { style: { textAlign: 'center' } }, 'Budgeted'),
                          h('th', { style: { textAlign: 'center' } }, 'Actual'),
                          h('th', { style: { textAlign: 'center' } }, 'Variance'),
                          h('th', { style: { textAlign: 'right' } }, 'Actual Amount'),
                          h('th', { style: { textAlign: 'center' } }, 'Status')
                        )
                      ),
                      h('tbody', null,
                        getStageAnalytics(selectedEngagement).map(stage => {
                          const color = stage.variancePercent > 10 ? '#DC3545' : 
                                       stage.variancePercent < -10 ? '#28A745' : '#FF9800';
                          
                          return h('tr', { key: stage.stage },
                            h('td', { style: { fontWeight: '600' } }, stage.stageName),
                            h('td', { style: { textAlign: 'center' } }, stage.budgetedHours.toFixed(1) + 'h'),
                            h('td', { style: { textAlign: 'center', fontWeight: '600', color: '#1976D2' } }, 
                              stage.actualHours.toFixed(1) + 'h'
                            ),
                            h('td', { style: { textAlign: 'center' } },
                              h('div', { style: { fontWeight: '600', color: color } },
                                (stage.variance >= 0 ? '+' : '') + stage.variance.toFixed(1) + 'h'
                              ),
                              h('div', { style: { fontSize: '11px', color: color } },
                                (stage.variancePercent >= 0 ? '+' : '') + stage.variancePercent.toFixed(1) + '%'
                              )
                            ),
                            h('td', { style: { textAlign: 'right', fontWeight: '600' } }, 
                              'P' + (stage.actualAmount / 1000).toFixed(0) + 'K'
                            ),
                            h('td', { style: { textAlign: 'center' } },
                              h('span', {
                                className: 'status-badge',
                                style: { background: color, color: 'white', fontSize: '11px' }
                              }, stage.status)
                            )
                          );
                        })
                      )
                    )
                  ),
                  
                  // Task-Level Analysis Tab
                  detailTab === 'task' && h('div', null,
                    h('h3', { style: { fontSize: '16px', fontWeight: '700', marginBottom: '12px', color: '#1F4E78' } },
                      'üìù Task-Level Analysis'
                    ),
                    h('table', { style: { marginBottom: '24px' } },
                      h('thead', null,
                        h('tr', null,
                          h('th', null, 'Stage'),
                          h('th', null, 'Task'),
                          h('th', { style: { textAlign: 'center' } }, 'Code'),
                          h('th', { style: { textAlign: 'center' } }, 'Budgeted'),
                          h('th', { style: { textAlign: 'center' } }, 'Actual'),
                          h('th', { style: { textAlign: 'center' } }, 'Variance'),
                          h('th', { style: { textAlign: 'right' } }, 'Actual Amount'),
                          h('th', { style: { textAlign: 'center' } }, 'Status')
                        )
                      ),
                      h('tbody', null,
                        getTaskAnalytics(selectedEngagement).map((task, idx) => {
                          const color = task.variancePercent > 10 ? '#DC3545' : 
                                       task.variancePercent < -10 ? '#28A745' : '#FF9800';
                          
                          return h('tr', { key: idx },
                            h('td', { style: { fontSize: '12px', color: '#666' } }, task.stageName),
                            h('td', { style: { fontWeight: '600', fontSize: '13px' } }, task.taskName),
                            h('td', { style: { textAlign: 'center', fontSize: '11px', fontFamily: 'monospace' } }, 
                              task.taskCode
                            ),
                            h('td', { style: { textAlign: 'center' } }, task.budgetedHours.toFixed(1) + 'h'),
                            h('td', { style: { textAlign: 'center', fontWeight: '600', color: '#1976D2' } }, 
                              task.actualHours.toFixed(1) + 'h'
                            ),
                            h('td', { style: { textAlign: 'center' } },
                              h('div', { style: { fontWeight: '600', color: color } },
                                (task.variance >= 0 ? '+' : '') + task.variance.toFixed(1) + 'h'
                              ),
                              h('div', { style: { fontSize: '11px', color: color } },
                                (task.variancePercent >= 0 ? '+' : '') + task.variancePercent.toFixed(1) + '%'
                              )
                            ),
                            h('td', { style: { textAlign: 'right', fontSize: '13px' } }, 
                              task.actualAmount > 0 ? 'P' + (task.actualAmount / 1000).toFixed(0) + 'K' : '-'
                            ),
                            h('td', { style: { textAlign: 'center' } },
                              h('span', {
                                className: 'status-badge',
                                style: { background: color, color: 'white', fontSize: '11px' }
                              }, task.status)
                            )
                          );
                        })
                      )
                    )
                  ),
                  
                  // Individual Analysis Tab
                  detailTab === 'individual' && h('div', null,
                    h('h3', { style: { fontSize: '16px', fontWeight: '700', marginBottom: '12px', color: '#1F4E78' } },
                      'üë§ Individual Staff Analysis'
                    ),
                    h('table', { style: { marginBottom: '24px' } },
                      h('thead', null,
                        h('tr', null,
                          h('th', null, 'Staff Member'),
                          h('th', { style: { textAlign: 'center' } }, 'Budgeted'),
                          h('th', { style: { textAlign: 'center' } }, 'Actual'),
                          h('th', { style: { textAlign: 'center' } }, 'Variance'),
                          h('th', { style: { textAlign: 'right' } }, 'Actual Amount'),
                          h('th', { style: { textAlign: 'center' } }, 'Tasks Worked'),
                          h('th', { style: { textAlign: 'center' } }, 'Status')
                        )
                      ),
                      h('tbody', null,
                        getIndividualAnalytics(selectedEngagement).map((individual, idx) => {
                          const color = individual.variancePercent > 10 ? '#DC3545' : 
                                       individual.variancePercent < -10 ? '#28A745' : '#FF9800';
                          
                          return h('tr', { key: idx },
                            h('td', { style: { fontWeight: '600' } }, individual.staffName),
                            h('td', { style: { textAlign: 'center' } }, 
                              individual.budgetedHours.toFixed(1) + 'h'
                            ),
                            h('td', { style: { textAlign: 'center', fontWeight: '600', color: '#1976D2' } }, 
                              individual.actualHours.toFixed(1) + 'h'
                            ),
                            h('td', { style: { textAlign: 'center' } },
                              h('div', { style: { fontWeight: '600', color: color } },
                                (individual.variance >= 0 ? '+' : '') + individual.variance.toFixed(1) + 'h'
                              ),
                              individual.budgetedHours > 0 && h('div', { style: { fontSize: '11px', color: color } },
                                (individual.variancePercent >= 0 ? '+' : '') + individual.variancePercent.toFixed(1) + '%'
                              )
                            ),
                            h('td', { style: { textAlign: 'right', fontWeight: '600' } }, 
                              'P' + (individual.actualAmount / 1000).toFixed(0) + 'K'
                            ),
                            h('td', { style: { textAlign: 'center', fontSize: '13px', color: '#666' } },
                              Object.keys(individual.tasks).length + ' tasks'
                            ),
                            h('td', { style: { textAlign: 'center' } },
                              h('span', {
                                className: 'status-badge',
                                style: { background: color, color: 'white', fontSize: '11px' }
                              }, individual.status)
                            )
                          );
                        })
                      )
                    )
                  )
                )
              ),
              h('div', { className: 'modal-footer' },
                h('button', { 
                  className: 'btn btn-secondary', 
                  onClick: () => setSelectedEngagement(null) 
                }, 'Close')
              )
            )
          )
      );
    }

    function BillingView({ engagements, onUpdate }) {
      const [selectedEngagement, setSelectedEngagement] = useState(null);
      const [showBillingForm, setShowBillingForm] = useState(false);
      const [editingBilling, setEditingBilling] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');

      const totalBudget = engagements.reduce((sum, e) => sum + e.budgetedFee, 0);
      const totalBilled = engagements.reduce((sum, e) => 
        sum + (e.billings || []).reduce((s, b) => s + b.amount, 0), 0
      );
      const totalOutstanding = totalBudget - totalBilled;
      const collectionRate = totalBudget > 0 ? ((totalBilled / totalBudget) * 100).toFixed(1) : 0;

      const engagementsWithBilling = engagements.map(e => {
        const billed = (e.billings || []).reduce((sum, b) => sum + b.amount, 0);
        const outstanding = e.budgetedFee - billed;
        const progress = e.budgetedFee > 0 ? ((billed / e.budgetedFee) * 100).toFixed(0) : 0;
        return { ...e, totalBilled: billed, outstanding, billingProgress: progress };
      }).filter(e => e.clientName.toLowerCase().includes(searchTerm.toLowerCase()));

      const handleAddBilling = (billing) => {
        const updated = engagements.map(e => {
          if (e.id === selectedEngagement.id) {
            const billings = e.billings || [];
            if (editingBilling) {
              return { ...e, billings: billings.map(b => b.id === billing.id ? billing : b) };
            } else {
              return { ...e, billings: [...billings, { ...billing, id: Date.now() }] };
            }
          }
          return e;
        });
        onUpdate(updated);
        setShowBillingForm(false);
        setEditingBilling(null);
      };

      const handleDeleteBilling = (billingId) => {
        if (confirm('Delete this billing record?')) {
          const updated = engagements.map(e => {
            if (e.id === selectedEngagement.id) {
              return { ...e, billings: (e.billings || []).filter(b => b.id !== billingId) };
            }
            return e;
          });
          onUpdate(updated);
        }
      };

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, 'Billing Management')
        ),

        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'Total Budget'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, `P${(totalBudget / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, 'All engagements')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#28A745' } },
            h('div', { className: 'metric-label' }, 'Total Billed'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, `P${(totalBilled / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, `${collectionRate}% of budget`)
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#FFC107' } },
            h('div', { className: 'metric-label' }, 'Outstanding'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, `P${(totalOutstanding / 1000).toFixed(0)}K`),
            h('div', { className: 'metric-detail' }, 'To be billed')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'Collection Rate'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, `${collectionRate}%`),
            h('div', { className: 'metric-detail' }, 'Billed vs Budget')
          )
        ),

        h('div', { className: 'card', style: { marginBottom: '20px', padding: '16px' } },
          h('input', {
            className: 'form-input',
            style: { marginBottom: 0 },
            type: 'text',
            placeholder: 'Search by client name...',
            value: searchTerm,
            onChange: (e) => setSearchTerm(e.target.value)
          })
        ),

        h('div', { className: 'card', style: { overflowX: 'auto' } },
          h('table', null,
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', { style: { textAlign: 'right' } }, 'Budget Fee'),
                h('th', { style: { textAlign: 'right' } }, 'Total Billed'),
                h('th', { style: { textAlign: 'right' } }, 'Outstanding'),
                h('th', { style: { textAlign: 'center' } }, 'Progress'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              engagementsWithBilling.map(e => {
                const progressColor = e.billingProgress >= 100 ? '#28A745' : 
                                     e.billingProgress >= 70 ? '#4472C4' : '#FFC107';
                
                return h('tr', { key: e.id },
                  h('td', { style: { fontWeight: '600' } }, e.clientName),
                  h('td', { style: { textAlign: 'right' } }, `P${e.budgetedFee.toLocaleString()}`),
                  h('td', { style: { textAlign: 'right', color: '#28A745', fontWeight: '600' } }, `P${e.totalBilled.toLocaleString()}`),
                  h('td', { style: { textAlign: 'right', color: e.outstanding > 0 ? '#FFC107' : '#28A745', fontWeight: '600' } }, `P${e.outstanding.toLocaleString()}`),
                  h('td', { style: { textAlign: 'center' } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', justifyContent: 'center' } },
                      h('div', { style: { width: '100px', height: '20px', background: '#E0E0E0', borderRadius: '10px', overflow: 'hidden' } },
                        h('div', { style: { width: `${Math.min(e.billingProgress, 100)}%`, height: '100%', background: progressColor, transition: 'width 0.3s' } })
                      ),
                      h('span', { style: { fontSize: '13px', fontWeight: '600', color: progressColor } }, `${e.billingProgress}%`)
                    )
                  ),
                  h('td', { style: { textAlign: 'center' } },
                    h('button', {
                      className: 'btn btn-primary',
                      style: { padding: '6px 16px', fontSize: '13px' },
                      onClick: () => setSelectedEngagement(e)
                    }, 'Manage')
                  )
                );
              })
            )
          )
        ),

        selectedEngagement && h(BillingDetailModal, {
          engagement: selectedEngagement,
          onClose: () => setSelectedEngagement(null),
          onAddBilling: () => {
            setEditingBilling(null);
            setShowBillingForm(true);
          },
          onEditBilling: (billing) => {
            setEditingBilling(billing);
            setShowBillingForm(true);
          },
          onDeleteBilling: handleDeleteBilling
        }),

        showBillingForm && selectedEngagement && h(BillingForm, {
          engagement: selectedEngagement,
          billing: editingBilling,
          onSave: handleAddBilling,
          onCancel: () => {
            setShowBillingForm(false);
            setEditingBilling(null);
          }
        })
      );
    }

    function BillingDetailModal({ engagement, onClose, onAddBilling, onEditBilling, onDeleteBilling }) {
      const billings = engagement.billings || [];
      const totalBilled = billings.reduce((sum, b) => sum + b.amount, 0);
      const outstanding = engagement.budgetedFee - totalBilled;
      const progress = engagement.budgetedFee > 0 ? ((totalBilled / engagement.budgetedFee) * 100).toFixed(1) : 0;

      return h('div', { className: 'modal', onClick: onClose },
        h('div', { className: 'modal-content', style: { maxWidth: '800px' }, onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, `Billing: ${engagement.clientName}`),
            h('button', { className: 'close-btn', onClick: onClose }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            h('div', { style: { background: '#F8F9FA', padding: '20px', borderRadius: '8px', marginBottom: '24px' } },
              h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px', marginBottom: '16px' } },
                h('div', null,
                  h('div', { style: { fontSize: '12px', color: '#666' } }, 'Budget Fee'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700', color: '#4472C4' } }, `P${engagement.budgetedFee.toLocaleString()}`)
                ),
                h('div', null,
                  h('div', { style: { fontSize: '12px', color: '#666' } }, 'Total Billed'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700', color: '#28A745' } }, `P${totalBilled.toLocaleString()}`)
                ),
                h('div', null,
                  h('div', { style: { fontSize: '12px', color: '#666' } }, 'Outstanding'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700', color: outstanding > 0 ? '#FFC107' : '#28A745' } }, `P${outstanding.toLocaleString()}`)
                )
              ),
              h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '8px' } }, 'Billing Progress'),
              h('div', { className: 'progress-bar' },
                h('div', { className: 'progress-fill', style: { width: `${Math.min(progress, 100)}%`, background: progress >= 100 ? '#28A745' : '#4472C4' } })
              ),
              h('div', { style: { fontSize: '14px', fontWeight: '600', marginTop: '8px', textAlign: 'center' } }, `${progress}% Billed`)
            ),

            h('div', { style: { marginBottom: '16px' } },
              h('button', { className: 'btn btn-primary', onClick: onAddBilling }, '+ Add Billing Record')
            ),

            h('div', { className: 'section-title' }, 'Billing History'),
            billings.length === 0 ?
              h('div', { className: 'empty-state' },
                h('div', { className: 'empty-state-icon' }, 'üí∞'),
                h('p', null, 'No billing records yet')
              ) :
              h('table', null,
                h('thead', null,
                  h('tr', null,
                    h('th', null, 'Date'),
                    h('th', { style: { textAlign: 'right' } }, 'Amount'),
                    h('th', null, 'Description'),
                    h('th', { style: { textAlign: 'center' } }, 'Status'),
                    h('th', { style: { textAlign: 'center' } }, 'Actions')
                  )
                ),
                h('tbody', null,
                  billings.sort((a, b) => new Date(b.date) - new Date(a.date)).map(b => 
                    h('tr', { key: b.id },
                      h('td', null, b.date),
                      h('td', { style: { textAlign: 'right', fontWeight: '600' } }, `P${b.amount.toLocaleString()}`),
                      h('td', null, b.description),
                      h('td', { style: { textAlign: 'center' } },
                        h('span', { className: 'status-badge', style: { background: b.status === 'Paid' ? '#28A745' : '#FFC107', color: 'white' } }, b.status)
                      ),
                      h('td', { style: { textAlign: 'center' } },
                        h('div', { style: { display: 'flex', gap: '8px', justifyContent: 'center' } },
                          h('button', {
                            style: { padding: '4px 10px', background: '#4472C4', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                            onClick: () => onEditBilling(b)
                          }, 'Edit'),
                          h('button', {
                            style: { padding: '4px 10px', background: '#DC3545', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' },
                            onClick: () => onDeleteBilling(b.id)
                          }, 'Delete')
                        )
                      )
                    )
                  )
                )
              )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Close')
          )
        )
      );
    }

    function BillingForm({ engagement, billing, onSave, onCancel }) {
      const [formData, setFormData] = useState(billing || {
        date: new Date().toISOString().split('T')[0],
        amount: '',
        description: '',
        status: 'Draft'
      });

      const handleChange = (field, value) => {
        setFormData({ ...formData, [field]: value });
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.date || !formData.amount || !formData.description) {
          alert('Please fill in all fields');
          return;
        }
        onSave({ ...formData, amount: parseFloat(formData.amount) || 0 });
      };

      return h('div', { className: 'modal', onClick: onCancel },
        h('div', { className: 'modal-content', style: { maxWidth: '600px' }, onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, billing ? 'Edit Billing' : 'Add Billing'),
            h('button', { className: 'close-btn', onClick: onCancel }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            h('form', { onSubmit: handleSubmit, id: 'billingForm' },
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Date *'),
                h('input', { className: 'form-input', type: 'date', value: formData.date, onChange: (e) => handleChange('date', e.target.value), required: true })
              ),
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Amount (BWP) *'),
                h('input', { className: 'form-input', type: 'number', value: formData.amount, onChange: (e) => handleChange('amount', e.target.value), required: true, min: '0' })
              ),
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Description *'),
                h('textarea', { className: 'form-input', style: { minHeight: '80px' }, value: formData.description, onChange: (e) => handleChange('description', e.target.value), required: true })
              ),
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Status *'),
                h('select', { className: 'form-input', value: formData.status, onChange: (e) => handleChange('status', e.target.value), required: true },
                  h('option', { value: 'Draft' }, 'Draft'),
                  h('option', { value: 'Invoiced' }, 'Invoiced'),
                  h('option', { value: 'Paid' }, 'Paid'),
                  h('option', { value: 'Overdue' }, 'Overdue')
                )
              )
            )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', type: 'button', onClick: onCancel }, 'Cancel'),
            h('button', { className: 'btn btn-primary', type: 'submit', form: 'billingForm' }, billing ? 'Update' : 'Add Billing')
          )
        )
      );
    }


    // SECTION 5: RESOURCE PLANNING & OPTIMIZATION MODULE
    

    // SECTION 5: RESOURCE OPTIMIZATION MODULE
    function ResourceOptimizationView({ staff, engagements, onUpdate }) {
      const [selectedEngagement, setSelectedEngagement] = useState(null);
      const [showTaskManager, setShowTaskManager] = useState(false);
      const [currentView, setCurrentView] = useState('tasks');

      return h('div', null,
        h('div', { className: 'page-header' },
          h('h1', { className: 'page-title' }, 'Resource Optimization'),
          h('p', { style: { marginTop: '8px', fontSize: '14px', color: '#666' } }, 
            'Task-based planning with calendar views and resource allocation'
          )
        ),

        h('div', { style: { marginBottom: '24px', display: 'flex', gap: '0', flexWrap: 'wrap' } },
          h('button', { 
            className: `view-tab ${currentView === 'tasks' ? 'active' : ''}`,
            onClick: () => setCurrentView('tasks')
          }, 'üìã', h('span', null, 'Task Planning')),
          h('button', { 
            className: `view-tab ${currentView === 'calendar' ? 'active' : ''}`,
            onClick: () => setCurrentView('calendar')
          }, 'üìÖ', h('span', null, 'Calendar View')),
          h('button', { 
            className: `view-tab ${currentView === 'gantt' ? 'active' : ''}`,
            onClick: () => setCurrentView('gantt')
          }, 'üìä', h('span', null, 'Gantt Chart')),
          h('button', { 
            className: `view-tab ${currentView === 'utilization' ? 'active' : ''}`,
            onClick: () => setCurrentView('utilization')
          }, 'üìà', h('span', null, 'Utilization')),
          h('button', { 
            className: `view-tab ${currentView === 'adjustments' ? 'active' : ''}`,
            onClick: () => setCurrentView('adjustments')
          }, '‚úÖ', h('span', null, 'Approvals'))
        ),

        currentView === 'tasks' && h('div', null,
          // Workflow Banner
          h('div', {
            style: {
              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              padding: '20px 24px',
              borderRadius: '12px',
              color: 'white',
              marginBottom: '24px',
              boxShadow: '0 4px 12px rgba(102,126,234,0.3)'
            }
          },
            h('div', { style: { fontSize: '16px', fontWeight: '700', marginBottom: '12px' } }, 
              'üîÑ Workflow: Step 3 of 4'
            ),
            h('div', { style: { display: 'flex', gap: '16px', alignItems: 'center', fontSize: '14px' } },
              h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', opacity: 0.7 } },
                h('div', { style: { padding: '6px 12px', background: 'rgba(255,255,255,0.2)', borderRadius: '6px' } }, 
                  '‚úì 1. Engagement'
                )
              ),
              h('div', { style: { fontSize: '20px', opacity: 0.7 } }, '‚Üí'),
              h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', opacity: 0.7 } },
                h('div', { style: { padding: '6px 12px', background: 'rgba(255,255,255,0.2)', borderRadius: '6px' } }, 
                  '‚úì 2. Budget'
                )
              ),
              h('div', { style: { fontSize: '20px' } }, '‚Üí'),
              h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                h('div', { style: { padding: '6px 12px', background: 'rgba(255,255,255,0.9)', color: '#667eea', borderRadius: '6px', fontWeight: '700' } }, 
                  'üìã 3. Allocate Tasks'
                )
              ),
              h('div', { style: { fontSize: '20px', opacity: 0.7 } }, '‚Üí'),
              h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', opacity: 0.7 } },
                h('div', { style: { padding: '6px 12px', background: 'rgba(255,255,255,0.2)', borderRadius: '6px' } }, 
                  '4. Calendar'
                )
              )
            ),
            h('div', { style: { marginTop: '12px', fontSize: '13px', opacity: 0.9, fontStyle: 'italic' } },
              'üí° Select a budget below ‚Üí Click "Allocate Tasks" ‚Üí Assign team members to each budgeted task'
            )
          ),

          h('div', { className: 'card' },
            h('div', { style: { marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
              h('h3', { style: { fontSize: '20px', fontWeight: '700', color: '#1F4E78', margin: 0 } }, 
                'üí∞ Budget Allocation Overview'
              ),
              h('div', { style: { fontSize: '13px', color: '#666' } },
                engagements.filter(e => e.budgetData && e.hasBudget).length + ' budgets ready for allocation'
              )
            ),
            h('table', null,
              h('thead', null,
                h('tr', null,
                  h('th', null, 'Client'),
                  h('th', { style: { textAlign: 'center' } }, 'Budget Status'),
                  h('th', { style: { textAlign: 'center' } }, 'Total Tasks'),
                  h('th', { style: { textAlign: 'center' } }, 'Budget Hours'),
                  h('th', { style: { textAlign: 'center' } }, 'Allocated'),
                  h('th', { style: { textAlign: 'center' } }, 'Progress'),
                  h('th', { style: { textAlign: 'center' } }, 'Actions')
                )
              ),
              h('tbody', null,
                engagements.map(e => {
                  const tasks = e.tasks || [];
                  const budgetedTasks = tasks.filter(t => t.budgetLocked);
                  const totalBudgetHours = budgetedTasks.reduce((sum, t) => sum + (t.budgetHours || 0), 0);
                  const assignedTasks = budgetedTasks.filter(t => (t.assignments || []).length > 0);
                  const totalAssignedHours = budgetedTasks.reduce((sum, t) => {
                    const taskAssigned = (t.assignments || []).reduce((s, a) => s + (a.hours || 0), 0);
                    return sum + taskAssigned;
                  }, 0);
                  const hasBudget = e.budgetData && e.hasBudget;
                  const allocationProgress = totalBudgetHours > 0 ? Math.round((totalAssignedHours / totalBudgetHours) * 100) : 0;

                  return h('tr', { key: e.id },
                    h('td', { style: { fontWeight: '600' } }, e.clientName),
                    h('td', { style: { textAlign: 'center' } },
                      h('span', {
                        style: {
                          padding: '5px 12px',
                          borderRadius: '12px',
                          fontSize: '11px',
                          fontWeight: '700',
                          background: hasBudget ? '#E8F5E9' : '#FFF3E0',
                          color: hasBudget ? '#2E7D32' : '#E65100',
                          display: 'inline-block'
                        }
                      }, hasBudget ? '‚úÖ Budget Ready' : '‚ö†Ô∏è No Budget')
                    ),
                    h('td', { style: { textAlign: 'center', fontSize: '14px' } }, 
                      h('div', { style: { fontWeight: '700', fontSize: '16px', color: '#1F4E78' } }, budgetedTasks.length),
                      budgetedTasks.length > 0 && h('div', { style: { fontSize: '11px', color: assignedTasks.length === budgetedTasks.length ? '#4CAF50' : '#FF9800', marginTop: '2px', fontWeight: '600' } },
                        assignedTasks.length + '/' + budgetedTasks.length + ' assigned'
                      )
                    ),
                    h('td', { style: { textAlign: 'center', fontWeight: '700', fontSize: '15px', color: '#1F4E78' } }, 
                      totalBudgetHours + 'h'
                    ),
                    h('td', { style: { textAlign: 'center' } }, 
                      h('div', { style: { fontWeight: '700', fontSize: '15px', color: totalAssignedHours > 0 ? '#2E7D32' : '#999' } }, 
                        totalAssignedHours + 'h'
                      ),
                      totalAssignedHours > 0 && totalAssignedHours !== totalBudgetHours && h('div', { 
                        style: { 
                          fontSize: '10px', 
                          marginTop: '4px',
                          color: totalAssignedHours > totalBudgetHours ? '#F44336' : '#FF9800',
                          fontWeight: '600'
                        } 
                      }, totalAssignedHours > totalBudgetHours ? 
                        '+' + (totalAssignedHours - totalBudgetHours) + 'h over' : 
                        (totalBudgetHours - totalAssignedHours) + 'h remaining'
                      )
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('div', { style: { width: '100%', maxWidth: '120px', margin: '0 auto' } },
                        h('div', { style: { 
                          height: '24px', 
                          background: '#E0E0E0', 
                          borderRadius: '12px', 
                          overflow: 'hidden',
                          position: 'relative'
                        } },
                          h('div', {
                            style: {
                              height: '100%',
                              width: allocationProgress + '%',
                              background: allocationProgress === 100 ? '#4CAF50' : 
                                          allocationProgress > 100 ? '#F44336' : 
                                          allocationProgress > 50 ? '#FF9800' : '#2196F3',
                              transition: 'width 0.3s',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center'
                            }
                          },
                            allocationProgress > 15 && h('span', { 
                              style: { 
                                color: 'white', 
                                fontSize: '11px', 
                                fontWeight: '700' 
                              } 
                            }, allocationProgress + '%')
                          )
                        ),
                        allocationProgress <= 15 && allocationProgress > 0 && h('div', { 
                          style: { 
                            fontSize: '10px', 
                            marginTop: '4px', 
                            fontWeight: '600',
                            color: '#666'
                          } 
                        }, allocationProgress + '%')
                      )
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('button', {
                        className: 'btn btn-primary',
                        style: {
                          padding: '10px 20px',
                          fontSize: '13px',
                          fontWeight: '700',
                          opacity: !hasBudget || budgetedTasks.length === 0 || e.budgetApprovalStatus !== 'Approved' ? 0.5 : 1,
                          cursor: !hasBudget || budgetedTasks.length === 0 || e.budgetApprovalStatus !== 'Approved' ? 'not-allowed' : 'pointer',
                          background: allocationProgress === 100 ? '#4CAF50' : 
                                     e.budgetApprovalStatus !== 'Approved' ? '#999' : '#1F4E78'
                        },
                        onClick: () => {
                          if (e.budgetApprovalStatus !== 'Approved') {
                            alert('‚ö†Ô∏è Budget must be approved before allocating tasks.\n\nPlease ask your Manager/Partner to approve the budget in Budget Approvals.');
                            return;
                          }
                          if (hasBudget && budgetedTasks.length > 0) {
                            setSelectedEngagement(e);
                            setShowTaskManager(true);
                          }
                        },
                        disabled: !hasBudget || budgetedTasks.length === 0 || e.budgetApprovalStatus !== 'Approved',
                        title: e.budgetApprovalStatus !== 'Approved' ? 'Budget requires approval before allocation' : ''
                      }, 
                        !hasBudget ? '‚ö†Ô∏è Create Budget First' :
                        budgetedTasks.length === 0 ? '‚ö†Ô∏è No Tasks' :
                        e.budgetApprovalStatus !== 'Approved' ? 'üîí Pending Approval' :
                        allocationProgress === 100 ? '‚úì Review Allocation' :
                        allocationProgress > 0 ? 'üìã Continue Allocating' :
                        'üìã Start Allocation'
                      )
                    )
                  );
                })
              )
            )
          )
        ),

        currentView === 'calendar' && h(CalendarView, { 
          engagements, 
          staff, 
          onUpdate,
          onOpenTaskManager: (engagement) => {
            setSelectedEngagement(engagement);
            setShowTaskManager(true);
          }
        }),
        
        currentView === 'gantt' && h(GanttChartView, { engagements, staff }),
        
        currentView === 'utilization' && h(UtilizationView, { engagements, staff }),
        
        currentView === 'adjustments' && h(ApprovalsView, { engagements, staff, onUpdate }),

        showTaskManager && selectedEngagement && h(TaskManagerModal, {
          engagement: selectedEngagement,
          staff: staff,
          allEngagements: engagements,
          onClose: () => {
            setShowTaskManager(false);
            setSelectedEngagement(null);
          },
          onUpdate: (updatedEngagement) => {
            const updated = engagements.map(e => 
              e.id === updatedEngagement.id ? updatedEngagement : e
            );
            onUpdate(updated);
            setShowTaskManager(false);
            setSelectedEngagement(null);
          }
        })
      );
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FINAL BUDGET SYSTEM - ALL ISSUES FIXED
    // Client names, Excel, Load previous, Multi-select
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FINAL BUDGET SYSTEM - ALL ISSUES FIXED
    // Client names, Excel export, Load previous, Multi-select tasks
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // TASK CODE LIBRARY
    const TASK_LIBRARY = {
      'A': {
        name: 'Acceptance',
        color: '#9C27B0',
        tasks: [
          { code: 'A01', name: 'Client acceptance evaluation', hours: 4 },
          { code: 'A02', name: 'Continuance assessment', hours: 3 },
          { code: 'A03', name: 'Independence assessment', hours: 2 },
          { code: 'A04', name: 'Engagement letter preparation', hours: 3 },
          { code: 'A05', name: 'AML/KYC procedures', hours: 4 }
        ]
      },
      'B': {
        name: 'Planning',
        color: '#2196F3',
        tasks: [
          { code: 'B01', name: 'Prep audit budget', hours: 6 },
          { code: 'B02', name: 'Client preparation list', hours: 4 },
          { code: 'B05', name: 'Pre-engagement planning', hours: 12 },
          { code: 'B07', name: 'System walkthroughs', hours: 20 },
          { code: 'B08', name: 'Risk assessment', hours: 16 },
          { code: 'B09', name: 'Materiality determination', hours: 4 },
          { code: 'B11', name: 'Audit plan', hours: 12 },
          { code: 'B14', name: 'Strategy memorandum', hours: 8 }
        ]
      },
      'C': {
        name: 'Fieldwork',
        color: '#4CAF50',
        tasks: [
          { code: 'C01', name: 'Revenue - Trading', hours: 24 },
          { code: 'C03', name: 'Cost of sales', hours: 18 },
          { code: 'C10', name: 'PPE', hours: 20 },
          { code: 'C14', name: 'ROU assets (IFRS 16)', hours: 16 },
          { code: 'C30', name: 'Inventories', hours: 18 },
          { code: 'C31', name: 'Trade receivables', hours: 20 },
          { code: 'C33', name: 'Cash', hours: 12 },
          { code: 'C45', name: 'Trade payables', hours: 16 },
          { code: 'C50', name: 'Current tax', hours: 14 },
          { code: 'C51', name: 'Deferred tax', hours: 16 }
        ]
      },
      'D': {
        name: 'Completion',
        color: '#FF9800',
        tasks: [
          { code: 'D01', name: 'Subsequent events', hours: 6 },
          { code: 'D03', name: 'Analytical review', hours: 8 },
          { code: 'D08', name: 'FS review', hours: 16 },
          { code: 'D09', name: 'Management reps', hours: 4 },
          { code: 'D12', name: 'File review', hours: 16 },
          { code: 'D16', name: 'Draft report', hours: 6 }
        ]
      },
      'E': {
        name: 'Lockdown',
        color: '#F44336',
        tasks: [
          { code: 'E01', name: 'Final report', hours: 4 },
          { code: 'E03', name: 'Report signing', hours: 2 },
          { code: 'E05', name: 'File archiving', hours: 6 },
          { code: 'E11', name: 'CIPA filing', hours: 4 }
        ]
      }
    };

    function FinalBudgetSystem({ engagements, staff, onUpdate, user }) {
      const [mode, setMode] = React.useState('list');
      const [step, setStep] = React.useState(1);
      const [stageIdx, setStageIdx] = React.useState(0);
      const [selectedTasks, setSelectedTasks] = React.useState({});
      
      // CUSTOM TASK CODES: Load from localStorage, allow adding custom tasks
      const [taskLibrary, setTaskLibrary] = React.useState(() => {
        const saved = localStorage.getItem('customTaskLibrary');
        return saved ? JSON.parse(saved) : TASK_LIBRARY;
      });
      
      // Save custom tasks to localStorage
      React.useEffect(() => {
        localStorage.setItem('customTaskLibrary', JSON.stringify(taskLibrary));
      }, [taskLibrary]);
      
      const [showAddTaskModal, setShowAddTaskModal] = React.useState(false);
      const [addTaskStage, setAddTaskStage] = React.useState('A');
      const [newTaskCode, setNewTaskCode] = React.useState('');
      const [newTaskName, setNewTaskName] = React.useState('');
      const [newTaskHours, setNewTaskHours] = React.useState(4);
      
      const [budget, setBudget] = React.useState({
        id: null,
        engagementId: null,
        client: '',
        yearEnd: '',
        fee: 0,
        totalHours: 0,
        stages: [],
        tasks: {},
        created: null
      });

      // Get saved budgets
      const savedBudgets = engagements
        .filter(e => e.budgetData)
        .map(e => ({
          ...e.budgetData,
          engagementId: e.id,
          clientName: e.clientName,
          status: e.budgetData.status || e.budgetApprovalStatus || 'Draft'  // FIXED: Use budget approval status
        }));

      // Select engagement
      const selectEngagement = (engId) => {
        const eng = engagements.find(e => e.id === parseInt(engId));
        if (!eng) return;

        const hours = Math.round((eng.budgetedFee || 0) / 1000);
        
        setBudget({
          id: Date.now(),
          engagementId: eng.id,
          client: eng.clientName,
          yearEnd: eng.yearEnd,
          fee: eng.budgetedFee || 0,
          totalHours: hours,
          stages: [
            { code: 'A', name: 'Acceptance', color: '#9C27B0', hours: Math.round(hours * 0.02) },
            { code: 'B', name: 'Planning', color: '#2196F3', hours: Math.round(hours * 0.12) },
            { code: 'C', name: 'Fieldwork', color: '#4CAF50', hours: Math.round(hours * 0.60) },
            { code: 'D', name: 'Completion', color: '#FF9800', hours: Math.round(hours * 0.20) },
            { code: 'E', name: 'Lockdown', color: '#F44336', hours: Math.round(hours * 0.06) }
          ],
          tasks: {},
          created: new Date().toISOString()
        });
        setSelectedTasks({});
      };

      // Load from previous budget
      const loadFromPrevious = (sourceEngId, targetEngId) => {
        const sourceEng = engagements.find(e => e.id === parseInt(sourceEngId));
        const targetEng = engagements.find(e => e.id === parseInt(targetEngId));
        
        if (!sourceEng || !targetEng || !sourceEng.budgetData) return;

        const hours = Math.round((targetEng.budgetedFee || 0) / 1000);
        
        setBudget({
          id: Date.now(),
          engagementId: targetEng.id,
          client: targetEng.clientName,
          yearEnd: targetEng.yearEnd,
          fee: targetEng.budgetedFee || 0,
          totalHours: hours,
          stages: sourceEng.budgetData.stages,
          tasks: JSON.parse(JSON.stringify(sourceEng.budgetData.tasks)),
          created: new Date().toISOString()
        });
        setSelectedTasks({});
      };

      // Add tasks (multi-select)
      const addSelectedTasks = (stageCode) => {
        const tasksToAdd = selectedTasks[stageCode] || [];
        if (tasksToAdd.length === 0) return;

        const newTasks = {...budget.tasks};
        if (!newTasks[stageCode]) newTasks[stageCode] = [];

        tasksToAdd.forEach(taskCode => {
          const task = taskLibrary[stageCode].tasks.find(t => t.code === taskCode);
          if (task && !newTasks[stageCode].find(t => t.code === taskCode)) {
            newTasks[stageCode].push({...task});
          }
        });

        setBudget({...budget, tasks: newTasks});
        setSelectedTasks({...selectedTasks, [stageCode]: []});
      };

      // Toggle task selection
      const toggleTaskSelection = (stageCode, taskCode) => {
        const current = selectedTasks[stageCode] || [];
        const newSelection = current.includes(taskCode)
          ? current.filter(c => c !== taskCode)
          : [...current, taskCode];
        
        setSelectedTasks({...selectedTasks, [stageCode]: newSelection});
      };

      // Remove task
      const removeTask = (stageCode, taskCode) => {
        const newTasks = {...budget.tasks};
        newTasks[stageCode] = newTasks[stageCode].filter(t => t.code !== taskCode);
        setBudget({...budget, tasks: newTasks});
      };

      // Update hours
      const updateHours = (stageCode, taskCode, hours) => {
        const newTasks = {...budget.tasks};
        const task = newTasks[stageCode].find(t => t.code === taskCode);
        if (task) {
          task.hours = parseInt(hours) || 0;
          setBudget({...budget, tasks: newTasks});
        }
      };

      // Export to Excel - FIXED!
      const exportExcel = () => {
        if (typeof XLSX === 'undefined') {
          alert('Excel library not loaded. Please refresh the page and try again.');
          return;
        }

        try {
          const wb = XLSX.utils.book_new();
          
          const summary = [
            ['AUDIT BUDGET - ' + budget.client],
            ['Year End:', budget.yearEnd],
            ['Fee:', 'P' + budget.fee.toLocaleString()],
            ['Hours:', budget.totalHours],
            [],
            ['Stage', 'Tasks', 'Hours']
          ];

          budget.stages.forEach(stage => {
            const tasks = budget.tasks[stage.code] || [];
            const hours = tasks.reduce((sum, t) => sum + t.hours, 0);
            summary.push([stage.name, tasks.length, hours]);
          });

          const ws1 = XLSX.utils.aoa_to_sheet(summary);
          XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

          const detail = [['Stage', 'Code', 'Task', 'Hours']];
          budget.stages.forEach(stage => {
            (budget.tasks[stage.code] || []).forEach(task => {
              detail.push([stage.name, task.code, task.name, task.hours]);
            });
          });

          const ws2 = XLSX.utils.aoa_to_sheet(detail);
          XLSX.utils.book_append_sheet(wb, ws2, 'Detail');

          const clientName = (budget.client || 'Budget').replace(/[^a-z0-9]/gi, '_');
          XLSX.writeFile(wb, clientName + '_Budget.xlsx');
          alert('‚úÖ Budget exported successfully!');
        } catch (error) {
          alert('Export failed: ' + error.message);
        }
      };

      // Save budget - CREATES TASKS AUTOMATICALLY
      const saveBudget = () => {
        // CRITICAL FIX: Check if budget is approved - block saves if approved
        const existingEngagement = engagements.find(e => e.id === budget.engagementId);
        const isApproved = existingEngagement && existingEngagement.budgetData && 
                          existingEngagement.budgetData.status === 'Approved';
        
        if (isApproved) {
          // Check if current user is Partner
          const session = JSON.parse(localStorage.getItem('audit_manager_session') || '{}');
          const isPartner = session.user && session.user.role === 'Partner';
          
          if (isPartner) {
            // Partner can unlock - show confirmation dialog
            const confirmUnlock = confirm(
              'üîí BUDGET LOCKED\n\n' +
              'This budget has been approved and is locked.\n\n' +
              'As a Partner, you can unlock this budget for editing.\n\n' +
              '‚ö†Ô∏è Unlocking will:\n' +
              '‚Ä¢ Change status to "Pending Approval"\n' +
              '‚Ä¢ Require re-approval after changes\n' +
              '‚Ä¢ Be logged in audit trail\n\n' +
              'Do you want to UNLOCK this budget?'
            );
            
            if (!confirmUnlock) {
              return; // User cancelled
            }
            
            // Unlock the budget
            const reason = prompt('Please provide reason for unlocking this budget:');
            if (!reason || reason.trim() === '') {
              alert('Reason is required to unlock budget');
              return;
            }
            
            // Update budget status to pending
            existingEngagement.budgetData.status = 'Pending Approval';
            existingEngagement.budgetData.unlockHistory = existingEngagement.budgetData.unlockHistory || [];
            existingEngagement.budgetData.unlockHistory.push({
              unlockedBy: session.user.name,
              unlockedAt: new Date().toISOString(),
              reason: reason,
              previousStatus: 'Approved',
              type: 'Direct Unlock'
            });
            
            // Save the unlocked state
            const updatedEngagements = engagements.map(e => 
              e.id === existingEngagement.id ? existingEngagement : e
            );
            onUpdate(updatedEngagements);
            
            alert('‚úÖ BUDGET UNLOCKED\n\nBudget has been unlocked for editing.\n\nStatus changed to: Pending Approval\n\nPlease make your changes and re-submit for approval.');
            // Continue with save - budget is now unlocked
          } else {
            // Non-partner must request unlock from Partner
            const confirmRequest = confirm(
              'üîí BUDGET LOCKED\n\n' +
              'This budget has been approved and is locked.\n\n' +
              'You need Partner approval to unlock this budget.\n\n' +
              'üìù Would you like to REQUEST unlock approval?\n\n' +
              '‚Ä¢ Partner will be notified\n' +
              '‚Ä¢ You must provide a reason\n' +
              '‚Ä¢ Partner can approve or reject\n\n' +
              'Request unlock approval?'
            );
            
            if (!confirmRequest) {
              return; // User cancelled
            }
            
            // Request unlock approval
            const reason = prompt('Please provide reason for requesting budget unlock:');
            if (!reason || reason.trim() === '') {
              alert('Reason is required to request unlock');
              return;
            }
            
            // Create unlock request
            existingEngagement.budgetData.unlockRequests = existingEngagement.budgetData.unlockRequests || [];
            const requestId = Date.now();
            existingEngagement.budgetData.unlockRequests.push({
              id: requestId,
              requestedBy: session.user.name,
              requestedByRole: session.user.role,
              requestedAt: new Date().toISOString(),
              reason: reason,
              status: 'Pending',
              approvedBy: null,
              approvedAt: null,
              rejectionReason: null
            });
            
            // Save the request
            const updatedEngagements = engagements.map(e => 
              e.id === existingEngagement.id ? existingEngagement : e
            );
            onUpdate(updatedEngagements);
            
            alert(
              '‚úÖ UNLOCK REQUEST SUBMITTED\n\n' +
              'Your unlock request has been sent to Partner.\n\n' +
              'Requested by: ' + session.user.name + '\n' +
              'Reason: ' + reason + '\n\n' +
              'You will be notified when Partner reviews your request.\n\n' +
              'Check Budget Approvals page for status updates.'
            );
            return; // Stop save - budget still locked
          }
        }
        
        // Convert budget tasks to engagement tasks format
        const tasksArray = [];
        let taskId = Date.now();
        
        budget.stages.forEach(stage => {
          const stageTasks = budget.tasks[stage.code] || [];
          stageTasks.forEach(task => {
            tasksArray.push({
              id: taskId++,
              name: task.name,
              code: task.code,
              stage: stage.code.toLowerCase() === 'a' ? 'acceptance' :
                     stage.code.toLowerCase() === 'b' ? 'planning' :
                     stage.code.toLowerCase() === 'c' ? 'fieldwork' :
                     stage.code.toLowerCase() === 'd' ? 'completion' : 'lockdown',
              budgetHours: task.hours,  // LOCKED from budget
              actualHours: 0,
              status: 'Not Started',
              assignments: [],  // Will be populated in Task Manager
              budgetSource: 'Budget Builder',  // Mark as budgeted task
              budgetLocked: true  // Cannot edit budget hours in Task Manager
            });
          });
        });

        const updated = engagements.map(e => {
          if (e.id === budget.engagementId) {
            // Merge new tasks with existing (avoid duplicates by code)
            const existingTasks = e.tasks || [];
            const existingCodes = existingTasks.map(t => t.code).filter(c => c);
            const newTasks = tasksArray.filter(t => !existingCodes.includes(t.code));
            
            // Preserve existing approval status if any
            const existingBudgetData = e.budgetData || {};
            const budgetStatus = existingBudgetData.status || 'Pending Approval';
            
            return {
              ...e,
              budgetData: {
                ...budget,
                status: budgetStatus,  // PRESERVE existing status
                createdBy: existingBudgetData.createdBy || user.name,
                createdDate: existingBudgetData.createdDate || new Date().toISOString(),
                approvedBy: existingBudgetData.approvedBy || null,
                approvedDate: existingBudgetData.approvedDate || null,
                approvalComments: existingBudgetData.approvalComments || null
              },
              hasBudget: true,
              budgetApprovalStatus: budgetStatus === 'Approved' ? 'Approved' : 'Pending',
              tasks: [...existingTasks, ...newTasks],
              budgetedHours: tasksArray.reduce((sum, t) => sum + t.budgetHours, 0)
            };
          }
          return e;
        });
        
        onUpdate(updated);
        alert('‚úÖ Budget saved for ' + budget.client + '\n\n' +
              tasksArray.length + ' tasks created with locked budget hours.\n\n' +
              'Status: Pending Approval by Manager/Partner\n' +
              'Budget can be edited until approved.');
        setMode('list');
      };

      // Delete budget
      const deleteBudget = (engId) => {
        if (!confirm('Delete this budget?')) return;
        const updated = engagements.map(e => {
          if (e.id === engId) {
            const { budgetData, hasBudget, ...rest } = e;
            return rest;
          }
          return e;
        });
        onUpdate(updated);
      };

      // Custom Task Modal Handler
      const handleAddCustomTask = () => {
        if (!newTaskName) {
          alert('Please enter task name');
          return;
        }
        
        // AUTO-GENERATE next task code in sequence
        const existingCodes = taskLibrary[addTaskStage].tasks.map(t => t.code);
        
        // Extract numeric parts (e.g., "A01" -> 1, "A05" -> 5)
        const numbers = existingCodes
          .map(code => parseInt(code.substring(1)))
          .filter(num => !isNaN(num))
          .sort((a, b) => a - b);
        
        // Find next available number
        let nextNumber = 1;
        for (let i = 0; i < numbers.length; i++) {
          if (numbers[i] === nextNumber) {
            nextNumber++;
          } else {
            break;
          }
        }
        
        // Format as code (e.g., A01, A02, etc.)
        const autoCode = addTaskStage + String(nextNumber).padStart(2, '0');
        
        console.log('Auto-generated code:', autoCode);
        console.log('Existing codes:', existingCodes);
        console.log('Next number:', nextNumber);
        
        // Add to library
        const updatedLibrary = {
          ...taskLibrary,
          [addTaskStage]: {
            ...taskLibrary[addTaskStage],
            tasks: [
              ...taskLibrary[addTaskStage].tasks,
              {
                code: autoCode,
                name: newTaskName,
                hours: parseInt(newTaskHours) || 4,
                custom: true
              }
            ].sort((a, b) => a.code.localeCompare(b.code))
          }
        };
        
        setTaskLibrary(updatedLibrary);
        setShowAddTaskModal(false);
        setNewTaskCode('');
        setNewTaskName('');
        setNewTaskHours(4);
        alert('‚úÖ Custom task code added: ' + autoCode + ' - ' + newTaskName);
      };

      // REPOSITORY VIEW
      if (mode === 'list') {
        return React.createElement('div', { className: 'card' },
          React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '24px' } },
            React.createElement('h2', { className: 'page-title', style: { margin: 0 } }, 'üìä Budget Repository'),
            React.createElement('button', {
              className: 'btn btn-primary',
              onClick: () => { setMode('create'); setStep(1); }
            }, '+ Create New Budget')
          ),
          
          savedBudgets.length === 0 ? React.createElement('div', {
            style: { padding: '48px', textAlign: 'center', background: '#F8F9FA', borderRadius: '12px' }
          },
            React.createElement('div', { style: { fontSize: '48px' } }, 'üìã'),
            React.createElement('div', { style: { fontSize: '18px', fontWeight: '600', marginTop: '16px' } }, 'No Budgets Yet'),
            React.createElement('button', {
              className: 'btn btn-primary',
              style: { marginTop: '16px' },
              onClick: () => setMode('create')
            }, 'Create First Budget')
          ) : React.createElement('table', null,
            React.createElement('thead', null,
              React.createElement('tr', null,
                React.createElement('th', null, 'Client'),
                React.createElement('th', null, 'Year End'),
                React.createElement('th', null, 'Tasks'),
                React.createElement('th', null, 'Hours'),
                React.createElement('th', null, 'Status'),
                React.createElement('th', null, 'Created'),
                React.createElement('th', null, 'Actions')
              )
            ),
            React.createElement('tbody', null,
              savedBudgets.map(bud => {
                const totalTasks = Object.values(bud.tasks || {}).flat().length;
                const totalHours = Object.values(bud.tasks || {}).flat().reduce((s, t) => s + t.hours, 0);
                const budgetStatus = bud.status || 'Draft';
                const isApproved = budgetStatus === 'Approved';
                const isPending = budgetStatus === 'Pending Approval';
                
                return React.createElement('tr', { key: bud.id },
                  React.createElement('td', { style: { fontWeight: '600' } }, bud.clientName),
                  React.createElement('td', null, bud.yearEnd),
                  React.createElement('td', null, totalTasks),
                  React.createElement('td', null, totalHours + 'h'),
                  React.createElement('td', null,
                    React.createElement('span', {
                      style: {
                        padding: '4px 10px',
                        borderRadius: '12px',
                        fontSize: '11px',
                        fontWeight: '600',
                        background: isApproved ? '#E8F5E9' : isPending ? '#FFF3E0' : '#F5F5F5',
                        color: isApproved ? '#2E7D32' : isPending ? '#E65100' : '#666'
                      }
                    }, budgetStatus)
                  ),
                  React.createElement('td', null, new Date(bud.created).toLocaleDateString()),
                  React.createElement('td', null,
                    React.createElement('div', { style: { display: 'flex', gap: '8px', flexWrap: 'wrap' } },
                      React.createElement('button', {
                        className: 'btn btn-secondary',
                        style: { 
                          padding: '4px 10px', 
                          fontSize: '12px',
                          background: isApproved ? '#E3F2FD' : '',
                          color: isApproved ? '#1976D2' : '',
                          border: isApproved ? '1px solid #1976D2' : ''
                        },
                        onClick: () => {
                          if (isApproved) {
                            const proceed = confirm(
                              'üìñ BUDGET IS APPROVED (READ-ONLY MODE)\n\n' +
                              'This budget has been approved and is locked for editing.\n\n' +
                              '‚úì You can view it in read-only mode\n' +
                              '‚úó Changes cannot be saved\n\n' +
                              'If modifications are needed, please contact your Partner to unlock.\n\n' +
                              'Click OK to proceed in read-only mode, or Cancel to close.'
                            );
                            if (proceed) {
                              setBudget({...bud, readOnly: true});
                              setMode('create');
                              setStep(2);
                              setStageIdx(0);
                            }
                          } else {
                            setBudget(bud);
                            setMode('create');
                            setStep(2);
                            setStageIdx(0);
                          }
                        },
                        title: isApproved ? 'View Budget (Read-Only)' : 'Edit Budget'
                      }, isApproved ? 'üìñ View' : '‚úèÔ∏è Edit'),
                      (isPending && (user.role === 'Manager' || user.role === 'Partner')) && React.createElement('button', {
                        className: 'btn btn-primary',
                        style: { padding: '4px 10px', fontSize: '12px', background: '#4CAF50' },
                        onClick: () => {
                          if (confirm('Approve this budget for ' + bud.clientName + '?')) {
                            const updated = engagements.map(e => {
                              if (e.id === bud.engagementId) {
                                return {
                                  ...e,
                                  budgetData: {
                                    ...e.budgetData,
                                    status: 'Approved',
                                    approvedBy: user.name,
                                    approvedDate: new Date().toISOString(),
                                    approvalComments: 'Approved'
                                  },
                                  budgetApprovalStatus: 'Approved'
                                };
                              }
                              return e;
                            });
                            onUpdate(updated);
                            alert('‚úÖ Budget approved for ' + bud.clientName);
                          }
                        },
                        title: 'Approve Budget'
                      }, '‚úì Approve'),
                      React.createElement('button', {
                        className: 'btn btn-secondary',
                        style: { padding: '4px 8px', fontSize: '12px' },
                        onClick: () => { setBudget(bud); exportExcel(); },
                        title: 'Export to Excel'
                      }, 'üì•'),
                      !isApproved && React.createElement('button', {
                        className: 'btn btn-secondary',
                        style: { padding: '4px 8px', fontSize: '12px', color: '#F44336' },
                        onClick: () => deleteBudget(bud.engagementId),
                        title: 'Delete Budget'
                      }, '‚úï')
                    )
                  )
                );
              })
            )
          )
        );
      }

      // CREATE - STEP 1: SELECT ENGAGEMENT
      if (mode === 'create' && step === 1) {
        const available = engagements.filter(e => e.status !== 'Completed');
        const withBudgets = engagements.filter(e => e.budgetData);

        return React.createElement('div', { className: 'card' },
          React.createElement('h2', { className: 'page-title' }, 'üéØ Create Budget'),
          
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', { className: 'form-label' }, 'Select Engagement'),
            React.createElement('select', {
              className: 'form-input',
              value: budget.engagementId || '',
              onChange: (e) => {
                if (e.target.value) {
                  selectEngagement(e.target.value);
                  setTimeout(() => setStep(2), 300);
                }
              }
            },
              React.createElement('option', { value: '' }, '-- Select Client --'),
              available.map(e =>
                React.createElement('option', { key: e.id, value: e.id },
                  e.clientName + ' (' + e.yearEnd + ') - P' + (e.budgetedFee || 0).toLocaleString()
                )
              )
            )
          ),
          
          withBudgets.length > 0 && React.createElement('div', { style: { marginTop: '24px' } },
            React.createElement('div', {
              style: { padding: '16px', background: '#E3F2FD', borderRadius: '8px', marginBottom: '16px' }
            }, 'üí° Or load tasks from a previous budget'),
            
            React.createElement('div', { className: 'form-grid' },
              React.createElement('div', { className: 'form-group' },
                React.createElement('label', { className: 'form-label' }, 'Load From'),
                React.createElement('select', {
                  id: 'sourceEngagement',
                  className: 'form-input'
                },
                  React.createElement('option', { value: '' }, '-- Select Source Budget --'),
                  withBudgets.map(e =>
                    React.createElement('option', { key: e.id, value: e.id }, e.clientName + ' (' + e.yearEnd + ')')
                  )
                )
              ),
              React.createElement('div', { className: 'form-group' },
                React.createElement('label', { className: 'form-label' }, 'Apply To'),
                React.createElement('select', {
                  id: 'targetEngagement',
                  className: 'form-input'
                },
                  React.createElement('option', { value: '' }, '-- Select Target --'),
                  available.map(e =>
                    React.createElement('option', { key: e.id, value: e.id }, e.clientName + ' (' + e.yearEnd + ')')
                  )
                )
              )
            ),
            
            React.createElement('button', {
              className: 'btn btn-primary',
              style: { marginTop: '12px' },
              onClick: () => {
                const source = document.getElementById('sourceEngagement').value;
                const target = document.getElementById('targetEngagement').value;
                if (source && target) {
                  loadFromPrevious(source, target);
                  setStep(2);
                }
              }
            }, 'üìã Load Previous Budget')
          ),
          
          React.createElement('div', { style: { marginTop: '24px' } },
            React.createElement('button', {
              className: 'btn btn-secondary',
              onClick: () => setMode('list')
            }, '‚Üê Back')
          )
        );
      }

      // CREATE - STEP 2: ADD TASKS
      if (mode === 'create' && step === 2) {
        const stage = budget.stages[stageIdx];
        const stageTasks = budget.tasks[stage.code] || [];
        const stageHours = stageTasks.reduce((s, t) => s + t.hours, 0);
        const selected = selectedTasks[stage.code] || [];

        return React.createElement('div', null,
          React.createElement('div', { className: 'card' },
          React.createElement('h2', { className: 'page-title' },
            stage.code + '-CODES: ' + stage.name + ' | ' + budget.client
          ),
          
          React.createElement('div', {
            style: {
              padding: '16px',
              background: stage.color + '15',
              borderRadius: '8px',
              borderLeft: '4px solid ' + stage.color,
              marginBottom: '24px'
            }
          },
            React.createElement('div', { style: { fontWeight: '600' } },
              'Used: ' + stageHours + 'h / ' + stage.hours + 'h'
            )
          ),
          
          React.createElement('div', { style: { marginBottom: '20px' } },
            React.createElement('label', { className: 'form-label' }, '‚úö Select Tasks (Multi-Select)'),
            React.createElement('div', {
              style: {
                border: '2px solid #E0E0E0',
                borderRadius: '8px',
                padding: '12px',
                maxHeight: '200px',
                overflowY: 'auto'
              }
            },
              taskLibrary[stage.code].tasks.map(task =>
                React.createElement('label', {
                  key: task.code,
                  style: {
                    display: 'block',
                    padding: '8px',
                    cursor: 'pointer',
                    background: selected.includes(task.code) ? '#E3F2FD' : 'transparent',
                    borderRadius: '4px',
                    marginBottom: '4px'
                  }
                },
                  React.createElement('input', {
                    type: 'checkbox',
                    checked: selected.includes(task.code),
                    disabled: stageTasks.find(t => t.code === task.code),
                    onChange: () => toggleTaskSelection(stage.code, task.code),
                    style: { marginRight: '8px' }
                  }),
                  React.createElement('span', {
                    style: { fontWeight: '600', color: stage.color }
                  }, task.code),
                  ': ',
                  task.name,
                  ' (' + task.hours + 'h)'
                )
              )
            ),
            
            React.createElement('button', {
              className: 'btn btn-primary',
              style: { marginTop: '12px', width: '100%' },
              onClick: () => addSelectedTasks(stage.code),
              disabled: selected.length === 0
            }, '‚úö Add Selected Tasks (' + selected.length + ')'),
            
            React.createElement('button', {
              className: 'btn btn-secondary',
              style: { marginTop: '8px', width: '100%', fontSize: '13px' },
              onClick: () => {
                console.log('Add Custom Task button clicked!');
                console.log('Current stage:', stage.code);
                setAddTaskStage(stage.code);
                setShowAddTaskModal(true);
                console.log('Modal should be open now');
              }
            }, '‚ûï Add Custom Task Code')
          ),
          
          stageTasks.length > 0 && React.createElement('div', null,
            React.createElement('h3', { style: { fontSize: '14px', fontWeight: '600', marginBottom: '12px' } },
              'Selected Tasks (' + stageTasks.length + '):'
            ),
            stageTasks.map(task =>
              React.createElement('div', {
                key: task.code,
                style: {
                  padding: '12px',
                  background: '#F8F9FA',
                  borderRadius: '8px',
                  marginBottom: '8px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px'
                }
              },
                React.createElement('span', {
                  style: {
                    background: stage.color,
                    color: 'white',
                    padding: '4px 10px',
                    borderRadius: '6px',
                    fontSize: '12px',
                    fontWeight: '600',
                    minWidth: '50px',
                    textAlign: 'center'
                  }
                }, task.code),
                React.createElement('div', { style: { flex: 1, fontSize: '14px' } }, task.name),
                React.createElement('input', {
                  type: 'number',
                  value: task.hours,
                  onChange: (e) => updateHours(stage.code, task.code, e.target.value),
                  style: {
                    width: '70px',
                    padding: '6px',
                    border: '2px solid ' + stage.color,
                    borderRadius: '4px',
                    textAlign: 'center'
                  },
                  min: 0
                }),
                React.createElement('button', {
                  className: 'btn btn-secondary',
                  onClick: () => removeTask(stage.code, task.code),
                  style: { padding: '6px 12px', fontSize: '12px' }
                }, '‚úï')
              )
            )
          ),
          
          React.createElement('div', { style: { marginTop: '32px', display: 'flex', justifyContent: 'space-between' } },
            React.createElement('button', {
              className: 'btn btn-secondary',
              onClick: () => {
                if (stageIdx > 0) {
                  setStageIdx(stageIdx - 1);
                } else {
                  setStep(1);
                }
              }
            }, '‚Üê ' + (stageIdx > 0 ? 'Previous' : 'Back')),
            React.createElement('button', {
              className: 'btn btn-primary',
              onClick: () => {
                if (stageIdx < budget.stages.length - 1) {
                  setStageIdx(stageIdx + 1);
                } else {
                  setStep(3);
                }
              }
            }, (stageIdx < budget.stages.length - 1 ? 'Next' : 'Review') + ' ‚Üí')
          )
        ),
        
        // Custom Task Modal - render as overlay
        showAddTaskModal && React.createElement('div', {
          className: 'modal',
          style: { display: 'flex' },
          onClick: () => {
            console.log('Modal background clicked');
            setShowAddTaskModal(false);
          }
        },
          React.createElement('div', {
            className: 'modal-content',
            style: { maxWidth: '500px' },
            onClick: (e) => e.stopPropagation()
          },
            React.createElement('div', { className: 'modal-header' },
              React.createElement('h2', { className: 'modal-title' }, 
                '‚ûï Add Custom Task Code - Stage ' + addTaskStage
              ),
              React.createElement('button', {
                className: 'close-btn',
                onClick: () => setShowAddTaskModal(false)
              }, '√ó')
            ),
            React.createElement('div', { className: 'modal-body' },
              // Auto-generated code preview
              React.createElement('div', { 
                style: { 
                  padding: '16px',
                  background: '#E3F2FD',
                  borderRadius: '8px',
                  marginBottom: '20px',
                  border: '2px solid #1976D2'
                } 
              },
                React.createElement('div', { 
                  style: { fontSize: '12px', color: '#666', marginBottom: '4px' } 
                }, 'üî¢ Auto-Generated Task Code'),
                React.createElement('div', { 
                  style: { 
                    fontSize: '24px', 
                    fontWeight: '700', 
                    color: '#1976D2',
                    fontFamily: 'monospace'
                  } 
                }, 
                  // Calculate next code
                  (() => {
                    const existingCodes = taskLibrary[addTaskStage].tasks.map(t => t.code);
                    const numbers = existingCodes
                      .map(code => parseInt(code.substring(1)))
                      .filter(num => !isNaN(num))
                      .sort((a, b) => a - b);
                    let nextNumber = 1;
                    for (let i = 0; i < numbers.length; i++) {
                      if (numbers[i] === nextNumber) {
                        nextNumber++;
                      } else {
                        break;
                      }
                    }
                    return addTaskStage + String(nextNumber).padStart(2, '0');
                  })()
                ),
                React.createElement('div', { 
                  style: { fontSize: '11px', color: '#666', marginTop: '4px' } 
                }, 'Next available code in ' + taskLibrary[addTaskStage].name + ' sequence')
              ),
              
              React.createElement('div', { className: 'form-group' },
                React.createElement('label', { className: 'form-label' }, 'Task Name *'),
                React.createElement('input', {
                  className: 'form-input',
                  type: 'text',
                  placeholder: 'e.g., Custom procedure',
                  value: newTaskName,
                  onChange: (e) => setNewTaskName(e.target.value),
                  autoFocus: true
                })
              ),
              React.createElement('div', { className: 'form-group' },
                React.createElement('label', { className: 'form-label' }, 'Default Hours'),
                React.createElement('input', {
                  className: 'form-input',
                  type: 'number',
                  min: 1,
                  value: newTaskHours,
                  onChange: (e) => setNewTaskHours(e.target.value)
                })
              )
            ),
            React.createElement('div', { className: 'modal-footer' },
              React.createElement('button', {
                className: 'btn btn-secondary',
                onClick: () => setShowAddTaskModal(false)
              }, 'Cancel'),
              React.createElement('button', {
                className: 'btn btn-primary',
                onClick: handleAddCustomTask
              }, '‚úì Add Task Code')
            )
          )
        )
      );
      }

      // STEP 3: REVIEW
      if (mode === 'create' && step === 3) {
        const totalHours = Object.values(budget.tasks).flat().reduce((s, t) => s + t.hours, 0);
        const totalTasks = Object.values(budget.tasks).flat().length;

        return React.createElement('div', { className: 'card' },
          React.createElement('h2', { className: 'page-title' }, 'üìä Budget Summary'),
          
          React.createElement('div', { className: 'metric-grid' },
            React.createElement('div', { className: 'metric-card' },
              React.createElement('div', { className: 'metric-label' }, 'Client'),
              React.createElement('div', { className: 'metric-value', style: { fontSize: '20px' } }, budget.client)
            ),
            React.createElement('div', { className: 'metric-card' },
              React.createElement('div', { className: 'metric-label' }, 'Hours'),
              React.createElement('div', { className: 'metric-value' }, totalHours)
            ),
            React.createElement('div', { className: 'metric-card' },
              React.createElement('div', { className: 'metric-label' }, 'Tasks'),
              React.createElement('div', { className: 'metric-value' }, totalTasks)
            )
          ),
          
          React.createElement('div', { style: { marginTop: '32px', display: 'flex', gap: '12px', justifyContent: 'space-between' } },
            React.createElement('button', {
              className: 'btn btn-secondary',
              onClick: () => { setStageIdx(budget.stages.length - 1); setStep(2); }
            }, '‚Üê Back'),
            React.createElement('div', { style: { display: 'flex', gap: '12px' } },
              React.createElement('button', {
                className: 'btn btn-secondary',
                onClick: exportExcel
              }, 'üì• Export'),
              React.createElement('button', {
                className: 'btn btn-primary',
                onClick: saveBudget
              }, 'üíæ Save')
            )
          )
        );
      }

      return null;
    }



    // Phase 2: Calendar View Component - Live Date-Aware Calendar
    function CalendarView({ engagements, staff, onUpdate, onOpenTaskManager }) {
      const [selectedStaff, setSelectedStaff] = useState(null);
      const [viewPeriod, setViewPeriod] = useState('week'); // week, 2weeks, 3weeks, month, 2months, 3months
      
      // Initialize to start of CURRENT week (Feb 9, 2026 is Sunday)
      const getCurrentWeekStart = () => {
        const today = new Date(2026, 1, 8); // Feb 8, 2026 (today based on system prompt)
        const day = today.getDay(); // 0 = Sunday
        const diff = today.getDate() - day; // Go back to Sunday
        return new Date(2026, 1, diff); // Feb 8, 2026 is Saturday, so Feb 9 is Sunday
      };
      
      const [startDate, setStartDate] = useState(getCurrentWeekStart());
      const [showAssignModal, setShowAssignModal] = useState(false);
      const [selectedDay, setSelectedDay] = useState(null);
      const [selectedEngagementForAssign, setSelectedEngagementForAssign] = useState(null);
      const [expandedCells, setExpandedCells] = useState({}); // Track which staff-day-client combinations are expanded
      const [expandAllMode, setExpandAllMode] = useState({}); // Track staff members with "expand all" mode
      const [showTaskEditor, setShowTaskEditor] = useState(false);
      const [selectedTaskForEdit, setSelectedTaskForEdit] = useState(null);
      const [selectedEngagementForEdit, setSelectedEngagementForEdit] = useState(null);

      const activeStaff = staff.filter(s => s.isActive);

      // Open task editor
      const openTaskEditor = (engagement, task) => {
        setSelectedEngagementForEdit(engagement);
        setSelectedTaskForEdit(task);
        setShowTaskEditor(true);
      };

      // Toggle client expansion in a specific day cell
      const toggleClientExpansion = (staffId, dayIndex, clientName) => {
        const key = `${staffId}-${dayIndex}-${clientName}`;
        setExpandedCells(prev => ({
          ...prev,
          [key]: !prev[key]
        }));
      };

      // Toggle expand all mode for a staff member
      const toggleExpandAll = (staffId) => {
        setExpandAllMode(prev => ({
          ...prev,
          [staffId]: !prev[staffId]
        }));
      };

      // Date utility functions
      const getNextMonday = (date) => {
        const d = new Date(date);
        const day = d.getDay();
        const diff = day === 0 ? 1 : day === 6 ? 2 : (8 - day);
        d.setDate(d.getDate() + diff);
        return d;
      };

      const getWorkingDays = (start, numDays) => {
        const days = [];
        const currentDate = new Date(start);
        let count = 0;
        
        while (count < numDays) {
          const dayOfWeek = currentDate.getDay();
          if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Skip weekends
            days.push({
              date: new Date(currentDate),
              dayName: currentDate.toLocaleDateString('en-US', { weekday: 'short' }),
              dayNumber: currentDate.getDate(),
              monthName: currentDate.toLocaleDateString('en-US', { month: 'short' }),
              fullDate: currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
            });
            count++;
          }
          currentDate.setDate(currentDate.getDate() + 1);
        }
        return days;
      };

      // Get working days based on view period
      const getPeriodDays = () => {
        // Start from the selected date directly, not next Monday
        const periods = {
          'week': 5,
          '2weeks': 10,
          '3weeks': 15,
          'month': 20,
          '2months': 40,
          '3months': 60
        };
        return getWorkingDays(startDate, periods[viewPeriod] || 5);
      };

      const workingDays = getPeriodDays();
      const totalDays = workingDays.length;

      // Calculate staff allocation per day
      const getStaffSchedule = (staffMember) => {
        const schedule = workingDays.map(day => ({
          ...day,
          allocated: 0,
          budgetedHours: 0,
          pendingHours: 0,
          approvedExtraHours: 0,
          overtimeHours: 0,
          pendingOvertimeHours: 0,
          tasks: [],
          tasksByClient: {}
        }));

        // Distribute task hours based on date ranges
        engagements.forEach(engagement => {
          (engagement.tasks || []).forEach(task => {
            // Calculate total assigned hours for this task
            const totalAssigned = (task.assignments || []).reduce((sum, a) => sum + (a.hours || 0), 0);
            const budget = task.budgetHours || 0;
            const assignmentOverrun = Math.max(0, totalAssigned - budget);
            const hasOverrun = assignmentOverrun > 0;
            const approvalStatus = task.approvalRequest?.status || null;

            (task.assignments || []).forEach(assignment => {
              if (assignment.staffId === staffMember.id) {
                // SKIP REJECTED OVERTIME TASKS - Don't show hours in calendar
                if (task.overtimeApproval && task.overtimeApproval.status === 'rejected') {
                  return; // Skip this task entirely
                }
                
                const totalHours = assignment.hours || 0;
                
                // Calculate what portion of this assignment is overrun
                const proportionOfOverrun = totalAssigned > 0 ? (assignment.hours / totalAssigned) : 0;
                const assignmentOverrunHours = assignmentOverrun * proportionOfOverrun;
                const assignmentBudgetHours = totalHours - assignmentOverrunHours;
                
                // Check if assignment has date range
                if (assignment.startDate && assignment.endDate) {
                  // Calculate working days in assignment's date range
                  const assignmentStart = new Date(assignment.startDate);
                  const assignmentEnd = new Date(assignment.endDate);
                  
                  // Filter schedule days that fall within assignment date range
                  const daysInRange = schedule.filter(day => {
                    const dayDate = day.date;
                    return dayDate >= assignmentStart && dayDate <= assignmentEnd;
                  });
                  
                  if (daysInRange.length > 0) {
                    const hoursPerDay = totalHours / daysInRange.length;
                    const budgetHoursPerDay = assignmentBudgetHours / daysInRange.length;
                    const overrunHoursPerDay = assignmentOverrunHours / daysInRange.length;
                    
                    daysInRange.forEach(day => {
                      const scheduleDay = schedule.find(d => d.date.getTime() === day.date.getTime());
                      if (scheduleDay) {
                        scheduleDay.allocated += hoursPerDay;
                        scheduleDay.budgetedHours += budgetHoursPerDay;
                        
                        if (hasOverrun) {
                          if (approvalStatus === 'approved') {
                            scheduleDay.approvedExtraHours += overrunHoursPerDay;
                          } else if (approvalStatus === 'pending') {
                            scheduleDay.pendingHours += overrunHoursPerDay;
                          } else {
                            // No approval request yet - treat as pending
                            scheduleDay.pendingHours += overrunHoursPerDay;
                          }
                        }
                        
                        const taskInfo = {
                          taskName: task.name,
                          clientName: engagement.clientName,
                          hours: hoursPerDay,
                          budgetHours: task.budgetHours,
                          totalAssigned: totalAssigned,
                          assignmentOverrun: assignmentOverrun,
                          hasOverrun: hasOverrun,
                          approvalStatus: approvalStatus,
                          stage: task.stage,
                          engagementId: engagement.id,
                          taskId: task.id
                        };
                        
                        scheduleDay.tasks.push(taskInfo);
                        
                        // Group by client
                        if (!scheduleDay.tasksByClient[engagement.clientName]) {
                          scheduleDay.tasksByClient[engagement.clientName] = [];
                        }
                        scheduleDay.tasksByClient[engagement.clientName].push(taskInfo);
                      }
                    });
                  }
                } else {
                  // No date range - distribute evenly across all days (backward compatibility)
                  const hoursPerDay = totalHours / totalDays;
                  const budgetHoursPerDay = assignmentBudgetHours / totalDays;
                  const overrunHoursPerDay = assignmentOverrunHours / totalDays;
                  
                  schedule.forEach((day) => {
                    day.allocated += hoursPerDay;
                    day.budgetedHours += budgetHoursPerDay;
                    
                    if (hasOverrun) {
                      if (approvalStatus === 'approved') {
                        day.approvedExtraHours += overrunHoursPerDay;
                      } else if (approvalStatus === 'pending') {
                        day.pendingHours += overrunHoursPerDay;
                      } else {
                        day.pendingHours += overrunHoursPerDay;
                      }
                    }
                    
                    const taskInfo = {
                      taskName: task.name,
                      clientName: engagement.clientName,
                      hours: hoursPerDay,
                      budgetHours: task.budgetHours,
                      totalAssigned: totalAssigned,
                      assignmentOverrun: assignmentOverrun,
                      hasOverrun: hasOverrun,
                      approvalStatus: approvalStatus,
                      stage: task.stage,
                      engagementId: engagement.id,
                      taskId: task.id
                    };
                    
                    day.tasks.push(taskInfo);
                    
                    // Group by client
                    if (!day.tasksByClient[engagement.clientName]) {
                      day.tasksByClient[engagement.clientName] = [];
                    }
                    day.tasksByClient[engagement.clientName].push(taskInfo);
                  });
                }
              }
            });
          });
        });

        // POST-PROCESSING: Apply 8h cap and calculate overtime
        schedule.forEach(day => {
          if (day.allocated > 8) {
            // Check if ANY task on this day has approved overtime
            const hasApprovedOT = day.tasks.some(t => {
              const task = engagements
                .flatMap(e => e.tasks || [])
                .find(et => et.id === t.taskId);
              return task && task.overtimeApproval && task.overtimeApproval.status === 'approved';
            });
            
            if (hasApprovedOT) {
              // Show overtime separately
              day.overtimeHours = day.allocated - 8;
              // day.allocated stays as full amount
            } else {
              // Cap at 8h, hide overtime
              day.pendingOvertimeHours = day.allocated - 8;
              day.allocated = 8; // Cap display
            }
          }
        });

        return schedule.map(day => ({
          ...day,
          idle: 8 - Math.min(day.allocated, 8),
          utilization: (Math.min(day.allocated, 8) / 8) * 100,
          overallocated: day.allocated > 8,
          clientCount: Object.keys(day.tasksByClient).length
        }));
      };

      // Get monthly overview for next 3 months
      const getMonthlyOverview = () => {
        const months = [];
        const currentDate = new Date(startDate);
        
        for (let i = 0; i < 3; i++) {
          const month = new Date(currentDate);
          month.setMonth(currentDate.getMonth() + i);
          
          const workingDaysInMonth = getWorkingDays(
            new Date(month.getFullYear(), month.getMonth(), 1),
            22 // Approximate working days
          ).length;

          months.push({
            name: month.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
            workingDays: workingDaysInMonth,
            totalHours: workingDaysInMonth * 8
          });
        }
        return months;
      };

      const monthlyOverview = getMonthlyOverview();

      // Get all staff with their schedules
      const staffSchedules = activeStaff.map(s => {
        const schedule = getStaffSchedule(s);
        const totalPeriodHours = schedule.reduce((sum, day) => sum + day.allocated, 0);
        const totalAvailableHours = totalDays * 8;
        const periodIdle = totalAvailableHours - totalPeriodHours;
        
        return {
          ...s,
          schedule,
          totalPeriodHours,
          totalAvailableHours,
          periodIdle,
          periodUtilization: (totalPeriodHours / totalAvailableHours) * 100
        };
      });

      const filteredStaff = selectedStaff 
        ? staffSchedules.filter(s => s.id === selectedStaff) 
        : staffSchedules;

      const getStageColor = (stageId) => {
        const colors = {
          acceptance: '#28A745',
          planning: '#4472C4',
          fieldwork: '#FFC107',
          completion: '#ED7D31',
          lockdown: '#DC3545'
        };
        return colors[stageId] || '#999';
      };

      // Navigation functions
      const goToNextPeriod = () => {
        const newDate = new Date(startDate);
        const daysToAdd = viewPeriod === 'week' ? 7 : viewPeriod === '2weeks' ? 14 : viewPeriod === '3weeks' ? 21 : 30;
        newDate.setDate(newDate.getDate() + daysToAdd);
        setStartDate(newDate);
      };

      const goToPreviousPeriod = () => {
        const newDate = new Date(startDate);
        const daysToSubtract = viewPeriod === 'week' ? 7 : viewPeriod === '2weeks' ? 14 : viewPeriod === '3weeks' ? 21 : 30;
        newDate.setDate(newDate.getDate() - daysToSubtract);
        setStartDate(newDate);
      };

      const goToToday = () => {
        setStartDate(new Date(2026, 0, 31)); // Current date
      };

      return h('div', null,
        // Period Selector and Navigation
        h('div', { className: 'card', style: { marginBottom: '20px' } },
          h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '16px' } },
            // Period buttons
            h('div', { style: { display: 'flex', gap: '8px', flexWrap: 'wrap' } },
              ['week', '2weeks', '3weeks', 'month', '2months', '3months'].map(period => {
                const labels = {
                  week: '1 Week',
                  '2weeks': '2 Weeks',
                  '3weeks': '3 Weeks',
                  month: '1 Month',
                  '2months': '2 Months',
                  '3months': '3 Months'
                };
                return h('button', {
                  key: period,
                  className: 'btn ' + (viewPeriod === period ? 'btn-primary' : 'btn-secondary'),
                  style: { padding: '8px 16px', fontSize: '13px' },
                  onClick: () => setViewPeriod(period)
                }, labels[period]);
              })
            ),

            // Date navigation
            h('div', { style: { display: 'flex', gap: '8px', alignItems: 'center' } },
              h('button', {
                className: 'btn btn-secondary',
                style: { padding: '8px 12px' },
                onClick: goToPreviousPeriod
              }, '‚óÄ'),
              h('button', {
                className: 'btn btn-secondary',
                style: { padding: '8px 16px' },
                onClick: goToToday
              }, 'Today'),
              h('button', {
                className: 'btn btn-secondary',
                style: { padding: '8px 12px' },
                onClick: goToNextPeriod
              }, '‚ñ∂'),
              h('div', { style: { fontSize: '14px', fontWeight: '600', marginLeft: '12px' } },
                workingDays.length > 0 ? workingDays[0].fullDate + ' - ' + workingDays[workingDays.length - 1].fullDate : ''
              )
            )
          )
        ),

        // Monthly Overview (for longer periods)
        (viewPeriod === '2months' || viewPeriod === '3months') && h('div', { className: 'card', style: { marginBottom: '20px' } },
          h('h3', { style: { marginBottom: '16px', fontSize: '16px', fontWeight: '600' } }, 'üìÖ Monthly Overview'),
          h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px' } },
            monthlyOverview.map((month, idx) => 
              h('div', {
                key: idx,
                style: {
                  background: 'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)',
                  padding: '16px',
                  borderRadius: '8px',
                  border: '2px solid #4472C4'
                }
              },
                h('div', { style: { fontSize: '14px', fontWeight: '700', color: '#1F4E78', marginBottom: '8px' } }, month.name),
                h('div', { style: { fontSize: '12px', color: '#666' } }, `${month.workingDays} working days`),
                h('div', { style: { fontSize: '20px', fontWeight: '700', color: '#4472C4', marginTop: '8px' } }, 
                  `${month.totalHours}h available`
                )
              )
            )
          )
        ),

        // Staff Filter
        h('div', { className: 'card', style: { marginBottom: '20px' } },
          h('div', { style: { display: 'flex', alignItems: 'center', gap: '16px', flexWrap: 'wrap' } },
            h('label', { style: { fontWeight: '600', fontSize: '14px' } }, 'Filter by Staff:'),
            h('select', {
              className: 'form-input',
              style: { width: '300px' },
              value: selectedStaff || '',
              onChange: (e) => setSelectedStaff(e.target.value ? parseInt(e.target.value) : null)
            },
              h('option', { value: '' }, `üîç All Staff (${activeStaff.length})`),
              activeStaff.map(s => h('option', { key: s.id, value: s.id }, s.name))
            ),
            selectedStaff && h('button', {
              className: 'btn btn-secondary',
              style: { padding: '8px 16px' },
              onClick: () => setSelectedStaff(null)
            }, 'Clear Filter')
          )
        ),

        // Staff Calendars
        filteredStaff.map(staffMember => {
          const hasIdleTime = staffMember.periodIdle > 0;
          const isOverallocated = staffMember.totalPeriodHours > staffMember.totalAvailableHours;

          return h('div', { 
            key: staffMember.id,
            className: 'card',
            style: { 
              marginBottom: '24px', 
              border: hasIdleTime ? '3px solid #DC3545' : isOverallocated ? '3px solid #FFC107' : '2px solid #E0E0E0' 
            }
          },
            // Staff Header
            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px' } },
              h('div', null,
                h('h3', { style: { fontSize: '18px', fontWeight: '700', marginBottom: '4px' } }, staffMember.name),
                h('div', { style: { fontSize: '13px', color: '#666' } }, 
                  staffMember.position + ' ‚Ä¢ ' + staffMember.level
                )
              ),
              h('div', { style: { display: 'flex', alignItems: 'center', gap: '12px' } },
                h('button', {
                  className: 'btn btn-secondary',
                  style: { padding: '6px 12px', fontSize: '12px' },
                  onClick: () => toggleExpandAll(staffMember.id)
                }, expandAllMode[staffMember.id] ? 'üìã Group by Client' : 'üìÇ Expand All'),
                h('div', { style: { textAlign: 'right' } },
                  h('div', { style: { fontSize: '24px', fontWeight: '700', color: isOverallocated ? '#FFC107' : hasIdleTime ? '#DC3545' : '#28A745' } }, 
                    staffMember.totalPeriodHours.toFixed(0) + 'h / ' + staffMember.totalAvailableHours + 'h'
                  ),
                  h('div', { style: { fontSize: '12px', color: '#666', marginTop: '4px' } }, 
                    hasIdleTime 
                      ? `‚ö†Ô∏è ${staffMember.periodIdle.toFixed(0)}h idle (${staffMember.periodUtilization.toFixed(0)}% utilized)` 
                      : isOverallocated 
                      ? `‚ö†Ô∏è ${(staffMember.totalPeriodHours - staffMember.totalAvailableHours).toFixed(0)}h overallocated`
                      : `‚úì ${staffMember.periodUtilization.toFixed(0)}% utilized`
                  )
                )
              )
            ),

            // Calendar Grid
            h('div', { style: { overflowX: 'auto' } },
              h('table', { style: { width: '100%', borderCollapse: 'separate', borderSpacing: '4px', fontSize: viewPeriod.includes('month') ? '11px' : '12px' } },
                h('thead', null,
                  h('tr', null,
                    staffMember.schedule.map((day, idx) =>
                      h('th', { 
                        key: idx,
                        style: { 
                          padding: viewPeriod.includes('month') ? '6px 4px' : '10px 8px',
                          background: '#1F4E78',
                          color: 'white',
                          fontWeight: '600',
                          fontSize: viewPeriod.includes('month') ? '10px' : '11px',
                          borderRadius: '6px 6px 0 0',
                          textAlign: 'center',
                          minWidth: viewPeriod.includes('month') ? '60px' : '120px'
                        }
                      }, 
                        h('div', null, day.dayName),
                        h('div', { style: { fontSize: '10px', opacity: 0.8, marginTop: '2px' } }, 
                          day.monthName + ' ' + day.dayNumber
                        )
                      )
                    )
                  )
                ),
                h('tbody', null,
                  h('tr', null,
                    staffMember.schedule.map((dayData, idx) => {
                      const hasIdle = dayData.idle > 0;
                      const isOver = dayData.overallocated;
                      
                      return h('td', {
                        key: idx,
                        style: {
                          padding: viewPeriod.includes('month') ? '6px 4px' : '12px 8px',
                          background: hasIdle ? '#FFEBEE' : isOver ? '#FFF3E0' : '#E8F5E9',
                          border: hasIdle ? '2px solid #DC3545' : isOver ? '2px solid #FFC107' : '2px solid #E0E0E0',
                          borderRadius: '0 0 6px 6px',
                          verticalAlign: 'top',
                          cursor: hasIdle ? 'pointer' : 'default'
                        },
                        onClick: hasIdle ? () => {
                          setSelectedDay({ staff: staffMember, day: dayData.fullDate, dayData });
                          setShowAssignModal(true);
                        } : undefined
                      },
                        // Hours summary - SEPARATED BY TYPE
                        h('div', { style: { marginBottom: '8px', textAlign: 'center' } },
                          // Total allocated hours
                          h('div', { style: { fontWeight: '700', fontSize: viewPeriod.includes('month') ? '11px' : '16px', marginBottom: '4px' } },
                            h('span', { style: { color: hasIdle ? '#DC3545' : isOver ? '#FFC107' : '#28A745' } },
                              dayData.allocated.toFixed(1) + 'h / 8h'
                            ),
                            // Show overtime badge if approved
                            dayData.overtimeHours > 0 && h('span', {
                              style: {
                                marginLeft: '6px',
                                fontSize: '12px',
                                color: '#1976D2',
                                fontWeight: '600'
                              }
                            }, '+' + dayData.overtimeHours.toFixed(1) + 'h OT‚úì')
                          ),
                          
                          // Hour breakdown (only for week view if there are different types)
                          !viewPeriod.includes('month') && (dayData.pendingHours > 0 || dayData.approvedExtraHours > 0 || dayData.overtimeHours > 0) && h('div', {
                            style: {
                              fontSize: '9px',
                              display: 'flex',
                              gap: '4px',
                              justifyContent: 'center',
                              flexWrap: 'wrap'
                            }
                          },
                            dayData.budgetedHours > 0 && h('div', {
                              style: {
                                background: '#E8F5E9',
                                color: '#2E7D32',
                                padding: '2px 6px',
                                borderRadius: '4px',
                                fontWeight: '600'
                              }
                            }, dayData.budgetedHours.toFixed(1) + 'h'),
                            
                            dayData.pendingHours > 0 && h('div', {
                              style: {
                                background: '#FFF3E0',
                                color: '#F57C00',
                                padding: '2px 6px',
                                borderRadius: '4px',
                                fontWeight: '600'
                              }
                            }, dayData.pendingHours.toFixed(1) + 'h ‚è≥'),
                            
                            dayData.approvedExtraHours > 0 && h('div', {
                              style: {
                                background: '#E3F2FD',
                                color: '#1976D2',
                                padding: '2px 6px',
                                borderRadius: '4px',
                                fontWeight: '600'
                              }
                            }, dayData.approvedExtraHours.toFixed(1) + 'h ‚úì'),
                            
                            dayData.overtimeHours > 0 && h('div', {
                              style: {
                                background: '#E8EAF6',
                                color: '#3F51B5',
                                padding: '2px 6px',
                                borderRadius: '4px',
                                fontWeight: '600',
                                border: '1px solid #3F51B5'
                              }
                            }, '+' + dayData.overtimeHours.toFixed(1) + 'h OT‚úì')
                          ),
                          
                          // Show pending overtime note
                          !viewPeriod.includes('month') && dayData.pendingOvertimeHours > 0 && h('div', {
                            style: {
                              fontSize: '9px',
                              color: '#F57C00',
                              marginTop: '4px',
                              fontStyle: 'italic'
                            }
                          }, dayData.pendingOvertimeHours.toFixed(1) + 'h OT pending approval')
                        ),

                        // Idle warning (only for week/2week view)
                        !viewPeriod.includes('month') && hasIdle && h('div', {
                          style: {
                            background: '#DC3545',
                            color: 'white',
                            padding: '4px 6px',
                            borderRadius: '4px',
                            fontSize: '10px',
                            fontWeight: '600',
                            marginBottom: '6px',
                            textAlign: 'center'
                          }
                        }, `${dayData.idle.toFixed(1)}h IDLE`),

                        // Task rendering - Grouped by Client or Expanded All
                        viewPeriod.includes('month') ? 
                          // Condensed view for month
                          dayData.tasks.length > 0 && h('div', { style: { fontSize: '9px', color: '#666', textAlign: 'center' } },
                            dayData.clientCount + ' client' + (dayData.clientCount > 1 ? 's' : '') + ', ' + 
                            dayData.tasks.length + ' task' + (dayData.tasks.length > 1 ? 's' : '')
                          )
                        :
                          // Detailed view for week - WITH CLIENT GROUPING
                          expandAllMode[staffMember.id] ?
                            // EXPAND ALL MODE - Show all tasks individually
                            h('div', { style: { fontSize: '10px' } },
                              dayData.tasks.map((task, tidx) => {
                                // Find the actual engagement and task objects for editing
                                const engagement = engagements.find(e => e.id === task.engagementId);
                                const fullTask = engagement?.tasks?.find(t => t.id === task.taskId);
                                
                                return h('div', {
                                  key: tidx,
                                  style: {
                                    background: task.hasOverrun ? '#FFEBEE' : 'white',
                                    padding: '4px 6px',
                                    borderRadius: '4px',
                                    marginBottom: '4px',
                                    borderLeft: `3px solid ${getStageColor(task.stage)}`,
                                    border: task.hasOverrun ? '1px solid #DC3545' : '1px solid #F0F0F0',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s'
                                  },
                                  onClick: (e) => {
                                    e.stopPropagation();
                                    if (engagement && fullTask) {
                                      openTaskEditor(engagement, fullTask);
                                    }
                                  },
                                  onMouseEnter: (e) => {
                                    e.currentTarget.style.background = task.hasOverrun ? '#FFD6D6' : '#F0F7FF';
                                    e.currentTarget.style.transform = 'scale(1.02)';
                                  },
                                  onMouseLeave: (e) => {
                                    e.currentTarget.style.background = task.hasOverrun ? '#FFEBEE' : 'white';
                                    e.currentTarget.style.transform = 'scale(1)';
                                  }
                                },
                                  h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'start', gap: '4px' } },
                                    h('div', { style: { flex: 1 } },
                                      h('div', { style: { fontWeight: '600', fontSize: '10px', color: '#333' } }, task.clientName),
                                      h('div', { style: { fontSize: '9px', color: '#666', marginTop: '2px' } }, 
                                        task.taskName.substring(0, 20) + (task.taskName.length > 20 ? '...' : '')
                                      )
                                    ),
                                    h('div', { style: { textAlign: 'right' } },
                                      h('div', { style: { fontSize: '10px', fontWeight: '600', color: task.hasOverrun ? '#DC3545' : '#666' } }, 
                                        task.hours.toFixed(1) + 'h'
                                      ),
                                      task.hasOverrun && h('div', { style: { fontSize: '8px', color: '#DC3545' } }, '‚ö†Ô∏è'),
                                      h('div', { style: { fontSize: '9px', color: '#999' } }, '‚úèÔ∏è')
                                    )
                                  )
                                );
                              })
                            )
                          :
                            // GROUPED MODE - Group by client
                            h('div', { style: { fontSize: '10px' } },
                              Object.entries(dayData.tasksByClient).map(([clientName, clientTasks]) => {
                                const totalClientHours = clientTasks.reduce((sum, t) => sum + t.hours, 0);
                                const hasOverrunTasks = clientTasks.some(t => t.hasOverrun);
                                const cellKey = `${staffMember.id}-${idx}-${clientName}`;
                                const isExpanded = expandedCells[cellKey];

                                return h('div', {
                                  key: clientName,
                                  style: {
                                    marginBottom: '4px'
                                  }
                                },
                                  // Client header (collapsible)
                                  h('div', {
                                    style: {
                                      background: hasOverrunTasks ? 'linear-gradient(135deg, #FFEBEE 0%, #FFE8E8 100%)' : 'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)',
                                      padding: '6px 8px',
                                      borderRadius: '4px',
                                      cursor: 'pointer',
                                      border: hasOverrunTasks ? '1px solid #DC3545' : '1px solid #4472C4',
                                      display: 'flex',
                                      justifyContent: 'space-between',
                                      alignItems: 'center',
                                      transition: 'all 0.2s'
                                    },
                                    onClick: (e) => {
                                      e.stopPropagation();
                                      toggleClientExpansion(staffMember.id, idx, clientName);
                                    }
                                  },
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: '4px', flex: 1 } },
                                      h('span', { style: { fontSize: '10px' } }, isExpanded ? '‚ñº' : '‚ñ∂'),
                                      h('div', null,
                                        h('div', { style: { fontWeight: '700', fontSize: '10px', color: hasOverrunTasks ? '#DC3545' : '#1976D2' } }, 
                                          clientName
                                        ),
                                        h('div', { style: { fontSize: '8px', color: '#666', marginTop: '2px' } }, 
                                          clientTasks.length + ' task' + (clientTasks.length > 1 ? 's' : '')
                                        )
                                      )
                                    ),
                                    h('div', { style: { fontSize: '10px', fontWeight: '700', color: hasOverrunTasks ? '#DC3545' : '#1976D2' } },
                                      totalClientHours.toFixed(1) + 'h',
                                      hasOverrunTasks && h('span', { style: { marginLeft: '4px' } }, '‚ö†Ô∏è')
                                    )
                                  ),

                                  // Expanded tasks
                                  isExpanded && h('div', { 
                                    style: { 
                                      marginTop: '4px',
                                      paddingLeft: '12px',
                                      borderLeft: '2px solid #E0E0E0'
                                    } 
                                  },
                                    clientTasks.map((task, tidx) => {
                                      // Find the actual engagement and task objects for editing
                                      const engagement = engagements.find(e => e.id === task.engagementId);
                                      const fullTask = engagement?.tasks?.find(t => t.id === task.taskId);
                                      
                                      return h('div', {
                                        key: tidx,
                                        style: {
                                          background: task.hasOverrun ? '#FFEBEE' : 'white',
                                          padding: '4px 6px',
                                          borderRadius: '3px',
                                          marginBottom: '3px',
                                          borderLeft: `2px solid ${getStageColor(task.stage)}`,
                                          border: task.hasOverrun ? '1px solid #DC3545' : '1px solid #F0F0F0',
                                          cursor: 'pointer',
                                          transition: 'all 0.2s'
                                        },
                                        onClick: (e) => {
                                          e.stopPropagation();
                                          if (engagement && fullTask) {
                                            openTaskEditor(engagement, fullTask);
                                          }
                                        },
                                        onMouseEnter: (e) => {
                                          e.currentTarget.style.background = task.hasOverrun ? '#FFD6D6' : '#F0F7FF';
                                          e.currentTarget.style.transform = 'scale(1.02)';
                                        },
                                        onMouseLeave: (e) => {
                                          e.currentTarget.style.background = task.hasOverrun ? '#FFEBEE' : 'white';
                                          e.currentTarget.style.transform = 'scale(1)';
                                        }
                                      },
                                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                                          h('div', { style: { fontSize: '9px', color: '#666', flex: 1 } }, 
                                            task.taskName.substring(0, 15) + (task.taskName.length > 15 ? '...' : '')
                                          ),
                                          h('div', { style: { display: 'flex', alignItems: 'center', gap: '4px' } },
                                            h('span', { style: { fontSize: '9px', fontWeight: '600', color: task.hasOverrun ? '#DC3545' : '#666' } }, 
                                              task.hours.toFixed(1) + 'h'
                                            ),
                                            task.hasOverrun && h('span', { style: { fontSize: '8px', color: '#DC3545' } }, '‚ö†Ô∏è'),
                                            h('span', { style: { fontSize: '9px', color: '#999', marginLeft: '2px' } }, '‚úèÔ∏è')
                                          )
                                        )
                                      );
                                    })
                                  )
                                );
                              })
                            ),

                        // Click prompt for idle
                        hasIdle && !viewPeriod.includes('month') && h('div', {
                          style: {
                            marginTop: '6px',
                            padding: '4px',
                            background: 'white',
                            borderRadius: '3px',
                            textAlign: 'center',
                            fontSize: '9px',
                            color: '#DC3545',
                            fontWeight: '600',
                            border: '1px dashed #DC3545'
                          }
                        }, 'üñ±Ô∏è Click')
                      );
                    })
                  )
                )
              )
            )
          );
        }),

        // No staff message
        filteredStaff.length === 0 && h('div', { className: 'card' },
          h('div', { className: 'empty-state' },
            h('div', { className: 'empty-state-icon' }, 'üë•'),
            h('p', null, 'No staff members found')
          )
        ),

        // Assign Work Modal
        showAssignModal && selectedDay && h('div', { className: 'modal', onClick: () => setShowAssignModal(false) },
          h('div', { 
            className: 'modal-content', 
            style: { maxWidth: '600px' },
            onClick: (e) => e.stopPropagation() 
          },
            h('div', { className: 'modal-header' },
              h('h2', { className: 'modal-title' }, 'Assign Work to Staff'),
              h('button', { className: 'close-btn', onClick: () => setShowAssignModal(false) }, '√ó')
            ),
            h('div', { className: 'modal-body' },
              h('div', { style: { background: '#E3F2FD', padding: '16px', borderRadius: '8px', marginBottom: '20px', border: '2px solid #4472C4' } },
                h('div', { style: { fontSize: '15px', fontWeight: '600', marginBottom: '8px', color: '#1F4E78' } },
                  `üìÖ ${selectedDay.staff.name} - ${selectedDay.day}`
                ),
                h('div', { style: { fontSize: '13px', color: '#666' } },
                  '‚ö†Ô∏è Available idle time: ' + selectedDay.dayData.idle.toFixed(1) + ' hours'
                )
              ),
              
              h('div', { style: { marginBottom: '20px' } },
                h('label', { className: 'form-label' }, 'Select Engagement to Assign Tasks:'),
                h('select', {
                  className: 'form-input',
                  value: selectedEngagementForAssign || '',
                  onChange: (e) => setSelectedEngagementForAssign(parseInt(e.target.value))
                },
                  h('option', { value: '' }, '-- Select an engagement --'),
                  engagements.map(e => 
                    h('option', { key: e.id, value: e.id }, 
                      `${e.clientName} (${(e.tasks || []).length} tasks, ${e.status})`
                    )
                  )
                )
              ),

              selectedEngagementForAssign && h('div', { 
                style: { background: '#F8F9FA', padding: '12px', borderRadius: '6px', marginBottom: '16px', fontSize: '13px' } 
              },
                h('strong', null, 'Next step: '),
                'The Task Manager will open where you can assign tasks to ' + selectedDay.staff.name
              ),

              h('button', {
                className: 'btn btn-primary',
                style: { width: '100%' },
                disabled: !selectedEngagementForAssign,
                onClick: () => {
                  if (selectedEngagementForAssign && onOpenTaskManager) {
                    const engagement = engagements.find(e => e.id === selectedEngagementForAssign);
                    setShowAssignModal(false);
                    setSelectedEngagementForAssign(null);
                    onOpenTaskManager(engagement);
                  }
                }
              }, 'üìã Open Task Manager' + (selectedEngagementForAssign ? '' : ' (Select engagement first)'))
            )
          )
        ),

        // Task Editor Modal
        showTaskEditor && selectedEngagementForEdit && selectedTaskForEdit && h(TaskManagerModal, {
          engagement: selectedEngagementForEdit,
          staff: staff,
          allEngagements: engagements,
          onClose: () => {
            setShowTaskEditor(false);
            setSelectedEngagementForEdit(null);
            setSelectedTaskForEdit(null);
          },
          onUpdate: (updatedEngagement) => {
            const updatedEngagements = engagements.map(e => 
              e.id === updatedEngagement.id ? updatedEngagement : e
            );
            onUpdate(updatedEngagements);
            setShowTaskEditor(false);
            setSelectedEngagementForEdit(null);
            setSelectedTaskForEdit(null);
          }
        })
      );
    }

    // Phase 3: Gantt Chart View Component
    function GanttChartView({ engagements, staff }) {
      const [selectedEngagement, setSelectedEngagement] = useState(null);
      const [timeScale, setTimeScale] = useState('week'); // week, month, quarter
      
      // Get all tasks with dates for timeline
      const allTasks = engagements.flatMap(e => 
        (e.tasks || []).map(t => ({
          ...t,
          clientName: e.clientName,
          engagementId: e.id,
          startDate: e.auditStartDate || '2026-02-03',
          endDate: e.completionDate || '2026-03-15'
        }))
      );

      // Group tasks by engagement
      const engagementsWithTasks = engagements.map(e => ({
        ...e,
        tasks: allTasks.filter(t => t.engagementId === e.id)
      })).filter(e => e.tasks.length > 0);

      // Calculate timeline based on all dates
      const allDates = allTasks.flatMap(t => [new Date(t.startDate), new Date(t.endDate)]);
      const minDate = allDates.length > 0 ? new Date(Math.min(...allDates)) : new Date();
      const maxDate = allDates.length > 0 ? new Date(Math.max(...allDates)) : new Date();
      
      // Generate timeline markers
      const getTimelineMarkers = () => {
        const markers = [];
        const current = new Date(minDate);
        current.setDate(1); // Start of month
        
        while (current <= maxDate) {
          markers.push({
            date: new Date(current),
            label: current.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
          });
          current.setMonth(current.getMonth() + 1);
        }
        return markers;
      };

      const timelineMarkers = getTimelineMarkers();
      const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) || 30;

      // Calculate position and width for task bar
      const getTaskBarStyle = (task) => {
        const taskStart = new Date(task.startDate);
        const taskEnd = new Date(task.endDate);
        const startOffset = Math.ceil((taskStart - minDate) / (1000 * 60 * 60 * 24));
        const duration = Math.ceil((taskEnd - taskStart) / (1000 * 60 * 60 * 24)) || 1;
        
        const leftPercent = (startOffset / totalDays) * 100;
        const widthPercent = (duration / totalDays) * 100;

        return {
          left: `${leftPercent}%`,
          width: `${Math.max(widthPercent, 2)}%`
        };
      };

      const getStageColor = (stageId) => {
        const colors = {
          acceptance: '#28A745',
          planning: '#4472C4',
          fieldwork: '#FFC107',
          completion: '#ED7D31',
          lockdown: '#DC3545'
        };
        return colors[stageId] || '#999';
      };

      const getProgressColor = (status) => {
        if (status === 'Completed') return '#28A745';
        if (status === 'In Progress') return '#4472C4';
        return '#999';
      };

      return h('div', null,
        // Header with controls
        h('div', { className: 'card', style: { marginBottom: '20px' } },
          h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '16px' } },
            h('div', null,
              h('h3', { style: { fontSize: '20px', fontWeight: '700', marginBottom: '4px' } }, 'üìä Gantt Chart Timeline'),
              h('p', { style: { fontSize: '13px', color: '#666' } }, 
                `Showing ${engagementsWithTasks.length} engagements with ${allTasks.length} tasks`
              )
            ),
            h('div', { style: { display: 'flex', gap: '8px' } },
              ['week', 'month', 'quarter'].map(scale => 
                h('button', {
                  key: scale,
                  className: 'btn ' + (timeScale === scale ? 'btn-primary' : 'btn-secondary'),
                  style: { padding: '8px 16px', fontSize: '13px', textTransform: 'capitalize' },
                  onClick: () => setTimeScale(scale)
                }, scale)
              )
            )
          )
        ),

        // Instructions
        h('div', { 
          style: { 
            background: 'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)',
            border: '2px solid #4472C4',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px'
          }
        },
          h('div', { style: { fontSize: '16px', fontWeight: '700', color: '#1F4E78', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' } },
            h('span', { style: { fontSize: '24px' } }, 'üí°'),
            'How to Use the Gantt Chart'
          ),
          h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '16px' } },
            h('div', null,
              h('div', { style: { fontSize: '14px', fontWeight: '600', color: '#1F4E78', marginBottom: '6px' } }, 'üìÖ Timeline Bars'),
              h('div', { style: { fontSize: '13px', color: '#666' } }, 
                'Horizontal bars show the duration of each engagement and task. Longer bars = longer duration.'
              )
            ),
            h('div', null,
              h('div', { style: { fontSize: '14px', fontWeight: '600', color: '#1F4E78', marginBottom: '6px' } }, 'üé® Color Coding'),
              h('div', { style: { fontSize: '13px', color: '#666' } }, 
                'Tasks are colored by audit stage: Green (Acceptance), Blue (Planning), Yellow (Fieldwork), Orange (Completion), Red (Lockdown).'
              )
            ),
            h('div', null,
              h('div', { style: { fontSize: '14px', fontWeight: '600', color: '#1F4E78', marginBottom: '6px' } }, '‚ñ∂ Click to Expand'),
              h('div', { style: { fontSize: '13px', color: '#666' } }, 
                'Click on any engagement row (‚ñ∂) to expand and see all individual tasks underneath with their timelines.'
              )
            ),
            h('div', null,
              h('div', { style: { fontSize: '14px', fontWeight: '600', color: '#1F4E78', marginBottom: '6px' } }, 'üìä Timeline View'),
              h('div', { style: { fontSize: '13px', color: '#666' } }, 
                'The chart shows from earliest start date to latest end date across all your engagements.'
              )
            )
          )
        ),

        // Legend
        h('div', { className: 'card', style: { marginBottom: '20px' } },
          h('div', { style: { display: 'flex', gap: '24px', flexWrap: 'wrap', alignItems: 'center' } },
            h('div', { style: { fontSize: '14px', fontWeight: '600' } }, 'Stages:'),
            AUDIT_STAGES.map(stage => 
              h('div', { key: stage.id, style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                h('div', { style: { width: '20px', height: '20px', borderRadius: '4px', background: getStageColor(stage.id) } }),
                h('span', { style: { fontSize: '13px' } }, stage.name)
              )
            )
          )
        ),

        // Gantt Chart
        h('div', { className: 'card' },
          h('div', { style: { overflowX: 'auto' } },
            h('div', { style: { minWidth: '800px' } },
              // Timeline header
              h('div', { style: { display: 'flex', borderBottom: '2px solid #1F4E78', marginBottom: '16px', paddingBottom: '8px' } },
                h('div', { style: { width: '250px', flexShrink: 0, fontWeight: '700', fontSize: '14px', color: '#1F4E78' } }, 
                  'Engagement / Task'
                ),
                h('div', { style: { flex: 1, display: 'flex', justifyContent: 'space-between', paddingLeft: '8px' } },
                  timelineMarkers.map((marker, idx) =>
                    h('div', { key: idx, style: { fontSize: '12px', fontWeight: '600', color: '#666' } }, 
                      marker.label
                    )
                  )
                )
              ),

              // Engagements and tasks
              engagementsWithTasks.length === 0 ?
                h('div', { className: 'empty-state' },
                  h('div', { className: 'empty-state-icon' }, 'üìä'),
                  h('p', null, 'No tasks to display in Gantt chart')
                ) :
                engagementsWithTasks.map(engagement => {
                  const isExpanded = selectedEngagement === engagement.id;
                  
                  return h('div', { 
                    key: engagement.id,
                    style: { marginBottom: '24px' }
                  },
                    // Engagement row
                    h('div', { 
                      style: { 
                        display: 'flex', 
                        alignItems: 'center',
                        padding: '12px 0',
                        cursor: 'pointer',
                        borderRadius: '8px',
                        background: isExpanded ? '#F8F9FA' : 'transparent'
                      },
                      onClick: () => setSelectedEngagement(isExpanded ? null : engagement.id)
                    },
                      h('div', { style: { width: '250px', flexShrink: 0 } },
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                          h('span', { style: { fontSize: '16px' } }, isExpanded ? '‚ñº' : '‚ñ∂'),
                          h('div', null,
                            h('div', { style: { fontWeight: '700', fontSize: '14px' } }, engagement.clientName),
                            h('div', { style: { fontSize: '11px', color: '#666' } }, 
                              `${engagement.tasks.length} tasks`
                            )
                          )
                        )
                      ),
                      h('div', { style: { flex: 1, position: 'relative', height: '30px', paddingLeft: '8px' } },
                        // Engagement timeline bar
                        h('div', {
                          style: {
                            position: 'absolute',
                            ...getTaskBarStyle({ startDate: engagement.auditStartDate, endDate: engagement.completionDate }),
                            height: '24px',
                            background: getProgressColor(engagement.status),
                            borderRadius: '4px',
                            border: '2px solid white',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '11px',
                            fontWeight: '600',
                            boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                          }
                        }, engagement.status)
                      )
                    ),

                    // Tasks (when expanded)
                    isExpanded && engagement.tasks.map(task => 
                      h('div', { 
                        key: task.id,
                        style: { 
                          display: 'flex', 
                          alignItems: 'center',
                          padding: '8px 0 8px 40px',
                          borderLeft: '2px solid #E0E0E0',
                          marginLeft: '20px'
                        }
                      },
                        h('div', { style: { width: '210px', flexShrink: 0 } },
                          h('div', { style: { fontSize: '13px', fontWeight: '600' } }, task.name),
                          h('div', { style: { fontSize: '11px', color: '#666' } }, 
                            `${task.budgetHours}h budgeted`
                          )
                        ),
                        h('div', { style: { flex: 1, position: 'relative', height: '24px', paddingLeft: '8px' } },
                          // Task bar
                          h('div', {
                            style: {
                              position: 'absolute',
                              ...getTaskBarStyle(task),
                              height: '18px',
                              background: getStageColor(task.stage),
                              borderRadius: '3px',
                              border: '1px solid white',
                              display: 'flex',
                              alignItems: 'center',
                              paddingLeft: '6px',
                              color: 'white',
                              fontSize: '10px',
                              fontWeight: '600',
                              boxShadow: '0 1px 3px rgba(0,0,0,0.15)'
                            }
                          }, 
                            h('span', { style: { whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' } },
                              AUDIT_STAGES.find(s => s.id === task.stage)?.name
                            )
                          )
                        )
                      )
                    )
                  );
                })
            )
          )
        )
      );
    }

    // Phase 2: Utilization View Component - Focus on Idle Time
    function UtilizationView({ engagements, staff }) {
      const activeStaff = staff.filter(s => s.isActive);
      
      const staffWithWorkload = activeStaff.map(s => {
        const taskAssignments = [];
        let totalBudgetHours = 0;
        
        engagements.forEach(e => {
          (e.tasks || []).forEach(task => {
            (task.assignments || []).forEach(assignment => {
              if (assignment.staffId === s.id) {
                taskAssignments.push({
                  engagementId: e.id,
                  clientName: e.clientName,
                  taskName: task.name,
                  stage: task.stage,
                  hours: assignment.hours || 0,
                  taskStatus: task.status
                });
                totalBudgetHours += assignment.hours || 0;
              }
            });
          });
        });

        const availableHours = 160;
        const utilization = (totalBudgetHours / availableHours) * 100;
        const idleHours = availableHours - totalBudgetHours;
        const hasIdleTime = idleHours > 0;

        return {
          ...s,
          taskAssignments,
          totalBudgetHours,
          availableHours,
          utilization,
          idleHours,
          hasIdleTime,
          engagementCount: new Set(taskAssignments.map(t => t.engagementId)).size
        };
      });

      const totalCapacity = activeStaff.length * 160;
      const totalAllocated = staffWithWorkload.reduce((sum, s) => sum + s.totalBudgetHours, 0);
      const totalIdle = staffWithWorkload.reduce((sum, s) => sum + s.idleHours, 0);
      const staffWithIdle = staffWithWorkload.filter(s => s.hasIdleTime).length;

      return h('div', null,
        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'Total Capacity'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, `${totalCapacity}h`),
            h('div', { className: 'metric-detail' }, `${activeStaff.length} active staff`)
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#28A745' } },
            h('div', { className: 'metric-label' }, 'Total Allocated'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, 
              `${totalAllocated.toFixed(0)}h`
            ),
            h('div', { className: 'metric-detail' }, 'Billable hours assigned')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#DC3545' } },
            h('div', { className: 'metric-label' }, 'üö® Total Idle Time'),
            h('div', { className: 'metric-value', style: { color: '#DC3545' } }, 
              `${totalIdle.toFixed(0)}h`
            ),
            h('div', { className: 'metric-detail' }, `${staffWithIdle} staff with idle time`)
          )
        ),

        // Idle Time Alert
        staffWithIdle > 0 && h('div', {
          style: {
            background: 'linear-gradient(135deg, #FFEBEE 0%, #FFE8B3 100%)',
            border: '2px solid #DC3545',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '24px',
            display: 'flex',
            alignItems: 'start',
            gap: '16px'
          }
        },
          h('div', { style: { fontSize: '48px' } }, '‚ö†Ô∏è'),
          h('div', null,
            h('div', { style: { fontSize: '18px', fontWeight: '700', color: '#DC3545', marginBottom: '8px' } },
              `Alert: ${staffWithIdle} staff member${staffWithIdle > 1 ? 's' : ''} have idle time`
            ),
            h('div', { style: { fontSize: '14px', color: '#666' } },
              'Underutilized staff should be assigned to engagements to maximize billable hours. See the Calendar View to identify available time slots.'
            )
          )
        ),

        h('div', { className: 'card' },
          h('h3', { style: { marginBottom: '20px', fontSize: '18px', fontWeight: '600' } }, 
            'Staff Utilization & Idle Time Overview'
          ),
          h('div', { style: { maxHeight: '600px', overflow: 'auto' } },
            staffWithWorkload
              .sort((a, b) => b.idleHours - a.idleHours) // Sort by idle time (most idle first)
              .map(s => {
                const hasIdle = s.hasIdleTime;
                const isOver = s.utilization > 100;
                const barColor = isOver ? '#FFC107' : hasIdle ? '#DC3545' : '#28A745';
                
                return h('div', {
                  key: s.id,
                  style: {
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '16px',
                    background: hasIdle ? '#FFEBEE' : '#F8F9FA',
                    border: hasIdle ? '2px solid #DC3545' : '1px solid #E0E0E0',
                    borderRadius: '8px',
                    marginBottom: '12px',
                    transition: 'all 0.2s'
                  }
                },
                  // Red flag for idle time
                  hasIdle && h('div', { style: { fontSize: '32px', flexShrink: 0 } }, 'üö®'),
                  
                  h('div', { style: { minWidth: '180px', flexShrink: 0 } },
                    h('div', { style: { fontWeight: '700', fontSize: '14px' } }, s.name),
                    h('div', { style: { fontSize: '12px', color: '#666' } }, s.position)
                  ),
                  
                  h('div', { style: { flex: 1 } },
                    h('div', { style: { height: '32px', background: '#E0E0E0', borderRadius: '16px', overflow: 'hidden', position: 'relative' } },
                      h('div', {
                        style: {
                          height: '100%',
                          width: `${Math.min(s.utilization, 100)}%`,
                          background: barColor,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: 'white',
                          fontSize: '13px',
                          fontWeight: '700',
                          transition: 'width 0.3s'
                        }
                      }, s.utilization > 15 && `${s.utilization.toFixed(0)}%`)
                    )
                  ),
                  
                  h('div', { style: { minWidth: '200px', textAlign: 'right' } },
                    h('div', { style: { fontSize: '16px', fontWeight: '700' } },
                      h('span', { style: { color: hasIdle ? '#DC3545' : '#28A745' } }, 
                        `${s.totalBudgetHours.toFixed(0)}h`
                      ),
                      h('span', { style: { color: '#999', fontSize: '13px' } }, ' / 160h')
                    ),
                    hasIdle && h('div', {
                      style: {
                        fontSize: '13px',
                        fontWeight: '700',
                        color: '#DC3545',
                        marginTop: '4px'
                      }
                    }, `‚ö†Ô∏è ${s.idleHours.toFixed(0)}h IDLE`)
                  ),
                  
                  h('div', { style: { minWidth: '150px', fontSize: '12px', color: '#666', textAlign: 'right' } },
                    h('div', null, `${s.taskAssignments.length} tasks assigned`),
                    h('div', null, `${s.engagementCount} engagements`)
                  )
                );
              })
          )
        )
      );
    }

    // Phase 3: Approvals & Workflow View Component
    function ApprovalsView({ engagements, staff, onUpdate }) {
      const [showApprovalModal, setShowApprovalModal] = useState(false);
      const [selectedRequest, setSelectedRequest] = useState(null);
      const [approvalComment, setApprovalComment] = useState('');
      const [showRequestModal, setShowRequestModal] = useState(false);
      const [requestReason, setRequestReason] = useState('');
      const [selectedTaskForRequest, setSelectedTaskForRequest] = useState(null);

      // Calculate tasks with allocated hours variance AND overtime approvals
      const tasksWithApprovals = engagements.flatMap(e =>
        (e.tasks || []).map(t => {
          // Calculate total allocated hours from assignments
          const totalAllocated = (t.assignments || []).reduce((sum, a) => sum + (a.hours || 0), 0);
          const budget = t.budgetHours || 0;
          const variance = totalAllocated - budget;
          
          return {
            ...t,
            engagementId: e.id,
            clientName: e.clientName,
            allocatedHours: totalAllocated,
            variance: variance,
            approvalRequest: t.approvalRequest || null,
            overtimeApproval: t.overtimeApproval || null,
            approvalHistory: t.approvalHistory || []  // CRITICAL: Include approval history
          };
        })
      );

      // UPDATED: Get all pending approvals from history
      const pendingBudgetRequests = [];
      const pendingOvertimeRequests = [];
      
      tasksWithApprovals.forEach(task => {
        if (task.approvalHistory && task.approvalHistory.length > 0) {
          task.approvalHistory.forEach(approval => {
            if (approval.status === 'pending') {
              if (approval.type === 'budget_overrun') {
                pendingBudgetRequests.push({
                  ...task,
                  approvalRequest: approval
                });
              } else if (approval.type === 'overtime') {
                pendingOvertimeRequests.push({
                  ...task,
                  overtimeApproval: approval
                });
              }
            }
          });
        } else {
          // Backwards compatibility for old structure
          if (task.approvalRequest && task.approvalRequest.status === 'pending') {
            pendingBudgetRequests.push(task);
          }
          if (task.overtimeApproval && task.overtimeApproval.status === 'pending') {
            pendingOvertimeRequests.push(task);
          }
        }
      });
      
      // Combined pending
      const pendingRequests = [...pendingBudgetRequests, ...pendingOvertimeRequests];
      
      // UPDATED: Get approved from history
      const approvedRequests = [];
      tasksWithApprovals.forEach(task => {
        if (task.approvalHistory && task.approvalHistory.length > 0) {
          task.approvalHistory.forEach(approval => {
            if (approval.status === 'approved') {
              approvedRequests.push({
                ...task,
                approval: approval
              });
            }
          });
        } else {
          // Backwards compatibility
          if ((task.approvalRequest && task.approvalRequest.status === 'approved') ||
              (task.overtimeApproval && task.overtimeApproval.status === 'approved')) {
            approvedRequests.push(task);
          }
        }
      });
      
      const rejectedRequests = tasksWithApprovals.filter(t => 
        (t.approvalRequest && t.approvalRequest.status === 'rejected') ||
        (t.overtimeApproval && t.overtimeApproval.status === 'rejected')
      );

      const tasksNeedingApproval = tasksWithApprovals.filter(t => 
        t.variance > 0 && !t.approvalRequest
      );

      const handleApprove = () => {
        if (!selectedRequest) {
          console.error('handleApprove: No selectedRequest');
          return;
        }
        
        console.log('handleApprove called with:', selectedRequest);
        
        const isOvertimeApproval = selectedRequest.overtimeApproval && 
                                    selectedRequest.overtimeApproval.status === 'pending';
        
        console.log('Is overtime approval?', isOvertimeApproval);
        
        try {
          // Update task with approval
          const updatedEngagements = engagements.map(e => {
            console.log('Processing engagement:', e.id, e.clientName);
            return {
              ...e,
              tasks: (e.tasks || []).map(t => {
                if (t.id === selectedRequest.id && e.id === selectedRequest.engagementId) {
                  console.log('Found matching task:', t.id, t.name);
                  const updates = { ...t };
                  
                  // CRITICAL FIX: Update approvalHistory array
                  const approvalHistory = t.approvalHistory ? [...t.approvalHistory] : [];
                  
                  if (isOvertimeApproval) {
                    console.log('Updating overtimeApproval in history');
                    // Find and update the specific approval in history
                    const approvalIndex = approvalHistory.findIndex(a => 
                      a.id === selectedRequest.overtimeApproval.id
                    );
                    
                    if (approvalIndex >= 0) {
                      approvalHistory[approvalIndex] = {
                        ...approvalHistory[approvalIndex],
                        status: 'approved',
                        approvedBy: 'Jonathan Malefho',
                        approvalDate: new Date().toISOString().split('T')[0],
                        comments: approvalComment || 'Approved'
                      };
                    }
                    
                    // Also update overtimeApproval for backwards compatibility
                    updates.overtimeApproval = {
                      ...(t.overtimeApproval || {}),
                      status: 'approved',
                      approvedBy: 'Jonathan Malefho',
                      approvalDate: new Date().toISOString().split('T')[0],
                      comments: approvalComment || 'Approved'
                    };
                  } else {
                    console.log('Updating approvalRequest in history');
                    // Find and update the specific approval in history
                    const approvalIndex = approvalHistory.findIndex(a => 
                      a.id === selectedRequest.approvalRequest.id
                    );
                    
                    if (approvalIndex >= 0) {
                      approvalHistory[approvalIndex] = {
                        ...approvalHistory[approvalIndex],
                        status: 'approved',
                        approvedBy: 'Jonathan Malefho',
                        approvalDate: new Date().toISOString().split('T')[0],
                        comments: approvalComment || 'Approved'
                      };
                    }
                    
                    // Also update approvalRequest for backwards compatibility
                    updates.approvalRequest = {
                      ...(t.approvalRequest || {}),
                      status: 'approved',
                      approvedBy: 'Jonathan Malefho',
                      approvalDate: new Date().toISOString().split('T')[0],
                      comments: approvalComment || 'Approved'
                    };
                  }
                  
                  // Update the approval history
                  updates.approvalHistory = approvalHistory;
                  
                  console.log('Updated task with approval history:', updates);
                  return updates;
                }
                return t;
              })
            };
          });
          
          console.log('About to call onUpdate with:', updatedEngagements);
          onUpdate(updatedEngagements);
          console.log('onUpdate completed successfully');
          
          setShowApprovalModal(false);
          setApprovalComment('');
          setSelectedRequest(null);
        } catch (error) {
          console.error('Error in handleApprove:', error);
          alert('Error approving request: ' + error.message);
        }
      };

      const handleReject = () => {
        if (!selectedRequest || !approvalComment) {
          alert('Please provide a reason for rejection');
          return;
        }
        
        const isOvertimeApproval = selectedRequest.overtimeApproval && 
                                    selectedRequest.overtimeApproval.status === 'pending';
        
        // Update task with rejection
        const updatedEngagements = engagements.map(e => ({
          ...e,
          tasks: (e.tasks || []).map(t => {
            if (t.id === selectedRequest.id && e.id === selectedRequest.engagementId) {
              const updates = { ...t };
              
              if (isOvertimeApproval) {
                // Safely update or create overtimeApproval
                updates.overtimeApproval = {
                  ...(t.overtimeApproval || {}),
                  status: 'rejected',
                  approvedBy: 'Jonathan Malefho',
                  approvalDate: new Date().toISOString().split('T')[0],
                  comments: approvalComment
                };
              } else {
                // Safely update or create approvalRequest
                updates.approvalRequest = {
                  ...(t.approvalRequest || {}),
                  status: 'rejected',
                  approvedBy: 'Jonathan Malefho',
                  approvalDate: new Date().toISOString().split('T')[0],
                  comments: approvalComment
                };
              }
              
              return updates;
            }
            return t;
          })
        }));
        
        onUpdate(updatedEngagements);
        setShowApprovalModal(false);
        setApprovalComment('');
        setSelectedRequest(null);
      };

      const handleSubmitRequest = () => {
        if (!selectedTaskForRequest || !requestReason) {
          alert('Please provide a reason for the request');
          return;
        }
        
        // Create approval request
        const updatedEngagements = engagements.map(e => ({
          ...e,
          tasks: (e.tasks || []).map(t => {
            if (t.id === selectedTaskForRequest.id && e.id === selectedTaskForRequest.engagementId) {
              return {
                ...t,
                approvalRequest: {
                  id: Date.now(),
                  requestedBy: 'Staff Member',
                  requestDate: new Date().toISOString().split('T')[0],
                  reason: requestReason,
                  additionalHours: t.variance,
                  status: 'pending',
                  approvedBy: null,
                  approvalDate: null,
                  comments: null
                }
              };
            }
            return t;
          })
        }));
        
        onUpdate(updatedEngagements);
        setShowRequestModal(false);
        setRequestReason('');
        setSelectedTaskForRequest(null);
      };

      return h('div', null,
        // Metrics
        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#FFC107' } },
            h('div', { className: 'metric-label' }, '‚è≥ Pending Approvals'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, pendingRequests.length),
            h('div', { className: 'metric-detail' }, 'Awaiting review')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#28A745' } },
            h('div', { className: 'metric-label' }, '‚úÖ Approved'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, approvedRequests.length),
            h('div', { className: 'metric-detail' }, 'Budget adjustments approved')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#DC3545' } },
            h('div', { className: 'metric-label' }, '‚ùå Rejected'),
            h('div', { className: 'metric-value', style: { color: '#DC3545' } }, rejectedRequests.length),
            h('div', { className: 'metric-detail' }, 'Requests declined')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#4472C4' } },
            h('div', { className: 'metric-label' }, 'üìù Need Approval'),
            h('div', { className: 'metric-value', style: { color: '#4472C4' } }, tasksNeedingApproval.length),
            h('div', { className: 'metric-detail' }, 'Tasks over budget')
          )
        ),

        // Pending Requests - Priority Section
        pendingRequests.length > 0 && h('div', { 
          className: 'card', 
          style: { 
            marginBottom: '24px',
            border: '3px solid #FFC107',
            background: 'linear-gradient(135deg, #FFF3E0 0%, #FFFFFF 100%)'
          }
        },
          h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' } },
            h('h3', { style: { fontSize: '18px', fontWeight: '700', color: '#F59E0B' } }, 
              '‚è≥ Pending Approval Requests (' + pendingRequests.length + ')'
            ),
            h('div', { style: { background: '#FFC107', color: 'white', padding: '6px 12px', borderRadius: '12px', fontSize: '12px', fontWeight: '600' } },
              '‚ö° ACTION REQUIRED'
            )
          ),

          h('table', { className: 'task-table-enhanced' },
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', null, 'Task'),
                h('th', { style: { textAlign: 'center' } }, 'Budget'),
                h('th', { style: { textAlign: 'center' } }, 'Allocated'),
                h('th', { style: { textAlign: 'center' } }, 'Variance'),
                h('th', null, 'Reason'),
                h('th', { style: { textAlign: 'center' } }, 'Requested'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              pendingRequests.map((task, idx) => {
                const isOvertimeRequest = task.overtimeApproval && task.overtimeApproval.status === 'pending';
                const request = isOvertimeRequest ? task.overtimeApproval : task.approvalRequest;
                
                return h('tr', { key: idx, style: { background: isOvertimeRequest ? '#FFF3E6' : '#FFF9E6' } },
                  h('td', { style: { fontWeight: '600' } }, task.clientName),
                  h('td', null, 
                    h('div', null,
                      task.name,
                      isOvertimeRequest && h('div', { 
                        style: { 
                          fontSize: '10px', 
                          color: '#FF6B6B', 
                          fontWeight: '700',
                          marginTop: '4px',
                          display: 'inline-block',
                          background: '#FFE5E5',
                          padding: '2px 6px',
                          borderRadius: '4px'
                        } 
                      }, '‚è±Ô∏è OVERTIME APPROVAL')
                    )
                  ),
                  h('td', { style: { textAlign: 'center' } }, task.budgetHours + 'h'),
                  h('td', { style: { textAlign: 'center' } }, task.allocatedHours.toFixed(1) + 'h'),
                  h('td', { style: { textAlign: 'center' } },
                    isOvertimeRequest ?
                      h('span', { style: { color: '#FF6B6B', fontWeight: '700' } }, 
                        'Capacity Exceeded'
                      ) :
                      h('span', { style: { color: '#DC3545', fontWeight: '700' } }, 
                        '+' + task.variance.toFixed(1) + 'h'
                      )
                  ),
                  h('td', { style: { fontSize: '12px', maxWidth: '200px' } }, 
                    request ? request.reason : 'N/A'
                  ),
                  h('td', { style: { textAlign: 'center', fontSize: '11px', color: '#666' } },
                    request ? request.requestDate : 'N/A'
                  ),
                  h('td', { style: { textAlign: 'center' } },
                    h('div', { style: { display: 'flex', gap: '6px', justifyContent: 'center' } },
                      h('button', {
                        className: 'action-btn-enhanced edit',
                        style: { fontSize: '11px', padding: '6px 12px', background: 'linear-gradient(135deg, #28A745 0%, #20c997 100%)', color: 'white' },
                        onClick: () => {
                          setSelectedRequest(task);
                          setShowApprovalModal(true);
                        }
                      }, '‚úì Review')
                    )
                  )
                );
              })
            )
          )
        ),

        // Tasks Needing Approval Request
        tasksNeedingApproval.length > 0 && h('div', { className: 'card', style: { marginBottom: '24px' } },
          h('h3', { style: { fontSize: '18px', fontWeight: '600', marginBottom: '16px' } }, 
            'üìù Tasks Over Budget (Request Approval)'
          ),
          
          h('table', { className: 'task-table-enhanced' },
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', null, 'Task'),
                h('th', { style: { textAlign: 'center' } }, 'Budget'),
                h('th', { style: { textAlign: 'center' } }, 'Allocated'),
                h('th', { style: { textAlign: 'center' } }, 'Variance'),
                h('th', { style: { textAlign: 'center' } }, 'Actions')
              )
            ),
            h('tbody', null,
              tasksNeedingApproval.map((task, idx) => 
                h('tr', { key: idx },
                  h('td', { style: { fontWeight: '600' } }, task.clientName),
                  h('td', null, task.name),
                  h('td', { style: { textAlign: 'center' } }, task.budgetHours + 'h'),
                  h('td', { style: { textAlign: 'center' } }, task.allocatedHours.toFixed(1) + 'h'),
                  h('td', { style: { textAlign: 'center' } },
                    h('span', { style: { color: '#DC3545', fontWeight: '700' } }, '+' + task.variance.toFixed(1) + 'h')
                  ),
                  h('td', { style: { textAlign: 'center' } },
                    h('button', {
                      className: 'action-btn-enhanced edit',
                      style: { fontSize: '11px', padding: '6px 12px' },
                      onClick: () => {
                        setSelectedTaskForRequest(task);
                        setShowRequestModal(true);
                      }
                    }, 'üì§ Request Approval')
                  )
                )
              )
            )
          )
        ),

        // Approved Requests History
        approvedRequests.length > 0 && h('div', { className: 'card', style: { marginBottom: '24px' } },
          h('h3', { style: { fontSize: '18px', fontWeight: '600', marginBottom: '16px', color: '#28A745' } }, 
            '‚úÖ Approved Requests (' + approvedRequests.length + ')'
          ),
          
          h('table', { className: 'task-table-enhanced' },
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', null, 'Task'),
                h('th', { style: { textAlign: 'center' } }, 'Variance'),
                h('th', null, 'Approved By'),
                h('th', { style: { textAlign: 'center' } }, 'Date'),
                h('th', null, 'Comments')
              )
            ),
            h('tbody', null,
              approvedRequests.map((task, idx) => {
                // Determine which approval type this is
                const isOvertimeApproval = task.overtimeApproval && task.overtimeApproval.status === 'approved';
                const approval = isOvertimeApproval ? task.overtimeApproval : task.approvalRequest;
                
                return h('tr', { key: idx, style: { background: '#E8F5E9' } },
                  h('td', { style: { fontWeight: '600' } }, task.clientName),
                  h('td', null, 
                    task.name,
                    isOvertimeApproval && h('div', { 
                      style: { 
                        fontSize: '10px', 
                        color: '#FF6B6B', 
                        fontWeight: '700',
                        marginTop: '4px',
                        background: '#FFE5E5',
                        padding: '2px 6px',
                        borderRadius: '3px',
                        display: 'inline-block'
                      } 
                    }, '‚è±Ô∏è OVERTIME')
                  ),
                  h('td', { style: { textAlign: 'center', color: '#28A745', fontWeight: '700' } }, 
                    isOvertimeApproval ? 'Capacity Exceeded' : '+' + task.variance + 'h'
                  ),
                  h('td', null, approval ? approval.approvedBy : '-'),
                  h('td', { style: { textAlign: 'center', fontSize: '11px' } }, 
                    approval ? approval.approvalDate : '-'
                  ),
                  h('td', { style: { fontSize: '12px', color: '#666' } }, 
                    approval ? (approval.comments || '-') : '-'
                  )
                );
              })
            )
          )
        ),

        // Rejected Requests History
        rejectedRequests.length > 0 && h('div', { className: 'card', style: { marginBottom: '24px' } },
          h('h3', { style: { fontSize: '18px', fontWeight: '600', marginBottom: '16px', color: '#DC3545' } }, 
            '‚ùå Rejected Requests (' + rejectedRequests.length + ')'
          ),
          
          h('table', { className: 'task-table-enhanced' },
            h('thead', null,
              h('tr', null,
                h('th', null, 'Client'),
                h('th', null, 'Task'),
                h('th', { style: { textAlign: 'center' } }, 'Variance'),
                h('th', null, 'Rejected By'),
                h('th', { style: { textAlign: 'center' } }, 'Date'),
                h('th', null, 'Comments')
              )
            ),
            h('tbody', null,
              rejectedRequests.map((task, idx) => {
                // Determine which approval type this is
                const isOvertimeApproval = task.overtimeApproval && task.overtimeApproval.status === 'rejected';
                const approval = isOvertimeApproval ? task.overtimeApproval : task.approvalRequest;
                
                return h('tr', { key: idx, style: { background: '#FFEBEE' } },
                  h('td', { style: { fontWeight: '600' } }, task.clientName),
                  h('td', null, 
                    h('span', { style: { textDecoration: 'line-through', color: '#999' } }, task.name),
                    isOvertimeApproval && h('div', { 
                      style: { 
                        fontSize: '10px', 
                        color: '#FF6B6B', 
                        fontWeight: '700',
                        marginTop: '4px',
                        background: '#FFE5E5',
                        padding: '2px 6px',
                        borderRadius: '3px',
                        display: 'inline-block'
                      } 
                    }, '‚è±Ô∏è OVERTIME')
                  ),
                  h('td', { style: { textAlign: 'center', color: '#DC3545', fontWeight: '700', textDecoration: 'line-through' } }, 
                    isOvertimeApproval ? 'Capacity Exceeded' : '+' + task.variance + 'h'
                  ),
                  h('td', null, approval ? approval.approvedBy : '-'),
                  h('td', { style: { textAlign: 'center', fontSize: '11px' } }, 
                    approval ? approval.approvalDate : '-'
                  ),
                  h('td', { style: { fontSize: '12px', color: '#666' } }, 
                    approval ? (approval.comments || '-') : '-'
                  )
                );
              })
            )
          )
        ),

        // Approval Modal
        showApprovalModal && selectedRequest && h('div', { className: 'modal', onClick: () => setShowApprovalModal(false) },
          h('div', { 
            className: 'modal-content', 
            style: { maxWidth: '600px' },
            onClick: (e) => e.stopPropagation() 
          },
            h('div', { className: 'modal-header' },
              h('h2', { className: 'modal-title' }, 'Review Approval Request'),
              h('button', { className: 'close-btn', onClick: () => setShowApprovalModal(false) }, '√ó')
            ),
            h('div', { className: 'modal-body' },
              h('div', { style: { background: '#F8F9FA', padding: '16px', borderRadius: '8px', marginBottom: '20px' } },
                h('div', { style: { fontSize: '16px', fontWeight: '700', marginBottom: '12px' } }, 
                  selectedRequest.clientName + ' - ' + selectedRequest.name
                ),
                // Check if this is an overtime approval
                (selectedRequest.overtimeApproval && selectedRequest.overtimeApproval.status === 'pending') ? 
                  // OVERTIME APPROVAL VIEW
                  h('div', null,
                    h('div', { 
                      style: { 
                        fontSize: '14px', 
                        fontWeight: '700', 
                        color: '#FF6B6B',
                        marginBottom: '12px',
                        background: '#FFE5E5',
                        padding: '8px',
                        borderRadius: '4px'
                      } 
                    }, '‚è±Ô∏è OVERTIME APPROVAL REQUEST'),
                    h('div', { style: { fontSize: '13px', color: '#666', marginBottom: '12px' } },
                      'This task assignment will cause staff to exceed 8 hours per day capacity.'
                    ),
                    selectedRequest.overtimeApproval.violations && Array.isArray(selectedRequest.overtimeApproval.violations) && selectedRequest.overtimeApproval.violations.length > 0 && 
                      h('div', { style: { marginBottom: '12px' } },
                        selectedRequest.overtimeApproval.violations.map((v, idx) => 
                          h('div', { key: idx, style: { marginBottom: '8px' } },
                            h('div', { style: { fontSize: '13px', fontWeight: '600', marginBottom: '4px' } }, (v.staffName || 'Unknown Staff') + ':'),
                            v.overtimeDays && Array.isArray(v.overtimeDays) && v.overtimeDays.slice(0, 3).map((day, dayIdx) =>
                              h('div', { key: dayIdx, style: { fontSize: '12px', color: '#666', marginLeft: '12px' } },
                                (day.date || '') + ': ' + 
                                (day.existing || 0).toFixed(1) + 'h existing + ' + 
                                (day.adding || 0).toFixed(1) + 'h new = ' + 
                                (day.total || 0).toFixed(1) + 'h (' + 
                                (day.overtime || 0).toFixed(1) + 'h over)'
                              )
                            ),
                            v.overtimeDays && Array.isArray(v.overtimeDays) && v.overtimeDays.length > 3 &&
                              h('div', { style: { fontSize: '12px', color: '#999', marginLeft: '12px', fontStyle: 'italic' } },
                                '... and ' + (v.overtimeDays.length - 3) + ' more days'
                              )
                          )
                        )
                      ),
                    h('div', { style: { borderTop: '1px solid #E0E0E0', paddingTop: '12px' } },
                      h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Reason:'),
                      h('div', { style: { fontSize: '14px' } }, selectedRequest.overtimeApproval.reason || 'No reason provided')
                    )
                  )
                : 
                  // BUDGET APPROVAL VIEW  
                  h('div', null,
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px', marginBottom: '12px' } },
                      h('div', null,
                        h('div', { style: { fontSize: '11px', color: '#666' } }, 'Budget Hours'),
                        h('div', { style: { fontSize: '18px', fontWeight: '700' } }, selectedRequest.budgetHours + 'h')
                      ),
                      h('div', null,
                        h('div', { style: { fontSize: '11px', color: '#666' } }, 'Allocated Hours'),
                        h('div', { style: { fontSize: '18px', fontWeight: '700' } }, selectedRequest.allocatedHours.toFixed(1) + 'h')
                      ),
                      h('div', null,
                        h('div', { style: { fontSize: '11px', color: '#666' } }, 'Variance'),
                        h('div', { style: { fontSize: '18px', fontWeight: '700', color: '#DC3545' } }, 
                          '+' + selectedRequest.variance.toFixed(1) + 'h'
                        )
                      )
                    ),
                    h('div', { style: { borderTop: '1px solid #E0E0E0', paddingTop: '12px' } },
                      h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '4px' } }, 'Reason:'),
                      h('div', { style: { fontSize: '14px' } }, 
                        selectedRequest.approvalRequest ? selectedRequest.approvalRequest.reason : 'No reason provided'
                      )
                    )
                  )
              ),

              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Manager Comments'),
                h('textarea', {
                  className: 'form-input',
                  rows: 3,
                  placeholder: 'Add comments about this approval/rejection...',
                  value: approvalComment,
                  onChange: (e) => setApprovalComment(e.target.value)
                })
              )
            ),
            h('div', { className: 'modal-footer' },
              h('button', { 
                className: 'btn btn-secondary', 
                onClick: () => setShowApprovalModal(false) 
              }, 'Cancel'),
              h('button', { 
                className: 'action-btn-enhanced delete',
                onClick: handleReject
              }, '‚ùå Reject'),
              h('button', { 
                className: 'action-btn-enhanced edit',
                style: { background: 'linear-gradient(135deg, #28A745 0%, #20c997 100%)', color: 'white' },
                onClick: handleApprove
              }, '‚úÖ Approve')
            )
          )
        ),

        // Request Modal
        showRequestModal && selectedTaskForRequest && h('div', { className: 'modal', onClick: () => setShowRequestModal(false) },
          h('div', { 
            className: 'modal-content', 
            style: { maxWidth: '600px' },
            onClick: (e) => e.stopPropagation() 
          },
            h('div', { className: 'modal-header' },
              h('h2', { className: 'modal-title' }, 'Request Hour Adjustment Approval'),
              h('button', { className: 'close-btn', onClick: () => setShowRequestModal(false) }, '√ó')
            ),
            h('div', { className: 'modal-body' },
              h('div', { style: { background: '#F8F9FA', padding: '16px', borderRadius: '8px', marginBottom: '20px' } },
                h('div', { style: { fontSize: '16px', fontWeight: '700', marginBottom: '8px' } }, 
                  selectedTaskForRequest.clientName + ' - ' + selectedTaskForRequest.name
                ),
                h('div', { style: { fontSize: '14px', color: '#666' } },
                  `Requesting approval for additional ${selectedTaskForRequest.variance} hours`
                )
              ),

              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Reason for Additional Hours *'),
                h('textarea', {
                  className: 'form-input',
                  rows: 4,
                  placeholder: 'Explain why additional hours are needed (e.g., scope change, unexpected issues, client requests)...',
                  value: requestReason,
                  onChange: (e) => setRequestReason(e.target.value),
                  required: true
                })
              )
            ),
            h('div', { className: 'modal-footer' },
              h('button', { 
                className: 'btn btn-secondary', 
                onClick: () => setShowRequestModal(false) 
              }, 'Cancel'),
              h('button', { 
                className: 'btn btn-primary',
                onClick: handleSubmitRequest,
                disabled: !requestReason
              }, 'üì§ Submit Request')
            )
          )
        )
      );
    }

    function TaskManagerModal({ engagement, staff, onClose, onUpdate }) {
      const [showAdjustmentForm, setShowAdjustmentForm] = useState(false);
      const [selectedTask, setSelectedTask] = useState(null);

      // Get all tasks with hour variances
      const tasksWithVariance = engagements.flatMap(e =>
        (e.tasks || [])
          .map(t => ({
            ...t,
            engagementId: e.id,
            clientName: e.clientName,
            variance: (t.actualHours || 0) - (t.budgetHours || 0)
          }))
          .filter(t => t.variance !== 0)
      );

      const totalOverruns = tasksWithVariance.filter(t => t.variance > 0).length;
      const totalUnderruns = tasksWithVariance.filter(t => t.variance < 0).length;
      const totalVarianceHours = tasksWithVariance.reduce((sum, t) => sum + Math.abs(t.variance), 0);

      return h('div', null,
        h('div', { className: 'metric-grid' },
          h('div', { className: 'metric-card', style: { borderLeftColor: '#DC3545' } },
            h('div', { className: 'metric-label' }, 'Budget Overruns'),
            h('div', { className: 'metric-value', style: { color: '#DC3545' } }, totalOverruns),
            h('div', { className: 'metric-detail' }, 'Tasks over budget')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#28A745' } },
            h('div', { className: 'metric-label' }, 'Budget Underruns'),
            h('div', { className: 'metric-value', style: { color: '#28A745' } }, totalUnderruns),
            h('div', { className: 'metric-detail' }, 'Tasks under budget')
          ),
          h('div', { className: 'metric-card', style: { borderLeftColor: '#FFC107' } },
            h('div', { className: 'metric-label' }, 'Total Variance'),
            h('div', { className: 'metric-value', style: { color: '#FFC107' } }, `${totalVarianceHours}h`),
            h('div', { className: 'metric-detail' }, 'Hours difference')
          )
        ),

        h('div', { className: 'card' },
          h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' } },
            h('h3', { style: { fontSize: '18px', fontWeight: '600' } }, 
              'Hour Adjustments & Approval'
            ),
            h('div', { style: { padding: '8px 16px', background: '#E3F2FD', borderRadius: '8px', fontSize: '13px', color: '#1976D2' } },
              'üí° Phase 2: Approval workflow coming soon'
            )
          ),

          tasksWithVariance.length === 0 ?
            h('div', { className: 'empty-state' },
              h('div', { className: 'empty-state-icon' }, '‚úÖ'),
              h('p', null, 'All tasks are on budget!')
            ) :
            h('table', { className: 'task-table-enhanced' },
              h('thead', null,
                h('tr', null,
                  h('th', null, 'Client'),
                  h('th', null, 'Task'),
                  h('th', { style: { textAlign: 'center' } }, 'Budget'),
                  h('th', { style: { textAlign: 'center' } }, 'Actual'),
                  h('th', { style: { textAlign: 'center' } }, 'Variance'),
                  h('th', { style: { textAlign: 'center' } }, 'Status'),
                  h('th', { style: { textAlign: 'center' } }, 'Actions')
                )
              ),
              h('tbody', null,
                tasksWithVariance.map((task, idx) => {
                  const varianceClass = task.variance > 0 ? 'overrun' : 'underrun';
                  
                  return h('tr', { key: idx },
                    h('td', { style: { fontWeight: '600' } }, task.clientName),
                    h('td', null, task.name),
                    h('td', { style: { textAlign: 'center' } }, `${task.budgetHours}h`),
                    h('td', { style: { textAlign: 'center' } }, `${task.actualHours}h`),
                    h('td', { style: { textAlign: 'center' } },
                      h('span', {
                        style: {
                          color: task.variance > 0 ? '#DC3545' : '#28A745',
                          fontWeight: '700',
                          fontSize: '14px'
                        }
                      }, `${task.variance > 0 ? '+' : ''}${task.variance}h`)
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('span', {
                        className: 'hour-adjustment'
                      }, task.variance > 0 ? '‚ö†Ô∏è Over Budget' : '‚úì Under Budget')
                    ),
                    h('td', { style: { textAlign: 'center' } },
                      h('button', {
                        className: 'action-btn-enhanced edit',
                        style: { fontSize: '11px', padding: '6px 12px' }
                      }, 'Request Approval')
                    )
                  );
                })
              )
            )
        )
      );
    }

    function TaskManagerModal({ engagement, staff, allEngagements, onClose, onUpdate }) {
      const [tasks, setTasks] = useState(engagement.tasks || []);
      const [currentStage, setCurrentStage] = useState('acceptance');
      const [showTaskForm, setShowTaskForm] = useState(false);
      const [editingTask, setEditingTask] = useState(null);

      const handleSaveTask = (task) => {
        let updatedTasks;
        if (editingTask) {
          // CRITICAL FIX: Preserve existing approval requests and other fields
          updatedTasks = tasks.map(t => {
            if (t.id === task.id) {
              return {
                ...t,  // Keep all existing fields (including approvalRequest)
                ...task,  // Update with new values
                // Ensure approvalRequest is preserved if it exists
                approvalRequest: task.approvalRequest || t.approvalRequest
              };
            }
            return t;
          });
        } else {
          updatedTasks = [...tasks, { ...task, id: Date.now() }];
        }
        setTasks(updatedTasks);
        setShowTaskForm(false);
        setEditingTask(null);
      };

      const handleDeleteTask = (taskId) => {
        if (confirm('Delete this task?')) {
          setTasks(tasks.filter(t => t.id !== taskId));
        }
      };

      const handleLoadDefaultTasks = () => {
        if (confirm('Load default audit tasks?')) {
          const newTasks = [];
          let taskId = Date.now();
          
          Object.entries(DEFAULT_TASKS).forEach(([stage, stageTasks]) => {
            stageTasks.forEach(task => {
              newTasks.push({
                id: taskId++,
                stage: stage,
                name: task.name,
                budgetHours: task.defaultHours,
                actualHours: 0,
                status: 'Not Started',
                assignments: []
              });
            });
          });
          
          setTasks([...tasks, ...newTasks]);
        }
      };

      const currentStageTasks = tasks.filter(t => t.stage === currentStage);
      const totalBudgetHours = tasks.reduce((sum, t) => sum + (t.budgetHours || 0), 0);
      
      // Calculate lockdown period from engagement's auditCompletionDate
      const auditCompletionDate = engagement.auditCompletionDate || engagement.completionDate;
      const lockdownDeadline = calculateLockdownDeadline(auditCompletionDate);
      const lockdownStartDate = auditCompletionDate; // Lockdown starts at completion
      
      const hasBudget = engagement.budgetData && engagement.hasBudget;
      const budgetedTasks = tasks.filter(t => t.budgetLocked);
      const nonBudgetedTasks = tasks.filter(t => !t.budgetLocked);

      return h('div', { className: 'modal', onClick: onClose },
        h('div', { className: 'modal-content', onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, 'üìã Allocate Budget Tasks: ' + engagement.clientName),
            h('button', { className: 'close-btn', onClick: onClose }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            
            // Budget Status Banner
            hasBudget && h('div', {
              style: {
                background: 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)',
                color: 'white',
                padding: '12px 16px',
                borderRadius: '8px',
                marginBottom: '16px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between'
              }
            },
              h('div', null,
                h('div', { style: { fontSize: '14px', fontWeight: '700', marginBottom: '4px' } },
                  'üìä ' + budgetedTasks.length + ' Tasks Loaded from Budget (Hours Locked)'
                ),
                h('div', { style: { fontSize: '12px', opacity: 0.9 } },
                  'Assign staff members to each task below. Budget hours cannot be changed.'
                )
              ),
              h('div', { style: { fontSize: '24px' } }, 'üîí')
            ),

            h('div', { style: { background: '#1F4E78', color: 'white', padding: '16px', borderRadius: '8px', marginBottom: '20px' } },
              h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '16px', textAlign: 'center' } },
                h('div', null,
                  h('div', { style: { fontSize: '12px', opacity: 0.8 } }, 'Budgeted Tasks'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700' } }, budgetedTasks.length),
                  h('div', { style: { fontSize: '10px', opacity: 0.7, marginTop: '4px' } }, 'üîí Locked')
                ),
                h('div', null,
                  h('div', { style: { fontSize: '12px', opacity: 0.8 } }, 'Budget Hours'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700' } }, totalBudgetHours + 'h')
                ),
                h('div', null,
                  h('div', { style: { fontSize: '12px', opacity: 0.8 } }, 'Completed'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700' } }, 
                    tasks.filter(t => t.status === 'Completed').length
                  )
                ),
                h('div', null,
                  h('div', { style: { fontSize: '12px', opacity: 0.8 } }, 'In Progress'),
                  h('div', { style: { fontSize: '24px', fontWeight: '700' } }, 
                    tasks.filter(t => t.status === 'In Progress').length
                  )
                )
              )
            ),

            h('div', { style: { marginBottom: '20px', display: 'flex', gap: '12px', alignItems: 'center' } },
              h('div', { 
                style: { 
                  flex: 1,
                  padding: '12px 16px',
                  background: '#E3F2FD',
                  borderRadius: '8px',
                  border: '2px dashed #2196F3'
                } 
              },
                h('div', { style: { fontSize: '13px', fontWeight: '600', color: '#1976D2', marginBottom: '4px' } },
                  'üí° Allocation Instructions'
                ),
                h('div', { style: { fontSize: '12px', color: '#1565C0' } },
                  'Click "Edit" on any task below to assign team members. You can save with unallocated tasks and return later.'
                )
              )
            ),

            h('div', { style: { display: 'flex', gap: '6px', marginBottom: '20px', overflowX: 'auto' } },
              AUDIT_STAGES.map(stage => {
                const count = tasks.filter(t => t.stage === stage.id).length;
                return h('button', { 
                  key: stage.id,
                  className: 'stage-tab-enhanced ' + stage.id + (currentStage === stage.id ? ' active' : ''),
                  onClick: () => setCurrentStage(stage.id)
                }, 
                  stage.name,
                  h('span', { className: 'tab-count' }, count),
                  stage.id === 'lockdown' && h('span', { style: { marginLeft: '4px' } }, '‚è∞')
                );
              })
            ),

            currentStage === 'lockdown' && auditCompletionDate && h('div', { className: 'lockdown-warning-enhanced' },
              h('div', { className: 'icon' }, 'üîí'),
              h('div', null,
                h('strong', null, 'Lockdown Stage: '),
                '60 days from completion date. ',
                h('br'),
                h('strong', null, 
                  new Date(lockdownStartDate).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) +
                  ' to ' +
                  new Date(lockdownDeadline).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'})
                ),
                '. Deadline: ' + new Date(lockdownDeadline).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'})
              )
            ),

            h('div', { style: { marginTop: '20px' } },
              currentStageTasks.length === 0 ?
                h('div', { className: 'empty-state' },
                  h('div', { className: 'empty-state-icon' }, 'üìù'),
                  h('p', null, 'No tasks in ' + AUDIT_STAGES.find(s => s.id === currentStage)?.name)
                ) :
                h('table', { className: 'task-table-enhanced' },
                  h('thead', null,
                    h('tr', null,
                      h('th', null, 'Task Name'),
                      h('th', { style: { textAlign: 'center' } }, 'Budget Hours'),
                      h('th', { style: { textAlign: 'center' } }, 'Assigned To'),
                      h('th', { style: { textAlign: 'center' } }, 'Status'),
                      h('th', { style: { textAlign: 'center' } }, 'Actions')
                    )
                  ),
                  h('tbody', null,
                    currentStageTasks.map(task => {
                      const assignedStaff = (task.assignments || []).map(a => {
                        const s = staff.find(st => st.id === a.staffId);
                        return s ? s.name : 'Unknown';
                      }).join(', ');
                      
                      const statusClass = task.status === 'Completed' ? 'completed' :
                                        task.status === 'In Progress' ? 'in-progress' : 'not-started';

                      return h('tr', { key: task.id },
                        h('td', { style: { fontWeight: '600' } }, 
                          task.name,
                          task.budgetLocked && h('span', {
                            style: {
                              marginLeft: '8px',
                              fontSize: '10px',
                              padding: '2px 6px',
                              background: '#E8F5E9',
                              color: '#2E7D32',
                              borderRadius: '4px',
                              fontWeight: '600'
                            }
                          }, 'üìä Budgeted')
                        ),
                        h('td', { 
                          style: { 
                            textAlign: 'center',
                            fontWeight: task.budgetLocked ? '600' : 'normal',
                            color: task.budgetLocked ? '#2E7D32' : 'inherit'
                          } 
                        }, task.budgetHours + 'h'),
                        h('td', { style: { textAlign: 'center', fontSize: '12px' } }, assignedStaff || '-'),
                        h('td', { style: { textAlign: 'center' } },
                          h('span', {
                            className: 'status-badge-enhanced ' + statusClass
                          }, task.status)
                        ),
                        h('td', { style: { textAlign: 'center' } },
                          h('div', { style: { display: 'flex', gap: '6px', justifyContent: 'center' } },
                            h('button', {
                              className: 'action-btn-enhanced edit',
                              onClick: () => {
                                setEditingTask(task);
                                setShowTaskForm(true);
                              }
                            }, 'Edit'),
                            h('button', {
                              className: 'action-btn-enhanced delete',
                              onClick: () => handleDeleteTask(task.id)
                            }, 'Delete')
                          )
                        )
                      );
                    })
                  )
                )
            )
          ),
          h('div', { className: 'modal-footer', style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
            h('div', { style: { display: 'flex', gap: '12px' } },
              h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Close'),
              currentStage !== 'acceptance' && h('button', {
                className: 'btn btn-secondary',
                onClick: () => {
                  const stageOrder = ['acceptance', 'planning', 'fieldwork', 'completion', 'lockdown'];
                  const currentIdx = stageOrder.indexOf(currentStage);
                  if (currentIdx > 0) {
                    setCurrentStage(stageOrder[currentIdx - 1]);
                  }
                }
              }, '‚Üê Previous Stage')
            ),
            h('div', { style: { display: 'flex', gap: '12px' } },
              h('button', { 
                className: 'btn btn-primary', 
                onClick: () => {
                  onUpdate({ ...engagement, tasks });
                  alert('‚úÖ Tasks saved successfully!');
                }
              }, 'üíæ Save All Tasks'),
              currentStage !== 'lockdown' && h('button', {
                className: 'btn btn-primary',
                style: { background: '#4CAF50' },
                onClick: () => {
                  // Save first
                  onUpdate({ ...engagement, tasks });
                  // Then auto-advance to next stage
                  const stageOrder = ['acceptance', 'planning', 'fieldwork', 'completion', 'lockdown'];
                  const currentIdx = stageOrder.indexOf(currentStage);
                  if (currentIdx < stageOrder.length - 1) {
                    setCurrentStage(stageOrder[currentIdx + 1]);
                    alert('‚úÖ Saved! Moving to next stage: ' + stageOrder[currentIdx + 1].charAt(0).toUpperCase() + stageOrder[currentIdx + 1].slice(1));
                  }
                }
              }, 'üíæ Save & Next Stage ‚Üí')
            )
          )
        ),

        showTaskForm && h(TaskForm, {
          task: editingTask,
          stage: currentStage,
          staff: staff,
          currentEngagement: engagement,
          allEngagements: allEngagements,
          onSave: handleSaveTask,
          onCancel: () => {
            setShowTaskForm(false);
            setEditingTask(null);
          }
        })
      );
    }

    function TaskForm({ task, stage, staff, currentEngagement, allEngagements, onSave, onCancel }) {
      const [formData, setFormData] = useState(task || {
        name: '',
        stage: stage,
        budgetHours: '',
        actualHours: 0,
        status: 'Not Started',
        assignments: []
      });
      const [searchTerm, setSearchTerm] = useState('');
      const [showApprovalWarning, setShowApprovalWarning] = useState(false);
      const [approvalReason, setApprovalReason] = useState('');
      const [hasCapacityViolation, setHasCapacityViolation] = useState(false);

      // Helper: Calculate existing capacity for a staff member
      const calculateExistingCapacity = (staffId, startDate, endDate) => {
        if (!startDate || !endDate || !allEngagements) {
          console.log('  ‚Üí calculateExistingCapacity: Missing params', {startDate, endDate, hasAllEngagements: !!allEngagements});
          return {};
        }
        
        console.log('  ‚Üí calculateExistingCapacity START');
        console.log('  ‚Üí staffId:', staffId);
        console.log('  ‚Üí allEngagements count:', allEngagements.length);
        
        try {
          const start = new Date(startDate);
          const end = new Date(endDate);
          const capacityByDate = {};
          
          // Initialize capacity for date range
          let current = new Date(start);
          while (current <= end) {
            const day = current.getDay();
            if (day !== 0 && day !== 6) {
              capacityByDate[current.toISOString().split('T')[0]] = 0;
            }
            current.setDate(current.getDate() + 1);
          }
          
          console.log('  ‚Üí Initialized dates:', Object.keys(capacityByDate));
          
          // Calculate existing allocations
          let tasksChecked = 0;
          let assignmentsChecked = 0;
          let matchingAssignments = 0;
          
          allEngagements.forEach(eng => {
            if (!eng || !eng.tasks) return;
            
            (eng.tasks || []).forEach(t => {
              tasksChecked++;
              
              // Skip current task being edited
              if (task && t.id === task.id) {
                console.log('  ‚Üí Skipping current task:', t.name);
                return;
              }
              
              (t.assignments || []).forEach(assignment => {
                assignmentsChecked++;
                
                // Convert both to string for comparison (handles number vs string mismatch)
                if (String(assignment.staffId) === String(staffId)) {
                  // Use assignment dates if available, otherwise use engagement dates
                  const assignmentStart = assignment.startDate || eng.auditStartDate;
                  const assignmentEnd = assignment.endDate || eng.auditCompletionDate;
                  
                  console.log('  ‚Üí Found assignment for staffId', staffId, ':', {
                    task: t.name,
                    hours: assignment.hours,
                    assignmentStartDate: assignment.startDate,
                    assignmentEndDate: assignment.endDate,
                    engagementStartDate: eng.auditStartDate,
                    engagementEndDate: eng.auditCompletionDate,
                    effectiveStart: assignmentStart,
                    effectiveEnd: assignmentEnd
                  });
                  
                  if (assignmentStart && assignmentEnd && assignment.hours) {
                    matchingAssignments++;
                    console.log('  ‚Üí MATCH! Task:', t.name, 'Hours:', assignment.hours, 'Dates:', assignmentStart, 'to', assignmentEnd);
                    
                    const taskStart = new Date(assignmentStart);
                    const taskEnd = new Date(assignmentEnd);
                    
                    // Calculate working days
                    let workingDays = 0;
                    let curr = new Date(taskStart);
                    while (curr <= taskEnd) {
                      if (curr.getDay() !== 0 && curr.getDay() !== 6) workingDays++;
                      curr.setDate(curr.getDate() + 1);
                    }
                    
                    if (workingDays > 0) {
                      const hoursPerDay = assignment.hours / workingDays;
                      console.log('  ‚Üí Adding', hoursPerDay, 'h/day');
                      
                      // Add to overlapping days
                      curr = new Date(taskStart);
                      while (curr <= taskEnd) {
                        if (curr.getDay() !== 0 && curr.getDay() !== 6) {
                          const dateKey = curr.toISOString().split('T')[0];
                          if (capacityByDate.hasOwnProperty(dateKey)) {
                            capacityByDate[dateKey] += hoursPerDay;
                          }
                        }
                        curr.setDate(curr.getDate() + 1);
                      }
                    }
                  } else {
                    console.log('  ‚Üí ‚ùå REJECTED: Missing', 
                      !assignmentStart ? 'start date' : '',
                      !assignmentEnd ? 'end date' : '',
                      !assignment.hours ? 'hours' : ''
                    );
                  }
                } else if (assignment.staffId && assignment.hours) {
                  // Log why it didn't match
                  console.log('  ‚Üí Not matching: assignment.staffId=', assignment.staffId, '(', typeof assignment.staffId, ') vs staffId=', staffId, '(', typeof staffId, ')');
                }
              });
            });
          });
          
          console.log('  ‚Üí Stats: Checked', tasksChecked, 'tasks,', assignmentsChecked, 'assignments, Found', matchingAssignments, 'matches');
          console.log('  ‚Üí Final capacity:', capacityByDate);
          
          return capacityByDate;
        } catch (error) {
          console.error('  ‚Üí Capacity calculation error:', error);
          return {};
        }
      };

      const handleChange = (field, value) => {
        setFormData({ ...formData, [field]: value });
      };

      const handleAssignmentChange = (staffId, field, value) => {
        const assignments = [...(formData.assignments || [])];
        const existingIndex = assignments.findIndex(a => a.staffId === staffId);
        
        if (field === 'hours') {
          const hours = parseFloat(value);
          if (hours > 0) {
            if (existingIndex >= 0) {
              assignments[existingIndex] = { 
                ...assignments[existingIndex],
                hours 
              };
            } else {
              assignments.push({ 
                staffId, 
                hours,
                startDate: '',
                endDate: ''
              });
            }
          } else {
            if (existingIndex >= 0) {
              assignments.splice(existingIndex, 1);
            }
          }
        } else if (field === 'startDate' || field === 'endDate') {
          // DATE VALIDATION
          const auditStartDate = currentEngagement?.auditStartDate;
          const auditCompletionDate = currentEngagement?.auditCompletionDate;
          
          // Calculate lockdown period (60 days AFTER completion)
          let lockdownStartDate = null;
          let lockdownEndDate = null;
          if (auditCompletionDate) {
            lockdownStartDate = auditCompletionDate;
            const lockEnd = new Date(auditCompletionDate);
            lockEnd.setDate(lockEnd.getDate() + 60);
            lockdownEndDate = lockEnd.toISOString().split('T')[0];
          }
          
          // Check if this is a lockdown task
          const isLockdownTask = formData.stage === 'lockdown' || stage === 'lockdown';
          
          if (field === 'startDate') {
            // Validation 1: Not before audit start
            if (auditStartDate && value < auditStartDate) {
              alert(
                '‚ùå INVALID START DATE\n\n' +
                'Task cannot start before Audit Start Date.\n\n' +
                'Audit Start: ' + new Date(auditStartDate).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + '\n' +
                'Selected: ' + new Date(value).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + '\n\n' +
                'Please choose a date on or after the audit start date.'
              );
              return;
            }
            
            // Validation 2: Non-lockdown cannot start after completion
            if (!isLockdownTask && auditCompletionDate && value > auditCompletionDate) {
              alert(
                '‚ùå INVALID START DATE\n\n' +
                'Non-lockdown tasks cannot start after Completion Date.\n\n' +
                'Completion: ' + new Date(auditCompletionDate).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + '\n' +
                'Selected: ' + new Date(value).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + '\n\n' +
                'Please choose an earlier date or use a lockdown task (Stage E).'
              );
              return;
            }
            
            // Validation 3: Lockdown tasks must be in lockdown period
            if (isLockdownTask && lockdownStartDate && lockdownEndDate) {
              if (value < lockdownStartDate || value > lockdownEndDate) {
                alert(
                  '‚ùå INVALID START DATE FOR LOCKDOWN TASK\n\n' +
                  'Lockdown tasks must be within the lockdown period.\n\n' +
                  'Lockdown Period:\n' +
                  new Date(lockdownStartDate).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + ' to ' +
                  new Date(lockdownEndDate).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + '\n\n' +
                  'Selected: ' + new Date(value).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + '\n\n' +
                  'Please choose a date within the lockdown period.'
                );
                return;
              }
            }
            
            // Validation 4: Non-lockdown tasks cannot be in lockdown period
            if (!isLockdownTask && lockdownStartDate && value >= lockdownStartDate) {
              alert(
                '‚ö†Ô∏è DATE IN LOCKDOWN PERIOD\n\n' +
                'This date is in the lockdown period (60 days after completion).\n\n' +
                'Lockdown Period: ' + new Date(lockdownStartDate).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + ' onwards\n\n' +
                'Options:\n' +
                '1. Choose an earlier date (before ' + new Date(lockdownStartDate).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + ')\n' +
                '2. Change task stage to Lockdown (Stage E)'
              );
              return;
            }
          } else if (field === 'endDate') {
            const assignment = assignments[existingIndex];
            const startDate = assignment?.startDate;
            
            // Validation 1: End must be after start
            if (startDate && value < startDate) {
              alert(
                '‚ùå INVALID END DATE\n\n' +
                'End date cannot be before start date.\n\n' +
                'Start Date: ' + new Date(startDate).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + '\n' +
                'Selected End: ' + new Date(value).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'})
              );
              return;
            }
            
            // Validation 2: Non-lockdown cannot end after completion
            if (!isLockdownTask && auditCompletionDate && value > auditCompletionDate) {
              alert(
                '‚ùå INVALID END DATE\n\n' +
                'Non-lockdown tasks cannot end after Completion Date.\n\n' +
                'Completion: ' + new Date(auditCompletionDate).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + '\n' +
                'Selected: ' + new Date(value).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + '\n\n' +
                'Please choose an earlier end date.'
              );
              return;
            }
            
            // Validation 3: Lockdown tasks must end within lockdown period
            if (isLockdownTask && lockdownEndDate && value > lockdownEndDate) {
              alert(
                '‚ùå INVALID END DATE FOR LOCKDOWN TASK\n\n' +
                'Lockdown tasks must end within lockdown period.\n\n' +
                'Lockdown Ends: ' + new Date(lockdownEndDate).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + '\n' +
                'Selected: ' + new Date(value).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) + '\n\n' +
                'Please choose an earlier end date.'
              );
              return;
            }
          }
          
          // If all validations pass, update the date
          if (existingIndex >= 0) {
            assignments[existingIndex] = {
              ...assignments[existingIndex],
              [field]: value
            };
          }
        } else {
          // Other fields (not hours or dates)
          if (existingIndex >= 0) {
            assignments[existingIndex] = {
              ...assignments[existingIndex],
              [field]: value
            };
          }
        }
        
        // Update form data
        const updatedFormData = { ...formData, assignments };
        setFormData(updatedFormData);
        
        // Check if total assigned hours exceed budget OR if there are capacity violations
        const totalAssigned = assignments.reduce((sum, a) => sum + (a.hours || 0), 0);
        const budget = parseFloat(updatedFormData.budgetHours) || 0;
        
        // FULL capacity check against existing allocations
        let hasCapacityIssue = false;
        
        // Check each assignment for capacity violations
        assignments.forEach(a => {
          if (a.hours > 0 && a.staffId && a.startDate && a.endDate) {
            // Get existing capacity for this staff member
            const existingCapacity = calculateExistingCapacity(
              a.staffId,
              a.startDate,
              a.endDate
            );
            
            // Calculate hours per day for this assignment
            const start = new Date(a.startDate);
            const end = new Date(a.endDate);
            let workingDays = 0;
            let curr = new Date(start);
            while (curr <= end) {
              if (curr.getDay() !== 0 && curr.getDay() !== 6) workingDays++;
              curr.setDate(curr.getDate() + 1);
            }
            
            if (workingDays > 0) {
              const hoursPerDay = a.hours / workingDays;
              
              // Check if adding this would exceed 8h on any day
              curr = new Date(start);
              while (curr <= end) {
                if (curr.getDay() !== 0 && curr.getDay() !== 6) {
                  const dateKey = curr.toISOString().split('T')[0];
                  const existing = existingCapacity[dateKey] || 0;
                  const newTotal = existing + hoursPerDay;
                  
                  if (newTotal > 8) {
                    hasCapacityIssue = true;
                    break;
                  }
                }
                curr.setDate(curr.getDate() + 1);
              }
            }
          }
        });
        
        if (totalAssigned > budget || hasCapacityIssue) {
          setShowApprovalWarning(true);
          setHasCapacityViolation(hasCapacityIssue);
        } else {
          setShowApprovalWarning(false);
          setHasCapacityViolation(false);
          setApprovalReason('');
        }
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.name || !formData.budgetHours) {
          alert('Please fill in task name and budget hours');
          return;
        }

        const budget = parseFloat(formData.budgetHours) || 0;
        const totalAssigned = (formData.assignments || []).reduce((sum, a) => sum + (a.hours || 0), 0);
        const assignmentOverrun = totalAssigned - budget;

        // REQUIRE date ranges for all assignments
        const assignmentsWithoutDates = formData.assignments.filter(a => 
          a.hours > 0 && (!a.startDate || !a.endDate)
        );
        
        if (assignmentsWithoutDates.length > 0) {
          const staffNames = assignmentsWithoutDates.map(a => {
            const s = staff.find(st => st.id === a.staffId);
            return s?.name || 'Unknown';
          }).join(', ');
          
          alert(`Date ranges required!\n\nPlease specify Start Date and End Date for:\n${staffNames}\n\nDate ranges are required for capacity checking.`);
          return;
        }

        // NEW: Check for daily capacity violations
        const overtimeViolations = [];
        
        console.log('=== CAPACITY CHECK START ===');
        console.log('Task:', formData.name);
        console.log('Assignments:', formData.assignments);
        
        formData.assignments.forEach(assignment => {
          if (assignment.startDate && assignment.endDate && assignment.hours > 0) {
            const staffMember = staff.find(s => s.id === assignment.staffId);
            console.log('\nChecking assignment for:', staffMember?.name);
            console.log('Hours:', assignment.hours, 'Dates:', assignment.startDate, 'to', assignment.endDate);
            
            // Get existing capacity
            const existingCapacity = calculateExistingCapacity(
              assignment.staffId,
              assignment.startDate,
              assignment.endDate
            );
            
            console.log('Existing capacity by date:', existingCapacity);
            
            // Calculate working days for this assignment
            const start = new Date(assignment.startDate);
            const end = new Date(assignment.endDate);
            let workingDays = 0;
            const current = new Date(start);
            while (current <= end) {
              const day = current.getDay();
              if (day !== 0 && day !== 6) workingDays++;
              current.setDate(current.getDate() + 1);
            }
            
            if (workingDays > 0) {
              const hoursPerDay = assignment.hours / workingDays;
              
              // Check each day for capacity violations
              let maxOvertime = 0;
              let overtimeDays = [];
              
              const curr = new Date(start);
              while (curr <= end) {
                const day = curr.getDay();
                if (day !== 0 && day !== 6) {
                  const dateKey = curr.toISOString().split('T')[0];
                  const existing = existingCapacity[dateKey] || 0;
                  const newTotal = existing + hoursPerDay;
                  
                  if (newTotal > 8) {
                    const overtimeForDay = newTotal - 8;
                    maxOvertime = Math.max(maxOvertime, overtimeForDay);
                    overtimeDays.push({
                      date: dateKey,
                      existing: existing,
                      adding: hoursPerDay,
                      total: newTotal,
                      overtime: overtimeForDay
                    });
                  }
                }
                curr.setDate(curr.getDate() + 1);
              }
              
              if (overtimeDays.length > 0) {
                console.log('VIOLATION DETECTED!');
                console.log('Overtime days:', overtimeDays);
                
                overtimeViolations.push({
                  staffName: staffMember?.name || 'Unknown',
                  staffId: assignment.staffId,
                  hoursPerDay: hoursPerDay,
                  overtimeHours: maxOvertime,
                  overtimeDays: overtimeDays,
                  startDate: assignment.startDate,
                  endDate: assignment.endDate
                });
              } else {
                console.log('No violations - within capacity');
              }
            }
          }
        });
        
        console.log('\nTotal violations found:', overtimeViolations.length);
        console.log('Violations:', overtimeViolations);
        console.log('=== CAPACITY CHECK END ===\n');

        // If overtime detected, require approval
        if (overtimeViolations.length > 0 && !approvalReason.trim()) {
          const violationsList = overtimeViolations.map(v => {
            const dayDetails = v.overtimeDays.slice(0, 3).map(d => 
              `  ${d.date}: ${d.existing.toFixed(1)}h existing + ${d.adding.toFixed(1)}h new = ${d.total.toFixed(1)}h (${d.overtime.toFixed(1)}h over)`
            ).join('\n');
            
            const moreText = v.overtimeDays.length > 3 ? `\n  ... and ${v.overtimeDays.length - 3} more days` : '';
            
            return `${v.staffName}:\n${dayDetails}${moreText}`;
          }).join('\n\n');
          
          alert(`‚ö†Ô∏è DAILY CAPACITY EXCEEDED!\n\nAdding this task will exceed 8h/day capacity:\n\n${violationsList}\n\n‚ùå TASK NOT SAVED\n\nPlease scroll down and enter a reason in the "Approval Reason" field, then click Save again.`);
          
          // Scroll to approval reason field
          const reasonField = document.querySelector('textarea[placeholder*="reason"]');
          if (reasonField) {
            reasonField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            reasonField.focus();
            reasonField.style.border = '3px solid #FF6B6B';
            reasonField.style.background = '#FFE5E5';
            setTimeout(() => {
              reasonField.style.border = '';
              reasonField.style.background = '';
            }, 3000);
          }
          
          return;
        }

        // Check if approval is needed for assignment overrun
        if (assignmentOverrun > 0 && !approvalReason.trim()) {
          alert(`‚ö†Ô∏è BUDGET EXCEEDED!\n\nTotal assigned hours (${totalAssigned}h) exceed budget (${budget}h) by ${assignmentOverrun}h.\n\n‚ùå TASK NOT SAVED\n\nPlease scroll down and enter a reason in the "Approval Reason" field, then click Save again.`);
          
          // Scroll to approval reason field
          const reasonField = document.querySelector('textarea[placeholder*="reason"]');
          if (reasonField) {
            reasonField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            reasonField.focus();
            reasonField.style.border = '3px solid #FF6B6B';
            reasonField.style.background = '#FFE5E5';
            setTimeout(() => {
              reasonField.style.border = '';
              reasonField.style.background = '';
            }, 3000);
          }
          
          return;
        }

        // Create task with approval requests
        const taskData = {
          ...formData,
          budgetHours: budget,
          actualHours: parseFloat(formData.actualHours) || 0
        };

        // CRITICAL FIX: Use approvalHistory array to maintain audit trail
        // Initialize from existing task if editing
        const existingApprovals = (task && task.approvalHistory) ? [...task.approvalHistory] : [];

        // Add new approval request for assignment overrun (if needed)
        if (assignmentOverrun > 0) {
          existingApprovals.push({
            id: Date.now(),
            type: 'budget_overrun',
            requestedBy: "Current User",
            requestDate: new Date().toISOString().split('T')[0],
            reason: approvalReason,
            additionalHours: assignmentOverrun,
            status: 'pending',
            approvedBy: null,
            approvalDate: null,
            comments: null
          });
        }

        // Add new overtime approval request (if needed)
        if (overtimeViolations.length > 0) {
          existingApprovals.push({
            id: Date.now() + 1,
            type: 'overtime',
            requestedBy: "Current User",
            requestDate: new Date().toISOString().split('T')[0],
            reason: approvalReason,
            violations: overtimeViolations,
            status: 'pending',
            approvedBy: null,
            approvalDate: null,
            comments: null
          });
        }

        // Store all approvals in history array
        if (existingApprovals.length > 0) {
          taskData.approvalHistory = existingApprovals;
        }

        // For backwards compatibility, keep the last pending approval in approvalRequest
        const pendingApprovals = existingApprovals.filter(a => a.status === 'pending');
        if (pendingApprovals.length > 0) {
          taskData.approvalRequest = pendingApprovals[pendingApprovals.length - 1];
        }

        onSave(taskData);
      };

      const filteredStaff = staff.filter(s => {
        if (!s.isActive) return false;
        const searchLower = searchTerm.toLowerCase();
        return s.name.toLowerCase().includes(searchLower) || 
               s.position.toLowerCase().includes(searchLower) ||
               s.level.toLowerCase().includes(searchLower);
      });

      const totalAssignedHours = (formData.assignments || []).reduce((sum, a) => sum + (a.hours || 0), 0);
      const budget = parseFloat(formData.budgetHours) || 0;
      const assignmentOverrun = totalAssignedHours - budget;
      const hasOverrun = assignmentOverrun > 0;

      return h('div', { className: 'modal', onClick: onCancel },
        h('div', { className: 'modal-content', style: { maxWidth: '800px' }, onClick: (e) => e.stopPropagation() },
          h('div', { className: 'modal-header' },
            h('h2', { className: 'modal-title' }, task ? 'Edit Task' : 'Add New Task'),
            h('button', { className: 'close-btn', onClick: onCancel }, '√ó')
          ),
          h('div', { className: 'modal-body' },
            h('form', { onSubmit: handleSubmit, id: 'taskForm' },
              h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Task Name *'),
                h('input', { 
                  className: 'form-input', 
                  type: 'text', 
                  value: formData.name, 
                  onChange: (e) => handleChange('name', e.target.value),
                  required: true,
                  placeholder: 'e.g., Risk assessment procedures'
                })
              ),
              
              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Stage *'),
                  h('select', { 
                    className: 'form-input', 
                    value: formData.stage, 
                    onChange: (e) => handleChange('stage', e.target.value),
                    required: true
                  },
                    AUDIT_STAGES.map(s => 
                      h('option', { key: s.id, value: s.id }, 
                        s.name + (s.id === 'lockdown' ? ' (Max 60 days)' : '')
                      )
                    )
                  )
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Status'),
                  h('select', { 
                    className: 'form-input', 
                    value: formData.status, 
                    onChange: (e) => handleChange('status', e.target.value)
                  },
                    h('option', { value: 'Not Started' }, 'Not Started'),
                    h('option', { value: 'In Progress' }, 'In Progress'),
                    h('option', { value: 'Completed' }, 'Completed')
                  )
                )
              ),

              h('div', { className: 'form-grid' },
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 
                    'Budget Hours *',
                    task && task.budgetLocked && h('span', { 
                      style: { 
                        marginLeft: '8px', 
                        fontSize: '11px', 
                        color: '#4CAF50', 
                        fontWeight: '600',
                        background: '#E8F5E9',
                        padding: '2px 8px',
                        borderRadius: '4px'
                      } 
                    }, 'üîí Locked from Budget')
                  ),
                  h('input', { 
                    className: 'form-input', 
                    type: 'number', 
                    value: formData.budgetHours, 
                    onChange: (e) => handleChange('budgetHours', e.target.value),
                    required: true,
                    min: '0',
                    step: '0.5',
                    disabled: task && task.budgetLocked,  // Read-only if from budget
                    style: task && task.budgetLocked ? { 
                      background: '#F5F5F5', 
                      cursor: 'not-allowed',
                      fontWeight: '600',
                      color: '#4CAF50'
                    } : {}
                  }),
                  task && task.budgetLocked && h('div', {
                    style: {
                      fontSize: '11px',
                      color: '#666',
                      marginTop: '4px'
                    }
                  }, 'üí° Budget hours set from Budget Builder and cannot be changed here')
                ),
                h('div', { className: 'form-group' },
                  h('label', { className: 'form-label' }, 'Actual Hours'),
                  h('input', { 
                    className: 'form-input', 
                    type: 'number', 
                    value: formData.actualHours, 
                    onChange: (e) => handleChange('actualHours', e.target.value),
                    min: '0',
                    step: '0.5'
                  }),
                  h('div', { style: { fontSize: '11px', color: '#666', marginTop: '4px', fontStyle: 'italic' } },
                    'For final reporting only - not used for approvals'
                  )
                )
              ),

              h('div', { className: 'section-title' }, 
                'Team Assignments',
                h('span', { style: { fontSize: '13px', fontWeight: 'normal', marginLeft: '12px' } },
                  h('span', { style: { color: '#666' } }, 'Total Assigned: '),
                  h('span', { style: { fontWeight: '700', color: hasOverrun ? '#DC3545' : totalAssignedHours > 0 ? '#28A745' : '#666' } },
                    totalAssignedHours.toFixed(1) + 'h'
                  ),
                  budget > 0 && h('span', { style: { color: '#999', marginLeft: '4px' } }, 
                    ' / ' + budget + 'h budget'
                  ),
                  hasOverrun && h('span', { style: { color: '#DC3545', marginLeft: '8px', fontWeight: '700' } },
                    '‚ö†Ô∏è +' + assignmentOverrun.toFixed(1) + 'h over!'
                  )
                )
              ),

              // Approval Warning and Reason - FOR BOTH BUDGET AND CAPACITY VIOLATIONS
              (hasOverrun || hasCapacityViolation) && h('div', {
                style: {
                  background: hasCapacityViolation ? 'linear-gradient(135deg, #E3F2FD 0%, #FFF3E0 100%)' : 'linear-gradient(135deg, #FFF3E0 0%, #FFEBEE 100%)',
                  border: hasCapacityViolation ? '2px solid #2196F3' : '2px solid #FFC107',
                  borderRadius: '8px',
                  padding: '16px',
                  marginBottom: '20px'
                }
              },
                h('div', { style: { display: 'flex', alignItems: 'start', gap: '12px', marginBottom: '12px' } },
                  h('div', { style: { fontSize: '32px' } }, hasCapacityViolation ? '‚è∞' : '‚ö†Ô∏è'),
                  h('div', null,
                    h('div', { style: { fontSize: '16px', fontWeight: '700', color: hasCapacityViolation ? '#1976D2' : '#DC3545', marginBottom: '6px' } },
                      hasCapacityViolation ? 'Daily Capacity Will Be Exceeded' : 'Assignment Overrun Detected'
                    ),
                    !hasCapacityViolation && h('div', { style: { fontSize: '13px', color: '#666', marginBottom: '4px' } },
                      `Budget: ${budget}h | Total Assigned: ${totalAssignedHours.toFixed(1)}h | Overrun: ${assignmentOverrun.toFixed(1)}h`
                    ),
                    h('div', { style: { fontSize: '13px', color: '#666', marginBottom: '8px' } },
                      hasCapacityViolation 
                        ? 'One or more staff members will exceed 8 hours per day with this assignment. Overtime approval will be required.'
                        : `You have assigned ${assignmentOverrun.toFixed(1)} hours more than the budget. An approval request will be automatically created for the additional hours.`
                    ),
                    h('div', { style: { fontSize: '12px', color: '#856404', background: '#FFF9E6', padding: '8px', borderRadius: '4px', border: '1px solid #FFE58F' } },
                      hasCapacityViolation
                        ? 'üí° Tip: Explain why overtime is needed (e.g., "Urgent client deadline", "Critical phase of audit", "Staff shortage").'
                        : 'üí° Tip: Explain why the task requires more hours than originally budgeted (e.g., "Scope expanded", "Unexpected complexity", "Client request").'
                    )
                  )
                ),
                h('div', { className: 'form-group', style: { marginBottom: 0 } },
                  h('label', { className: 'form-label' }, 
                    hasCapacityViolation 
                      ? 'Overtime Approval Reason *'
                      : 'Approval Reason for Additional ' + assignmentOverrun.toFixed(1) + 'h *',
                    h('span', { style: { color: '#DC3545', marginLeft: '4px' } }, '(Required)')
                  ),
                  h('textarea', {
                    className: 'form-input',
                    rows: 3,
                    placeholder: hasCapacityViolation
                      ? 'Explain why overtime is necessary (e.g., "Client moved deadline forward by 2 weeks", "Complex technical issues requiring additional senior time", "Year-end reporting deadline cannot be moved")...'
                      : 'Explain why additional assignment hours are needed beyond the budget (e.g., "Client expanded scope to include 3 additional subsidiaries", "Complex technical issues discovered during planning", "Regulatory requirement changes")...',
                    value: approvalReason,
                    onChange: (e) => setApprovalReason(e.target.value),
                    required: hasOverrun || hasCapacityViolation,
                    style: { borderColor: (hasOverrun || hasCapacityViolation) && !approvalReason ? '#DC3545' : undefined }
                  })
                )
              ),
              
              h('input', {
                type: 'text',
                className: 'form-input',
                style: { marginBottom: '12px' },
                placeholder: 'üîç Search staff by name, position, or level...',
                value: searchTerm,
                onChange: (e) => setSearchTerm(e.target.value)
              }),

              h('div', { style: { fontSize: '12px', color: '#666', marginBottom: '12px' } },
                'Showing ' + filteredStaff.length + ' of ' + staff.filter(s => s.isActive).length + ' staff'
              ),

              h('div', { style: { maxHeight: '300px', overflow: 'auto', border: '1px solid #E0E0E0', borderRadius: '8px', padding: '8px' } },
                filteredStaff.length === 0 ?
                  h('div', { style: { textAlign: 'center', padding: '20px', color: '#999' } },
                    searchTerm ? 'No staff found matching "' + searchTerm + '"' : 'No active staff available'
                  ) :
                  filteredStaff.map(s => {
                    const assignment = (formData.assignments || []).find(a => a.staffId === s.id);
                    const hours = assignment ? assignment.hours : '';
                    const startDate = assignment ? assignment.startDate : '';
                    const endDate = assignment ? assignment.endDate : '';
                    
                    return h('div', { 
                      key: s.id, 
                      style: { 
                        padding: '12px', 
                        borderBottom: '1px solid #F0F0F0',
                        background: hours ? '#F0F7FF' : 'transparent',
                        borderRadius: hours ? '6px' : '0',
                        marginBottom: hours ? '8px' : '0'
                      }
                    },
                      h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: hours ? '8px' : '0' } },
                        h('div', { style: { flex: 1 } },
                          h('div', { style: { fontWeight: '600', fontSize: '14px' } }, s.name),
                          h('div', { style: { fontSize: '12px', color: '#666' } }, s.position + ' ‚Ä¢ ' + s.level)
                        ),
                        h('input', {
                          type: 'number',
                          placeholder: 'Hours',
                          value: hours,
                          onChange: (e) => handleAssignmentChange(s.id, 'hours', e.target.value),
                          style: { 
                            width: '90px', 
                            padding: '8px', 
                            border: '2px solid #4472C4', 
                            borderRadius: '6px',
                            fontSize: '14px',
                            fontWeight: hours ? '600' : 'normal'
                          },
                          min: '0',
                          step: '0.5'
                        })
                      ),
                      hours > 0 && h('div', { 
                        style: { 
                          display: 'grid', 
                          gridTemplateColumns: '1fr 1fr', 
                          gap: '8px',
                          paddingTop: '8px',
                          borderTop: '1px solid #E0E0E0'
                        } 
                      },
                        h('div', null,
                          h('label', { style: { fontSize: '11px', color: '#666', fontWeight: '600', display: 'block', marginBottom: '4px' } }, 
                            'üìÖ Start Date'
                          ),
                          h('input', {
                            type: 'date',
                            value: startDate,
                            onChange: (e) => handleAssignmentChange(s.id, 'startDate', e.target.value),
                            style: {
                              width: '100%',
                              padding: '6px',
                              border: '1px solid #E0E0E0',
                              borderRadius: '4px',
                              fontSize: '12px'
                            }
                          })
                        ),
                        h('div', null,
                          h('label', { style: { fontSize: '11px', color: '#666', fontWeight: '600', display: 'block', marginBottom: '4px' } }, 
                            'üìÖ End Date'
                          ),
                          h('input', {
                            type: 'date',
                            value: endDate,
                            onChange: (e) => handleAssignmentChange(s.id, 'endDate', e.target.value),
                            style: {
                              width: '100%',
                              padding: '6px',
                              border: '1px solid #E0E0E0',
                              borderRadius: '4px',
                              fontSize: '12px'
                            }
                          })
                        )
                      ),
                      hours > 0 && startDate && endDate && h('div', {
                        style: {
                          marginTop: '6px',
                          padding: '6px 8px',
                          background: '#E3F2FD',
                          borderRadius: '4px',
                          fontSize: '11px',
                          color: '#1976D2',
                          fontWeight: '600'
                        }
                      }, 'üìä ' + hours + 'h distributed from ' + new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + 
                         ' to ' + new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }))
                    );
                  })
              )
            )
          ),
          h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', type: 'button', onClick: onCancel }, 'Cancel'),
            h('button', { className: 'btn btn-primary', type: 'submit', form: 'taskForm' }, 
              task ? 'Update Task' : 'Add Task'
            )
          )
        )
      );
    }

    // Initialize App
    const root = createRoot(document.getElementById('root'));
    root.render(h(App));
  </script>
</body>
</html>
